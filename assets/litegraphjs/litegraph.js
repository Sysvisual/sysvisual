!function(global){var LiteGraph=global.LiteGraph={VERSION:.4,CANVAS_GRID_SIZE:10,NODE_TITLE_HEIGHT:30,NODE_TITLE_TEXT_Y:20,NODE_SLOT_HEIGHT:20,NODE_WIDGET_HEIGHT:20,NODE_WIDTH:140,NODE_MIN_WIDTH:50,NODE_COLLAPSED_RADIUS:10,NODE_COLLAPSED_WIDTH:80,NODE_TITLE_COLOR:"#999",NODE_SELECTED_TITLE_COLOR:"#FFF",NODE_TEXT_SIZE:14,NODE_TEXT_COLOR:"#AAA",NODE_SUBTEXT_SIZE:12,NODE_DEFAULT_COLOR:"#333",NODE_DEFAULT_BGCOLOR:"#353535",NODE_DEFAULT_BOXCOLOR:"#666",NODE_DEFAULT_SHAPE:"box",NODE_BOX_OUTLINE_COLOR:"#FFF",DEFAULT_SHADOW_COLOR:"rgba(0,0,0,0.5)",DEFAULT_GROUP_FONT:24,WIDGET_BGCOLOR:"#222",WIDGET_OUTLINE_COLOR:"#666",WIDGET_TEXT_COLOR:"#DDD",WIDGET_SECONDARY_TEXT_COLOR:"#999",LINK_COLOR:"#9A9",EVENT_LINK_COLOR:"#A86",CONNECTING_LINK_COLOR:"#AFA",MAX_NUMBER_OF_NODES:1e3,DEFAULT_POSITION:[100,100],VALID_SHAPES:["default","box","round","card"],BOX_SHAPE:1,ROUND_SHAPE:2,CIRCLE_SHAPE:3,CARD_SHAPE:4,ARROW_SHAPE:5,GRID_SHAPE:6,INPUT:1,OUTPUT:2,EVENT:-1,ACTION:-1,NODE_MODES:["Always","On Event","Never","On Trigger"],NODE_MODES_COLORS:["#666","#422","#333","#224","#626"],ALWAYS:0,ON_EVENT:1,NEVER:2,ON_TRIGGER:3,UP:1,DOWN:2,LEFT:3,RIGHT:4,CENTER:5,LINK_RENDER_MODES:["Straight","Linear","Spline"],STRAIGHT_LINK:0,LINEAR_LINK:1,SPLINE_LINK:2,NORMAL_TITLE:0,NO_TITLE:1,TRANSPARENT_TITLE:2,AUTOHIDE_TITLE:3,VERTICAL_LAYOUT:"vertical",proxy:null,node_images_path:"",debug:!1,catch_exceptions:!0,throw_errors:!0,allow_scripts:!1,use_deferred_actions:!0,registered_node_types:{},node_types_by_file_extension:{},Nodes:{},Globals:{},searchbox_extras:{},auto_sort_node_types:!1,node_box_coloured_when_on:!1,node_box_coloured_by_mode:!1,dialog_close_on_mouse_leave:!0,dialog_close_on_mouse_leave_delay:500,shift_click_do_break_link_from:!1,click_do_break_link_to:!1,search_hide_on_mouse_leave:!0,search_filter_enabled:!1,search_show_all_on_open:!0,auto_load_slot_types:!1,registered_slot_in_types:{},registered_slot_out_types:{},slot_types_in:[],slot_types_out:[],slot_types_default_in:[],slot_types_default_out:[],alt_drag_do_clone_nodes:!1,do_add_triggers_slots:!1,allow_multi_output_for_events:!0,middle_click_slot_add_default_node:!1,release_link_on_empty_shows_menu:!1,pointerevents_method:"mouse",ctrl_shift_v_paste_connect_unselected_outputs:!1,use_uuids:!1,registerNodeType:function(t,e){if(!e.prototype)throw"Cannot register a simple object, it must be a class with a prototype";e.type=t,LiteGraph.debug&&console.log("Node registered: "+t);let s=e.name,o=t.lastIndexOf("/");for(var n in e.category=t.substring(0,o),e.title||(e.title=s),LGraphNode.prototype)e.prototype[n]||(e.prototype[n]=LGraphNode.prototype[n]);let r=this.registered_node_types[t];if(r&&console.log("replacing node type: "+t),!Object.prototype.hasOwnProperty.call(e.prototype,"shape")&&(Object.defineProperty(e.prototype,"shape",{set:function(t){switch(t){case"default":delete this._shape;break;case"box":this._shape=LiteGraph.BOX_SHAPE;break;case"round":this._shape=LiteGraph.ROUND_SHAPE;break;case"circle":this._shape=LiteGraph.CIRCLE_SHAPE;break;case"card":this._shape=LiteGraph.CARD_SHAPE;break;default:this._shape=t}},get:function(){return this._shape},enumerable:!0,configurable:!0}),e.supported_extensions))for(let a in e.supported_extensions){let u=e.supported_extensions[a];u&&u.constructor===String&&(this.node_types_by_file_extension[u.toLowerCase()]=e)}this.registered_node_types[t]=e,e.constructor.name&&(this.Nodes[s]=e),LiteGraph.onNodeTypeRegistered&&LiteGraph.onNodeTypeRegistered(t,e),r&&LiteGraph.onNodeTypeReplaced&&LiteGraph.onNodeTypeReplaced(t,e,r),e.prototype.onPropertyChange&&console.warn("LiteGraph node class "+t+" has onPropertyChange method, it must be called onPropertyChanged with d at the end"),this.auto_load_slot_types&&new e(e.title||"tmpnode")},unregisterNodeType:function(t){let e=t.constructor===String?this.registered_node_types[t]:t;if(!e)throw"node type not found: "+t;delete this.registered_node_types[e.type],e.constructor.name&&delete this.Nodes[e.constructor.name]},registerNodeAndSlotType:function(t,e,s){s=s||!1;let o=t.constructor===String&&"anonymous"!==this.registered_node_types[t]?this.registered_node_types[t]:t,n=o.constructor.type,r=[];r="string"==typeof e?e.split(","):e==this.EVENT||e==this.ACTION?["_event_"]:["*"];for(let a=0;a<r.length;++a){let u=r[a];""===u&&(u="*");let h=s?"registered_slot_out_types":"registered_slot_in_types";void 0===this[h][u]&&(this[h][u]={nodes:[]}),this[h][u].nodes.includes(n)||this[h][u].nodes.push(n),s?this.slot_types_out.includes(u.toLowerCase())||(this.slot_types_out.push(u.toLowerCase()),this.slot_types_out.sort()):this.slot_types_in.includes(u.toLowerCase())||(this.slot_types_in.push(u.toLowerCase()),this.slot_types_in.sort())}},buildNodeClassFromObject:function(t,e){var s="";if(e.inputs)for(var o=0;o<e.inputs.length;++o){var n=e.inputs[o][0],r=e.inputs[o][1];r&&r.constructor===String&&(r='"'+r+'"'),s+="this.addInput('"+n+"',"+r+");\n"}if(e.outputs)for(var o=0;o<e.outputs.length;++o){var n=e.outputs[o][0],r=e.outputs[o][1];r&&r.constructor===String&&(r='"'+r+'"'),s+="this.addOutput('"+n+"',"+r+");\n"}if(e.properties)for(var o in e.properties){var a=e.properties[o];a&&a.constructor===String&&(a='"'+a+'"'),s+="this.addProperty('"+o+"',"+a+");\n"}var u=Function(s+="if(this.onCreate)this.onCreate()");for(var o in e)"inputs"!=o&&"outputs"!=o&&"properties"!=o&&(u.prototype[o]=e[o]);return u.title=e.title||t.split("/").pop(),u.desc=e.desc||"Generated from object",this.registerNodeType(t,u),u},wrapFunctionAsNode:function(t,e,s,o,n){var r=Array(e.length),a="";if(null!==s)for(var u=LiteGraph.getParameterNames(e),h=0;h<u.length;++h){var l=0;s&&(null!=s[h]&&s[h].constructor===String?l="'"+s[h]+"'":null!=s[h]&&(l=s[h])),a+="this.addInput('"+u[h]+"',"+l+");\n"}null!==o&&(a+="this.addOutput('out',"+(null!=o?o.constructor===String?"'"+o+"'":o:0)+");\n"),n&&(a+="this.properties = "+JSON.stringify(n)+";\n");var d=Function(a);return d.title=t.split("/").pop(),d.desc="Generated from "+e.name,d.prototype.onExecute=function t(){for(var s=0;s<r.length;++s)r[s]=this.getInputData(s);var o=e.apply(this,r);this.setOutputData(0,o)},this.registerNodeType(t,d),d},clearRegisteredTypes:function(){this.registered_node_types={},this.node_types_by_file_extension={},this.Nodes={},this.searchbox_extras={}},addNodeMethod:function(t,e){for(var s in LGraphNode.prototype[t]=e,this.registered_node_types){var o=this.registered_node_types[s];o.prototype[t]&&(o.prototype["_"+t]=o.prototype[t]),o.prototype[t]=e}},createNode:function(t,e,s){var o=this.registered_node_types[t];if(!o)return LiteGraph.debug&&console.log('GraphNode type "'+t+'" not registered.'),null;o.prototype,e=e||o.title||t;var n=null;if(LiteGraph.catch_exceptions)try{n=new o(e)}catch(r){return console.error(r),null}else n=new o(e);if(n.type=t,!n.title&&e&&(n.title=e),n.properties||(n.properties={}),n.properties_info||(n.properties_info=[]),n.flags||(n.flags={}),n.size||(n.size=n.computeSize()),n.pos||(n.pos=LiteGraph.DEFAULT_POSITION.concat()),n.mode||(n.mode=LiteGraph.ALWAYS),s)for(var a in s)n[a]=s[a];return n.onNodeCreated&&n.onNodeCreated(),n},getNodeType:function(t){return this.registered_node_types[t]},getNodeTypesInCategory:function(t,e){var s=[];for(var o in this.registered_node_types){var n=this.registered_node_types[o];n.filter==e&&(""==t?null==n.category&&s.push(n):n.category==t&&s.push(n))}return this.auto_sort_node_types&&s.sort(function(t,e){return t.title.localeCompare(e.title)}),s},getNodeTypesCategories:function(t){var e={"":1};for(var s in this.registered_node_types){var o=this.registered_node_types[s];if(o.category&&!o.skip_list){if(o.filter!=t)continue;e[o.category]=1}}var n=[];for(var s in e)n.push(s);return this.auto_sort_node_types?n.sort():n},reloadNodes:function(t){for(var e=document.getElementsByTagName("script"),s=[],o=0;o<e.length;o++)s.push(e[o]);var n=document.getElementsByTagName("head")[0];t=document.location.href+t;for(var o=0;o<s.length;o++){var r=s[o].src;if(r&&r.substr(0,t.length)==t)try{LiteGraph.debug&&console.log("Reloading: "+r);var a=document.createElement("script");a.type="text/javascript",a.src=r,n.appendChild(a),n.removeChild(s[o])}catch(u){if(LiteGraph.throw_errors)throw u;LiteGraph.debug&&console.log("Error while reloading "+r)}}LiteGraph.debug&&console.log("Nodes reloaded")},cloneObject:function(t,e){if(null==t)return null;var s=JSON.parse(JSON.stringify(t));if(!e)return s;for(var o in s)e[o]=s[o];return e},uuidv4:function(){return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,t=>(t^16*Math.random()>>t/4).toString(16))},isValidConnection:function(t,e){if((""==t||"*"===t)&&(t=0),(""==e||"*"===e)&&(e=0),!t||!e||t==e||t==LiteGraph.EVENT&&e==LiteGraph.ACTION)return!0;if(t=String(t),e=String(e),t=t.toLowerCase(),e=e.toLowerCase(),-1==t.indexOf(",")&&-1==e.indexOf(","))return t==e;for(var s=t.split(","),o=e.split(","),n=0;n<s.length;++n)for(var r=0;r<o.length;++r)if(this.isValidConnection(s[n],o[r]))return!0;return!1},registerSearchboxExtra:function(t,e,s){this.searchbox_extras[e.toLowerCase()]={type:t,desc:e,data:s}},fetchFile:function(t,e,s,o){if(!t)return null;if(e=e||"text",t.constructor===String)return"http"==t.substr(0,4)&&LiteGraph.proxy&&(t=LiteGraph.proxy+t.substr(t.indexOf(":")+3)),fetch(t).then(function(t){if(!t.ok)throw Error("File not found");return"arraybuffer"==e?t.arrayBuffer():"text"==e||"string"==e?t.text():"json"==e?t.json():"blob"==e?t.blob():void 0}).then(function(t){s&&s(t)}).catch(function(e){console.error("error fetching file:",t),o&&o(e)});if(t.constructor===File||t.constructor===Blob){var n=new FileReader;if(n.onload=function(t){var o=t.target.result;"json"==e&&(o=JSON.parse(o)),s&&s(o)},"arraybuffer"==e)return n.readAsArrayBuffer(t);if("text"==e||"json"==e)return n.readAsText(t);if("blob"==e)return n.readAsBinaryString(t)}return null}};function LGraph(t){LiteGraph.debug&&console.log("Graph created"),this.list_of_graphcanvas=null,this.clear(),t&&this.configure(t)}function LLink(t,e,s,o,n,r){this.id=t,this.type=e,this.origin_id=s,this.origin_slot=o,this.target_id=n,this.target_slot=r,this._data=null,this._pos=new Float32Array(2)}function LGraphNode(t){this._ctor(t)}function LGraphGroup(t){this._ctor(t)}function DragAndScale(t,e){this.offset=new Float32Array([0,0]),this.scale=1,this.max_scale=10,this.min_scale=.1,this.onredraw=null,this.enabled=!0,this.last_mouse=[0,0],this.element=null,this.visible_area=new Float32Array(4),t&&(this.element=t,e||this.bindEvents(t))}function LGraphCanvas(t,e,s){this.options=s=s||{},this.background_image=LGraphCanvas.DEFAULT_BACKGROUND_IMAGE,t&&t.constructor===String&&(t=document.querySelector(t)),this.ds=new DragAndScale,this.zoom_modify_alpha=!0,this.title_text_font=""+LiteGraph.NODE_TEXT_SIZE+"px Arial",this.inner_text_font="normal "+LiteGraph.NODE_SUBTEXT_SIZE+"px Arial",this.node_title_color=LiteGraph.NODE_TITLE_COLOR,this.default_link_color=LiteGraph.LINK_COLOR,this.default_connection_color={input_off:"#778",input_on:"#7F7",output_off:"#778",output_on:"#7F7"},this.default_connection_color_byType={},this.default_connection_color_byTypeOff={},this.highquality_render=!0,this.use_gradients=!1,this.editor_alpha=1,this.pause_rendering=!1,this.clear_background=!0,this.clear_background_color="#222",this.read_only=!1,this.render_only_selected=!0,this.live_mode=!1,this.show_info=!0,this.allow_dragcanvas=!0,this.allow_dragnodes=!0,this.allow_interaction=!0,this.multi_select=!1,this.allow_searchbox=!0,this.allow_reconnect_links=!0,this.align_to_grid=!1,this.drag_mode=!1,this.dragging_rectangle=null,this.filter=null,this.set_canvas_dirty_on_mouse_event=!0,this.always_render_background=!1,this.render_shadows=!0,this.render_canvas_border=!0,this.render_connections_shadows=!1,this.render_connections_border=!0,this.render_curved_connections=!1,this.render_connection_arrows=!1,this.render_collapsed_slots=!0,this.render_execution_order=!1,this.render_title_colored=!0,this.render_link_tooltip=!0,this.links_render_mode=LiteGraph.SPLINE_LINK,this.mouse=[0,0],this.graph_mouse=[0,0],this.canvas_mouse=this.graph_mouse,this.onSearchBox=null,this.onSearchBoxSelection=null,this.onMouse=null,this.onDrawBackground=null,this.onDrawForeground=null,this.onDrawOverlay=null,this.onDrawLinkTooltip=null,this.onNodeMoved=null,this.onSelectionChange=null,this.onConnectingChange=null,this.onBeforeChange=null,this.onAfterChange=null,this.connections_width=3,this.round_radius=8,this.current_node=null,this.node_widget=null,this.over_link_center=null,this.last_mouse_position=[0,0],this.visible_area=this.ds.visible_area,this.visible_links=[],this.viewport=s.viewport||null,e&&e.attachCanvas(this),this.setCanvas(t,s.skip_events),this.clear(),s.skip_render||this.startRendering(),this.autoresize=s.autoresize}"undefined"!=typeof performance?LiteGraph.getTime=performance.now.bind(performance):"undefined"!=typeof Date&&Date.now?LiteGraph.getTime=Date.now.bind(Date):"undefined"!=typeof process?LiteGraph.getTime=function(){var t=process.hrtime();return .001*t[0]+1e-6*t[1]}:LiteGraph.getTime=function t(){return new Date().getTime()},global.LGraph=LiteGraph.LGraph=LGraph,LGraph.supported_types=["number","string","boolean"],LGraph.prototype.getSupportedTypes=function(){return this.supported_types||LGraph.supported_types},LGraph.STATUS_STOPPED=1,LGraph.STATUS_RUNNING=2,LGraph.prototype.clear=function(){if(this.stop(),this.status=LGraph.STATUS_STOPPED,this.last_node_id=0,this.last_link_id=0,this._version=-1,this._nodes)for(var t=0;t<this._nodes.length;++t){var e=this._nodes[t];e.onRemoved&&e.onRemoved()}this._nodes=[],this._nodes_by_id={},this._nodes_in_order=[],this._nodes_executable=null,this._groups=[],this.links={},this.iteration=0,this.config={},this.vars={},this.extra={},this.globaltime=0,this.runningtime=0,this.fixedtime=0,this.fixedtime_lapse=.01,this.elapsed_time=.01,this.last_update_time=0,this.starttime=0,this.catch_errors=!0,this.nodes_executing=[],this.nodes_actioning=[],this.nodes_executedAction=[],this.inputs={},this.outputs={},this.change(),this.sendActionToCanvas("clear")},LGraph.prototype.attachCanvas=function(t){if(t.constructor!=LGraphCanvas)throw"attachCanvas expects a LGraphCanvas instance";t.graph&&t.graph!=this&&t.graph.detachCanvas(t),t.graph=this,this.list_of_graphcanvas||(this.list_of_graphcanvas=[]),this.list_of_graphcanvas.push(t)},LGraph.prototype.detachCanvas=function(t){if(this.list_of_graphcanvas){var e=this.list_of_graphcanvas.indexOf(t);-1!=e&&(t.graph=null,this.list_of_graphcanvas.splice(e,1))}},LGraph.prototype.start=function(t){if(this.status!=LGraph.STATUS_RUNNING){this.status=LGraph.STATUS_RUNNING,this.onPlayEvent&&this.onPlayEvent(),this.sendEventToAllNodes("onStart"),this.starttime=LiteGraph.getTime(),this.last_update_time=this.starttime;var e=this;if(0==(t=t||0)&&"undefined"!=typeof window&&window.requestAnimationFrame){function s(){-1==e.execution_timer_id&&(window.requestAnimationFrame(s),e.onBeforeStep&&e.onBeforeStep(),e.runStep(1,!e.catch_errors),e.onAfterStep&&e.onAfterStep())}this.execution_timer_id=-1,s()}else this.execution_timer_id=setInterval(function(){e.onBeforeStep&&e.onBeforeStep(),e.runStep(1,!e.catch_errors),e.onAfterStep&&e.onAfterStep()},t)}},LGraph.prototype.stop=function(){this.status!=LGraph.STATUS_STOPPED&&(this.status=LGraph.STATUS_STOPPED,this.onStopEvent&&this.onStopEvent(),null!=this.execution_timer_id&&(-1!=this.execution_timer_id&&clearInterval(this.execution_timer_id),this.execution_timer_id=null),this.sendEventToAllNodes("onStop"))},LGraph.prototype.runStep=function(t,e,s){t=t||1;var o=LiteGraph.getTime();this.globaltime=.001*(o-this.starttime);var n=this._nodes_executable?this._nodes_executable:this._nodes;if(n){if(s=s||n.length,e){for(var r=0;r<t;r++){for(var a=0;a<s;++a){var u=n[a];LiteGraph.use_deferred_actions&&u._waiting_actions&&u._waiting_actions.length&&u.executePendingActions(),u.mode==LiteGraph.ALWAYS&&u.onExecute&&u.doExecute()}this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep&&this.onExecuteStep()}this.onAfterExecute&&this.onAfterExecute()}else try{for(var r=0;r<t;r++){for(var a=0;a<s;++a){var u=n[a];LiteGraph.use_deferred_actions&&u._waiting_actions&&u._waiting_actions.length&&u.executePendingActions(),u.mode==LiteGraph.ALWAYS&&u.onExecute&&u.onExecute()}this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep&&this.onExecuteStep()}this.onAfterExecute&&this.onAfterExecute(),this.errors_in_execution=!1}catch(h){if(this.errors_in_execution=!0,LiteGraph.throw_errors)throw h;LiteGraph.debug&&console.log("Error during execution: "+h),this.stop()}var l=LiteGraph.getTime(),d=l-o;0==d&&(d=1),this.execution_time=.001*d,this.globaltime+=.001*d,this.iteration+=1,this.elapsed_time=(l-this.last_update_time)*.001,this.last_update_time=l,this.nodes_executing=[],this.nodes_actioning=[],this.nodes_executedAction=[]}},LGraph.prototype.updateExecutionOrder=function(){this._nodes_in_order=this.computeExecutionOrder(!1),this._nodes_executable=[];for(var t=0;t<this._nodes_in_order.length;++t)this._nodes_in_order[t].onExecute&&this._nodes_executable.push(this._nodes_in_order[t])},LGraph.prototype.computeExecutionOrder=function(t,e){for(var s=[],o=[],n={},r={},a={},u=0,h=this._nodes.length;u<h;++u){var l=this._nodes[u];if(!t||l.onExecute){n[l.id]=l;var d=0;if(l.inputs)for(var c=0,f=l.inputs.length;c<f;c++)l.inputs[c]&&null!=l.inputs[c].link&&(d+=1);0==d?(o.push(l),e&&(l._level=1)):(e&&(l._level=0),a[l.id]=d)}}for(;0!=o.length;){var l=o.shift();if(s.push(l),delete n[l.id],l.outputs)for(var u=0;u<l.outputs.length;u++){var g=l.outputs[u];if(null!=g&&null!=g.links&&0!=g.links.length)for(var c=0;c<g.links.length;c++){var v=g.links[c],$=this.links[v];if($&&!r[$.id]){var m=this.getNodeById($.target_id);if(null==m){r[$.id]=!0;continue}e&&(!m._level||m._level<=l._level)&&(m._level=l._level+1),r[$.id]=!0,a[m.id]-=1,0==a[m.id]&&o.push(m)}}}}for(var u in n)s.push(n[u]);s.length!=this._nodes.length&&LiteGraph.debug&&console.warn("something went wrong, nodes missing");for(var h=s.length,u=0;u<h;++u)s[u].order=u;s=s.sort(function(t,e){var s=t.constructor.priority||t.priority||0,o=e.constructor.priority||e.priority||0;return s==o?t.order-e.order:s-o});for(var u=0;u<h;++u)s[u].order=u;return s},LGraph.prototype.getAncestors=function(t){for(var e=[],s=[t],o={};s.length;){var n=s.shift();if(n.inputs){o[n.id]||n==t||(o[n.id]=!0,e.push(n));for(var r=0;r<n.inputs.length;++r){var a=n.getInputNode(r);a&&-1==e.indexOf(a)&&s.push(a)}}}return e.sort(function(t,e){return t.order-e.order}),e},LGraph.prototype.arrange=function(t,e){t=t||100;let s=this.computeExecutionOrder(!1,!0),o=[];for(let n=0;n<s.length;++n){let r=s[n],a=r._level||1;o[a]||(o[a]=[]),o[a].push(r)}let u=t;for(let h=0;h<o.length;++h){let l=o[h];if(!l)continue;let d=100,c=t+LiteGraph.NODE_TITLE_HEIGHT;for(let f=0;f<l.length;++f){let g=l[f];g.pos[0]=e==LiteGraph.VERTICAL_LAYOUT?c:u,g.pos[1]=e==LiteGraph.VERTICAL_LAYOUT?u:c;let v=e==LiteGraph.VERTICAL_LAYOUT?1:0;g.size[v]>d&&(d=g.size[v]);let $=e==LiteGraph.VERTICAL_LAYOUT?0:1;c+=g.size[$]+t+LiteGraph.NODE_TITLE_HEIGHT}u+=d+t}this.setDirtyCanvas(!0,!0)},LGraph.prototype.getTime=function(){return this.globaltime},LGraph.prototype.getFixedTime=function(){return this.fixedtime},LGraph.prototype.getElapsedTime=function(){return this.elapsed_time},LGraph.prototype.sendEventToAllNodes=function(t,e,s){s=s||LiteGraph.ALWAYS;var o=this._nodes_in_order?this._nodes_in_order:this._nodes;if(o)for(var n=0,r=o.length;n<r;++n){var a=o[n];if(a.constructor===LiteGraph.Subgraph&&"onExecute"!=t){a.mode==s&&a.sendEventToAllNodes(t,e,s);continue}a[t]&&a.mode==s&&(void 0===e?a[t]():e&&e.constructor===Array?a[t].apply(a,e):a[t](e))}},LGraph.prototype.sendActionToCanvas=function(t,e){if(this.list_of_graphcanvas)for(var s=0;s<this.list_of_graphcanvas.length;++s){var o=this.list_of_graphcanvas[s];o[t]&&o[t].apply(o,e)}},LGraph.prototype.add=function(t,e){if(t){if(t.constructor===LGraphGroup){this._groups.push(t),this.setDirtyCanvas(!0),this.change(),t.graph=this,this._version++;return}if(-1!=t.id&&null!=this._nodes_by_id[t.id]&&(console.warn("LiteGraph: there is already a node with this ID, changing it"),LiteGraph.use_uuids?t.id=LiteGraph.uuidv4():t.id=++this.last_node_id),this._nodes.length>=LiteGraph.MAX_NUMBER_OF_NODES)throw"LiteGraph: max number of nodes in a graph reached";return LiteGraph.use_uuids?(null==t.id||-1==t.id)&&(t.id=LiteGraph.uuidv4()):null==t.id||-1==t.id?t.id=++this.last_node_id:this.last_node_id<t.id&&(this.last_node_id=t.id),t.graph=this,this._version++,this._nodes.push(t),this._nodes_by_id[t.id]=t,t.onAdded&&t.onAdded(this),this.config.align_to_grid&&t.alignToGrid(),e||this.updateExecutionOrder(),this.onNodeAdded&&this.onNodeAdded(t),this.setDirtyCanvas(!0),this.change(),t}},LGraph.prototype.remove=function(t){if(t.constructor===LiteGraph.LGraphGroup){var e=this._groups.indexOf(t);-1!=e&&this._groups.splice(e,1),t.graph=null,this._version++,this.setDirtyCanvas(!0,!0),this.change();return}if(null!=this._nodes_by_id[t.id]&&!t.ignore_remove){if(this.beforeChange(),t.inputs)for(var s=0;s<t.inputs.length;s++){var o=t.inputs[s];null!=o.link&&t.disconnectInput(s)}if(t.outputs)for(var s=0;s<t.outputs.length;s++){var o=t.outputs[s];null!=o.links&&o.links.length&&t.disconnectOutput(s)}if(t.onRemoved&&t.onRemoved(),t.graph=null,this._version++,this.list_of_graphcanvas)for(var s=0;s<this.list_of_graphcanvas.length;++s){var n=this.list_of_graphcanvas[s];n.selected_nodes[t.id]&&delete n.selected_nodes[t.id],n.node_dragged==t&&(n.node_dragged=null)}var r=this._nodes.indexOf(t);-1!=r&&this._nodes.splice(r,1),delete this._nodes_by_id[t.id],this.onNodeRemoved&&this.onNodeRemoved(t),this.sendActionToCanvas("checkPanels"),this.setDirtyCanvas(!0,!0),this.afterChange(),this.change(),this.updateExecutionOrder()}},LGraph.prototype.getNodeById=function(t){return null==t?null:this._nodes_by_id[t]},LGraph.prototype.findNodesByClass=function(t,e){(e=e||[]).length=0;for(var s=0,o=this._nodes.length;s<o;++s)this._nodes[s].constructor===t&&e.push(this._nodes[s]);return e},LGraph.prototype.findNodesByType=function(t,e){var t=t.toLowerCase();(e=e||[]).length=0;for(var s=0,o=this._nodes.length;s<o;++s)this._nodes[s].type.toLowerCase()==t&&e.push(this._nodes[s]);return e},LGraph.prototype.findNodeByTitle=function(t){for(var e=0,s=this._nodes.length;e<s;++e)if(this._nodes[e].title==t)return this._nodes[e];return null},LGraph.prototype.findNodesByTitle=function(t){for(var e=[],s=0,o=this._nodes.length;s<o;++s)this._nodes[s].title==t&&e.push(this._nodes[s]);return e},LGraph.prototype.getNodeOnPos=function(t,e,s,o){s=s||this._nodes;for(var n=null,r=s.length-1;r>=0;r--){var a=s[r];if(a.isPointInside(t,e,o))return a}return n},LGraph.prototype.getGroupOnPos=function(t,e){for(var s=this._groups.length-1;s>=0;s--){var o=this._groups[s];if(o.isPointInside(t,e,2,!0))return o}return null},LGraph.prototype.checkNodeTypes=function(){for(var t=!1,e=0;e<this._nodes.length;e++){var s=this._nodes[e],o=LiteGraph.registered_node_types[s.type];if(s.constructor!=o){console.log("node being replaced by newer version: "+s.type);var n=LiteGraph.createNode(s.type);t=!0,this._nodes[e]=n,n.configure(s.serialize()),n.graph=this,this._nodes_by_id[n.id]=n,s.inputs&&(n.inputs=s.inputs.concat()),s.outputs&&(n.outputs=s.outputs.concat())}}this.updateExecutionOrder()},LGraph.prototype.onAction=function(t,e,s){this._input_nodes=this.findNodesByClass(LiteGraph.GraphInput,this._input_nodes);for(var o=0;o<this._input_nodes.length;++o){var n=this._input_nodes[o];if(n.properties.name==t){n.actionDo(t,e,s);break}}},LGraph.prototype.trigger=function(t,e){this.onTrigger&&this.onTrigger(t,e)},LGraph.prototype.addInput=function(t,e,s){!this.inputs[t]&&(this.beforeChange(),this.inputs[t]={name:t,type:e,value:s},this._version++,this.afterChange(),this.onInputAdded&&this.onInputAdded(t,e),this.onInputsOutputsChange&&this.onInputsOutputsChange())},LGraph.prototype.setInputData=function(t,e){var s=this.inputs[t];s&&(s.value=e)},LGraph.prototype.getInputData=function(t){var e=this.inputs[t];return e?e.value:null},LGraph.prototype.renameInput=function(t,e){return e==t?void 0:!!this.inputs[t]&&(this.inputs[e]?(console.error("there is already one input with that name"),!1):void(this.inputs[e]=this.inputs[t],delete this.inputs[t],this._version++,this.onInputRenamed&&this.onInputRenamed(t,e),this.onInputsOutputsChange&&this.onInputsOutputsChange()))},LGraph.prototype.changeInputType=function(t,e){if(!this.inputs[t])return!1;(!this.inputs[t].type||String(this.inputs[t].type).toLowerCase()!=String(e).toLowerCase())&&(this.inputs[t].type=e,this._version++,this.onInputTypeChanged&&this.onInputTypeChanged(t,e))},LGraph.prototype.removeInput=function(t){return!!this.inputs[t]&&(delete this.inputs[t],this._version++,this.onInputRemoved&&this.onInputRemoved(t),this.onInputsOutputsChange&&this.onInputsOutputsChange(),!0)},LGraph.prototype.addOutput=function(t,e,s){this.outputs[t]={name:t,type:e,value:s},this._version++,this.onOutputAdded&&this.onOutputAdded(t,e),this.onInputsOutputsChange&&this.onInputsOutputsChange()},LGraph.prototype.setOutputData=function(t,e){var s=this.outputs[t];s&&(s.value=e)},LGraph.prototype.getOutputData=function(t){var e=this.outputs[t];return e?e.value:null},LGraph.prototype.renameOutput=function(t,e){return!!this.outputs[t]&&(this.outputs[e]?(console.error("there is already one output with that name"),!1):void(this.outputs[e]=this.outputs[t],delete this.outputs[t],this._version++,this.onOutputRenamed&&this.onOutputRenamed(t,e),this.onInputsOutputsChange&&this.onInputsOutputsChange()))},LGraph.prototype.changeOutputType=function(t,e){if(!this.outputs[t])return!1;(!this.outputs[t].type||String(this.outputs[t].type).toLowerCase()!=String(e).toLowerCase())&&(this.outputs[t].type=e,this._version++,this.onOutputTypeChanged&&this.onOutputTypeChanged(t,e))},LGraph.prototype.removeOutput=function(t){return!!this.outputs[t]&&(delete this.outputs[t],this._version++,this.onOutputRemoved&&this.onOutputRemoved(t),this.onInputsOutputsChange&&this.onInputsOutputsChange(),!0)},LGraph.prototype.triggerInput=function(t,e){for(var s=this.findNodesByTitle(t),o=0;o<s.length;++o)s[o].onTrigger(e)},LGraph.prototype.setCallback=function(t,e){for(var s=this.findNodesByTitle(t),o=0;o<s.length;++o)s[o].setTrigger(e)},LGraph.prototype.beforeChange=function(t){this.onBeforeChange&&this.onBeforeChange(this,t),this.sendActionToCanvas("onBeforeChange",this)},LGraph.prototype.afterChange=function(t){this.onAfterChange&&this.onAfterChange(this,t),this.sendActionToCanvas("onAfterChange",this)},LGraph.prototype.connectionChange=function(t,e){this.updateExecutionOrder(),this.onConnectionChange&&this.onConnectionChange(t),this._version++,this.sendActionToCanvas("onConnectionChange")},LGraph.prototype.isLive=function(){if(!this.list_of_graphcanvas)return!1;for(var t=0;t<this.list_of_graphcanvas.length;++t)if(this.list_of_graphcanvas[t].live_mode)return!0;return!1},LGraph.prototype.clearTriggeredSlots=function(){for(var t in this.links){var e=this.links[t];e&&e._last_time&&(e._last_time=0)}},LGraph.prototype.change=function(){LiteGraph.debug&&console.log("Graph changed"),this.sendActionToCanvas("setDirty",[!0,!0]),this.on_change&&this.on_change(this)},LGraph.prototype.setDirtyCanvas=function(t,e){this.sendActionToCanvas("setDirty",[t,e])},LGraph.prototype.removeLink=function(t){var e=this.links[t];if(e){var s=this.getNodeById(e.target_id);s&&s.disconnectInput(e.target_slot)}},LGraph.prototype.serialize=function(){for(var t=[],e=0,s=this._nodes.length;e<s;++e)t.push(this._nodes[e].serialize());var o=[];for(var e in this.links){var n=this.links[e];if(!n.serialize){console.warn("weird LLink bug, link info is not a LLink but a regular object");var r=new LLink;for(var a in n)r[a]=n[a];this.links[e]=r,n=r}o.push(n.serialize())}for(var u=[],e=0;e<this._groups.length;++e)u.push(this._groups[e].serialize());var h={last_node_id:this.last_node_id,last_link_id:this.last_link_id,nodes:t,links:o,groups:u,config:this.config,extra:this.extra,version:LiteGraph.VERSION};return this.onSerialize&&this.onSerialize(h),h},LGraph.prototype.configure=function(t,e){if(t){e||this.clear();var s=t.nodes;if(t.links&&t.links.constructor===Array){for(var o=[],n=0;n<t.links.length;++n){var r=t.links[n];if(!r){console.warn("serialized graph link data contains errors, skipping.");continue}var a=new LLink;a.configure(r),o[a.id]=a}t.links=o}for(var n in t)"nodes"!=n&&"groups"!=n&&(this[n]=t[n]);var u=!1;if(this._nodes=[],s){for(var n=0,h=s.length;n<h;++n){var l=s[n],d=LiteGraph.createNode(l.type,l.title);d||(LiteGraph.debug&&console.log("Node not found or has errors: "+l.type),(d=new LGraphNode).last_serialization=l,d.has_errors=!0,u=!0),d.id=l.id,this.add(d,!0)}for(var n=0,h=s.length;n<h;++n){var l=s[n],d=this.getNodeById(l.id);d&&d.configure(l)}}if(this._groups.length=0,t.groups)for(var n=0;n<t.groups.length;++n){var c=new LiteGraph.LGraphGroup;c.configure(t.groups[n]),this.add(c)}return this.updateExecutionOrder(),this.extra=t.extra||{},this.onConfigure&&this.onConfigure(t),this._version++,this.setDirtyCanvas(!0,!0),u}},LGraph.prototype.load=function(t,e){var s=this;if(t.constructor===File||t.constructor===Blob){var o=new FileReader;o.addEventListener("load",function(t){var o=JSON.parse(t.target.result);s.configure(o),e&&e()}),o.readAsText(t);return}var n=new XMLHttpRequest;n.open("GET",t,!0),n.send(null),n.onload=function(t){if(200!==n.status){console.error("Error loading graph:",n.status,n.response);return}var o=JSON.parse(n.response);s.configure(o),e&&e()},n.onerror=function(t){console.error("Error loading graph:",t)}},LGraph.prototype.onNodeTrace=function(t,e,s){},LLink.prototype.configure=function(t){t.constructor===Array?(this.id=t[0],this.origin_id=t[1],this.origin_slot=t[2],this.target_id=t[3],this.target_slot=t[4],this.type=t[5]):(this.id=t.id,this.type=t.type,this.origin_id=t.origin_id,this.origin_slot=t.origin_slot,this.target_id=t.target_id,this.target_slot=t.target_slot)},LLink.prototype.serialize=function(){return[this.id,this.origin_id,this.origin_slot,this.target_id,this.target_slot,this.type]},LiteGraph.LLink=LLink,global.LGraphNode=LiteGraph.LGraphNode=LGraphNode,LGraphNode.prototype._ctor=function(t){this.title=t||"Unnamed",this.size=[LiteGraph.NODE_WIDTH,60],this.graph=null,this._pos=new Float32Array(10,10),Object.defineProperty(this,"pos",{set:function(t){t&&!(t.length<2)&&(this._pos[0]=t[0],this._pos[1]=t[1])},get:function(){return this._pos},enumerable:!0}),LiteGraph.use_uuids?this.id=LiteGraph.uuidv4():this.id=-1,this.type=null,this.inputs=[],this.outputs=[],this.connections=[],this.properties={},this.properties_info=[],this.flags={}},LGraphNode.prototype.configure=function(t){for(var e in this.graph&&this.graph._version++,t){if("properties"==e){for(var s in t.properties)this.properties[s]=t.properties[s],this.onPropertyChanged&&this.onPropertyChanged(s,t.properties[s]);continue}null!=t[e]&&("object"==typeof t[e]?this[e]&&this[e].configure?this[e].configure(t[e]):this[e]=LiteGraph.cloneObject(t[e],this[e]):this[e]=t[e])}if(t.title||(this.title=this.constructor.title),this.inputs)for(var o=0;o<this.inputs.length;++o){var n=this.inputs[o],r=this.graph?this.graph.links[n.link]:null;this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.INPUT,o,!0,r,n),this.onInputAdded&&this.onInputAdded(n)}if(this.outputs)for(var o=0;o<this.outputs.length;++o){var a=this.outputs[o];if(a.links){for(var e=0;e<a.links.length;++e){var r=this.graph?this.graph.links[a.links[e]]:null;this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,o,!0,r,a)}this.onOutputAdded&&this.onOutputAdded(a)}}if(this.widgets){for(var o=0;o<this.widgets.length;++o){var u=this.widgets[o];u&&u.options&&u.options.property&&void 0!=this.properties[u.options.property]&&(u.value=JSON.parse(JSON.stringify(this.properties[u.options.property])))}if(t.widgets_values)for(var o=0;o<t.widgets_values.length;++o)this.widgets[o]&&(this.widgets[o].value=t.widgets_values[o])}this.onConfigure&&this.onConfigure(t)},LGraphNode.prototype.serialize=function(){var t={id:this.id,type:this.type,pos:this.pos,size:this.size,flags:LiteGraph.cloneObject(this.flags),order:this.order,mode:this.mode};if(this.constructor===LGraphNode&&this.last_serialization)return this.last_serialization;if(this.inputs&&(t.inputs=this.inputs),this.outputs){for(var e=0;e<this.outputs.length;e++)delete this.outputs[e]._data;t.outputs=this.outputs}if(this.title&&this.title!=this.constructor.title&&(t.title=this.title),this.properties&&(t.properties=LiteGraph.cloneObject(this.properties)),this.widgets&&this.serialize_widgets){t.widgets_values=[];for(var e=0;e<this.widgets.length;++e)this.widgets[e]?t.widgets_values[e]=this.widgets[e].value:t.widgets_values[e]=null}return t.type||(t.type=this.constructor.type),this.color&&(t.color=this.color),this.bgcolor&&(t.bgcolor=this.bgcolor),this.boxcolor&&(t.boxcolor=this.boxcolor),this.shape&&(t.shape=this.shape),this.onSerialize&&this.onSerialize(t)&&console.warn("node onSerialize shouldnt return anything, data should be stored in the object pass in the first parameter"),t},LGraphNode.prototype.clone=function(){var t=LiteGraph.createNode(this.type);if(!t)return null;var e=LiteGraph.cloneObject(this.serialize());if(e.inputs)for(var s=0;s<e.inputs.length;++s)e.inputs[s].link=null;if(e.outputs)for(var s=0;s<e.outputs.length;++s)e.outputs[s].links&&(e.outputs[s].links.length=0);return delete e.id,LiteGraph.use_uuids&&(e.id=LiteGraph.uuidv4()),t.configure(e),t},LGraphNode.prototype.toString=function(){return JSON.stringify(this.serialize())},LGraphNode.prototype.getTitle=function(){return this.title||this.constructor.title},LGraphNode.prototype.setProperty=function(t,e){if(this.properties||(this.properties={}),e!==this.properties[t]){var s=this.properties[t];if(this.properties[t]=e,this.onPropertyChanged&&!1===this.onPropertyChanged(t,e,s)&&(this.properties[t]=s),this.widgets)for(var o=0;o<this.widgets.length;++o){var n=this.widgets[o];if(n&&n.options.property==t){n.value=e;break}}}},LGraphNode.prototype.setOutputData=function(t,e){if(this.outputs&&-1!=t&&!(t>=this.outputs.length)){var s=this.outputs[t];if(s&&(s._data=e,this.outputs[t].links))for(var o=0;o<this.outputs[t].links.length;o++){var n=this.outputs[t].links[o],r=this.graph.links[n];r&&(r.data=e)}}},LGraphNode.prototype.setOutputDataType=function(t,e){if(this.outputs&&-1!=t&&!(t>=this.outputs.length)){var s=this.outputs[t];if(s&&(s.type=e,this.outputs[t].links))for(var o=0;o<this.outputs[t].links.length;o++){var n=this.outputs[t].links[o];this.graph.links[n].type=e}}},LGraphNode.prototype.getInputData=function(t,e){if(this.inputs&&!(t>=this.inputs.length)&&null!=this.inputs[t].link){var s=this.inputs[t].link,o=this.graph.links[s];if(!o)return null;if(!e)return o.data;var n=this.graph.getNodeById(o.origin_id);return n&&(n.updateOutputData?n.updateOutputData(o.origin_slot):n.onExecute&&n.onExecute()),o.data}},LGraphNode.prototype.getInputDataType=function(t){if(!this.inputs||t>=this.inputs.length||null==this.inputs[t].link)return null;var e=this.inputs[t].link,s=this.graph.links[e];if(!s)return null;var o=this.graph.getNodeById(s.origin_id);if(!o)return s.type;var n=o.outputs[s.origin_slot];return n?n.type:null},LGraphNode.prototype.getInputDataByName=function(t,e){var s=this.findInputSlot(t);return -1==s?null:this.getInputData(s,e)},LGraphNode.prototype.isInputConnected=function(t){return!!this.inputs&&t<this.inputs.length&&null!=this.inputs[t].link},LGraphNode.prototype.getInputInfo=function(t){return this.inputs&&t<this.inputs.length?this.inputs[t]:null},LGraphNode.prototype.getInputLink=function(t){if(!this.inputs)return null;if(t<this.inputs.length){var e=this.inputs[t];return this.graph.links[e.link]}return null},LGraphNode.prototype.getInputNode=function(t){if(!this.inputs||t>=this.inputs.length)return null;var e=this.inputs[t];if(!e||null===e.link)return null;var s=this.graph.links[e.link];return s?this.graph.getNodeById(s.origin_id):null},LGraphNode.prototype.getInputOrProperty=function(t){if(!this.inputs||!this.inputs.length)return this.properties?this.properties[t]:null;for(var e=0,s=this.inputs.length;e<s;++e){var o=this.inputs[e];if(t==o.name&&null!=o.link){var n=this.graph.links[o.link];if(n)return n.data}}return this.properties[t]},LGraphNode.prototype.getOutputData=function(t){return!this.outputs||t>=this.outputs.length?null:(0,this.outputs[t]._data)},LGraphNode.prototype.getOutputInfo=function(t){return this.outputs&&t<this.outputs.length?this.outputs[t]:null},LGraphNode.prototype.isOutputConnected=function(t){return!!this.outputs&&t<this.outputs.length&&this.outputs[t].links&&this.outputs[t].links.length},LGraphNode.prototype.isAnyOutputConnected=function(){if(!this.outputs)return!1;for(var t=0;t<this.outputs.length;++t)if(this.outputs[t].links&&this.outputs[t].links.length)return!0;return!1},LGraphNode.prototype.getOutputNodes=function(t){if(!this.outputs||0==this.outputs.length||t>=this.outputs.length)return null;var e=this.outputs[t];if(!e.links||0==e.links.length)return null;for(var s=[],o=0;o<e.links.length;o++){var n=e.links[o],r=this.graph.links[n];if(r){var a=this.graph.getNodeById(r.target_id);a&&s.push(a)}}return s},LGraphNode.prototype.addOnTriggerInput=function(){var t=this.findInputSlot("onTrigger");return -1==t?(this.addInput("onTrigger",LiteGraph.EVENT,{optional:!0,nameLocked:!0}),this.findInputSlot("onTrigger")):t},LGraphNode.prototype.addOnExecutedOutput=function(){var t=this.findOutputSlot("onExecuted");return -1==t?(this.addOutput("onExecuted",LiteGraph.ACTION,{optional:!0,nameLocked:!0}),this.findOutputSlot("onExecuted")):t},LGraphNode.prototype.onAfterExecuteNode=function(t,e){var s=this.findOutputSlot("onExecuted");-1!=s&&this.triggerSlot(s,t,null,e)},LGraphNode.prototype.changeMode=function(t){switch(t){case LiteGraph.ON_EVENT:break;case LiteGraph.ON_TRIGGER:this.addOnTriggerInput(),this.addOnExecutedOutput();break;case LiteGraph.NEVER:case LiteGraph.ALWAYS:case LiteGraph.ON_REQUEST:break;default:return!1}return this.mode=t,!0},LGraphNode.prototype.executePendingActions=function(){if(this._waiting_actions&&this._waiting_actions.length){for(var t=0;t<this._waiting_actions.length;++t){var e=this._waiting_actions[t];this.onAction(e[0],e[1],e[2],e[3],e[4])}this._waiting_actions.length=0}},LGraphNode.prototype.doExecute=function(t,e){e=e||{},this.onExecute&&(e.action_call||(e.action_call=this.id+"_exec_"+Math.floor(9999*Math.random())),this.graph.nodes_executing[this.id]=!0,this.onExecute(t,e),this.graph.nodes_executing[this.id]=!1,this.exec_version=this.graph.iteration,e&&e.action_call&&(this.action_call=e.action_call,this.graph.nodes_executedAction[this.id]=e.action_call)),this.execute_triggered=2,this.onAfterExecuteNode&&this.onAfterExecuteNode(t,e)},LGraphNode.prototype.actionDo=function(t,e,s,o){s=s||{},this.onAction&&(s.action_call||(s.action_call=this.id+"_"+(t||"action")+"_"+Math.floor(9999*Math.random())),this.graph.nodes_actioning[this.id]=t||"actioning",this.onAction(t,e,s,o),this.graph.nodes_actioning[this.id]=!1,s&&s.action_call&&(this.action_call=s.action_call,this.graph.nodes_executedAction[this.id]=s.action_call)),this.action_triggered=2,this.onAfterExecuteNode&&this.onAfterExecuteNode(e,s)},LGraphNode.prototype.trigger=function(t,e,s){if(this.outputs&&this.outputs.length){this.graph&&(this.graph._last_trigger_time=LiteGraph.getTime());for(var o=0;o<this.outputs.length;++o){var n=this.outputs[o];n&&n.type===LiteGraph.EVENT&&(!t||n.name==t)&&this.triggerSlot(o,e,null,s)}}},LGraphNode.prototype.triggerSlot=function(t,e,s,o){if(o=o||{},this.outputs){if(null==t){console.error("slot must be a number");return}t.constructor!==Number&&console.warn("slot must be a number, use node.trigger('name') if you want to use a string");var n=this.outputs[t];if(n){var r=n.links;if(r&&r.length){this.graph&&(this.graph._last_trigger_time=LiteGraph.getTime());for(var a=0;a<r.length;++a){var u=r[a];if(null==s||s==u){var h=this.graph.links[r[a]];if(h){h._last_time=LiteGraph.getTime();var l=this.graph.getNodeById(h.target_id);if(l){var d=l.inputs[h.target_slot];if(l.mode===LiteGraph.ON_TRIGGER)o.action_call||(o.action_call=this.id+"_trigg_"+Math.floor(9999*Math.random())),l.onExecute&&l.doExecute(e,o);else if(l.onAction){o.action_call||(o.action_call=this.id+"_act_"+Math.floor(9999*Math.random()));var d=l.inputs[h.target_slot];LiteGraph.use_deferred_actions&&l.onExecute?(l._waiting_actions||(l._waiting_actions=[]),l._waiting_actions.push([d.name,e,o,h.target_slot])):l.actionDo(d.name,e,o,h.target_slot)}}}}}}}}},LGraphNode.prototype.clearTriggeredSlot=function(t,e){if(this.outputs){var s=this.outputs[t];if(s){var o=s.links;if(o&&o.length)for(var n=0;n<o.length;++n){var r=o[n];if(null==e||e==r){var a=this.graph.links[o[n]];a&&(a._last_time=0)}}}}},LGraphNode.prototype.setSize=function(t){this.size=t,this.onResize&&this.onResize(this.size)},LGraphNode.prototype.addProperty=function(t,e,s,o){var n={name:t,type:s,default_value:e};if(o)for(var r in o)n[r]=o[r];return this.properties_info||(this.properties_info=[]),this.properties_info.push(n),this.properties||(this.properties={}),this.properties[t]=e,n},LGraphNode.prototype.addOutput=function(t,e,s){var o={name:t,type:e,links:null};if(s)for(var n in s)o[n]=s[n];return this.outputs||(this.outputs=[]),this.outputs.push(o),this.onOutputAdded&&this.onOutputAdded(o),LiteGraph.auto_load_slot_types&&LiteGraph.registerNodeAndSlotType(this,e,!0),this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0),o},LGraphNode.prototype.addOutputs=function(t){for(var e=0;e<t.length;++e){var s=t[e],o={name:s[0],type:s[1],link:null};if(t[2])for(var n in s[2])o[n]=s[2][n];this.outputs||(this.outputs=[]),this.outputs.push(o),this.onOutputAdded&&this.onOutputAdded(o),LiteGraph.auto_load_slot_types&&LiteGraph.registerNodeAndSlotType(this,s[1],!0)}this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.removeOutput=function(t){this.disconnectOutput(t),this.outputs.splice(t,1);for(var e=t;e<this.outputs.length;++e)if(this.outputs[e]&&this.outputs[e].links)for(var s=this.outputs[e].links,o=0;o<s.length;++o){var n=this.graph.links[s[o]];n&&(n.origin_slot-=1)}this.setSize(this.computeSize()),this.onOutputRemoved&&this.onOutputRemoved(t),this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.addInput=function(t,e,s){e=e||0;var o={name:t,type:e,link:null};if(s)for(var n in s)o[n]=s[n];return this.inputs||(this.inputs=[]),this.inputs.push(o),this.setSize(this.computeSize()),this.onInputAdded&&this.onInputAdded(o),LiteGraph.registerNodeAndSlotType(this,e),this.setDirtyCanvas(!0,!0),o},LGraphNode.prototype.addInputs=function(t){for(var e=0;e<t.length;++e){var s=t[e],o={name:s[0],type:s[1],link:null};if(t[2])for(var n in s[2])o[n]=s[2][n];this.inputs||(this.inputs=[]),this.inputs.push(o),this.onInputAdded&&this.onInputAdded(o),LiteGraph.registerNodeAndSlotType(this,s[1])}this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.removeInput=function(t){this.disconnectInput(t);for(var e=this.inputs.splice(t,1),s=t;s<this.inputs.length;++s){if(this.inputs[s]){var o=this.graph.links[this.inputs[s].link];o&&(o.target_slot-=1)}}this.setSize(this.computeSize()),this.onInputRemoved&&this.onInputRemoved(t,e[0]),this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.addConnection=function(t,e,s,o){var n={name:t,type:e,pos:s,direction:o,links:null};return this.connections.push(n),n},LGraphNode.prototype.computeSize=function(t){if(this.constructor.size)return this.constructor.size.concat();var e=Math.max(this.inputs?this.inputs.length:1,this.outputs?this.outputs.length:1),s=t||new Float32Array([0,0]);e=Math.max(e,1);var o=LiteGraph.NODE_TEXT_SIZE,n=v(this.title),r=0,a=0;if(this.inputs)for(var u=0,h=this.inputs.length;u<h;++u){var l=this.inputs[u],d=l.label||l.name||"",c=v(d);r<c&&(r=c)}if(this.outputs)for(var u=0,h=this.outputs.length;u<h;++u){var f=this.outputs[u],d=f.label||f.name||"",c=v(d);a<c&&(a=c)}s[0]=Math.max(r+a+10,n),s[0]=Math.max(s[0],LiteGraph.NODE_WIDTH),this.widgets&&this.widgets.length&&(s[0]=Math.max(s[0],1.5*LiteGraph.NODE_WIDTH)),s[1]=(this.constructor.slot_start_y||0)+e*LiteGraph.NODE_SLOT_HEIGHT;var g=0;if(this.widgets&&this.widgets.length){for(var u=0,h=this.widgets.length;u<h;++u)this.widgets[u].computeSize?g+=this.widgets[u].computeSize(s[0])[1]+4:g+=LiteGraph.NODE_WIDGET_HEIGHT+4;g+=8}function v(t){return t?o*t.length*.6:0}return this.widgets_up?s[1]=Math.max(s[1],g):null!=this.widgets_start_y?s[1]=Math.max(s[1],g+this.widgets_start_y):s[1]+=g,this.constructor.min_height&&s[1]<this.constructor.min_height&&(s[1]=this.constructor.min_height),s[1]+=6,s},LGraphNode.prototype.getPropertyInfo=function(t){var e=null;if(this.properties_info){for(var s=0;s<this.properties_info.length;++s)if(this.properties_info[s].name==t){e=this.properties_info[s];break}}return this.constructor["@"+t]&&(e=this.constructor["@"+t]),this.constructor.widgets_info&&this.constructor.widgets_info[t]&&(e=this.constructor.widgets_info[t]),!e&&this.onGetPropertyInfo&&(e=this.onGetPropertyInfo(t)),e||(e={}),e.type||(e.type=typeof this.properties[t]),"combo"==e.widget&&(e.type="enum"),e},LGraphNode.prototype.addWidget=function(t,e,s,o,n){this.widgets||(this.widgets=[]),!n&&o&&o.constructor===Object&&(n=o,o=null),n&&n.constructor===String&&(n={property:n}),o&&o.constructor===String&&(n||(n={}),n.property=o,o=null),o&&o.constructor!==Function&&(console.warn("addWidget: callback must be a function"),o=null);var r={type:t.toLowerCase(),name:e,value:s,callback:o,options:n||{}};if(void 0!==r.options.y&&(r.y=r.options.y),o||r.options.callback||r.options.property||console.warn("LiteGraph addWidget(...) without a callback or property assigned"),"combo"==t&&!r.options.values)throw"LiteGraph addWidget('combo',...) requires to pass values in options: { values:['red','blue'] }";return this.widgets.push(r),this.setSize(this.computeSize()),r},LGraphNode.prototype.addCustomWidget=function(t){return this.widgets||(this.widgets=[]),this.widgets.push(t),t},LGraphNode.prototype.getBounding=function(t,e){t=t||new Float32Array(4);let s=this.pos,o=this.flags.collapsed,n=this.size,r=0,a=1,u=0,h=0;return e&&(a=6+(r=4),h=5+(u=4)),t[0]=s[0]-r,t[1]=s[1]-LiteGraph.NODE_TITLE_HEIGHT-u,t[2]=o?(this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH)+a:n[0]+a,t[3]=o?LiteGraph.NODE_TITLE_HEIGHT+h:n[1]+LiteGraph.NODE_TITLE_HEIGHT+h,this.onBounding&&this.onBounding(t),t},LGraphNode.prototype.isPointInside=function(t,e,s,o){s=s||0;var n=this.graph&&this.graph.isLive()?0:LiteGraph.NODE_TITLE_HEIGHT;if(o&&(n=0),this.flags&&this.flags.collapsed){if(isInsideRectangle(t,e,this.pos[0]-s,this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT-s,(this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH)+2*s,LiteGraph.NODE_TITLE_HEIGHT+2*s))return!0}else if(this.pos[0]-4-s<t&&this.pos[0]+this.size[0]+4+s>t&&this.pos[1]-n-s<e&&this.pos[1]+this.size[1]+s>e)return!0;return!1},LGraphNode.prototype.getSlotInPosition=function(t,e){var s=new Float32Array(2);if(this.inputs)for(var o=0,n=this.inputs.length;o<n;++o){var r=this.inputs[o];if(this.getConnectionPos(!0,o,s),isInsideRectangle(t,e,s[0]-10,s[1]-5,20,10))return{input:r,slot:o,link_pos:s}}if(this.outputs)for(var o=0,n=this.outputs.length;o<n;++o){var a=this.outputs[o];if(this.getConnectionPos(!1,o,s),isInsideRectangle(t,e,s[0]-10,s[1]-5,20,10))return{output:a,slot:o,link_pos:s}}return null},LGraphNode.prototype.findInputSlot=function(t,e){if(!this.inputs)return -1;for(var s=0,o=this.inputs.length;s<o;++s)if(t==this.inputs[s].name)return e?this.inputs[s]:s;return -1},LGraphNode.prototype.findOutputSlot=function(t,e){if(e=e||!1,!this.outputs)return -1;for(var s=0,o=this.outputs.length;s<o;++s)if(t==this.outputs[s].name)return e?this.outputs[s]:s;return -1},LGraphNode.prototype.findInputSlotFree=function(t){var t=t||{},e=Object.assign({returnObj:!1,typesNotAccepted:[]},t);if(!this.inputs)return -1;for(var s=0,o=this.inputs.length;s<o;++s)if(!(this.inputs[s].link&&null!=this.inputs[s].link||e.typesNotAccepted&&e.typesNotAccepted.includes&&e.typesNotAccepted.includes(this.inputs[s].type)))return e.returnObj?this.inputs[s]:s;return -1},LGraphNode.prototype.findOutputSlotFree=function(t){var t=t||{},e=Object.assign({returnObj:!1,typesNotAccepted:[]},t);if(!this.outputs)return -1;for(var s=0,o=this.outputs.length;s<o;++s)if(!(this.outputs[s].links&&null!=this.outputs[s].links||e.typesNotAccepted&&e.typesNotAccepted.includes&&e.typesNotAccepted.includes(this.outputs[s].type)))return e.returnObj?this.outputs[s]:s;return -1},LGraphNode.prototype.findInputSlotByType=function(t,e,s,o){return this.findSlotByType(!0,t,e,s,o)},LGraphNode.prototype.findOutputSlotByType=function(t,e,s,o){return this.findSlotByType(!1,t,e,s,o)},LGraphNode.prototype.findSlotByType=function(t,e,s,o,n){s=s||!1,o=o||!1,n=n||!1;var r=(t=t||!1)?this.inputs:this.outputs;if(!r)return -1;(""==e||"*"==e)&&(e=0);for(var a=0,u=r.length;a<u;++a){var h=(e+"").toLowerCase().split(","),l="0"==r[a].type||"*"==r[a].type?"0":r[a].type;l=(l+"").toLowerCase().split(",");for(var d=0;d<h.length;d++)for(var c=0;c<l.length;c++)if("_event_"==h[d]&&(h[d]=LiteGraph.EVENT),"_event_"==l[d]&&(l[d]=LiteGraph.EVENT),"*"==h[d]&&(h[d]=0),"*"==l[d]&&(l[d]=0),h[d]==l[c]){if(o&&r[a].links&&null!==r[a].links)continue;return s?r[a]:a}}if(o&&!n)for(var a=0,u=r.length;a<u;++a){var h=(e+"").toLowerCase().split(","),l="0"==r[a].type||"*"==r[a].type?"0":r[a].type;l=(l+"").toLowerCase().split(",");for(var d=0;d<h.length;d++)for(var c=0;c<l.length;c++)if("*"==h[d]&&(h[d]=0),"*"==l[d]&&(l[d]=0),h[d]==l[c])return s?r[a]:a}return -1},LGraphNode.prototype.connectByType=function(t,e,s,o){var o=o||{},n=Object.assign({createEventInCase:!0,firstFreeIfOutputGeneralInCase:!0,generalTypeInCase:!0},o);e&&e.constructor===Number&&(e=this.graph.getNodeById(e));var r=e.findInputSlotByType(s,!1,!0);if(r>=0&&null!==r)return this.connect(t,e,r);if(n.createEventInCase&&s==LiteGraph.EVENT)return this.connect(t,e,-1);if(n.generalTypeInCase){var r=e.findInputSlotByType(0,!1,!0,!0);if(r>=0)return this.connect(t,e,r)}if(n.firstFreeIfOutputGeneralInCase&&(0==s||"*"==s||""==s)){var r=e.findInputSlotFree({typesNotAccepted:[LiteGraph.EVENT]});if(r>=0)return this.connect(t,e,r)}return console.debug("no way to connect type: ",s," to targetNODE ",e),null},LGraphNode.prototype.connectByTypeOutput=function(t,e,s,o){var o=o||{},n=Object.assign({createEventInCase:!0,firstFreeIfInputGeneralInCase:!0,generalTypeInCase:!0},o);e&&e.constructor===Number&&(e=this.graph.getNodeById(e));var r=e.findOutputSlotByType(s,!1,!0);if(r>=0&&null!==r)return e.connect(r,this,t);if(n.generalTypeInCase){var r=e.findOutputSlotByType(0,!1,!0,!0);if(r>=0)return e.connect(r,this,t)}if(n.createEventInCase&&s==LiteGraph.EVENT&&LiteGraph.do_add_triggers_slots){var r=e.addOnExecutedOutput();return e.connect(r,this,t)}if(n.firstFreeIfInputGeneralInCase&&(0==s||"*"==s||""==s)){var r=e.findOutputSlotFree({typesNotAccepted:[LiteGraph.EVENT]});if(r>=0)return e.connect(r,this,t)}return console.debug("no way to connect byOUT type: ",s," to sourceNODE ",e),null},LGraphNode.prototype.connect=function(t,e,s){if(s=s||0,!this.graph)return console.log("Connect: Error, node doesn't belong to any graph. Nodes must be added first to a graph before connecting them."),null;if(t.constructor===String){if(-1==(t=this.findOutputSlot(t)))return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+t),null}else if(!this.outputs||t>=this.outputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),null;if(e&&e.constructor===Number&&(e=this.graph.getNodeById(e)),!e)throw"target node is null";if(e==this)return null;if(s.constructor===String){if(-1==(s=e.findInputSlot(s)))return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+s),null}else if(s===LiteGraph.EVENT){if(!LiteGraph.do_add_triggers_slots)return null;e.changeMode(LiteGraph.ON_TRIGGER),s=e.findInputSlot("onTrigger")}else if(!e.inputs||s>=e.inputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),null;var o,n=!1,r=e.inputs[s],a=null,u=this.outputs[t];return this.outputs[t]?(e.onBeforeConnectInput&&(s=e.onBeforeConnectInput(s)),!1!==s&&null!==s&&LiteGraph.isValidConnection(u.type,r.type))?e.onConnectInput&&!1===e.onConnectInput(s,u.type,u,this,t)||this.onConnectOutput&&!1===this.onConnectOutput(t,r.type,r,e,s)?null:(e.inputs[s]&&null!=e.inputs[s].link&&(this.graph.beforeChange(),e.disconnectInput(s,{doProcessChange:!1}),n=!0),null!==u.links&&u.links.length&&u.type===LiteGraph.EVENT&&!LiteGraph.allow_multi_output_for_events&&(this.graph.beforeChange(),this.disconnectOutput(t,!1,{doProcessChange:!1}),n=!0),o=LiteGraph.use_uuids?LiteGraph.uuidv4():++this.graph.last_link_id,a=new LLink(o,r.type||u.type,this.id,t,e.id,s),this.graph.links[a.id]=a,null==u.links&&(u.links=[]),u.links.push(a.id),e.inputs[s].link=a.id,this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,t,!0,a,u),e.onConnectionsChange&&e.onConnectionsChange(LiteGraph.INPUT,s,!0,a,r),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.INPUT,e,s,this,t),this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,t,e,s)),this.setDirtyCanvas(!1,!0),this.graph.afterChange(),this.graph.connectionChange(this,a),a):(this.setDirtyCanvas(!1,!0),n&&this.graph.connectionChange(this,a),null):null},LGraphNode.prototype.disconnectOutput=function(t,e){if(t.constructor===String){if(-1==(t=this.findOutputSlot(t)))return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+t),!1}else if(!this.outputs||t>=this.outputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),!1;var s=this.outputs[t];if(!s||!s.links||0==s.links.length)return!1;if(e){if(e.constructor===Number&&(e=this.graph.getNodeById(e)),!e)throw"Target Node not found";for(var o=0,n=s.links.length;o<n;o++){var r=s.links[o],a=this.graph.links[r];if(a.target_id==e.id){s.links.splice(o,1);var u=e.inputs[a.target_slot];u.link=null,delete this.graph.links[r],this.graph&&this.graph._version++,e.onConnectionsChange&&e.onConnectionsChange(LiteGraph.INPUT,a.target_slot,!1,a,u),this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,t,!1,a,s),this.graph&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,t),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,t),this.graph.onNodeConnectionChange(LiteGraph.INPUT,e,a.target_slot));break}}}else{for(var o=0,n=s.links.length;o<n;o++){var r=s.links[o],a=this.graph.links[r];if(a){var e=this.graph.getNodeById(a.target_id),u=null;this.graph&&this.graph._version++,e&&((u=e.inputs[a.target_slot]).link=null,e.onConnectionsChange&&e.onConnectionsChange(LiteGraph.INPUT,a.target_slot,!1,a,u),this.graph&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(LiteGraph.INPUT,e,a.target_slot)),delete this.graph.links[r],this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,t,!1,a,s),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,t),this.graph.onNodeConnectionChange(LiteGraph.INPUT,e,a.target_slot))}}s.links=null}return this.setDirtyCanvas(!1,!0),this.graph.connectionChange(this),!0},LGraphNode.prototype.disconnectInput=function(t){if(t.constructor===String){if(-1==(t=this.findInputSlot(t)))return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+t),!1}else if(!this.inputs||t>=this.inputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),!1;var e=this.inputs[t];if(!e)return!1;var s=this.inputs[t].link;if(null!=s){this.inputs[t].link=null;var o=this.graph.links[s];if(o){var n=this.graph.getNodeById(o.origin_id);if(!n)return!1;var r=n.outputs[o.origin_slot];if(!r||!r.links||0==r.links.length)return!1;for(var a=0,u=r.links.length;a<u;a++)if(r.links[a]==s){r.links.splice(a,1);break}delete this.graph.links[s],this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.INPUT,t,!1,o,e),n.onConnectionsChange&&n.onConnectionsChange(LiteGraph.OUTPUT,a,!1,o,r),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,n,a),this.graph.onNodeConnectionChange(LiteGraph.INPUT,this,t))}}return this.setDirtyCanvas(!1,!0),this.graph&&this.graph.connectionChange(this),!0},LGraphNode.prototype.getConnectionPos=function(t,e,s){s=s||new Float32Array(2);var o=0;t&&this.inputs&&(o=this.inputs.length),!t&&this.outputs&&(o=this.outputs.length);var n=.5*LiteGraph.NODE_SLOT_HEIGHT;if(this.flags.collapsed){var r=this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH;return this.horizontal?(s[0]=this.pos[0]+.5*r,t?s[1]=this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT:s[1]=this.pos[1]):(t?s[0]=this.pos[0]:s[0]=this.pos[0]+r,s[1]=this.pos[1]-.5*LiteGraph.NODE_TITLE_HEIGHT),s}return t&&-1==e?(s[0]=this.pos[0]+.5*LiteGraph.NODE_TITLE_HEIGHT,s[1]=this.pos[1]+.5*LiteGraph.NODE_TITLE_HEIGHT,s):t&&o>e&&this.inputs[e].pos?(s[0]=this.pos[0]+this.inputs[e].pos[0],s[1]=this.pos[1]+this.inputs[e].pos[1],s):!t&&o>e&&this.outputs[e].pos?(s[0]=this.pos[0]+this.outputs[e].pos[0],s[1]=this.pos[1]+this.outputs[e].pos[1],s):this.horizontal?(s[0]=this.pos[0]+(e+.5)*(this.size[0]/o),t?s[1]=this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT:s[1]=this.pos[1]+this.size[1],s):(t?s[0]=this.pos[0]+n:s[0]=this.pos[0]+this.size[0]+1-n,s[1]=this.pos[1]+(e+.7)*LiteGraph.NODE_SLOT_HEIGHT+(this.constructor.slot_start_y||0),s)},LGraphNode.prototype.alignToGrid=function(){this.pos[0]=LiteGraph.CANVAS_GRID_SIZE*Math.round(this.pos[0]/LiteGraph.CANVAS_GRID_SIZE),this.pos[1]=LiteGraph.CANVAS_GRID_SIZE*Math.round(this.pos[1]/LiteGraph.CANVAS_GRID_SIZE)},LGraphNode.prototype.trace=function(t){this.console||(this.console=[]),this.console.push(t),this.console.length>LGraphNode.MAX_CONSOLE&&this.console.shift(),this.graph.onNodeTrace&&this.graph.onNodeTrace(this,t)},LGraphNode.prototype.setDirtyCanvas=function(t,e){this.graph&&this.graph.sendActionToCanvas("setDirty",[t,e])},LGraphNode.prototype.loadImage=function(t){var e=new Image;e.src=LiteGraph.node_images_path+t,e.ready=!1;var s=this;return e.onload=function(){this.ready=!0,s.setDirtyCanvas(!0)},e},LGraphNode.prototype.captureInput=function(t){if(this.graph&&this.graph.list_of_graphcanvas)for(var e=this.graph.list_of_graphcanvas,s=0;s<e.length;++s){var o=e[s];(t||o.node_capturing_input==this)&&(o.node_capturing_input=t?this:null)}},LGraphNode.prototype.collapse=function(t){this.graph._version++,(!1!==this.constructor.collapsable||t)&&(this.flags.collapsed?this.flags.collapsed=!1:this.flags.collapsed=!0,this.setDirtyCanvas(!0,!0))},LGraphNode.prototype.pin=function(t){this.graph._version++,void 0===t?this.flags.pinned=!this.flags.pinned:this.flags.pinned=t},LGraphNode.prototype.localToScreen=function(t,e,s){return[(t+this.pos[0])*s.scale+s.offset[0],(e+this.pos[1])*s.scale+s.offset[1]]},global.LGraphGroup=LiteGraph.LGraphGroup=LGraphGroup,LGraphGroup.prototype._ctor=function(t){this.title=t||"Group",this.font_size=24,this.color=LGraphCanvas.node_colors.pale_blue?LGraphCanvas.node_colors.pale_blue.groupcolor:"#AAA",this._bounding=new Float32Array([10,10,140,80]),this._pos=this._bounding.subarray(0,2),this._size=this._bounding.subarray(2,4),this._nodes=[],this.graph=null,Object.defineProperty(this,"pos",{set:function(t){t&&!(t.length<2)&&(this._pos[0]=t[0],this._pos[1]=t[1])},get:function(){return this._pos},enumerable:!0}),Object.defineProperty(this,"size",{set:function(t){t&&!(t.length<2)&&(this._size[0]=Math.max(140,t[0]),this._size[1]=Math.max(80,t[1]))},get:function(){return this._size},enumerable:!0})},LGraphGroup.prototype.configure=function(t){this.title=t.title,this._bounding.set(t.bounding),this.color=t.color,this.font_size=t.font_size},LGraphGroup.prototype.serialize=function(){var t=this._bounding;return{title:this.title,bounding:[Math.round(t[0]),Math.round(t[1]),Math.round(t[2]),Math.round(t[3])],color:this.color,font_size:this.font_size}},LGraphGroup.prototype.move=function(t,e,s){if(this._pos[0]+=t,this._pos[1]+=e,!s)for(var o=0;o<this._nodes.length;++o){var n=this._nodes[o];n.pos[0]+=t,n.pos[1]+=e}},LGraphGroup.prototype.recomputeInsideNodes=function(){this._nodes.length=0;for(var t=this.graph._nodes,e=new Float32Array(4),s=0;s<t.length;++s){var o=t[s];o.getBounding(e),overlapBounding(this._bounding,e)&&this._nodes.push(o)}},LGraphGroup.prototype.isPointInside=LGraphNode.prototype.isPointInside,LGraphGroup.prototype.setDirtyCanvas=LGraphNode.prototype.setDirtyCanvas,LiteGraph.DragAndScale=DragAndScale,DragAndScale.prototype.bindEvents=function(t){this.last_mouse=new Float32Array(2),this._binded_mouse_callback=this.onMouse.bind(this),LiteGraph.pointerListenerAdd(t,"down",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(t,"move",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(t,"up",this._binded_mouse_callback),t.addEventListener("mousewheel",this._binded_mouse_callback,!1),t.addEventListener("wheel",this._binded_mouse_callback,!1)},DragAndScale.prototype.computeVisibleArea=function(t){if(!this.element){this.visible_area[0]=this.visible_area[1]=this.visible_area[2]=this.visible_area[3]=0;return}var e=this.element.width,s=this.element.height,o=-this.offset[0],n=-this.offset[1];t&&(o+=t[0]/this.scale,n+=t[1]/this.scale,e=t[2],s=t[3]);var r=o+e/this.scale,a=n+s/this.scale;this.visible_area[0]=o,this.visible_area[1]=n,this.visible_area[2]=r-o,this.visible_area[3]=a-n},DragAndScale.prototype.onMouse=function(t){if(this.enabled){var e=this.element,s=e.getBoundingClientRect(),o=t.clientX-s.left,n=t.clientY-s.top;t.canvasx=o,t.canvasy=n,t.dragging=this.dragging;var r=!this.viewport||this.viewport&&o>=this.viewport[0]&&o<this.viewport[0]+this.viewport[2]&&n>=this.viewport[1]&&n<this.viewport[1]+this.viewport[3],a=!1;if(this.onmouse&&(a=this.onmouse(t)),t.type==LiteGraph.pointerevents_method+"down"&&r)this.dragging=!0,LiteGraph.pointerListenerRemove(e,"move",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(document,"move",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(document,"up",this._binded_mouse_callback);else if(t.type==LiteGraph.pointerevents_method+"move"){if(!a){var u=o-this.last_mouse[0],h=n-this.last_mouse[1];this.dragging&&this.mouseDrag(u,h)}}else t.type==LiteGraph.pointerevents_method+"up"?(this.dragging=!1,LiteGraph.pointerListenerRemove(document,"move",this._binded_mouse_callback),LiteGraph.pointerListenerRemove(document,"up",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(e,"move",this._binded_mouse_callback)):r&&("mousewheel"==t.type||"wheel"==t.type||"DOMMouseScroll"==t.type)&&(t.eventType="mousewheel","wheel"==t.type?t.wheel=-t.deltaY:t.wheel=null!=t.wheelDeltaY?t.wheelDeltaY:-60*t.detail,t.delta=t.wheelDelta?t.wheelDelta/40:t.deltaY?-t.deltaY/3:0,this.changeDeltaScale(1+.05*t.delta));if(this.last_mouse[0]=o,this.last_mouse[1]=n,r)return t.preventDefault(),t.stopPropagation(),!1}},DragAndScale.prototype.toCanvasContext=function(t){t.scale(this.scale,this.scale),t.translate(this.offset[0],this.offset[1])},DragAndScale.prototype.convertOffsetToCanvas=function(t){return[(t[0]+this.offset[0])*this.scale,(t[1]+this.offset[1])*this.scale]},DragAndScale.prototype.convertCanvasToOffset=function(t,e){return(e=e||[0,0])[0]=t[0]/this.scale-this.offset[0],e[1]=t[1]/this.scale-this.offset[1],e},DragAndScale.prototype.mouseDrag=function(t,e){this.offset[0]+=t/this.scale,this.offset[1]+=e/this.scale,this.onredraw&&this.onredraw(this)},DragAndScale.prototype.changeScale=function(t,e){if(t<this.min_scale?t=this.min_scale:t>this.max_scale&&(t=this.max_scale),t!=this.scale&&this.element){var s=this.element.getBoundingClientRect();if(s){e=e||[.5*s.width,.5*s.height];var o=this.convertCanvasToOffset(e);this.scale=t,.01>Math.abs(this.scale-1)&&(this.scale=1);var n=this.convertCanvasToOffset(e),r=[n[0]-o[0],n[1]-o[1]];this.offset[0]+=r[0],this.offset[1]+=r[1],this.onredraw&&this.onredraw(this)}}},DragAndScale.prototype.changeDeltaScale=function(t,e){this.changeScale(this.scale*t,e)},DragAndScale.prototype.reset=function(){this.scale=1,this.offset[0]=0,this.offset[1]=0},global.LGraphCanvas=LiteGraph.LGraphCanvas=LGraphCanvas,LGraphCanvas.DEFAULT_BACKGROUND_IMAGE="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAIAAAD/gAIDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQBJREFUeNrs1rEKwjAUhlETUkj3vP9rdmr1Ysammk2w5wdxuLgcMHyptfawuZX4pJSWZTnfnu/lnIe/jNNxHHGNn//HNbbv+4dr6V+11uF527arU7+u63qfa/bnmh8sWLBgwYJlqRf8MEptXPBXJXa37BSl3ixYsGDBMliwFLyCV/DeLIMFCxYsWLBMwSt4Be/NggXLYMGCBUvBK3iNruC9WbBgwYJlsGApeAWv4L1ZBgsWLFiwYJmCV/AK3psFC5bBggULloJX8BpdwXuzYMGCBctgwVLwCl7Be7MMFixYsGDBsu8FH1FaSmExVfAxBa/gvVmwYMGCZbBg/W4vAQYA5tRF9QYlv/QAAAAASUVORK5CYII=",LGraphCanvas.link_type_colors={"-1":LiteGraph.EVENT_LINK_COLOR,number:"#AAA",node:"#DCA"},LGraphCanvas.gradients={},LGraphCanvas.prototype.clear=function(){this.frame=0,this.last_draw_time=0,this.render_time=0,this.fps=0,this.dragging_rectangle=null,this.selected_nodes={},this.selected_group=null,this.visible_nodes=[],this.node_dragged=null,this.node_over=null,this.node_capturing_input=null,this.connecting_node=null,this.highlighted_links={},this.dragging_canvas=!1,this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.dirty_area=null,this.node_in_panel=null,this.node_widget=null,this.last_mouse=[0,0],this.last_mouseclick=0,this.pointer_is_down=!1,this.pointer_is_double=!1,this.visible_area.set([0,0,0,0]),this.onClear&&this.onClear()},LGraphCanvas.prototype.setGraph=function(t,e){if(this.graph!=t){if(e||this.clear(),!t&&this.graph){this.graph.detachCanvas(this);return}t.attachCanvas(this),this._graph_stack&&(this._graph_stack=null),this.setDirty(!0,!0)}},LGraphCanvas.prototype.getTopGraph=function(){return this._graph_stack.length?this._graph_stack[0]:this.graph},LGraphCanvas.prototype.openSubgraph=function(t){if(!t)throw"graph cannot be null";if(this.graph==t)throw"graph cannot be the same";this.clear(),this.graph&&(this._graph_stack||(this._graph_stack=[]),this._graph_stack.push(this.graph)),t.attachCanvas(this),this.checkPanels(),this.setDirty(!0,!0)},LGraphCanvas.prototype.closeSubgraph=function(){if(this._graph_stack&&0!=this._graph_stack.length){var t=this.graph._subgraph_node,e=this._graph_stack.pop();this.selected_nodes={},this.highlighted_links={},e.attachCanvas(this),this.setDirty(!0,!0),t&&(this.centerOnNode(t),this.selectNodes([t])),this.ds.offset=[0,0],this.ds.scale=1}},LGraphCanvas.prototype.getCurrentGraph=function(){return this.graph},LGraphCanvas.prototype.setCanvas=function(t,e){if(t&&t.constructor===String&&!(t=document.getElementById(t)))throw"Error creating LiteGraph canvas: Canvas not found";if(t!==this.canvas){if(t||!this.canvas||e||this.unbindEvents(),this.canvas=t,this.ds.element=t,t){if(t.className+=" lgraphcanvas",t.data=this,t.tabindex="1",this.bgcanvas=null,this.bgcanvas||(this.bgcanvas=document.createElement("canvas"),this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height),null==t.getContext){if("canvas"!=t.localName)throw"Element supplied for LGraphCanvas must be a <canvas> element, you passed a "+t.localName;throw"This browser doesn't support Canvas"}null==(this.ctx=t.getContext("2d"))&&(t.webgl_enabled||console.warn("This canvas seems to be WebGL, enabling WebGL renderer"),this.enableWebGL()),e||this.bindEvents()}}},LGraphCanvas.prototype._doNothing=function t(e){return e.preventDefault(),!1},LGraphCanvas.prototype._doReturnTrue=function t(e){return e.preventDefault(),!0},LGraphCanvas.prototype.bindEvents=function(){if(this._events_binded){console.warn("LGraphCanvas: events already binded");return}var t=this.canvas,e=this.getCanvasWindow().document;this._mousedown_callback=this.processMouseDown.bind(this),this._mousewheel_callback=this.processMouseWheel.bind(this),this._mousemove_callback=this.processMouseMove.bind(this),this._mouseup_callback=this.processMouseUp.bind(this),LiteGraph.pointerListenerAdd(t,"down",this._mousedown_callback,!0),t.addEventListener("mousewheel",this._mousewheel_callback,!1),LiteGraph.pointerListenerAdd(t,"up",this._mouseup_callback,!0),LiteGraph.pointerListenerAdd(t,"move",this._mousemove_callback),t.addEventListener("contextmenu",this._doNothing),t.addEventListener("DOMMouseScroll",this._mousewheel_callback,!1),this._key_callback=this.processKey.bind(this),t.setAttribute("tabindex",1),t.addEventListener("keydown",this._key_callback,!0),e.addEventListener("keyup",this._key_callback,!0),this._ondrop_callback=this.processDrop.bind(this),t.addEventListener("dragover",this._doNothing,!1),t.addEventListener("dragend",this._doNothing,!1),t.addEventListener("drop",this._ondrop_callback,!1),t.addEventListener("dragenter",this._doReturnTrue,!1),this._events_binded=!0},LGraphCanvas.prototype.unbindEvents=function(){if(!this._events_binded){console.warn("LGraphCanvas: no events binded");return}var t=this.getCanvasWindow().document;LiteGraph.pointerListenerRemove(this.canvas,"move",this._mousedown_callback),LiteGraph.pointerListenerRemove(this.canvas,"up",this._mousedown_callback),LiteGraph.pointerListenerRemove(this.canvas,"down",this._mousedown_callback),this.canvas.removeEventListener("mousewheel",this._mousewheel_callback),this.canvas.removeEventListener("DOMMouseScroll",this._mousewheel_callback),this.canvas.removeEventListener("keydown",this._key_callback),t.removeEventListener("keyup",this._key_callback),this.canvas.removeEventListener("contextmenu",this._doNothing),this.canvas.removeEventListener("drop",this._ondrop_callback),this.canvas.removeEventListener("dragenter",this._doReturnTrue),this._mousedown_callback=null,this._mousewheel_callback=null,this._key_callback=null,this._ondrop_callback=null,this._events_binded=!1},LGraphCanvas.getFileExtension=function(t){var e=t.indexOf("?");-1!=e&&(t=t.substr(0,e));var s=t.lastIndexOf(".");return -1==s?"":t.substr(s+1).toLowerCase()},LGraphCanvas.prototype.enableWebGL=function(){if("undefined"==typeof GL)throw"litegl.js must be included to use a WebGL canvas";if("undefined"==typeof enableWebGLCanvas)throw"webglCanvas.js must be included to use this feature";this.gl=this.ctx=enableWebGLCanvas(this.canvas),this.ctx.webgl=!0,this.bgcanvas=this.canvas,this.bgctx=this.gl,this.canvas.webgl_enabled=!0},LGraphCanvas.prototype.setDirty=function(t,e){t&&(this.dirty_canvas=!0),e&&(this.dirty_bgcanvas=!0)},LGraphCanvas.prototype.getCanvasWindow=function(){if(!this.canvas)return window;var t=this.canvas.ownerDocument;return t.defaultView||t.parentWindow},LGraphCanvas.prototype.startRendering=function(){!this.is_rendering&&(this.is_rendering=!0,t.call(this));function t(){this.pause_rendering||this.draw();var e=this.getCanvasWindow();this.is_rendering&&e.requestAnimationFrame(t.bind(this))}},LGraphCanvas.prototype.stopRendering=function(){this.is_rendering=!1},LGraphCanvas.prototype.blockClick=function(){this.block_click=!0,this.last_mouseclick=0},LGraphCanvas.prototype.processMouseDown=function(t){if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){this.adjustMouseEvent(t);var e=this.getCanvasWindow();e.document,LGraphCanvas.active_canvas=this;var s=this,o=t.clientX,n=t.clientY;this.ds.viewport=this.viewport;var r=!this.viewport||this.viewport&&o>=this.viewport[0]&&o<this.viewport[0]+this.viewport[2]&&n>=this.viewport[1]&&n<this.viewport[1]+this.viewport[3];if(this.options.skip_events||(LiteGraph.pointerListenerRemove(this.canvas,"move",this._mousemove_callback),LiteGraph.pointerListenerAdd(e.document,"move",this._mousemove_callback,!0),LiteGraph.pointerListenerAdd(e.document,"up",this._mouseup_callback,!0)),r){var a=this.graph.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes,5),u=!1,h=LiteGraph.getTime(),l=void 0===t.isPrimary||!t.isPrimary,d=h-this.last_mouseclick<300&&l;if(this.mouse[0]=t.clientX,this.mouse[1]=t.clientY,this.graph_mouse[0]=t.canvasX,this.graph_mouse[1]=t.canvasY,this.last_click_position=[this.mouse[0],this.mouse[1]],this.pointer_is_down&&l?this.pointer_is_double=!0:this.pointer_is_double=!1,this.pointer_is_down=!0,this.canvas.focus(),LiteGraph.closeAllContextMenus(e),!this.onMouse||!0!=this.onMouse(t)){if(1!=t.which||this.pointer_is_double){if(2==t.which){if(LiteGraph.middle_click_slot_add_default_node){if(a&&this.allow_interaction&&!u&&!this.read_only&&!this.connecting_node&&!a.flags.collapsed&&!this.live_mode){var c=!1,f=!1,g=!1;if(a.outputs)for(var v=0,$=a.outputs.length;v<$;++v){var m=a.outputs[v],y=a.getConnectionPos(!1,v);if(isInsideRectangle(t.canvasX,t.canvasY,y[0]-15,y[1]-10,30,20)){c=m,f=v,g=!0;break}}if(a.inputs)for(var v=0,$=a.inputs.length;v<$;++v){var x=a.inputs[v],y=a.getConnectionPos(!0,v);if(isInsideRectangle(t.canvasX,t.canvasY,y[0]-15,y[1]-10,30,20)){c=x,f=v,g=!1;break}}if(c&&!1!==f){var _=.5-(f+1)/(g?a.outputs.length:a.inputs.length),b=a.getBounding(),T=[g?b[0]+b[2]:b[0],t.canvasY-80];this.createDefaultNodeForSlot({nodeFrom:g?a:null,slotFrom:g?f:null,nodeTo:g?null:a,slotTo:g?null:f,position:T,nodeType:"AUTO",posAdd:[g?30:-30,-(130*_)],posSizeFix:[g?0:-1,0]})}}}else!u&&this.allow_dragcanvas&&(this.dragging_canvas=!0)}else(3==t.which||this.pointer_is_double)&&this.allow_interaction&&!u&&!this.read_only&&(a&&(Object.keys(this.selected_nodes).length&&(this.selected_nodes[a.id]||t.shiftKey||t.ctrlKey||t.metaKey)?this.selected_nodes[a.id]||this.selectNodes([a],!0):this.selectNodes([a])),this.processContextMenu(a,t))}else{t.ctrlKey&&(this.dragging_rectangle=new Float32Array(4),this.dragging_rectangle[0]=t.canvasX,this.dragging_rectangle[1]=t.canvasY,this.dragging_rectangle[2]=1,this.dragging_rectangle[3]=1,u=!0),LiteGraph.alt_drag_do_clone_nodes&&t.altKey&&a&&this.allow_interaction&&!u&&!this.read_only&&(cloned=a.clone())&&(cloned.pos[0]+=5,cloned.pos[1]+=5,this.graph.add(cloned,!1,{doCalcSize:!1}),a=cloned,u=!0,O||(this.allow_dragnodes&&(this.graph.beforeChange(),this.node_dragged=a),this.selected_nodes[a.id]||this.processNodeSelected(a,t)));var E=!1;if(a&&(this.allow_interaction||a.flags.allow_interaction)&&!u&&!this.read_only){if(this.live_mode||a.flags.pinned||this.bringToFront(a),this.allow_interaction&&!this.connecting_node&&!a.flags.collapsed&&!this.live_mode){if(!u&&!1!==a.resizable&&isInsideRectangle(t.canvasX,t.canvasY,a.pos[0]+a.size[0]-5,a.pos[1]+a.size[1]-5,10,10))this.graph.beforeChange(),this.resizing_node=a,this.canvas.style.cursor="se-resize",u=!0;else{if(a.outputs)for(var v=0,$=a.outputs.length;v<$;++v){var m=a.outputs[v],y=a.getConnectionPos(!1,v);if(isInsideRectangle(t.canvasX,t.canvasY,y[0]-15,y[1]-10,30,20)){this.connecting_node=a,this.connecting_output=m,this.connecting_output.slot_index=v,this.connecting_pos=a.getConnectionPos(!1,v),this.connecting_slot=v,LiteGraph.shift_click_do_break_link_from&&t.shiftKey&&a.disconnectOutput(v),d?a.onOutputDblClick&&a.onOutputDblClick(v,t):a.onOutputClick&&a.onOutputClick(v,t),u=!0;break}}if(a.inputs)for(var v=0,$=a.inputs.length;v<$;++v){var x=a.inputs[v],y=a.getConnectionPos(!0,v);if(isInsideRectangle(t.canvasX,t.canvasY,y[0]-15,y[1]-10,30,20)){if(d?a.onInputDblClick&&a.onInputDblClick(v,t):a.onInputClick&&a.onInputClick(v,t),null!==x.link){var w=this.graph.links[x.link];LiteGraph.click_do_break_link_to&&(a.disconnectInput(v),this.dirty_bgcanvas=!0,u=!0),(this.allow_reconnect_links||t.shiftKey)&&(LiteGraph.click_do_break_link_to||a.disconnectInput(v),this.connecting_node=this.graph._nodes_by_id[w.origin_id],this.connecting_slot=w.origin_slot,this.connecting_output=this.connecting_node.outputs[this.connecting_slot],this.connecting_pos=this.connecting_node.getConnectionPos(!1,this.connecting_slot),this.dirty_bgcanvas=!0,u=!0)}u||(this.connecting_node=a,this.connecting_input=x,this.connecting_input.slot_index=v,this.connecting_pos=a.getConnectionPos(!0,v),this.connecting_slot=v,this.dirty_bgcanvas=!0,u=!0)}}}}if(!u){var O=!1,I=[t.canvasX-a.pos[0],t.canvasY-a.pos[1]],D=this.processNodeWidgets(a,this.graph_mouse,t);if(D&&(O=!0,this.node_widget=[a,D]),this.allow_interaction&&d&&this.selected_nodes[a.id]&&(a.onDblClick&&a.onDblClick(t,I,this),this.processNodeDblClicked(a),O=!0),a.onMouseDown&&a.onMouseDown(t,I,this))O=!0;else{if(a.subgraph&&!a.skip_subgraph_button&&!a.flags.collapsed&&I[0]>a.size[0]-LiteGraph.NODE_TITLE_HEIGHT&&I[1]<0){var s=this;setTimeout(function(){s.openSubgraph(a.subgraph)},10)}this.live_mode&&(E=!0,O=!0)}O?a.is_selected||this.processNodeSelected(a,t):(this.allow_dragnodes&&(this.graph.beforeChange(),this.node_dragged=a),this.processNodeSelected(a,t)),this.dirty_canvas=!0}}else if(!u){if(!this.read_only)for(var v=0;v<this.visible_links.length;++v){var N=this.visible_links[v],C=N._pos;if(C&&!(t.canvasX<C[0]-4)&&!(t.canvasX>C[0]+4)&&!(t.canvasY<C[1]-4)&&!(t.canvasY>C[1]+4)){this.showLinkMenu(N,t),this.over_link_center=null;break}}this.selected_group=this.graph.getGroupOnPos(t.canvasX,t.canvasY),this.selected_group_resizing=!1,this.selected_group&&!this.read_only&&(t.ctrlKey&&(this.dragging_rectangle=null),distance([t.canvasX,t.canvasY],[this.selected_group.pos[0]+this.selected_group.size[0],this.selected_group.pos[1]+this.selected_group.size[1]])*this.ds.scale<10?this.selected_group_resizing=!0:this.selected_group.recomputeInsideNodes()),d&&!this.read_only&&this.allow_searchbox&&(this.showSearchBox(t),t.preventDefault(),t.stopPropagation()),E=!0}!u&&E&&this.allow_dragcanvas&&(this.dragging_canvas=!0)}return this.last_mouse[0]=t.clientX,this.last_mouse[1]=t.clientY,this.last_mouseclick=LiteGraph.getTime(),this.last_mouse_dragging=!0,this.graph.change(),e.document.activeElement&&("input"==e.document.activeElement.nodeName.toLowerCase()||"textarea"==e.document.activeElement.nodeName.toLowerCase())||t.preventDefault(),t.stopPropagation(),this.onMouseDown&&this.onMouseDown(t),!1}}}},LGraphCanvas.prototype.processMouseMove=function(t){if(this.autoresize&&this.resize(),this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){LGraphCanvas.active_canvas=this,this.adjustMouseEvent(t);var e=[t.clientX,t.clientY];this.mouse[0]=e[0],this.mouse[1]=e[1];var s=[e[0]-this.last_mouse[0],e[1]-this.last_mouse[1]];if(this.last_mouse=e,this.graph_mouse[0]=t.canvasX,this.graph_mouse[1]=t.canvasY,this.block_click)return t.preventDefault(),!1;t.dragging=this.last_mouse_dragging,this.node_widget&&(this.processNodeWidgets(this.node_widget[0],this.graph_mouse,t,this.node_widget[1]),this.dirty_canvas=!0);var o=this.graph.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes);if(this.dragging_rectangle)this.dragging_rectangle[2]=t.canvasX-this.dragging_rectangle[0],this.dragging_rectangle[3]=t.canvasY-this.dragging_rectangle[1],this.dirty_canvas=!0;else if(this.selected_group&&!this.read_only){if(this.selected_group_resizing)this.selected_group.size=[t.canvasX-this.selected_group.pos[0],t.canvasY-this.selected_group.pos[1]];else{var n=s[0]/this.ds.scale,r=s[1]/this.ds.scale;this.selected_group.move(n,r,t.ctrlKey),this.selected_group._nodes.length&&(this.dirty_canvas=!0)}this.dirty_bgcanvas=!0}else if(this.dragging_canvas)this.ds.offset[0]+=s[0]/this.ds.scale,this.ds.offset[1]+=s[1]/this.ds.scale,this.dirty_canvas=!0,this.dirty_bgcanvas=!0;else if((this.allow_interaction||o&&o.flags.allow_interaction)&&!this.read_only){this.connecting_node&&(this.dirty_canvas=!0);for(var a=0,u=this.graph._nodes.length;a<u;++a)this.graph._nodes[a].mouseOver&&o!=this.graph._nodes[a]&&(this.graph._nodes[a].mouseOver=!1,this.node_over&&this.node_over.onMouseLeave&&this.node_over.onMouseLeave(t),this.node_over=null,this.dirty_canvas=!0);if(o){if(o.redraw_on_mouse&&(this.dirty_canvas=!0),!o.mouseOver&&(o.mouseOver=!0,this.node_over=o,this.dirty_canvas=!0,o.onMouseEnter&&o.onMouseEnter(t)),o.onMouseMove&&o.onMouseMove(t,[t.canvasX-o.pos[0],t.canvasY-o.pos[1]],this),this.connecting_node){if(this.connecting_output){var h=this._highlight_input||[0,0];if(this.isOverNodeBox(o,t.canvasX,t.canvasY));else{var l=this.isOverNodeInput(o,t.canvasX,t.canvasY,h);if(-1!=l&&o.inputs[l]){var d=o.inputs[l].type;LiteGraph.isValidConnection(this.connecting_output.type,d)&&(this._highlight_input=h,this._highlight_input_slot=o.inputs[l])}else this._highlight_input=null,this._highlight_input_slot=null}}else if(this.connecting_input){var h=this._highlight_output||[0,0];if(this.isOverNodeBox(o,t.canvasX,t.canvasY));else{var l=this.isOverNodeOutput(o,t.canvasX,t.canvasY,h);if(-1!=l&&o.outputs[l]){var d=o.outputs[l].type;LiteGraph.isValidConnection(this.connecting_input.type,d)&&(this._highlight_output=h)}else this._highlight_output=null}}}this.canvas&&(isInsideRectangle(t.canvasX,t.canvasY,o.pos[0]+o.size[0]-5,o.pos[1]+o.size[1]-5,5,5)?this.canvas.style.cursor="se-resize":this.canvas.style.cursor="crosshair")}else{for(var c=null,a=0;a<this.visible_links.length;++a){var f=this.visible_links[a],g=f._pos;if(g&&!(t.canvasX<g[0]-4)&&!(t.canvasX>g[0]+4)&&!(t.canvasY<g[1]-4)&&!(t.canvasY>g[1]+4)){c=f;break}}c!=this.over_link_center&&(this.over_link_center=c,this.dirty_canvas=!0),this.canvas&&(this.canvas.style.cursor="")}if(this.node_capturing_input&&this.node_capturing_input!=o&&this.node_capturing_input.onMouseMove&&this.node_capturing_input.onMouseMove(t,[t.canvasX-this.node_capturing_input.pos[0],t.canvasY-this.node_capturing_input.pos[1]],this),this.node_dragged&&!this.live_mode){for(var a in this.selected_nodes){var v=this.selected_nodes[a];v.pos[0]+=s[0]/this.ds.scale,v.pos[1]+=s[1]/this.ds.scale,v.is_selected||this.processNodeSelected(v,t)}this.dirty_canvas=!0,this.dirty_bgcanvas=!0}if(this.resizing_node&&!this.live_mode){var $=[t.canvasX-this.resizing_node.pos[0],t.canvasY-this.resizing_node.pos[1]],m=this.resizing_node.computeSize();$[0]=Math.max(m[0],$[0]),$[1]=Math.max(m[1],$[1]),this.resizing_node.setSize($),this.canvas.style.cursor="se-resize",this.dirty_canvas=!0,this.dirty_bgcanvas=!0}}return t.preventDefault(),!1}},LGraphCanvas.prototype.processMouseUp=function(t){var e=void 0===t.isPrimary||t.isPrimary;if(!e)return!1;if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){var s,o=this.getCanvasWindow().document;LGraphCanvas.active_canvas=this,this.options.skip_events||(LiteGraph.pointerListenerRemove(o,"move",this._mousemove_callback,!0),LiteGraph.pointerListenerAdd(this.canvas,"move",this._mousemove_callback,!0),LiteGraph.pointerListenerRemove(o,"up",this._mouseup_callback,!0)),this.adjustMouseEvent(t);var n=LiteGraph.getTime();if(t.click_time=n-this.last_mouseclick,this.last_mouse_dragging=!1,this.last_click_position=null,this.block_click&&(this.block_click=!1),1==t.which){if(this.node_widget&&this.processNodeWidgets(this.node_widget[0],this.graph_mouse,t),this.node_widget=null,this.selected_group){var r=this.selected_group.pos[0]-Math.round(this.selected_group.pos[0]),a=this.selected_group.pos[1]-Math.round(this.selected_group.pos[1]);this.selected_group.move(r,a,t.ctrlKey),this.selected_group.pos[0]=Math.round(this.selected_group.pos[0]),this.selected_group.pos[1]=Math.round(this.selected_group.pos[1]),this.selected_group._nodes.length&&(this.dirty_canvas=!0),this.selected_group=null}this.selected_group_resizing=!1;var u=this.graph.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes);if(this.dragging_rectangle){if(this.graph){var h=this.graph._nodes,l=new Float32Array(4),d=Math.abs(this.dragging_rectangle[2]),c=Math.abs(this.dragging_rectangle[3]),f=this.dragging_rectangle[2]<0?this.dragging_rectangle[0]-d:this.dragging_rectangle[0],g=this.dragging_rectangle[3]<0?this.dragging_rectangle[1]-c:this.dragging_rectangle[1];if(this.dragging_rectangle[0]=f,this.dragging_rectangle[1]=g,this.dragging_rectangle[2]=d,this.dragging_rectangle[3]=c,!u||d>10&&c>10){for(var v=[],$=0;$<h.length;++$){var m=h[$];m.getBounding(l),overlapBounding(this.dragging_rectangle,l)&&v.push(m)}v.length&&this.selectNodes(v,t.shiftKey)}else this.selectNodes([u],t.shiftKey||t.ctrlKey)}this.dragging_rectangle=null}else if(this.connecting_node){this.dirty_canvas=!0,this.dirty_bgcanvas=!0;var y=(this.connecting_output||this.connecting_input).type;if(u){if(this.connecting_output){var x=this.isOverNodeInput(u,t.canvasX,t.canvasY);-1!=x?this.connecting_node.connect(this.connecting_slot,u,x):this.connecting_node.connectByType(this.connecting_slot,u,y)}else if(this.connecting_input){var x=this.isOverNodeOutput(u,t.canvasX,t.canvasY);-1!=x?u.connect(x,this.connecting_node,this.connecting_slot):this.connecting_node.connectByTypeOutput(this.connecting_slot,u,y)}}else LiteGraph.release_link_on_empty_shows_menu&&(t.shiftKey&&this.allow_searchbox?this.connecting_output?this.showSearchBox(t,{node_from:this.connecting_node,slot_from:this.connecting_output,type_filter_in:this.connecting_output.type}):this.connecting_input&&this.showSearchBox(t,{node_to:this.connecting_node,slot_from:this.connecting_input,type_filter_out:this.connecting_input.type}):this.connecting_output?this.showConnectionMenu({nodeFrom:this.connecting_node,slotFrom:this.connecting_output,e:t}):this.connecting_input&&this.showConnectionMenu({nodeTo:this.connecting_node,slotTo:this.connecting_input,e:t}));this.connecting_output=null,this.connecting_input=null,this.connecting_pos=null,this.connecting_node=null,this.connecting_slot=-1}else if(this.resizing_node)this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.graph.afterChange(this.resizing_node),this.resizing_node=null;else if(this.node_dragged){var u=this.node_dragged;u&&t.click_time<300&&isInsideRectangle(t.canvasX,t.canvasY,u.pos[0],u.pos[1]-LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT)&&u.collapse(),this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.node_dragged.pos[0]=Math.round(this.node_dragged.pos[0]),this.node_dragged.pos[1]=Math.round(this.node_dragged.pos[1]),(this.graph.config.align_to_grid||this.align_to_grid)&&this.node_dragged.alignToGrid(),this.onNodeMoved&&this.onNodeMoved(this.node_dragged),this.graph.afterChange(this.node_dragged),this.node_dragged=null}else{var u=this.graph.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes);!u&&t.click_time<300&&this.deselectAllNodes(),this.dirty_canvas=!0,this.dragging_canvas=!1,this.node_over&&this.node_over.onMouseUp&&this.node_over.onMouseUp(t,[t.canvasX-this.node_over.pos[0],t.canvasY-this.node_over.pos[1]],this),this.node_capturing_input&&this.node_capturing_input.onMouseUp&&this.node_capturing_input.onMouseUp(t,[t.canvasX-this.node_capturing_input.pos[0],t.canvasY-this.node_capturing_input.pos[1]])}}else 2==t.which?(this.dirty_canvas=!0,this.dragging_canvas=!1):3==t.which&&(this.dirty_canvas=!0,this.dragging_canvas=!1);return e&&(this.pointer_is_down=!1,this.pointer_is_double=!1),this.graph.change(),t.stopPropagation(),t.preventDefault(),!1}},LGraphCanvas.prototype.processMouseWheel=function(t){if(this.graph&&this.allow_dragcanvas){var e=null!=t.wheelDeltaY?t.wheelDeltaY:-60*t.detail;this.adjustMouseEvent(t);var s,o=t.clientX,n=t.clientY;if(!this.viewport||this.viewport&&o>=this.viewport[0]&&o<this.viewport[0]+this.viewport[2]&&n>=this.viewport[1]&&n<this.viewport[1]+this.viewport[3]){var r=this.ds.scale;return e>0?r*=1.1:e<0&&(r*=1/1.1),this.ds.changeScale(r,[t.clientX,t.clientY]),this.graph.change(),t.preventDefault(),!1}}},LGraphCanvas.prototype.isOverNodeBox=function(t,e,s){var o=LiteGraph.NODE_TITLE_HEIGHT;return!!isInsideRectangle(e,s,t.pos[0]+2,t.pos[1]+2-o,o-4,o-4)},LGraphCanvas.prototype.isOverNodeInput=function(t,e,s,o){if(t.inputs)for(var n=0,r=t.inputs.length;n<r;++n){t.inputs[n];var a=t.getConnectionPos(!0,n),u=!1;if(u=t.horizontal?isInsideRectangle(e,s,a[0]-5,a[1]-10,10,20):isInsideRectangle(e,s,a[0]-10,a[1]-5,40,10))return o&&(o[0]=a[0],o[1]=a[1]),n}return -1},LGraphCanvas.prototype.isOverNodeOutput=function(t,e,s,o){if(t.outputs)for(var n=0,r=t.outputs.length;n<r;++n){t.outputs[n];var a=t.getConnectionPos(!1,n),u=!1;if(u=t.horizontal?isInsideRectangle(e,s,a[0]-5,a[1]-10,10,20):isInsideRectangle(e,s,a[0]-10,a[1]-5,40,10))return o&&(o[0]=a[0],o[1]=a[1]),n}return -1},LGraphCanvas.prototype.processKey=function(t){if(this.graph){var e=!1;if("input"!=t.target.localName){if("keydown"==t.type){if(32==t.keyCode&&(this.dragging_canvas=!0,e=!0),27==t.keyCode&&(this.node_panel&&this.node_panel.close(),this.options_panel&&this.options_panel.close(),e=!0),65==t.keyCode&&t.ctrlKey&&(this.selectNodes(),e=!0),67===t.keyCode&&(t.metaKey||t.ctrlKey)&&!t.shiftKey&&this.selected_nodes&&(this.copyToClipboard(),e=!0),86===t.keyCode&&(t.metaKey||t.ctrlKey)&&this.pasteFromClipboard(t.shiftKey),(46==t.keyCode||8==t.keyCode)&&"input"!=t.target.localName&&"textarea"!=t.target.localName&&(this.deleteSelectedNodes(),e=!0),this.selected_nodes)for(var s in this.selected_nodes)this.selected_nodes[s].onKeyDown&&this.selected_nodes[s].onKeyDown(t)}else if("keyup"==t.type&&(32==t.keyCode&&(this.dragging_canvas=!1),this.selected_nodes))for(var s in this.selected_nodes)this.selected_nodes[s].onKeyUp&&this.selected_nodes[s].onKeyUp(t);if(this.graph.change(),e)return t.preventDefault(),t.stopImmediatePropagation(),!1}}},LGraphCanvas.prototype.copyToClipboard=function(){var t={nodes:[],links:[]},e=0,s=[];for(var o in this.selected_nodes){var n=this.selected_nodes[o];!1!==n.clonable&&(n._relative_id=e,s.push(n),e+=1)}for(var o=0;o<s.length;++o){var n=s[o];if(!1!==n.clonable){var r=n.clone();if(!r){console.warn("node type not found: "+n.type);continue}if(t.nodes.push(r.serialize()),n.inputs&&n.inputs.length)for(var a=0;a<n.inputs.length;++a){var u=n.inputs[a];if(u&&null!=u.link){var h=this.graph.links[u.link];if(h){var l=this.graph.getNodeById(h.origin_id);l&&t.links.push([l._relative_id,h.origin_slot,n._relative_id,h.target_slot,l.id])}}}}}localStorage.setItem("litegrapheditor_clipboard",JSON.stringify(t))},LGraphCanvas.prototype.pasteFromClipboard=function(t=!1){if(LiteGraph.ctrl_shift_v_paste_connect_unselected_outputs||!t){var e=localStorage.getItem("litegrapheditor_clipboard");if(e){this.graph.beforeChange();for(var s=JSON.parse(e),o=!1,n=!1,r=0;r<s.nodes.length;++r)o?(o[0]>s.nodes[r].pos[0]&&(o[0]=s.nodes[r].pos[0],n[0]=r),o[1]>s.nodes[r].pos[1]&&(o[1]=s.nodes[r].pos[1],n[1]=r)):(o=[s.nodes[r].pos[0],s.nodes[r].pos[1]],n=[r,r]);for(var a=[],r=0;r<s.nodes.length;++r){var u=s.nodes[r],h=LiteGraph.createNode(u.type);h&&(h.configure(u),h.pos[0]+=this.graph_mouse[0]-o[0],h.pos[1]+=this.graph_mouse[1]-o[1],this.graph.add(h,{doProcessChange:!1}),a.push(h))}for(var r=0;r<s.links.length;++r){var l,d=s.links[r],c=d[0];if(null!=c)l=a[c];else if(LiteGraph.ctrl_shift_v_paste_connect_unselected_outputs&&t){var f=d[4];f&&(l=this.graph.getNodeById(f))}var g=a[d[2]];l&&g?l.connect(d[1],g,d[3]):console.warn("Warning, nodes missing on pasting")}this.selectNodes(a),this.graph.afterChange()}}},LGraphCanvas.prototype.processDrop=function(t){t.preventDefault(),this.adjustMouseEvent(t);var e=t.clientX,s=t.clientY;if(!this.viewport||this.viewport&&e>=this.viewport[0]&&e<this.viewport[0]+this.viewport[2]&&s>=this.viewport[1]&&s<this.viewport[1]+this.viewport[3]){var o=[t.canvasX,t.canvasY],n=this.graph?this.graph.getNodeOnPos(o[0],o[1]):null;if(!n){var r=null;this.onDropItem&&(r=this.onDropItem(event)),r||this.checkDropItem(t);return}if(n.onDropFile||n.onDropData){var a=t.dataTransfer.files;if(a&&a.length)for(var u=0;u<a.length;u++){var h=t.dataTransfer.files[0],l=h.name;if(LGraphCanvas.getFileExtension(l),n.onDropFile&&n.onDropFile(h),n.onDropData){var d=new FileReader;d.onload=function(t){var e=t.target.result;n.onDropData(e,l,h)};var c=h.type.split("/")[0];"text"==c||""==c?d.readAsText(h):"image"==c?d.readAsDataURL(h):d.readAsArrayBuffer(h)}}}return!!(n.onDropItem&&n.onDropItem(event))||!!this.onDropItem&&this.onDropItem(event)}},LGraphCanvas.prototype.checkDropItem=function(t){if(t.dataTransfer.files.length){var e=t.dataTransfer.files[0],s=LGraphCanvas.getFileExtension(e.name).toLowerCase(),o=LiteGraph.node_types_by_file_extension[s];if(o){this.graph.beforeChange();var n=LiteGraph.createNode(o.type);n.pos=[t.canvasX,t.canvasY],this.graph.add(n),n.onDropFile&&n.onDropFile(e),this.graph.afterChange()}}},LGraphCanvas.prototype.processNodeDblClicked=function(t){this.onShowNodePanel?this.onShowNodePanel(t):this.showShowNodePanel(t),this.onNodeDblClicked&&this.onNodeDblClicked(t),this.setDirty(!0)},LGraphCanvas.prototype.processNodeSelected=function(t,e){this.selectNode(t,e&&(e.shiftKey||e.ctrlKey||this.multi_select)),this.onNodeSelected&&this.onNodeSelected(t)},LGraphCanvas.prototype.selectNode=function(t,e){null==t?this.deselectAllNodes():this.selectNodes([t],e)},LGraphCanvas.prototype.selectNodes=function(t,e){for(var s in e||this.deselectAllNodes(),"string"==typeof(t=t||this.graph._nodes)&&(t=[t]),t){var o=t[s];if(o.is_selected){this.deselectNode(o);continue}if(!o.is_selected&&o.onSelected&&o.onSelected(),o.is_selected=!0,this.selected_nodes[o.id]=o,o.inputs)for(var n=0;n<o.inputs.length;++n)this.highlighted_links[o.inputs[n].link]=!0;if(o.outputs)for(var n=0;n<o.outputs.length;++n){var r=o.outputs[n];if(r.links)for(var a=0;a<r.links.length;++a)this.highlighted_links[r.links[a]]=!0}}this.onSelectionChange&&this.onSelectionChange(this.selected_nodes),this.setDirty(!0)},LGraphCanvas.prototype.deselectNode=function(t){if(t.is_selected){if(t.onDeselected&&t.onDeselected(),t.is_selected=!1,this.onNodeDeselected&&this.onNodeDeselected(t),t.inputs)for(var e=0;e<t.inputs.length;++e)delete this.highlighted_links[t.inputs[e].link];if(t.outputs)for(var e=0;e<t.outputs.length;++e){var s=t.outputs[e];if(s.links)for(var o=0;o<s.links.length;++o)delete this.highlighted_links[s.links[o]]}}},LGraphCanvas.prototype.deselectAllNodes=function(){if(this.graph){for(var t=this.graph._nodes,e=0,s=t.length;e<s;++e){var o=t[e];o.is_selected&&(o.onDeselected&&o.onDeselected(),o.is_selected=!1,this.onNodeDeselected&&this.onNodeDeselected(o))}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.onSelectionChange&&this.onSelectionChange(this.selected_nodes),this.setDirty(!0)}},LGraphCanvas.prototype.deleteSelectedNodes=function(){for(var t in this.graph.beforeChange(),this.selected_nodes){var e=this.selected_nodes[t];if(!e.block_delete){if(e.inputs&&e.inputs.length&&e.outputs&&e.outputs.length&&LiteGraph.isValidConnection(e.inputs[0].type,e.outputs[0].type)&&e.inputs[0].link&&e.outputs[0].links&&e.outputs[0].links.length){var s=e.graph.links[e.inputs[0].link],o=e.graph.links[e.outputs[0].links[0]],n=e.getInputNode(0),r=e.getOutputNodes(0)[0];n&&r&&n.connect(s.origin_slot,r,o.target_slot)}this.graph.remove(e),this.onNodeDeselected&&this.onNodeDeselected(e)}}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.setDirty(!0),this.graph.afterChange()},LGraphCanvas.prototype.centerOnNode=function(t){this.ds.offset[0]=-t.pos[0]-.5*t.size[0]+.5*this.canvas.width/this.ds.scale,this.ds.offset[1]=-t.pos[1]-.5*t.size[1]+.5*this.canvas.height/this.ds.scale,this.setDirty(!0,!0)},LGraphCanvas.prototype.adjustMouseEvent=function(t){var e=0,s=0;if(this.canvas){var o=this.canvas.getBoundingClientRect();e=t.clientX-o.left,s=t.clientY-o.top}else e=t.clientX,s=t.clientY;this.last_mouse_position[0]=e,this.last_mouse_position[1]=s,t.canvasX=e/this.ds.scale-this.ds.offset[0],t.canvasY=s/this.ds.scale-this.ds.offset[1]},LGraphCanvas.prototype.setZoom=function(t,e){this.ds.changeScale(t,e),this.dirty_canvas=!0,this.dirty_bgcanvas=!0},LGraphCanvas.prototype.convertOffsetToCanvas=function(t,e){return this.ds.convertOffsetToCanvas(t,e)},LGraphCanvas.prototype.convertCanvasToOffset=function(t,e){return this.ds.convertCanvasToOffset(t,e)},LGraphCanvas.prototype.convertEventToCanvasOffset=function(t){var e=this.canvas.getBoundingClientRect();return this.convertCanvasToOffset([t.clientX-e.left,t.clientY-e.top])},LGraphCanvas.prototype.bringToFront=function(t){var e=this.graph._nodes.indexOf(t);-1!=e&&(this.graph._nodes.splice(e,1),this.graph._nodes.push(t))},LGraphCanvas.prototype.sendToBack=function(t){var e=this.graph._nodes.indexOf(t);-1!=e&&(this.graph._nodes.splice(e,1),this.graph._nodes.unshift(t))};var temp=new Float32Array(4);LGraphCanvas.prototype.computeVisibleNodes=function(t,e){var s=e||[];s.length=0,t=t||this.graph._nodes;for(var o=0,n=t.length;o<n;++o){var r=t[o];(!this.live_mode||r.onDrawBackground||r.onDrawForeground)&&overlapBounding(this.visible_area,r.getBounding(temp,!0))&&s.push(r)}return s},LGraphCanvas.prototype.draw=function(t,e){if(this.canvas&&0!=this.canvas.width&&0!=this.canvas.height){var s=LiteGraph.getTime();this.render_time=(s-this.last_draw_time)*.001,this.last_draw_time=s,this.graph&&this.ds.computeVisibleArea(this.viewport),(this.dirty_bgcanvas||e||this.always_render_background||this.graph&&this.graph._last_trigger_time&&s-this.graph._last_trigger_time<1e3)&&this.drawBackCanvas(),(this.dirty_canvas||t)&&this.drawFrontCanvas(),this.fps=this.render_time?1/this.render_time:0,this.frame+=1}},LGraphCanvas.prototype.drawFrontCanvas=function(){this.dirty_canvas=!1,this.ctx||(this.ctx=this.bgcanvas.getContext("2d"));var t=this.ctx;if(t){var e=this.canvas;t.start2D&&!this.viewport&&(t.start2D(),t.restore(),t.setTransform(1,0,0,1,0,0));var s=this.viewport||this.dirty_area;if(s&&(t.save(),t.beginPath(),t.rect(s[0],s[1],s[2],s[3]),t.clip()),this.clear_background&&(s?t.clearRect(s[0],s[1],s[2],s[3]):t.clearRect(0,0,e.width,e.height)),this.bgcanvas==this.canvas?this.drawBackCanvas():t.drawImage(this.bgcanvas,0,0),this.onRender&&this.onRender(e,t),this.show_info&&this.renderInfo(t,s?s[0]:0,s?s[1]:0),this.graph){t.save(),this.ds.toCanvasContext(t);for(var o=0,n=this.computeVisibleNodes(null,this.visible_nodes),r=0;r<n.length;++r){var a=n[r];t.save(),t.translate(a.pos[0],a.pos[1]),this.drawNode(a,t),o+=1,t.restore()}if(this.render_execution_order&&this.drawExecutionOrder(t),this.graph.config.links_ontop&&!this.live_mode&&this.drawConnections(t),null!=this.connecting_pos){t.lineWidth=this.connections_width;var u=null,h=this.connecting_output||this.connecting_input,l=h.type,d=h.dir;null==d&&(d=this.connecting_output?this.connecting_node.horizontal?LiteGraph.DOWN:LiteGraph.RIGHT:this.connecting_node.horizontal?LiteGraph.UP:LiteGraph.LEFT);var c=h.shape;if(u=l===LiteGraph.EVENT?LiteGraph.EVENT_LINK_COLOR:LiteGraph.CONNECTING_LINK_COLOR,this.renderLink(t,this.connecting_pos,[this.graph_mouse[0],this.graph_mouse[1]],null,!1,null,u,d,LiteGraph.CENTER),t.beginPath(),l===LiteGraph.EVENT||c===LiteGraph.BOX_SHAPE?(t.rect(this.connecting_pos[0]-6+.5,this.connecting_pos[1]-5+.5,14,10),t.fill(),t.beginPath(),t.rect(this.graph_mouse[0]-6+.5,this.graph_mouse[1]-5+.5,14,10)):c===LiteGraph.ARROW_SHAPE?(t.moveTo(this.connecting_pos[0]+8,this.connecting_pos[1]+.5),t.lineTo(this.connecting_pos[0]-4,this.connecting_pos[1]+6+.5),t.lineTo(this.connecting_pos[0]-4,this.connecting_pos[1]-6+.5),t.closePath()):(t.arc(this.connecting_pos[0],this.connecting_pos[1],4,0,2*Math.PI),t.fill(),t.beginPath(),t.arc(this.graph_mouse[0],this.graph_mouse[1],4,0,2*Math.PI)),t.fill(),t.fillStyle="#ffcc00",this._highlight_input){t.beginPath();var f=this._highlight_input_slot.shape;f===LiteGraph.ARROW_SHAPE?(t.moveTo(this._highlight_input[0]+8,this._highlight_input[1]+.5),t.lineTo(this._highlight_input[0]-4,this._highlight_input[1]+6+.5),t.lineTo(this._highlight_input[0]-4,this._highlight_input[1]-6+.5),t.closePath()):t.arc(this._highlight_input[0],this._highlight_input[1],6,0,2*Math.PI),t.fill()}this._highlight_output&&(t.beginPath(),f===LiteGraph.ARROW_SHAPE?(t.moveTo(this._highlight_output[0]+8,this._highlight_output[1]+.5),t.lineTo(this._highlight_output[0]-4,this._highlight_output[1]+6+.5),t.lineTo(this._highlight_output[0]-4,this._highlight_output[1]-6+.5),t.closePath()):t.arc(this._highlight_output[0],this._highlight_output[1],6,0,2*Math.PI),t.fill())}this.dragging_rectangle&&(t.strokeStyle="#FFF",t.strokeRect(this.dragging_rectangle[0],this.dragging_rectangle[1],this.dragging_rectangle[2],this.dragging_rectangle[3])),this.over_link_center&&this.render_link_tooltip?this.drawLinkTooltip(t,this.over_link_center):this.onDrawLinkTooltip&&this.onDrawLinkTooltip(t,null),this.onDrawForeground&&this.onDrawForeground(t,this.visible_rect),t.restore()}this._graph_stack&&this._graph_stack.length&&this.drawSubgraphPanel(t),this.onDrawOverlay&&this.onDrawOverlay(t),s&&t.restore(),t.finish2D&&t.finish2D()}},LGraphCanvas.prototype.drawSubgraphPanel=function(t){var e=this.graph,s=e._subgraph_node;if(!s){console.warn("subgraph without subnode");return}this.drawSubgraphPanelLeft(e,s,t),this.drawSubgraphPanelRight(e,s,t)},LGraphCanvas.prototype.drawSubgraphPanelLeft=function(t,e,s){var o=e.inputs?e.inputs.length:0,n=200,r=Math.floor(1.6*LiteGraph.NODE_SLOT_HEIGHT);if(s.fillStyle="#111",s.globalAlpha=.8,s.beginPath(),s.roundRect(10,10,n,(o+1)*r+50,[8]),s.fill(),s.globalAlpha=1,s.fillStyle="#888",s.font="14px Arial",s.textAlign="left",s.fillText("Graph Inputs",20,34),this.drawButton(n-20,20,20,20,"X","#151515")){this.closeSubgraph();return}var a=50;if(s.font="14px Arial",e.inputs)for(var u=0;u<e.inputs.length;++u){var h=e.inputs[u];if(!h.not_subgraph_input){if(this.drawButton(20,a+2,n-20,r-2)){var l=e.constructor.input_node_type||"graph/input";this.graph.beforeChange();var d=LiteGraph.createNode(l);d?(t.add(d),this.block_click=!1,this.last_click_position=null,this.selectNodes([d]),this.node_dragged=d,this.dragging_canvas=!1,d.setProperty("name",h.name),d.setProperty("type",h.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange()):console.error("graph input node not found:",l)}s.fillStyle="#9C9",s.beginPath(),s.arc(n-16,a+.5*r,5,0,2*Math.PI),s.fill(),s.fillStyle="#AAA",s.fillText(h.name,30,a+.75*r),s.fillStyle="#777",s.fillText(h.type,130,a+.75*r),a+=r}}this.drawButton(20,a+2,n-20,r-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialog(e)},LGraphCanvas.prototype.drawSubgraphPanelRight=function(t,e,s){var o=e.outputs?e.outputs.length:0,n=this.bgcanvas.width,r=200,a=Math.floor(1.6*LiteGraph.NODE_SLOT_HEIGHT);s.fillStyle="#111",s.globalAlpha=.8,s.beginPath(),s.roundRect(n-r-10,10,r,(o+1)*a+50,[8]),s.fill(),s.globalAlpha=1,s.fillStyle="#888",s.font="14px Arial",s.textAlign="left";var u="Graph Outputs",h=s.measureText(u).width;if(s.fillText(u,n-h-20,34),this.drawButton(n-r,20,20,20,"X","#151515")){this.closeSubgraph();return}var l=50;if(s.font="14px Arial",e.outputs)for(var d=0;d<e.outputs.length;++d){var c=e.outputs[d];if(!c.not_subgraph_input){if(this.drawButton(n-r,l+2,r-20,a-2)){var f=e.constructor.output_node_type||"graph/output";this.graph.beforeChange();var g=LiteGraph.createNode(f);g?(t.add(g),this.block_click=!1,this.last_click_position=null,this.selectNodes([g]),this.node_dragged=g,this.dragging_canvas=!1,g.setProperty("name",c.name),g.setProperty("type",c.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange()):console.error("graph input node not found:",f)}s.fillStyle="#9C9",s.beginPath(),s.arc(n-r+16,l+.5*a,5,0,2*Math.PI),s.fill(),s.fillStyle="#AAA",s.fillText(c.name,n-r+30,l+.75*a),s.fillStyle="#777",s.fillText(c.type,n-r+130,l+.75*a),l+=a}}this.drawButton(n-r,l+2,r-20,a-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialogRight(e)},LGraphCanvas.prototype.drawButton=function(t,e,s,o,n,r,a,u){var h=this.ctx;r=r||LiteGraph.NODE_DEFAULT_COLOR,a=a||"#555",u=u||LiteGraph.NODE_TEXT_COLOR;var l=this.ds.convertOffsetToCanvas(this.graph_mouse),d=LiteGraph.isInsideRectangle(l[0],l[1],t,e,s,o);if(l=this.last_click_position?[this.last_click_position[0],this.last_click_position[1]]:null){var c=this.canvas.getBoundingClientRect();l[0]-=c.left,l[1]-=c.top}var f=l&&LiteGraph.isInsideRectangle(l[0],l[1],t,e,s,o);h.fillStyle=d?a:r,f&&(h.fillStyle="#AAA"),h.beginPath(),h.roundRect(t,e,s,o,[4]),h.fill(),null!=n&&n.constructor==String&&(h.fillStyle=u,h.textAlign="center",h.font=(.65*o|0)+"px Arial",h.fillText(n,t+.5*s,e+.75*o),h.textAlign="left");var g=f&&!this.block_click;return f&&this.blockClick(),g},LGraphCanvas.prototype.isAreaClicked=function(t,e,s,o,n){var r=this.mouse;LiteGraph.isInsideRectangle(r[0],r[1],t,e,s,o);var a=(r=this.last_click_position)&&LiteGraph.isInsideRectangle(r[0],r[1],t,e,s,o),u=a&&!this.block_click;return a&&n&&this.blockClick(),u},LGraphCanvas.prototype.renderInfo=function(t,e,s){e=e||10,s=s||this.canvas.height-80,t.save(),t.translate(e,s),t.font="10px Arial",t.fillStyle="#888",t.textAlign="left",this.graph?(t.fillText("T: "+this.graph.globaltime.toFixed(2)+"s",5,13),t.fillText("I: "+this.graph.iteration,5,26),t.fillText("N: "+this.graph._nodes.length+" ["+this.visible_nodes.length+"]",5,39),t.fillText("V: "+this.graph._version,5,52),t.fillText("FPS:"+this.fps.toFixed(2),5,65)):t.fillText("No graph selected",5,13),t.restore()},LGraphCanvas.prototype.drawBackCanvas=function(){var t=this.bgcanvas;(t.width!=this.canvas.width||t.height!=this.canvas.height)&&(t.width=this.canvas.width,t.height=this.canvas.height),this.bgctx||(this.bgctx=this.bgcanvas.getContext("2d"));var e=this.bgctx;e.start&&e.start();var s=this.viewport||[0,0,e.canvas.width,e.canvas.height];if(this.clear_background&&e.clearRect(s[0],s[1],s[2],s[3]),this._graph_stack&&this._graph_stack.length){e.save(),this._graph_stack[this._graph_stack.length-1];var o=this.graph._subgraph_node;e.strokeStyle=o.bgcolor,e.lineWidth=10,e.strokeRect(1,1,t.width-2,t.height-2),e.lineWidth=1,e.font="40px Arial",e.textAlign="center",e.fillStyle=o.bgcolor||"#AAA";for(var n="",r=1;r<this._graph_stack.length;++r)n+=this._graph_stack[r]._subgraph_node.getTitle()+" >> ";e.fillText(n+o.getTitle(),.5*t.width,40),e.restore()}var a=!1;if(this.onRenderBackground&&(a=this.onRenderBackground(t,e)),this.viewport||(e.restore(),e.setTransform(1,0,0,1,0,0)),this.visible_links.length=0,this.graph){if(e.save(),this.ds.toCanvasContext(e),this.ds.scale<1.5&&!a&&this.clear_background_color&&(e.fillStyle=this.clear_background_color,e.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3])),this.background_image&&this.ds.scale>.5&&!a){if(this.zoom_modify_alpha?e.globalAlpha=(1-.5/this.ds.scale)*this.editor_alpha:e.globalAlpha=this.editor_alpha,e.imageSmoothingEnabled=e.imageSmoothingEnabled=!1,!this._bg_img||this._bg_img.name!=this.background_image){this._bg_img=new Image,this._bg_img.name=this.background_image,this._bg_img.src=this.background_image;var u=this;this._bg_img.onload=function(){u.draw(!0,!0)}}var h=null;null==this._pattern&&this._bg_img.width>0?(h=e.createPattern(this._bg_img,"repeat"),this._pattern_img=this._bg_img,this._pattern=h):h=this._pattern,h&&(e.fillStyle=h,e.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3]),e.fillStyle="transparent"),e.globalAlpha=1,e.imageSmoothingEnabled=e.imageSmoothingEnabled=!0}this.graph._groups.length&&!this.live_mode&&this.drawGroups(t,e),this.onDrawBackground&&this.onDrawBackground(e,this.visible_area),this.onBackgroundRender&&(console.error("WARNING! onBackgroundRender deprecated, now is named onDrawBackground "),this.onBackgroundRender=null),this.render_canvas_border&&(e.strokeStyle="#235",e.strokeRect(0,0,t.width,t.height)),this.render_connections_shadows?(e.shadowColor="#000",e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=6):e.shadowColor="rgba(0,0,0,0)",this.live_mode||this.drawConnections(e),e.shadowColor="rgba(0,0,0,0)",e.restore()}e.finish&&e.finish(),this.dirty_bgcanvas=!1,this.dirty_canvas=!0};var temp_vec2=new Float32Array(2);LGraphCanvas.prototype.drawNode=function(t,e){var s=!1;this.current_node=t;var o=t.color||t.constructor.color||LiteGraph.NODE_DEFAULT_COLOR,n=t.bgcolor||t.constructor.bgcolor||LiteGraph.NODE_DEFAULT_BGCOLOR;t.mouseOver&&(s=!0);var r=this.ds.scale<.6;if(this.live_mode){!t.flags.collapsed&&(e.shadowColor="transparent",t.onDrawForeground&&t.onDrawForeground(e,this,this.canvas));return}var a=this.editor_alpha;if(e.globalAlpha=a,this.render_shadows&&!r?(e.shadowColor=LiteGraph.DEFAULT_SHADOW_COLOR,e.shadowOffsetX=2*this.ds.scale,e.shadowOffsetY=2*this.ds.scale,e.shadowBlur=3*this.ds.scale):e.shadowColor="transparent",!t.flags.collapsed||!t.onDrawCollapsed||!0!=t.onDrawCollapsed(e,this)){var u=t._shape||LiteGraph.BOX_SHAPE,h=temp_vec2;temp_vec2.set(t.size);var l=t.horizontal;if(t.flags.collapsed){e.font=this.inner_text_font;var d=t.getTitle?t.getTitle():t.title;null!=d&&(t._collapsed_width=Math.min(t.size[0],e.measureText(d).width+2*LiteGraph.NODE_TITLE_HEIGHT),h[0]=t._collapsed_width,h[1]=0)}t.clip_area&&(e.save(),e.beginPath(),u==LiteGraph.BOX_SHAPE?e.rect(0,0,h[0],h[1]):u==LiteGraph.ROUND_SHAPE?e.roundRect(0,0,h[0],h[1],[10]):u==LiteGraph.CIRCLE_SHAPE&&e.arc(.5*h[0],.5*h[1],.5*h[0],0,2*Math.PI),e.clip()),t.has_errors&&(n="red"),this.drawNodeShape(t,e,h,o,n,t.is_selected,t.mouseOver),e.shadowColor="transparent",t.onDrawForeground&&t.onDrawForeground(e,this,this.canvas),e.textAlign=l?"center":"left",e.font=this.inner_text_font;var c=!r,f=this.connecting_output,g=this.connecting_input;e.lineWidth=1;var v=0,$=new Float32Array(2);if(t.flags.collapsed){if(this.render_collapsed_slots){var m=null,y=null;if(t.inputs)for(var x=0;x<t.inputs.length;x++){var _=t.inputs[x];if(null!=_.link){m=_;break}}if(t.outputs)for(var x=0;x<t.outputs.length;x++){var _=t.outputs[x];_.links&&_.links.length&&(y=_)}if(m){var b=0,T=-.5*LiteGraph.NODE_TITLE_HEIGHT;l&&(b=.5*t._collapsed_width,T=-LiteGraph.NODE_TITLE_HEIGHT),e.fillStyle="#686",e.beginPath(),_.type===LiteGraph.EVENT||_.shape===LiteGraph.BOX_SHAPE?e.rect(b-7+.5,T-4,14,8):_.shape===LiteGraph.ARROW_SHAPE?(e.moveTo(b+8,T),e.lineTo(b+-4,T-4),e.lineTo(b+-4,T+4),e.closePath()):e.arc(b,T,4,0,2*Math.PI),e.fill()}if(y){var b=t._collapsed_width,T=-.5*LiteGraph.NODE_TITLE_HEIGHT;l&&(b=.5*t._collapsed_width,T=0),e.fillStyle="#686",e.strokeStyle="black",e.beginPath(),_.type===LiteGraph.EVENT||_.shape===LiteGraph.BOX_SHAPE?e.rect(b-7+.5,T-4,14,8):_.shape===LiteGraph.ARROW_SHAPE?(e.moveTo(b+6,T),e.lineTo(b-6,T-4),e.lineTo(b-6,T+4),e.closePath()):e.arc(b,T,4,0,2*Math.PI),e.fill()}}}else{if(t.inputs)for(var x=0;x<t.inputs.length;x++){var _=t.inputs[x],E=_.type,w=_.shape;e.globalAlpha=a,this.connecting_output&&!LiteGraph.isValidConnection(_.type,f.type)&&(e.globalAlpha=.4*a),e.fillStyle=null!=_.link?_.color_on||this.default_connection_color_byType[E]||this.default_connection_color.input_on:_.color_off||this.default_connection_color_byTypeOff[E]||this.default_connection_color_byType[E]||this.default_connection_color.input_off;var O=t.getConnectionPos(!0,x,$);O[0]-=t.pos[0],O[1]-=t.pos[1],v<O[1]+.5*LiteGraph.NODE_SLOT_HEIGHT&&(v=O[1]+.5*LiteGraph.NODE_SLOT_HEIGHT),e.beginPath(),"array"==E&&(w=LiteGraph.GRID_SHAPE);var I=!0;if(_.type===LiteGraph.EVENT||_.shape===LiteGraph.BOX_SHAPE?l?e.rect(O[0]-5+.5,O[1]-8+.5,10,14):e.rect(O[0]-6+.5,O[1]-5+.5,14,10):w===LiteGraph.ARROW_SHAPE?(e.moveTo(O[0]+8,O[1]+.5),e.lineTo(O[0]-4,O[1]+6+.5),e.lineTo(O[0]-4,O[1]-6+.5),e.closePath()):w===LiteGraph.GRID_SHAPE?(e.rect(O[0]-4,O[1]-4,2,2),e.rect(O[0]-1,O[1]-4,2,2),e.rect(O[0]+2,O[1]-4,2,2),e.rect(O[0]-4,O[1]-1,2,2),e.rect(O[0]-1,O[1]-1,2,2),e.rect(O[0]+2,O[1]-1,2,2),e.rect(O[0]-4,O[1]+2,2,2),e.rect(O[0]-1,O[1]+2,2,2),e.rect(O[0]+2,O[1]+2,2,2),I=!1):r?e.rect(O[0]-4,O[1]-4,8,8):e.arc(O[0],O[1],4,0,2*Math.PI),e.fill(),c){var D=null!=_.label?_.label:_.name;D&&(e.fillStyle=LiteGraph.NODE_TEXT_COLOR,l||_.dir==LiteGraph.UP?e.fillText(D,O[0],O[1]-10):e.fillText(D,O[0]+10,O[1]+5))}}if(e.textAlign=l?"center":"right",e.strokeStyle="black",t.outputs)for(var x=0;x<t.outputs.length;x++){var _=t.outputs[x],E=_.type,w=_.shape;this.connecting_input&&!LiteGraph.isValidConnection(E,g.type)&&(e.globalAlpha=.4*a);var O=t.getConnectionPos(!1,x,$);O[0]-=t.pos[0],O[1]-=t.pos[1],v<O[1]+.5*LiteGraph.NODE_SLOT_HEIGHT&&(v=O[1]+.5*LiteGraph.NODE_SLOT_HEIGHT),e.fillStyle=_.links&&_.links.length?_.color_on||this.default_connection_color_byType[E]||this.default_connection_color.output_on:_.color_off||this.default_connection_color_byTypeOff[E]||this.default_connection_color_byType[E]||this.default_connection_color.output_off,e.beginPath(),"array"==E&&(w=LiteGraph.GRID_SHAPE);var I=!0;if(E===LiteGraph.EVENT||w===LiteGraph.BOX_SHAPE?l?e.rect(O[0]-5+.5,O[1]-8+.5,10,14):e.rect(O[0]-6+.5,O[1]-5+.5,14,10):w===LiteGraph.ARROW_SHAPE?(e.moveTo(O[0]+8,O[1]+.5),e.lineTo(O[0]-4,O[1]+6+.5),e.lineTo(O[0]-4,O[1]-6+.5),e.closePath()):w===LiteGraph.GRID_SHAPE?(e.rect(O[0]-4,O[1]-4,2,2),e.rect(O[0]-1,O[1]-4,2,2),e.rect(O[0]+2,O[1]-4,2,2),e.rect(O[0]-4,O[1]-1,2,2),e.rect(O[0]-1,O[1]-1,2,2),e.rect(O[0]+2,O[1]-1,2,2),e.rect(O[0]-4,O[1]+2,2,2),e.rect(O[0]-1,O[1]+2,2,2),e.rect(O[0]+2,O[1]+2,2,2),I=!1):r?e.rect(O[0]-4,O[1]-4,8,8):e.arc(O[0],O[1],4,0,2*Math.PI),e.fill(),!r&&I&&e.stroke(),c){var D=null!=_.label?_.label:_.name;D&&(e.fillStyle=LiteGraph.NODE_TEXT_COLOR,l||_.dir==LiteGraph.DOWN?e.fillText(D,O[0],O[1]-8):e.fillText(D,O[0]-10,O[1]+5))}}if(e.textAlign="left",e.globalAlpha=1,t.widgets){var N=v;(l||t.widgets_up)&&(N=2),null!=t.widgets_start_y&&(N=t.widgets_start_y),this.drawNodeWidgets(t,N,e,this.node_widget&&this.node_widget[0]==t?this.node_widget[1]:null)}}t.clip_area&&e.restore(),e.globalAlpha=1}},LGraphCanvas.prototype.drawLinkTooltip=function(t,e){var s=e._pos;if(t.fillStyle="black",t.beginPath(),t.arc(s[0],s[1],3,0,2*Math.PI),t.fill(),null!=e.data&&(!this.onDrawLinkTooltip||!0!=this.onDrawLinkTooltip(t,e,this))){var o=e.data,n=null;if(null!=(n=o.constructor===Number?o.toFixed(2):o.constructor===String?'"'+o+'"':o.constructor===Boolean?String(o):o.toToolTip?o.toToolTip():"["+o.constructor.name+"]")){n=n.substr(0,30),t.font="14px Courier New";var r,a=t.measureText(n).width+20,u=24;t.shadowColor="black",t.shadowOffsetX=2,t.shadowOffsetY=2,t.shadowBlur=3,t.fillStyle="#454",t.beginPath(),t.roundRect(s[0]-.5*a,s[1]-15-u,a,u,[3]),t.moveTo(s[0]-10,s[1]-15),t.lineTo(s[0]+10,s[1]-15),t.lineTo(s[0],s[1]-5),t.fill(),t.shadowColor="transparent",t.textAlign="center",t.fillStyle="#CEC",t.fillText(n,s[0],s[1]-15-.3*u)}}};var tmp_area=new Float32Array(4);LGraphCanvas.prototype.drawNodeShape=function(t,e,s,o,n,r,a){e.strokeStyle=o,e.fillStyle=n;var u=LiteGraph.NODE_TITLE_HEIGHT,h=this.ds.scale<.5,l=t._shape||t.constructor.shape||LiteGraph.ROUND_SHAPE,d=t.constructor.title_mode,c=!0;d==LiteGraph.TRANSPARENT_TITLE||d==LiteGraph.NO_TITLE?c=!1:d==LiteGraph.AUTOHIDE_TITLE&&a&&(c=!0);var f=tmp_area;f[0]=0,f[1]=c?-u:0,f[2]=s[0]+1,f[3]=c?s[1]+u:s[1];var g=e.globalAlpha;if(e.beginPath(),l==LiteGraph.BOX_SHAPE||h?e.fillRect(f[0],f[1],f[2],f[3]):l==LiteGraph.ROUND_SHAPE||l==LiteGraph.CARD_SHAPE?e.roundRect(f[0],f[1],f[2],f[3],l==LiteGraph.CARD_SHAPE?[this.round_radius,this.round_radius,0,0]:[this.round_radius]):l==LiteGraph.CIRCLE_SHAPE&&e.arc(.5*s[0],.5*s[1],.5*s[0],0,2*Math.PI),e.fill(),!t.flags.collapsed&&c&&(e.shadowColor="transparent",e.fillStyle="rgba(0,0,0,0.2)",e.fillRect(0,-1,f[2],2)),e.shadowColor="transparent",t.onDrawBackground&&t.onDrawBackground(e,this,this.canvas,this.graph_mouse),c||d==LiteGraph.TRANSPARENT_TITLE){if(t.onDrawTitleBar)t.onDrawTitleBar(e,u,s,this.ds.scale,o);else if(d!=LiteGraph.TRANSPARENT_TITLE&&(t.constructor.title_color||this.render_title_colored)){var v=t.constructor.title_color||o;if(t.flags.collapsed&&(e.shadowColor=LiteGraph.DEFAULT_SHADOW_COLOR),this.use_gradients){var $=LGraphCanvas.gradients[v];$||(($=LGraphCanvas.gradients[v]=e.createLinearGradient(0,0,400,0)).addColorStop(0,v),$.addColorStop(1,"#000")),e.fillStyle=$}else e.fillStyle=v;e.beginPath(),l==LiteGraph.BOX_SHAPE||h?e.rect(0,-u,s[0]+1,u):(l==LiteGraph.ROUND_SHAPE||l==LiteGraph.CARD_SHAPE)&&e.roundRect(0,-u,s[0]+1,u,t.flags.collapsed?[this.round_radius]:[this.round_radius,this.round_radius,0,0]),e.fill(),e.shadowColor="transparent"}var m=!1;LiteGraph.node_box_coloured_by_mode&&LiteGraph.NODE_MODES_COLORS[t.mode]&&(m=LiteGraph.NODE_MODES_COLORS[t.mode]),LiteGraph.node_box_coloured_when_on&&(m=t.action_triggered?"#FFF":t.execute_triggered?"#AAA":m);var y=10;if(t.onDrawTitleBox?t.onDrawTitleBox(e,u,s,this.ds.scale):l==LiteGraph.ROUND_SHAPE||l==LiteGraph.CIRCLE_SHAPE||l==LiteGraph.CARD_SHAPE?(h&&(e.fillStyle="black",e.beginPath(),e.arc(.5*u,-.5*u,.5*y+1,0,2*Math.PI),e.fill()),e.fillStyle=t.boxcolor||m||LiteGraph.NODE_DEFAULT_BOXCOLOR,h?e.fillRect(.5*u-.5*y,-.5*u-.5*y,y,y):(e.beginPath(),e.arc(.5*u,-.5*u,.5*y,0,2*Math.PI),e.fill())):(h&&(e.fillStyle="black",e.fillRect((u-y)*.5-1,-((u+y)*.5)-1,y+2,y+2)),e.fillStyle=t.boxcolor||m||LiteGraph.NODE_DEFAULT_BOXCOLOR,e.fillRect((u-y)*.5,-((u+y)*.5),y,y)),e.globalAlpha=g,t.onDrawTitleText&&t.onDrawTitleText(e,u,s,this.ds.scale,this.title_text_font,r),!h){e.font=this.title_text_font;var x=String(t.getTitle());x&&(r?e.fillStyle=LiteGraph.NODE_SELECTED_TITLE_COLOR:e.fillStyle=t.constructor.title_text_color||this.node_title_color,t.flags.collapsed?(e.textAlign="left",e.measureText(x),e.fillText(x.substr(0,20),u,LiteGraph.NODE_TITLE_TEXT_Y-u),e.textAlign="left"):(e.textAlign="left",e.fillText(x,u,LiteGraph.NODE_TITLE_TEXT_Y-u)))}if(!t.flags.collapsed&&t.subgraph&&!t.skip_subgraph_button){var _=LiteGraph.NODE_TITLE_HEIGHT,b=t.size[0]-_,T=LiteGraph.isInsideRectangle(this.graph_mouse[0]-t.pos[0],this.graph_mouse[1]-t.pos[1],b+2,-_+2,_-4,_-4);e.fillStyle=T?"#888":"#555",l==LiteGraph.BOX_SHAPE||h?e.fillRect(b+2,-_+2,_-4,_-4):(e.beginPath(),e.roundRect(b+2,-_+2,_-4,_-4,[4]),e.fill()),e.fillStyle="#333",e.beginPath(),e.moveTo(b+.2*_,-(.6*_)),e.lineTo(b+.8*_,-(.6*_)),e.lineTo(b+.5*_,-(.3*_)),e.fill()}t.onDrawTitle&&t.onDrawTitle(e)}r&&(t.onBounding&&t.onBounding(f),d==LiteGraph.TRANSPARENT_TITLE&&(f[1]-=u,f[3]+=u),e.lineWidth=1,e.globalAlpha=.8,e.beginPath(),l==LiteGraph.BOX_SHAPE?e.rect(-6+f[0],-6+f[1],12+f[2],12+f[3]):l==LiteGraph.ROUND_SHAPE||l==LiteGraph.CARD_SHAPE&&t.flags.collapsed?e.roundRect(-6+f[0],-6+f[1],12+f[2],12+f[3],[2*this.round_radius]):l==LiteGraph.CARD_SHAPE?e.roundRect(-6+f[0],-6+f[1],12+f[2],12+f[3],[2*this.round_radius,2,2*this.round_radius,2]):l==LiteGraph.CIRCLE_SHAPE&&e.arc(.5*s[0],.5*s[1],.5*s[0]+6,0,2*Math.PI),e.strokeStyle=LiteGraph.NODE_BOX_OUTLINE_COLOR,e.stroke(),e.strokeStyle=o,e.globalAlpha=1),t.execute_triggered>0&&t.execute_triggered--,t.action_triggered>0&&t.action_triggered--};var margin_area=new Float32Array(4),link_bounding=new Float32Array(4),tempA=new Float32Array(2),tempB=new Float32Array(2);function compareObjects(t,e){for(var s in t)if(t[s]!=e[s])return!1;return!0}function distance(t,e){return Math.sqrt((e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1]))}function colorToString(t){return"rgba("+Math.round(255*t[0]).toFixed()+","+Math.round(255*t[1]).toFixed()+","+Math.round(255*t[2]).toFixed()+","+(4==t.length?t[3].toFixed(2):"1.0")+")"}function isInsideRectangle(t,e,s,o,n,r){return!!(s<t)&&!!(s+n>t)&&!!(o<e)&&!!(o+r>e)}function growBounding(t,e,s){e<t[0]?t[0]=e:e>t[2]&&(t[2]=e),s<t[1]?t[1]=s:s>t[3]&&(t[3]=s)}function isInsideBounding(t,e){return!(t[0]<e[0][0])&&!(t[1]<e[0][1])&&!(t[0]>e[1][0])&&!(t[1]>e[1][1])}function overlapBounding(t,e){var s=t[0]+t[2],o=t[1]+t[3],n=e[0]+e[2],r=e[1]+e[3];return!(t[0]>n)&&!(t[1]>r)&&!(s<e[0])&&!(o<e[1])}function hex2num(t){"#"==t.charAt(0)&&(t=t.slice(1)),t=t.toUpperCase();for(var e,s,o="0123456789ABCDEF",n=[,,,],r=0,a=0;a<6;a+=2)e=o.indexOf(t.charAt(a)),s=o.indexOf(t.charAt(a+1)),n[r]=16*e+s,r++;return n}function num2hex(t){for(var e,s,o="0123456789ABCDEF",n="#",r=0;r<3;r++)e=t[r]/16,s=t[r]%16,n+=o.charAt(e)+o.charAt(s);return n}function ContextMenu(t,e){e=e||{},this.options=e;var s=this;e.parentMenu&&(e.parentMenu.constructor!==this.constructor?(console.error("parentMenu must be of class ContextMenu, ignoring it"),e.parentMenu=null):(this.parentMenu=e.parentMenu,this.parentMenu.lock=!0,this.parentMenu.current_submenu=this));var o=null;e.event&&(o=e.event.constructor.name),"MouseEvent"!==o&&"CustomEvent"!==o&&"PointerEvent"!==o&&(console.error("Event passed to ContextMenu is not of type MouseEvent or CustomEvent. Ignoring it. ("+o+")"),e.event=null);var n=document.createElement("div");function r(t){var s=parseInt(n.style.top);return n.style.top=(s+t.deltaY*e.scroll_speed).toFixed()+"px",t.preventDefault(),!0}if(n.className="litegraph litecontextmenu litemenubar-panel",e.className&&(n.className+=" "+e.className),n.style.minWidth=100,n.style.minHeight=100,n.style.pointerEvents="none",setTimeout(function(){n.style.pointerEvents="auto"},100),LiteGraph.pointerListenerAdd(n,"up",function(t){return t.preventDefault(),!0},!0),n.addEventListener("contextmenu",function(t){return 2==t.button&&(t.preventDefault(),!1)},!0),LiteGraph.pointerListenerAdd(n,"down",function(t){if(2==t.button)return s.close(),t.preventDefault(),!0},!0),e.scroll_speed||(e.scroll_speed=.1),n.addEventListener("wheel",r,!0),n.addEventListener("mousewheel",r,!0),this.root=n,e.title){var a=document.createElement("div");a.className="litemenu-title",a.innerHTML=e.title,n.appendChild(a)}for(var u=0,h=0;h<t.length;h++){var l=t.constructor==Array?t[h]:h;null!=l&&l.constructor!==String&&(l=void 0===l.content?String(l):l.content);var d=t[h];this.addItem(l,d,e),u++}LiteGraph.pointerListenerAdd(n,"enter",function(t){n.closing_timer&&clearTimeout(n.closing_timer)});var c=document;e.event&&(c=e.event.target.ownerDocument),c||(c=document),c.fullscreenElement?c.fullscreenElement.appendChild(n):c.body.appendChild(n);var f=e.left||0,g=e.top||0;if(e.event){if(f=e.event.clientX-10,g=e.event.clientY-10,e.title&&(g-=20),e.parentMenu){var v=e.parentMenu.root.getBoundingClientRect();f=v.left+v.width}var $=document.body.getBoundingClientRect(),m=n.getBoundingClientRect();0==$.height&&console.error("document.body height is 0. That is dangerous, set html,body { height: 100%; }"),$.width&&f>$.width-m.width-10&&(f=$.width-m.width-10),$.height&&g>$.height-m.height-10&&(g=$.height-m.height-10)}n.style.left=f+"px",n.style.top=g+"px",e.scale&&(n.style.transform="scale("+e.scale+")")}function CurveEditor(t){this.points=t,this.selected=-1,this.nearest=-1,this.size=null,this.must_update=!0,this.margin=5}function clamp(t,e,s){return e>t?e:s<t?s:t}LGraphCanvas.prototype.drawConnections=function(t){var e=LiteGraph.getTime(),s=this.visible_area;margin_area[0]=s[0]-20,margin_area[1]=s[1]-20,margin_area[2]=s[2]+40,margin_area[3]=s[3]+40,t.lineWidth=this.connections_width,t.fillStyle="#AAA",t.strokeStyle="#AAA",t.globalAlpha=this.editor_alpha;for(var o=this.graph._nodes,n=0,r=o.length;n<r;++n){var a=o[n];if(a.inputs&&a.inputs.length)for(var u=0;u<a.inputs.length;++u){var h=a.inputs[u];if(h&&null!=h.link){var l=h.link,d=this.graph.links[l];if(d){var c=this.graph.getNodeById(d.origin_id);if(null!=c){var f=d.origin_slot,g=null;g=-1==f?[c.pos[0]+10,c.pos[1]+10]:c.getConnectionPos(!1,f,tempA);var v=a.getConnectionPos(!0,u,tempB);if(link_bounding[0]=g[0],link_bounding[1]=g[1],link_bounding[2]=v[0]-g[0],link_bounding[3]=v[1]-g[1],link_bounding[2]<0&&(link_bounding[0]+=link_bounding[2],link_bounding[2]=Math.abs(link_bounding[2])),link_bounding[3]<0&&(link_bounding[1]+=link_bounding[3],link_bounding[3]=Math.abs(link_bounding[3])),overlapBounding(link_bounding,margin_area)){var $=c.outputs[f],m=a.inputs[u];if($&&m){var y=$.dir||(c.horizontal?LiteGraph.DOWN:LiteGraph.RIGHT),x=m.dir||(a.horizontal?LiteGraph.UP:LiteGraph.LEFT);if(this.renderLink(t,g,v,d,!1,0,null,y,x),d&&d._last_time&&e-d._last_time<1e3){var _=2-(e-d._last_time)*.002,b=t.globalAlpha;t.globalAlpha=b*_,this.renderLink(t,g,v,d,!0,_,"white",y,x),t.globalAlpha=b}}}}}}}}t.globalAlpha=1},LGraphCanvas.prototype.renderLink=function(t,e,s,o,n,r,a,u,h,l){o&&this.visible_links.push(o),!a&&o&&(a=o.color||LGraphCanvas.link_type_colors[o.type]),a||(a=this.default_link_color),null!=o&&this.highlighted_links[o.id]&&(a="#FFF"),u=u||LiteGraph.RIGHT,h=h||LiteGraph.LEFT;var d=distance(e,s);this.render_connections_border&&this.ds.scale>.6&&(t.lineWidth=this.connections_width+4),t.lineJoin="round",(l=l||1)>1&&(t.lineWidth=.5),t.beginPath();for(var c=0;c<l;c+=1){var f=(c-(l-1)*.5)*5;if(this.links_render_mode==LiteGraph.SPLINE_LINK){t.moveTo(e[0],e[1]+f);var g=0,v=0,$=0,m=0;switch(u){case LiteGraph.LEFT:g=-.25*d;break;case LiteGraph.RIGHT:g=.25*d;break;case LiteGraph.UP:v=-.25*d;break;case LiteGraph.DOWN:v=.25*d}switch(h){case LiteGraph.LEFT:$=-.25*d;break;case LiteGraph.RIGHT:$=.25*d;break;case LiteGraph.UP:m=-.25*d;break;case LiteGraph.DOWN:m=.25*d}t.bezierCurveTo(e[0]+g,e[1]+v+f,s[0]+$,s[1]+m+f,s[0],s[1]+f)}else if(this.links_render_mode==LiteGraph.LINEAR_LINK){t.moveTo(e[0],e[1]+f);var g=0,v=0,$=0,m=0;switch(u){case LiteGraph.LEFT:g=-1;break;case LiteGraph.RIGHT:g=1;break;case LiteGraph.UP:v=-1;break;case LiteGraph.DOWN:v=1}switch(h){case LiteGraph.LEFT:$=-1;break;case LiteGraph.RIGHT:$=1;break;case LiteGraph.UP:m=-1;break;case LiteGraph.DOWN:m=1}var y=15;t.lineTo(e[0]+g*y,e[1]+v*y+f),t.lineTo(s[0]+$*y,s[1]+m*y+f),t.lineTo(s[0],s[1]+f)}else{if(this.links_render_mode!=LiteGraph.STRAIGHT_LINK)return;t.moveTo(e[0],e[1]);var x=e[0],_=e[1],b=s[0],T=s[1];u==LiteGraph.RIGHT?x+=10:_+=10,h==LiteGraph.LEFT?b-=10:T-=10,t.lineTo(x,_),t.lineTo((x+b)*.5,_),t.lineTo((x+b)*.5,T),t.lineTo(b,T),t.lineTo(s[0],s[1])}}this.render_connections_border&&this.ds.scale>.6&&!n&&(t.strokeStyle="rgba(0,0,0,0.5)",t.stroke()),t.lineWidth=this.connections_width,t.fillStyle=t.strokeStyle=a,t.stroke();var E=this.computeConnectionPoint(e,s,.5,u,h);if(o&&o._pos&&(o._pos[0]=E[0],o._pos[1]=E[1]),this.ds.scale>=.6&&this.highquality_render&&h!=LiteGraph.CENTER){if(this.render_connection_arrows){var w=this.computeConnectionPoint(e,s,.25,u,h),O=this.computeConnectionPoint(e,s,.26,u,h),I=this.computeConnectionPoint(e,s,.75,u,h),D=this.computeConnectionPoint(e,s,.76,u,h),N=0,C=0;this.render_curved_connections?(N=-Math.atan2(O[0]-w[0],O[1]-w[1]),C=-Math.atan2(D[0]-I[0],D[1]-I[1])):C=N=s[1]>e[1]?0:Math.PI,t.save(),t.translate(w[0],w[1]),t.rotate(N),t.beginPath(),t.moveTo(-5,-3),t.lineTo(0,7),t.lineTo(5,-3),t.fill(),t.restore(),t.save(),t.translate(I[0],I[1]),t.rotate(C),t.beginPath(),t.moveTo(-5,-3),t.lineTo(0,7),t.lineTo(5,-3),t.fill(),t.restore()}t.beginPath(),t.arc(E[0],E[1],5,0,2*Math.PI),t.fill()}if(r){t.fillStyle=a;for(var c=0;c<5;++c){var S=(.001*LiteGraph.getTime()+.2*c)%1,E=this.computeConnectionPoint(e,s,S,u,h);t.beginPath(),t.arc(E[0],E[1],5,0,2*Math.PI),t.fill()}}},LGraphCanvas.prototype.computeConnectionPoint=function(t,e,s,o,n){o=o||LiteGraph.RIGHT,n=n||LiteGraph.LEFT;var r=distance(t,e),a=t,u=[t[0],t[1]],h=[e[0],e[1]],l=e;switch(o){case LiteGraph.LEFT:u[0]+=-.25*r;break;case LiteGraph.RIGHT:u[0]+=.25*r;break;case LiteGraph.UP:u[1]+=-.25*r;break;case LiteGraph.DOWN:u[1]+=.25*r}switch(n){case LiteGraph.LEFT:h[0]+=-.25*r;break;case LiteGraph.RIGHT:h[0]+=.25*r;break;case LiteGraph.UP:h[1]+=-.25*r;break;case LiteGraph.DOWN:h[1]+=.25*r}var d,c=(1-s)*(1-s)*(1-s),f=3*((1-s)*(1-s))*s,g=3*(1-s)*(s*s),v=s*s*s;return[c*a[0]+f*u[0]+g*h[0]+v*l[0],c*a[1]+f*u[1]+g*h[1]+v*l[1]]},LGraphCanvas.prototype.drawExecutionOrder=function(t){t.shadowColor="transparent",t.globalAlpha=.25,t.textAlign="center",t.strokeStyle="white",t.globalAlpha=.75;for(var e=this.visible_nodes,s=0;s<e.length;++s){var o=e[s];t.fillStyle="black",t.fillRect(o.pos[0]-LiteGraph.NODE_TITLE_HEIGHT,o.pos[1]-LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT),0==o.order&&t.strokeRect(o.pos[0]-LiteGraph.NODE_TITLE_HEIGHT+.5,o.pos[1]-LiteGraph.NODE_TITLE_HEIGHT+.5,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT),t.fillStyle="#FFF",t.fillText(o.order,o.pos[0]+-.5*LiteGraph.NODE_TITLE_HEIGHT,o.pos[1]-6)}t.globalAlpha=1},LGraphCanvas.prototype.drawNodeWidgets=function(t,e,s,o){if(!t.widgets||!t.widgets.length)return 0;var n=t.size[0],r=t.widgets;e+=2;var a=LiteGraph.NODE_WIDGET_HEIGHT,u=this.ds.scale>.5;s.save(),s.globalAlpha=this.editor_alpha;for(var h=LiteGraph.WIDGET_OUTLINE_COLOR,l=LiteGraph.WIDGET_BGCOLOR,d=LiteGraph.WIDGET_TEXT_COLOR,c=LiteGraph.WIDGET_SECONDARY_TEXT_COLOR,f=15,g=0;g<r.length;++g){var v=r[g],$=e;v.y&&($=v.y),v.last_y=$,s.strokeStyle=h,s.fillStyle="#222",s.textAlign="left",v.disabled&&(s.globalAlpha*=.5);var m=v.width||n;switch(v.type){case"button":v.clicked&&(s.fillStyle="#AAA",v.clicked=!1,this.dirty_canvas=!0),s.fillRect(f,$,m-2*f,a),u&&!v.disabled&&s.strokeRect(f,$,m-2*f,a),u&&(s.textAlign="center",s.fillStyle=d,s.fillText(v.label||v.name,.5*m,$+.7*a));break;case"toggle":if(s.textAlign="left",s.strokeStyle=h,s.fillStyle=l,s.beginPath(),u?s.roundRect(f,$,m-2*f,a,[.5*a]):s.rect(f,$,m-2*f,a),s.fill(),u&&!v.disabled&&s.stroke(),s.fillStyle=v.value?"#89A":"#333",s.beginPath(),s.arc(m-2*f,$+.5*a,.36*a,0,2*Math.PI),s.fill(),u){s.fillStyle=c;let y=v.label||v.name;null!=y&&s.fillText(y,2*f,$+.7*a),s.fillStyle=v.value?d:c,s.textAlign="right",s.fillText(v.value?v.options.on||"true":v.options.off||"false",m-40,$+.7*a)}break;case"slider":s.fillStyle=l,s.fillRect(f,$,m-2*f,a);var x=v.options.max-v.options.min,_=(v.value-v.options.min)/x;if(_<0&&(_=0),_>1&&(_=1),s.fillStyle=v.options.hasOwnProperty("slider_color")?v.options.slider_color:o==v?"#89A":"#678",s.fillRect(f,$,_*(m-2*f),a),u&&!v.disabled&&s.strokeRect(f,$,m-2*f,a),v.marker){var b=(v.marker-v.options.min)/x;b<0&&(b=0),b>1&&(b=1),s.fillStyle=v.options.hasOwnProperty("marker_color")?v.options.marker_color:"#AA9",s.fillRect(f+b*(m-2*f),$,2,a)}u&&(s.textAlign="center",s.fillStyle=d,s.fillText(v.label||v.name+"  "+Number(v.value).toFixed(null!=v.options.precision?v.options.precision:3),.5*m,$+.7*a));break;case"number":case"combo":if(s.textAlign="left",s.strokeStyle=h,s.fillStyle=l,s.beginPath(),u?s.roundRect(f,$,m-2*f,a,[.5*a]):s.rect(f,$,m-2*f,a),s.fill(),u){if(v.disabled||s.stroke(),s.fillStyle=d,v.disabled||(s.beginPath(),s.moveTo(f+16,$+5),s.lineTo(f+6,$+.5*a),s.lineTo(f+16,$+a-5),s.fill(),s.beginPath(),s.moveTo(m-f-16,$+5),s.lineTo(m-f-6,$+.5*a),s.lineTo(m-f-16,$+a-5),s.fill()),s.fillStyle=c,s.fillText(v.label||v.name,2*f+5,$+.7*a),s.fillStyle=d,s.textAlign="right","number"==v.type)s.fillText(Number(v.value).toFixed(void 0!==v.options.precision?v.options.precision:3),m-2*f-20,$+.7*a);else{var T=v.value;if(v.options.values){var E=v.options.values;E.constructor===Function&&(E=E()),E&&E.constructor!==Array&&(T=E[v.value])}s.fillText(T,m-2*f-20,$+.7*a)}}break;case"string":case"text":if(s.textAlign="left",s.strokeStyle=h,s.fillStyle=l,s.beginPath(),u?s.roundRect(f,$,m-2*f,a,[.5*a]):s.rect(f,$,m-2*f,a),s.fill(),u){v.disabled||s.stroke(),s.save(),s.beginPath(),s.rect(f,$,m-2*f,a),s.clip(),s.fillStyle=c;let w=v.label||v.name;null!=w&&s.fillText(w,2*f,$+.7*a),s.fillStyle=d,s.textAlign="right",s.fillText(String(v.value).substr(0,30),m-2*f,$+.7*a),s.restore()}break;default:v.draw&&v.draw(s,t,m,$,a)}e+=(v.computeSize?v.computeSize(m)[1]:a)+4,s.globalAlpha=this.editor_alpha}s.restore(),s.textAlign="left"},LGraphCanvas.prototype.processNodeWidgets=function(node,pos,event,active_widget){if(!node.widgets||!node.widgets.length||!this.allow_interaction&&!node.flags.allow_interaction)return null;for(var x=pos[0]-node.pos[0],y=pos[1]-node.pos[1],width=node.size[0],deltaX=event.deltaX||event.deltax||0,that=this,ref_window=this.getCanvasWindow(),i=0;i<node.widgets.length;++i){var w=node.widgets[i];if(w&&!w.disabled){var widget_height=w.computeSize?w.computeSize(width)[1]:LiteGraph.NODE_WIDGET_HEIGHT,widget_width=w.width||width;if(w==active_widget||!(x<6)&&!(x>widget_width-12)&&!(y<w.last_y)&&!(y>w.last_y+widget_height)&&void 0!==w.last_y){var old_value=w.value;switch(w.type){case"button":event.type===LiteGraph.pointerevents_method+"down"&&(w.callback&&setTimeout(function(){w.callback(w,that,node,pos,event)},20),w.clicked=!0,this.dirty_canvas=!0);break;case"slider":var old_value=w.value,nvalue=clamp((x-15)/(widget_width-30),0,1);if(w.options.read_only)break;w.value=w.options.min+(w.options.max-w.options.min)*nvalue,old_value!=w.value&&setTimeout(function(){inner_value_change(w,w.value)},20),this.dirty_canvas=!0;break;case"number":case"combo":var old_value=w.value;if(event.type==LiteGraph.pointerevents_method+"move"&&"number"==w.type)deltaX&&(w.value+=.1*deltaX*(w.options.step||1)),null!=w.options.min&&w.value<w.options.min&&(w.value=w.options.min),null!=w.options.max&&w.value>w.options.max&&(w.value=w.options.max);else if(event.type==LiteGraph.pointerevents_method+"down"){var values=w.options.values;values&&values.constructor===Function&&(values=w.options.values(w,node));var values_list=null;"number"!=w.type&&(values_list=values.constructor===Array?values:Object.keys(values));var delta=x<40?-1:x>widget_width-40?1:0;if("number"==w.type)w.value+=.1*delta*(w.options.step||1),null!=w.options.min&&w.value<w.options.min&&(w.value=w.options.min),null!=w.options.max&&w.value>w.options.max&&(w.value=w.options.max);else if(delta){var index=-1;this.last_mouseclick=0,(index=values.constructor===Object?values_list.indexOf(String(w.value))+delta:values_list.indexOf(w.value)+delta)>=values_list.length&&(index=values_list.length-1),index<0&&(index=0),values.constructor===Array?w.value=values[index]:w.value=index}else{var text_values=values!=values_list?Object.values(values):values;function inner_clicked(t,e,s){return values!=values_list&&(t=text_values.indexOf(t)),this.value=t,inner_value_change(this,t),that.dirty_canvas=!0,!1}new LiteGraph.ContextMenu(text_values,{scale:Math.max(1,this.ds.scale),event:event,className:"dark",callback:inner_clicked.bind(w)},ref_window)}}else if(event.type==LiteGraph.pointerevents_method+"up"&&"number"==w.type){var delta=x<40?-1:x>widget_width-40?1:0;event.click_time<200&&0==delta&&this.prompt("Value",w.value,(function(v){if(/^[0-9+\-*/()\s]+|\d+\.\d+$/.test(v))try{v=eval(v)}catch(e){}this.value=Number(v),inner_value_change(this,this.value)}).bind(w),event)}old_value!=w.value&&setTimeout((function(){inner_value_change(this,this.value)}).bind(w),20),this.dirty_canvas=!0;break;case"toggle":event.type==LiteGraph.pointerevents_method+"down"&&(w.value=!w.value,setTimeout(function(){inner_value_change(w,w.value)},20));break;case"string":case"text":event.type==LiteGraph.pointerevents_method+"down"&&this.prompt("Value",w.value,(function(t){inner_value_change(this,t)}).bind(w),event,!!w.options&&w.options.multiline);break;default:w.mouse&&(this.dirty_canvas=w.mouse(event,[x,y],node))}return old_value!=w.value&&(node.onWidgetChanged&&node.onWidgetChanged(w.name,w.value,old_value,w),node.graph._version++),w}}}function inner_value_change(t,e){"number"==t.type&&(e=Number(e)),t.value=e,t.options&&t.options.property&&void 0!==node.properties[t.options.property]&&node.setProperty(t.options.property,e),t.callback&&t.callback(t.value,that,node,pos,event)}return null},LGraphCanvas.prototype.drawGroups=function(t,e){if(this.graph){var s=this.graph._groups;e.save(),e.globalAlpha=.5*this.editor_alpha;for(var o=0;o<s.length;++o){var n=s[o];if(overlapBounding(this.visible_area,n._bounding)){e.fillStyle=n.color||"#335",e.strokeStyle=n.color||"#335";var r=n._pos,a=n._size;e.globalAlpha=.25*this.editor_alpha,e.beginPath(),e.rect(r[0]+.5,r[1]+.5,a[0],a[1]),e.fill(),e.globalAlpha=this.editor_alpha,e.stroke(),e.beginPath(),e.moveTo(r[0]+a[0],r[1]+a[1]),e.lineTo(r[0]+a[0]-10,r[1]+a[1]),e.lineTo(r[0]+a[0],r[1]+a[1]-10),e.fill();var u=n.font_size||LiteGraph.DEFAULT_GROUP_FONT_SIZE;e.font=u+"px Arial",e.textAlign="left",e.fillText(n.title,r[0]+4,r[1]+u)}}e.restore()}},LGraphCanvas.prototype.adjustNodesSize=function(){for(var t=this.graph._nodes,e=0;e<t.length;++e)t[e].size=t[e].computeSize();this.setDirty(!0,!0)},LGraphCanvas.prototype.resize=function(t,e){if(!t&&!e){var s=this.canvas.parentNode;t=s.offsetWidth,e=s.offsetHeight}(this.canvas.width!=t||this.canvas.height!=e)&&(this.canvas.width=t,this.canvas.height=e,this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,this.setDirty(!0,!0))},LGraphCanvas.prototype.switchLiveMode=function(t){if(!t){this.live_mode=!this.live_mode,this.dirty_canvas=!0,this.dirty_bgcanvas=!0;return}var e=this,s=this.live_mode?1.1:.9;this.live_mode&&(this.live_mode=!1,this.editor_alpha=.1);var o=setInterval(function(){e.editor_alpha*=s,e.dirty_canvas=!0,e.dirty_bgcanvas=!0,s<1&&e.editor_alpha<.01&&(clearInterval(o),s<1&&(e.live_mode=!0)),s>1&&e.editor_alpha>.99&&(clearInterval(o),e.editor_alpha=1)},1)},LGraphCanvas.prototype.onNodeSelectionChange=function(t){},LGraphCanvas.onGroupAdd=function(t,e,s){var o=LGraphCanvas.active_canvas;o.getCanvasWindow();var n=new LiteGraph.LGraphGroup;n.pos=o.convertEventToCanvasOffset(s),o.graph.add(n)},LGraphCanvas.getBoundaryNodes=function(t){let e=null,s=null,o=null,n=null;for(let r in t){let a=t[r],[u,h]=a.pos,[l,d]=a.size;(null===e||h<e.pos[1])&&(e=a),(null===s||u+l>s.pos[0]+s.size[0])&&(s=a),(null===o||h+d>o.pos[1]+o.size[1])&&(o=a),(null===n||u<n.pos[0])&&(n=a)}return{top:e,right:s,bottom:o,left:n}},LGraphCanvas.prototype.boundaryNodesForSelection=function(){return LGraphCanvas.getBoundaryNodes(Object.values(this.selected_nodes))},LGraphCanvas.alignNodes=function(t,e,s){if(!t)return;let o=LGraphCanvas.active_canvas,n=[];for(let[r,a]of(n=void 0===s?LGraphCanvas.getBoundaryNodes(t):{top:s,right:s,bottom:s,left:s},Object.entries(o.selected_nodes)))switch(e){case"right":a.pos[0]=n.right.pos[0]+n.right.size[0]-a.size[0];break;case"left":a.pos[0]=n.left.pos[0];break;case"top":a.pos[1]=n.top.pos[1];break;case"bottom":a.pos[1]=n.bottom.pos[1]+n.bottom.size[1]-a.size[1]}o.dirty_canvas=!0,o.dirty_bgcanvas=!0},LGraphCanvas.onNodeAlign=function(t,e,s,o,n){new LiteGraph.ContextMenu(["Top","Bottom","Left","Right"],{event:s,callback:r,parentMenu:o});function r(t){LGraphCanvas.alignNodes(LGraphCanvas.active_canvas.selected_nodes,t.toLowerCase(),n)}},LGraphCanvas.onGroupAlign=function(t,e,s,o){new LiteGraph.ContextMenu(["Top","Bottom","Left","Right"],{event:s,callback:n,parentMenu:o});function n(t){LGraphCanvas.alignNodes(LGraphCanvas.active_canvas.selected_nodes,t.toLowerCase())}},LGraphCanvas.onMenuAdd=function(t,e,s,o,n){var r=LGraphCanvas.active_canvas,a=r.getCanvasWindow(),u=r.graph;if(u)return h("",o),!1;function h(t,e){var o=LiteGraph.getNodeTypesCategories(r.filter||u.filter).filter(function(e){return e.startsWith(t)}),l=[];o.map(function(e){if(e){var s,o=RegExp("^("+t+")"),n=e.replace(o,"").split("/")[0],r=""===t?n+"/":t+n+"/",a=n;-1!=a.indexOf("::")&&(a=a.split("::")[1]),-1===l.findIndex(function(t){return t.value===r})&&l.push({value:r,content:a,has_submenu:!0,callback:function(t,e,s,o){h(t.value,o)}})}}),LiteGraph.getNodeTypesInCategory(t.slice(0,-1),r.filter||u.filter).map(function(t){if(!t.skip_list){var e={value:t.type,content:t.title,has_submenu:!1,callback:function(t,e,s,o){var a=o.getFirstEvent();r.graph.beforeChange();var u=LiteGraph.createNode(t.value);u&&(u.pos=r.convertEventToCanvasOffset(a),r.graph.add(u)),n&&n(u),r.graph.afterChange()}};l.push(e)}}),new LiteGraph.ContextMenu(l,{event:s,parentMenu:e},a)}},LGraphCanvas.onMenuCollapseAll=function(){},LGraphCanvas.onMenuNodeEdit=function(){},LGraphCanvas.showMenuNodeOptionalInputs=function(t,e,s,o,n){if(n){var r,a=this,u=LGraphCanvas.active_canvas.getCanvasWindow(),e=n.optional_inputs;n.onGetInputs&&(e=n.onGetInputs());var h=[];if(e)for(var l=0;l<e.length;l++){var d=e[l];if(!d){h.push(null);continue}var c=d[0];d[2]||(d[2]={}),d[2].label&&(c=d[2].label),d[2].removable=!0;var f={content:c,value:d};d[1]==LiteGraph.ACTION&&(f.className="event"),h.push(f)}if(n.onMenuNodeInputs){var g=n.onMenuNodeInputs(h);g&&(h=g)}if(!h.length){console.log("no input entries");return}return new LiteGraph.ContextMenu(h,{event:s,callback:v,parentMenu:o,node:n},u),!1}function v(t,e,s){n&&(t.callback&&t.callback.call(a,n,t,e,s),t.value&&(n.graph.beforeChange(),n.addInput(t.value[0],t.value[1],t.value[2]),n.onNodeInputAdd&&n.onNodeInputAdd(t.value),n.setDirtyCanvas(!0,!0),n.graph.afterChange()))}},LGraphCanvas.showMenuNodeOptionalOutputs=function(t,e,s,o,n){if(n){var r=this,a=LGraphCanvas.active_canvas.getCanvasWindow(),e=n.optional_outputs;n.onGetOutputs&&(e=n.onGetOutputs());var u=[];if(e)for(var h=0;h<e.length;h++){var l=e[h];if(!l){u.push(null);continue}if(!n.flags||!n.flags.skip_repeated_outputs||-1==n.findOutputSlot(l[0])){var d=l[0];l[2]||(l[2]={}),l[2].label&&(d=l[2].label),l[2].removable=!0;var c={content:d,value:l};l[1]==LiteGraph.EVENT&&(c.className="event"),u.push(c)}}if(this.onMenuNodeOutputs&&(u=this.onMenuNodeOutputs(u)),LiteGraph.do_add_triggers_slots&&-1==n.findOutputSlot("onExecuted")&&u.push({content:"On Executed",value:["onExecuted",LiteGraph.EVENT,{nameLocked:!0}],className:"event"}),n.onMenuNodeOutputs){var f=n.onMenuNodeOutputs(u);f&&(u=f)}if(u.length)return new LiteGraph.ContextMenu(u,{event:s,callback:g,parentMenu:o,node:n},a),!1}function g(t,e,s){if(n){if(t.callback&&t.callback.call(r,n,t,e,s),t.value){var a=t.value[1];if(a&&(a.constructor===Object||a.constructor===Array)){var u=[];for(var h in a)u.push({content:h,value:a[h]});return new LiteGraph.ContextMenu(u,{event:e,callback:g,parentMenu:o,node:n}),!1}n.graph.beforeChange(),n.addOutput(t.value[0],t.value[1],t.value[2]),n.onNodeOutputAdd&&n.onNodeOutputAdd(t.value),n.setDirtyCanvas(!0,!0),n.graph.afterChange()}}}},LGraphCanvas.onShowMenuNodeProperties=function(t,e,s,o,n){if(n&&n.properties){var r=LGraphCanvas.active_canvas,a=r.getCanvasWindow(),u=[];for(var h in n.properties){var t=void 0!==n.properties[h]?n.properties[h]:" ";"object"==typeof t&&(t=JSON.stringify(t));var l=n.getPropertyInfo(h);("enum"==l.type||"combo"==l.type)&&(t=LGraphCanvas.getPropertyPrintableValue(t,l.values)),t=LGraphCanvas.decodeHTML(t),u.push({content:"<span class='property_name'>"+(l.label?l.label:h)+"</span><span class='property_value'>"+t+"</span>",value:h})}if(u.length)return new LiteGraph.ContextMenu(u,{event:s,callback:d,parentMenu:o,allow_html:!0,node:n},a),!1}function d(t,e,s,o){if(n){var a=this.getBoundingClientRect();r.showEditPropertyValue(n,t.value,{position:[a.left,a.top]})}}},LGraphCanvas.decodeHTML=function(t){var e=document.createElement("div");return e.innerText=t,e.innerHTML},LGraphCanvas.onMenuResizeNode=function(t,e,s,o,n){if(n){var r=function(t){t.size=t.computeSize(),t.onResize&&t.onResize(t.size)},a=LGraphCanvas.active_canvas;if(!a.selected_nodes||Object.keys(a.selected_nodes).length<=1)r(n);else for(var u in a.selected_nodes)r(a.selected_nodes[u]);n.setDirtyCanvas(!0,!0)}},LGraphCanvas.prototype.showLinkMenu=function(t,e){var s=this,o=s.graph.getNodeById(t.origin_id),n=s.graph.getNodeById(t.target_id),r=!1;o&&o.outputs&&o.outputs[t.origin_slot]&&(r=o.outputs[t.origin_slot].type);var a=!1;n&&n.outputs&&n.outputs[t.target_slot]&&(a=n.inputs[t.target_slot].type);var u=["Add Node",null,"Delete",null],h=new LiteGraph.ContextMenu(u,{event:e,title:null!=t.data?t.data.constructor.name:null,callback:l});function l(e,u,l){switch(e){case"Add Node":LGraphCanvas.onMenuAdd(null,null,l,h,function(e){e.inputs&&e.inputs.length&&e.outputs&&e.outputs.length&&o.connectByType(t.origin_slot,e,r)&&(e.connectByType(t.target_slot,n,a),e.pos[0]-=.5*e.size[0])});break;case"Delete":s.graph.removeLink(t.id)}}return!1},LGraphCanvas.prototype.createDefaultNodeForSlot=function(t){var t=t||{},e=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,position:[],nodeType:null,posAdd:[0,0],posSizeFix:[0,0]},t),s=this,o=e.nodeFrom&&null!==e.slotFrom,n=!o&&e.nodeTo&&null!==e.slotTo;if(!o&&!n)return console.warn("No data passed to createDefaultNodeForSlot "+e.nodeFrom+" "+e.slotFrom+" "+e.nodeTo+" "+e.slotTo),!1;if(!e.nodeType)return console.warn("No type to createDefaultNodeForSlot"),!1;var r=o?e.nodeFrom:e.nodeTo,a=o?e.slotFrom:e.slotTo,u=!1;switch(typeof a){case"string":u=o?r.findOutputSlot(a,!1):r.findInputSlot(a,!1),a=o?r.outputs[a]:r.inputs[a];break;case"object":u=o?r.findOutputSlot(a.name):r.findInputSlot(a.name);break;case"number":u=a,a=o?r.outputs[a]:r.inputs[a];break;default:return console.warn("Cant get slot information "+a),!1}(!1===a||!1===u)&&console.warn("createDefaultNodeForSlot bad slotX "+a+" "+u);var h=a.type==LiteGraph.EVENT?"_event_":a.type,l=o?LiteGraph.slot_types_default_out:LiteGraph.slot_types_default_in;if(l&&l[h]){if(a.link,nodeNewType=!1,"object"==typeof l[h]||"array"==typeof l[h]){for(var d in l[h])if(e.nodeType==l[h][d]||"AUTO"==e.nodeType){nodeNewType=l[h][d];break}}else(e.nodeType==l[h]||"AUTO"==e.nodeType)&&(nodeNewType=l[h]);if(nodeNewType){var c=!1;"object"==typeof nodeNewType&&nodeNewType.node&&(c=nodeNewType,nodeNewType=nodeNewType.node);var f=LiteGraph.createNode(nodeNewType);if(f){if(c){if(c.properties)for(var g in c.properties)f.addProperty(g,c.properties[g]);if(c.inputs)for(var g in f.inputs=[],c.inputs)f.addOutput(c.inputs[g][0],c.inputs[g][1]);if(c.outputs)for(var g in f.outputs=[],c.outputs)f.addOutput(c.outputs[g][0],c.outputs[g][1]);c.title&&(f.title=c.title),c.json&&f.configure(c.json)}return s.graph.add(f),f.pos=[e.position[0]+e.posAdd[0]+(e.posSizeFix[0]?e.posSizeFix[0]*f.size[0]:0),e.position[1]+e.posAdd[1]+(e.posSizeFix[1]?e.posSizeFix[1]*f.size[1]:0)],o?e.nodeFrom.connectByType(u,f,h):e.nodeTo.connectByTypeOutput(u,f,h),!0}console.log("failed creating "+nodeNewType)}}return!1},LGraphCanvas.prototype.showConnectionMenu=function(t){var t=t||{},e=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,e:null},t),s=this,o=e.nodeFrom&&e.slotFrom,n=!o&&e.nodeTo&&e.slotTo;if(!o&&!n)return console.warn("No data passed to showConnectionMenu"),!1;var r=o?e.nodeFrom:e.nodeTo,a=o?e.slotFrom:e.slotTo,u=!1;switch(typeof a){case"string":u=o?r.findOutputSlot(a,!1):r.findInputSlot(a,!1),a=o?r.outputs[a]:r.inputs[a];break;case"object":u=o?r.findOutputSlot(a.name):r.findInputSlot(a.name);break;case"number":u=a,a=o?r.outputs[a]:r.inputs[a];break;default:return console.warn("Cant get slot information "+a),!1}var h=["Add Node",null];s.allow_searchbox&&(h.push("Search"),h.push(null));var l=a.type==LiteGraph.EVENT?"_event_":a.type,d=o?LiteGraph.slot_types_default_out:LiteGraph.slot_types_default_in;if(d&&d[l]){if("object"==typeof d[l]||"array"==typeof d[l])for(var c in d[l])h.push(d[l][c]);else h.push(d[l])}var f=new LiteGraph.ContextMenu(h,{event:e.e,title:(a&&""!=a.name?a.name+(l?" | ":""):"")+(a&&l?l:""),callback:g});function g(t,n,r){switch(t){case"Add Node":LGraphCanvas.onMenuAdd(null,null,r,f,function(t){o?e.nodeFrom.connectByType(u,t,l):e.nodeTo.connectByTypeOutput(u,t,l)});break;case"Search":o?s.showSearchBox(r,{node_from:e.nodeFrom,slot_from:a,type_filter_in:l}):s.showSearchBox(r,{node_to:e.nodeTo,slot_from:a,type_filter_out:l});break;default:s.createDefaultNodeForSlot(Object.assign(e,{position:[e.e.canvasX,e.e.canvasY],nodeType:t}))}}return!1},LGraphCanvas.onShowPropertyEditor=function(t,e,s,o,n){var r=t.property||"title",a=n[r],u=document.createElement("div");u.is_modified=!1,u.className="graphdialog",u.innerHTML="<span class='name'></span><input autofocus type='text' class='value'/><button>OK</button>",u.close=function(){u.parentNode&&u.parentNode.removeChild(u)},u.querySelector(".name").innerText=r;var h=u.querySelector(".value");h&&(h.value=a,h.addEventListener("blur",function(t){this.focus()}),h.addEventListener("keydown",function(t){if(u.is_modified=!0,27==t.keyCode)u.close();else if(13==t.keyCode)v();else if(13!=t.keyCode&&"textarea"!=t.target.localName)return;t.preventDefault(),t.stopPropagation()}));var l=LGraphCanvas.active_canvas.canvas,d=l.getBoundingClientRect(),c=-20,f=-20;d&&(c-=d.left,f-=d.top),event?(u.style.left=event.clientX+c+"px",u.style.top=event.clientY+f+"px"):(u.style.left=.5*l.width+c+"px",u.style.top=.5*l.height+f+"px"),u.querySelector("button").addEventListener("click",v),l.parentNode.appendChild(u),h&&h.focus();var g=null;function v(){h&&$(h.value)}function $(e){"Number"==t.type?e=Number(e):"Boolean"==t.type&&(e=Boolean(e)),n[r]=e,u.parentNode&&u.parentNode.removeChild(u),n.setDirtyCanvas(!0,!0)}u.addEventListener("mouseleave",function(t){LiteGraph.dialog_close_on_mouse_leave&&!u.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(g=setTimeout(u.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),u.addEventListener("mouseenter",function(t){LiteGraph.dialog_close_on_mouse_leave&&g&&clearTimeout(g)})},LGraphCanvas.prototype.prompt=function(t,e,s,o,n){var r=this;t=t||"";var a=document.createElement("div");a.is_modified=!1,a.className="graphdialog rounded",n?a.innerHTML="<span class='name'></span> <textarea autofocus class='value'></textarea><button class='rounded'>OK</button>":a.innerHTML="<span class='name'></span> <input autofocus type='text' class='value'/><button class='rounded'>OK</button>",a.close=function(){r.prompt_box=null,a.parentNode&&a.parentNode.removeChild(a)};var u=LGraphCanvas.active_canvas.canvas;u.parentNode.appendChild(a),this.ds.scale>1&&(a.style.transform="scale("+this.ds.scale+")");var h=null,l=!1;LiteGraph.pointerListenerAdd(a,"leave",function(t){!l&&LiteGraph.dialog_close_on_mouse_leave&&!a.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(h=setTimeout(a.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),LiteGraph.pointerListenerAdd(a,"enter",function(t){LiteGraph.dialog_close_on_mouse_leave&&h&&clearTimeout(h)});var d=a.querySelectorAll("select");d&&d.forEach(function(t){t.addEventListener("click",function(t){l++}),t.addEventListener("blur",function(t){l=0}),t.addEventListener("change",function(t){l=-1})}),r.prompt_box&&r.prompt_box.close(),r.prompt_box=a,a.querySelector(".name").innerText=t;var c=a.querySelector(".value");c.value=e;var f=c;f.addEventListener("keydown",function(t){if(a.is_modified=!0,27==t.keyCode)a.close();else{if(13!=t.keyCode||"textarea"==t.target.localName)return;s&&s(this.value),a.close()}t.preventDefault(),t.stopPropagation()}),a.querySelector("button").addEventListener("click",function(t){s&&s(f.value),r.setDirty(!0),a.close()});var g=u.getBoundingClientRect(),v=-20,$=-20;return g&&(v-=g.left,$-=g.top),o?(a.style.left=o.clientX+v+"px",a.style.top=o.clientY+$+"px"):(a.style.left=.5*u.width+v+"px",a.style.top=.5*u.height+$+"px"),setTimeout(function(){f.focus()},10),a},LGraphCanvas.search_limit=-1,LGraphCanvas.prototype.showSearchBox=function(t,e){e=Object.assign({slot_from:null,node_from:null,node_to:null,do_type_filter:LiteGraph.search_filter_enabled,type_filter_in:!1,type_filter_out:!1,show_general_if_none_on_typefilter:!0,show_general_after_typefiltered:!0,hide_on_mouse_leave:LiteGraph.search_hide_on_mouse_leave,show_all_if_empty:!0,show_all_on_open:LiteGraph.search_show_all_on_open},e||{});var s=this,o=LGraphCanvas.active_canvas,n=o.canvas,r=n.ownerDocument||document,a=document.createElement("div");if(a.className="litegraph litesearchbox graphdialog rounded",a.innerHTML="<span class='name'>Search</span> <input autofocus type='text' class='value rounded'/>",e.do_type_filter&&(a.innerHTML+="<select class='slot_in_type_filter'><option value=''></option></select>",a.innerHTML+="<select class='slot_out_type_filter'><option value=''></option></select>"),a.innerHTML+="<div class='helper'></div>",r.fullscreenElement?r.fullscreenElement.appendChild(a):(r.body.appendChild(a),r.body.style.overflow="hidden"),e.do_type_filter)var u=a.querySelector(".slot_in_type_filter"),h=a.querySelector(".slot_out_type_filter");if(a.close=function(){s.search_box=null,this.blur(),n.focus(),r.body.style.overflow="",setTimeout(function(){s.canvas.focus()},20),a.parentNode&&a.parentNode.removeChild(a)},this.ds.scale>1&&(a.style.transform="scale("+this.ds.scale+")"),e.hide_on_mouse_leave){var l=!1,d=null;LiteGraph.pointerListenerAdd(a,"enter",function(t){d&&(clearTimeout(d),d=null)}),LiteGraph.pointerListenerAdd(a,"leave",function(t){!l&&(d=setTimeout(function(){a.close()},500))}),e.do_type_filter&&(u.addEventListener("click",function(t){l++}),u.addEventListener("blur",function(t){l=0}),u.addEventListener("change",function(t){l=-1}),h.addEventListener("click",function(t){l++}),h.addEventListener("blur",function(t){l=0}),h.addEventListener("change",function(t){l=-1}))}s.search_box&&s.search_box.close(),s.search_box=a;var c=a.querySelector(".helper"),f=null,g=null,v=null,$=a.querySelector("input");if($&&($.addEventListener("blur",function(t){s.search_box&&this.focus()}),$.addEventListener("keydown",function(t){if(38==t.keyCode)O(!1);else if(40==t.keyCode)O(!0);else if(27==t.keyCode)a.close();else if(13==t.keyCode)I(),v?w(v.innerHTML):f?w(f):a.close();else{g&&clearInterval(g),g=setTimeout(I,250);return}return t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),!0})),e.do_type_filter){if(u){var m=LiteGraph.slot_types_in,y=m.length;(e.type_filter_in==LiteGraph.EVENT||e.type_filter_in==LiteGraph.ACTION)&&(e.type_filter_in="_event_");for(var x=0;x<y;x++){var _=document.createElement("option");_.value=m[x],_.innerHTML=m[x],u.appendChild(_),!1!==e.type_filter_in&&(e.type_filter_in+"").toLowerCase()==(m[x]+"").toLowerCase()&&(_.selected=!0)}u.addEventListener("change",function(){I()})}if(h){var m=LiteGraph.slot_types_out,y=m.length;(e.type_filter_out==LiteGraph.EVENT||e.type_filter_out==LiteGraph.ACTION)&&(e.type_filter_out="_event_");for(var x=0;x<y;x++){var _=document.createElement("option");_.value=m[x],_.innerHTML=m[x],h.appendChild(_),!1!==e.type_filter_out&&(e.type_filter_out+"").toLowerCase()==(m[x]+"").toLowerCase()&&(_.selected=!0)}h.addEventListener("change",function(){I()})}}var b=n.getBoundingClientRect(),T=(t?t.clientX:b.left+.5*b.width)-80,E=(t?t.clientY:b.top+.5*b.height)-20;function w(n){if(n){if(s.onSearchBoxSelection)s.onSearchBoxSelection(n,t,o);else{var r=LiteGraph.searchbox_extras[n.toLowerCase()];r&&(n=r.type),o.graph.beforeChange();var u=LiteGraph.createNode(n);if(u&&(u.pos=o.convertEventToCanvasOffset(t),o.graph.add(u,!1)),r&&r.data){if(r.data.properties)for(var h in r.data.properties)u.addProperty(h,r.data.properties[h]);if(r.data.inputs)for(var h in u.inputs=[],r.data.inputs)u.addOutput(r.data.inputs[h][0],r.data.inputs[h][1]);if(r.data.outputs)for(var h in u.outputs=[],r.data.outputs)u.addOutput(r.data.outputs[h][0],r.data.outputs[h][1]);r.data.title&&(u.title=r.data.title),r.data.json&&u.configure(r.data.json)}if(e.node_from){var l=!1;switch(typeof e.slot_from){case"string":l=e.node_from.findOutputSlot(e.slot_from);break;case"object":-1==(l=e.slot_from.name?e.node_from.findOutputSlot(e.slot_from.name):-1)&&void 0!==e.slot_from.slot_index&&(l=e.slot_from.slot_index);break;case"number":l=e.slot_from;break;default:l=0}void 0!==e.node_from.outputs[l]&&!1!==l&&l>-1&&e.node_from.connectByType(l,u,e.node_from.outputs[l].type)}if(e.node_to){var l=!1;switch(typeof e.slot_from){case"string":l=e.node_to.findInputSlot(e.slot_from);break;case"object":-1==(l=e.slot_from.name?e.node_to.findInputSlot(e.slot_from.name):-1)&&void 0!==e.slot_from.slot_index&&(l=e.slot_from.slot_index);break;case"number":l=e.slot_from;break;default:l=0}void 0!==e.node_to.inputs[l]&&!1!==l&&l>-1&&e.node_to.connectByTypeOutput(l,u,e.node_to.inputs[l].type)}o.graph.afterChange()}}a.close()}function O(t){var e=v;v&&v.classList.remove("selected"),v?(v=t?v.nextSibling:v.previousSibling)||(v=e):v=t?c.childNodes[0]:c.childNodes[c.childNodes.length],v&&(v.classList.add("selected"),v.scrollIntoView({block:"end",behavior:"smooth"}))}function I(){g=null;var t=$.value;if(f=null,c.innerHTML="",t||e.show_all_if_empty){if(s.onSearchBox){var n=s.onSearchBox(c,t,o);if(n)for(var r=0;r<n.length;++r)x(n[r])}else{var a=0;t=t.toLowerCase();var u=o.filter||o.graph.filter;if(e.do_type_filter&&s.search_box)var h=s.search_box.querySelector(".slot_in_type_filter"),l=s.search_box.querySelector(".slot_out_type_filter");else var h=!1,l=!1;for(var r in LiteGraph.searchbox_extras){var d=LiteGraph.searchbox_extras[r];if(e.show_all_if_empty&&!t||-1!==d.desc.toLowerCase().indexOf(t)){var v=LiteGraph.registered_node_types[d.type];if((!v||v.filter==u)&&y(d.type)&&(x(d.desc,"searchbox_extra"),-1!==LGraphCanvas.search_limit&&a++>LGraphCanvas.search_limit))break}}var m=null;if(Array.prototype.filter)var m=Object.keys(LiteGraph.registered_node_types).filter(y);else for(var r in m=[],LiteGraph.registered_node_types)y(r)&&m.push(r);for(var r=0;r<m.length&&(x(m[r]),!(-1!==LGraphCanvas.search_limit&&a++>LGraphCanvas.search_limit));r++);if(e.show_general_after_typefiltered&&(h.value||l.value)){for(var r in filtered_extra=[],LiteGraph.registered_node_types)y(r,{inTypeOverride:!!h&&!!h.value&&"*",outTypeOverride:!!l&&!!l.value&&"*"})&&filtered_extra.push(r);for(var r=0;r<filtered_extra.length&&(x(filtered_extra[r],"generic_type"),!(-1!==LGraphCanvas.search_limit&&a++>LGraphCanvas.search_limit));r++);}if((h.value||l.value)&&0==c.childNodes.length&&e.show_general_if_none_on_typefilter){for(var r in filtered_extra=[],LiteGraph.registered_node_types)y(r,{skipFilter:!0})&&filtered_extra.push(r);for(var r=0;r<filtered_extra.length&&(x(filtered_extra[r],"not_in_filter"),!(-1!==LGraphCanvas.search_limit&&a++>LGraphCanvas.search_limit));r++);}function y(s,o){var o=o||{},n=Object.assign({skipFilter:!1,inTypeOverride:!1,outTypeOverride:!1},o),r=LiteGraph.registered_node_types[s];if(u&&r.filter!=u||(!e.show_all_if_empty||t)&&-1===s.toLowerCase().indexOf(t))return!1;if(e.do_type_filter&&!n.skipFilter){var a=s,d=h.value;if(!1!==n.inTypeOverride&&(d=n.inTypeOverride),h&&d&&LiteGraph.registered_slot_in_types[d]&&LiteGraph.registered_slot_in_types[d].nodes){var c=LiteGraph.registered_slot_in_types[d].nodes.includes(a);if(!1===c)return!1}var d=l.value;if(!1!==n.outTypeOverride&&(d=n.outTypeOverride),l&&d&&LiteGraph.registered_slot_out_types[d]&&LiteGraph.registered_slot_out_types[d].nodes){var c=LiteGraph.registered_slot_out_types[d].nodes.includes(a);if(!1===c)return!1}}return!0}}}function x(t,e){var s=document.createElement("div");f||(f=t),s.innerText=t,s.dataset.type=escape(t),s.className="litegraph lite-search-item",e&&(s.className+=" "+e),s.addEventListener("click",function(t){w(unescape(this.dataset.type))}),c.appendChild(s)}}return a.style.left=T+"px",a.style.top=E+"px",t.layerY>b.height-200&&(c.style.maxHeight=b.height-t.layerY-20+"px"),$.focus(),e.show_all_on_open&&I(),a},LGraphCanvas.prototype.showEditPropertyValue=function(t,e,s){if(t&&void 0!==t.properties[e]){s=s||{};var o,n=t.getPropertyInfo(e),r=n.type,a="";if("string"==r||"number"==r||"array"==r||"object"==r)a="<input autofocus type='text' class='value'/>";else if(("enum"==r||"combo"==r)&&n.values){for(var u in a="<select autofocus type='text' class='value'>",n.values){var h=u;n.values.constructor===Array&&(h=n.values[u]),a+="<option value='"+h+"' "+(h==t.properties[e]?"selected":"")+">"+n.values[u]+"</option>"}a+="</select>"}else if("boolean"==r||"toggle"==r)a="<input autofocus type='checkbox' class='value' "+(t.properties[e]?"checked":"")+"/>";else{console.warn("unknown type: "+r);return}var l=this.createDialog("<span class='name'>"+(n.label?n.label:e)+"</span>"+a+"<button>OK</button>",s),d=!1;if(("enum"==r||"combo"==r)&&n.values)(d=l.querySelector("select")).addEventListener("change",function(t){l.modified(),f(t.target.value)});else if("boolean"==r||"toggle"==r)(d=l.querySelector("input"))&&d.addEventListener("click",function(t){l.modified(),f(!!d.checked)});else if(d=l.querySelector("input")){d.addEventListener("blur",function(t){this.focus()});var h=void 0!==t.properties[e]?t.properties[e]:"";"string"!==r&&(h=JSON.stringify(h)),d.value=h,d.addEventListener("keydown",function(t){if(27==t.keyCode)l.close();else if(13==t.keyCode)c();else if(13!=t.keyCode){l.modified();return}t.preventDefault(),t.stopPropagation()})}return d&&d.focus(),l.querySelector("button").addEventListener("click",c),l}function c(){f(d.value)}function f(o){n&&n.values&&n.values.constructor===Object&&void 0!=n.values[o]&&(o=n.values[o]),"number"==typeof t.properties[e]&&(o=Number(o)),("array"==r||"object"==r)&&(o=JSON.parse(o)),t.properties[e]=o,t.graph&&t.graph._version++,t.onPropertyChanged&&t.onPropertyChanged(e,o),s.onclose&&s.onclose(),l.close(),t.setDirtyCanvas(!0,!0)}},LGraphCanvas.prototype.createDialog=function(t,e){e=Object.assign({checkForInput:!1,closeOnLeave:!0,closeOnLeave_checkModified:!0},e||{});var s=document.createElement("div");s.className="graphdialog",s.innerHTML=t,s.is_modified=!1;var o=this.canvas.getBoundingClientRect(),n=-20,r=-20;if(o&&(n-=o.left,r-=o.top),e.position?(n+=e.position[0],r+=e.position[1]):e.event?(n+=e.event.clientX,r+=e.event.clientY):(n+=.5*this.canvas.width,r+=.5*this.canvas.height),s.style.left=n+"px",s.style.top=r+"px",this.canvas.parentNode.appendChild(s),e.checkForInput){var a=[],u=!1;(a=s.querySelectorAll("input"))&&a.forEach(function(t){t.addEventListener("keydown",function(t){if(s.modified(),27==t.keyCode)s.close();else if(13!=t.keyCode)return;t.preventDefault(),t.stopPropagation()}),u||t.focus()})}s.modified=function(){s.is_modified=!0},s.close=function(){s.parentNode&&s.parentNode.removeChild(s)};var h=null,l=!1;s.addEventListener("mouseleave",function(t){!l&&(e.closeOnLeave||LiteGraph.dialog_close_on_mouse_leave)&&!s.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(h=setTimeout(s.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),s.addEventListener("mouseenter",function(t){(e.closeOnLeave||LiteGraph.dialog_close_on_mouse_leave)&&h&&clearTimeout(h)});var d=s.querySelectorAll("select");return d&&d.forEach(function(t){t.addEventListener("click",function(t){l++}),t.addEventListener("blur",function(t){l=0}),t.addEventListener("change",function(t){l=-1})}),s},LGraphCanvas.prototype.createPanel=function(t,e){var s=(e=e||{}).window||window,o=document.createElement("div");if(o.className="litegraph dialog",o.innerHTML="<div class='dialog-header'><span class='dialog-title'></span></div><div class='dialog-content'></div><div style='display:none;' class='dialog-alt-content'></div><div class='dialog-footer'></div>",o.header=o.querySelector(".dialog-header"),e.width&&(o.style.width=e.width+(e.width.constructor===Number?"px":"")),e.height&&(o.style.height=e.height+(e.height.constructor===Number?"px":"")),e.closable){var n=document.createElement("span");n.innerHTML="&#10005;",n.classList.add("close"),n.addEventListener("click",function(){o.close()}),o.header.appendChild(n)}return o.title_element=o.querySelector(".dialog-title"),o.title_element.innerText=t,o.content=o.querySelector(".dialog-content"),o.alt_content=o.querySelector(".dialog-alt-content"),o.footer=o.querySelector(".dialog-footer"),o.close=function(){o.onClose&&"function"==typeof o.onClose&&o.onClose(),o.parentNode&&o.parentNode.removeChild(o),this.parentNode&&this.parentNode.removeChild(this)},o.toggleAltContent=function(t){if(void 0!==t)var e=t?"block":"none",s=t?"none":"block";else var e="block"!=o.alt_content.style.display?"block":"none",s="block"!=o.alt_content.style.display?"none":"block";o.alt_content.style.display=e,o.content.style.display=s},o.toggleFooterVisibility=function(t){if(void 0!==t)var e=t?"block":"none";else var e="block"!=o.footer.style.display?"block":"none";o.footer.style.display=e},o.clear=function(){this.content.innerHTML=""},o.addHTML=function(t,e,s){var n=document.createElement("div");return e&&(n.className=e),n.innerHTML=t,s?o.footer.appendChild(n):o.content.appendChild(n),n},o.addButton=function(t,e,s){var n=document.createElement("button");return n.innerText=t,n.options=s,n.classList.add("btn"),n.addEventListener("click",e),o.footer.appendChild(n),n},o.addSeparator=function(){var t=document.createElement("div");t.className="separator",o.content.appendChild(t)},o.addWidget=function(t,e,n,r,a){r=r||{};var u=String(n);"number"==(t=t.toLowerCase())&&(u=n.toFixed(3));var h=document.createElement("div");h.className="property",h.innerHTML="<span class='property_name'></span><span class='property_value'></span>",h.querySelector(".property_name").innerText=r.label||e;var l=h.querySelector(".property_value");if(l.innerText=u,h.dataset.property=e,h.dataset.type=r.type||t,h.options=r,h.value=n,"code"==t)h.addEventListener("click",function(t){o.inner_showCodePad(this.dataset.property)});else if("boolean"==t)h.classList.add("boolean"),n&&h.classList.add("bool-on"),h.addEventListener("click",function(){var t=this.dataset.property;this.value=!this.value,this.classList.toggle("bool-on"),this.querySelector(".property_value").innerText=this.value?"true":"false",d(t,this.value)});else if("string"==t||"number"==t)l.setAttribute("contenteditable",!0),l.addEventListener("keydown",function(e){"Enter"!=e.code||"string"==t&&e.shiftKey||(e.preventDefault(),this.blur())}),l.addEventListener("blur",function(){var t=this.innerText,e=this.parentNode.dataset.property;"number"==this.parentNode.dataset.type&&(t=Number(t)),d(e,t)});else if("enum"==t||"combo"==t){var u=LGraphCanvas.getPropertyPrintableValue(n,r.values);l.innerText=u,l.addEventListener("click",function(t){var e=r.values||[],o=this.parentNode.dataset.property,n=this;function a(t,e,s){return n.innerText=t,d(o,t),!1}new LiteGraph.ContextMenu(e,{event:t,className:"dark",callback:a},s)})}function d(t,e){r.callback&&r.callback(t,e,r),a&&a(t,e,r)}return o.content.appendChild(h),h},o.onOpen&&"function"==typeof o.onOpen&&o.onOpen(),o},LGraphCanvas.getPropertyPrintableValue=function(t,e){if(!e||e.constructor===Array)return String(t);if(e.constructor===Object){var s="";for(var o in e)if(e[o]==t){s=o;break}return String(t)+" ("+s+")"}},LGraphCanvas.prototype.closePanels=function(){var t=document.querySelector("#node-panel");t&&t.close();var t=document.querySelector("#option-panel");t&&t.close()},LGraphCanvas.prototype.showShowGraphOptionsPanel=function(t,e,s,o){if(this.constructor&&"HTMLDivElement"==this.constructor.name){if(!e||!e.event||!e.event.target||!e.event.target.lgraphcanvas){console.warn("Canvas not found");return}var n=e.event.target.lgraphcanvas}else var n=this;n.closePanels();var r=n.getCanvasWindow();function a(){panel.content.innerHTML="";var t=function(t,e,s){s&&s.key&&(t=s.key),s.values&&(e=Object.values(s.values).indexOf(e)),n[t]=e},e=LiteGraph.availableCanvasOptions;for(var s in e.sort(),e){var o=e[s];panel.addWidget("boolean",o,n[o],{key:o,on:"True",off:"False"},t)}n.links_render_mode,panel.addWidget("combo","Render mode",LiteGraph.LINK_RENDER_MODES[n.links_render_mode],{key:"links_render_mode",values:LiteGraph.LINK_RENDER_MODES},t),panel.addSeparator(),panel.footer.innerHTML=""}panel=n.createPanel("Options",{closable:!0,window:r,onOpen:function(){n.OPTIONPANEL_IS_OPEN=!0},onClose:function(){n.OPTIONPANEL_IS_OPEN=!1,n.options_panel=null}}),n.options_panel=panel,panel.id="option-panel",panel.classList.add("settings"),a(),n.canvas.parentNode.appendChild(panel)},LGraphCanvas.prototype.showShowNodePanel=function(t){this.SELECTED_NODE=t,this.closePanels();var e=this.getCanvasWindow(),s=this,o=this.createPanel(t.title||"",{closable:!0,window:e,onOpen:function(){s.NODEPANEL_IS_OPEN=!0},onClose:function(){s.NODEPANEL_IS_OPEN=!1,s.node_panel=null}});function n(){o.content.innerHTML="",o.addHTML("<span class='node_type'>"+t.type+"</span><span class='node_desc'>"+(t.constructor.desc||"")+"</span><span class='separator'></span>"),o.addHTML("<h3>Properties</h3>");var e=function(e,o){switch(s.graph.beforeChange(t),e){case"Title":t.title=o;break;case"Mode":var n=Object.values(LiteGraph.NODE_MODES).indexOf(o);n>=0&&LiteGraph.NODE_MODES[n]?t.changeMode(n):console.warn("unexpected mode: "+o);break;case"Color":LGraphCanvas.node_colors[o]?(t.color=LGraphCanvas.node_colors[o].color,t.bgcolor=LGraphCanvas.node_colors[o].bgcolor):console.warn("unexpected color: "+o);break;default:t.setProperty(e,o)}s.graph.afterChange(),s.dirty_canvas=!0};o.addWidget("string","Title",t.title,{},e),o.addWidget("combo","Mode",LiteGraph.NODE_MODES[t.mode],{values:LiteGraph.NODE_MODES},e);var n="";for(var r in void 0!==t.color&&(n=Object.keys(LGraphCanvas.node_colors).filter(function(e){return LGraphCanvas.node_colors[e].color==t.color})),o.addWidget("combo","Color",n,{values:Object.keys(LGraphCanvas.node_colors)},e),t.properties){var a=t.properties[r],u=t.getPropertyInfo(r);u.type,t.onAddPropertyToPanel&&t.onAddPropertyToPanel(r,o)||o.addWidget(u.widget||u.type,r,a,u,e)}o.addSeparator(),t.onShowCustomPanelInfo&&t.onShowCustomPanelInfo(o),o.footer.innerHTML="",o.addButton("Delete",function(){t.block_delete||(t.graph.remove(t),o.close())}).classList.add("delete")}s.node_panel=o,o.id="node-panel",o.node=t,o.classList.add("settings"),o.inner_showCodePad=function(e){o.classList.remove("settings"),o.classList.add("centered"),o.alt_content.innerHTML="<textarea class='code'></textarea>";var s=o.alt_content.querySelector("textarea"),r=function(){o.toggleAltContent(!1),o.toggleFooterVisibility(!0),s.parentNode.removeChild(s),o.classList.add("settings"),o.classList.remove("centered"),n()};s.value=t.properties[e],s.addEventListener("keydown",function(o){"Enter"==o.code&&o.ctrlKey&&(t.setProperty(e,s.value),r())}),o.toggleAltContent(!0),o.toggleFooterVisibility(!1),s.style.height="calc(100% - 40px)";var a=o.addButton("Assign",function(){t.setProperty(e,s.value),r()});o.alt_content.appendChild(a);var u=o.addButton("Close",r);u.style.float="right",o.alt_content.appendChild(u)},n(),this.canvas.parentNode.appendChild(o)},LGraphCanvas.prototype.showSubgraphPropertiesDialog=function(t){console.log("showing subgraph properties dialog");var e=this.canvas.parentNode.querySelector(".subgraph_dialog");e&&e.close();var s=this.createPanel("Subgraph Inputs",{closable:!0,width:500});function o(){if(s.clear(),t.inputs)for(var e=0;e<t.inputs.length;++e){var n=t.inputs[e];if(!n.not_subgraph_input){var r="<button>&#10005;</button> <span class='bullet_icon'></span><span class='name'></span><span class='type'></span>",a=s.addHTML(r,"subgraph_property");a.dataset.name=n.name,a.dataset.slot=e,a.querySelector(".name").innerText=n.name,a.querySelector(".type").innerText=n.type,a.querySelector("button").addEventListener("click",function(e){t.removeInput(Number(this.parentNode.dataset.slot)),o()})}}}s.node=t,s.classList.add("subgraph_dialog");var n=" + <span class='label'>Name</span><input class='name'/><span class='label'>Type</span><input class='type'></input><button>+</button>";return s.addHTML(n,"subgraph_property extra",!0).querySelector("button").addEventListener("click",function(e){var s=this.parentNode,n=s.querySelector(".name").value,r=s.querySelector(".type").value;n&&-1==t.findInputSlot(n)&&(t.addInput(n,r),s.querySelector(".name").value="",s.querySelector(".type").value="",o())}),o(),this.canvas.parentNode.appendChild(s),s},LGraphCanvas.prototype.showSubgraphPropertiesDialogRight=function(t){var e=this.canvas.parentNode.querySelector(".subgraph_dialog");e&&e.close();var s=this.createPanel("Subgraph Outputs",{closable:!0,width:500});function o(){if(s.clear(),t.outputs)for(var e=0;e<t.outputs.length;++e){var n=t.outputs[e];if(!n.not_subgraph_output){var r="<button>&#10005;</button> <span class='bullet_icon'></span><span class='name'></span><span class='type'></span>",a=s.addHTML(r,"subgraph_property");a.dataset.name=n.name,a.dataset.slot=e,a.querySelector(".name").innerText=n.name,a.querySelector(".type").innerText=n.type,a.querySelector("button").addEventListener("click",function(e){t.removeOutput(Number(this.parentNode.dataset.slot)),o()})}}}s.node=t,s.classList.add("subgraph_dialog");var n=" + <span class='label'>Name</span><input class='name'/><span class='label'>Type</span><input class='type'></input><button>+</button>",r=s.addHTML(n,"subgraph_property extra",!0);function a(){var e=this.parentNode,s=e.querySelector(".name").value,n=e.querySelector(".type").value;s&&-1==t.findOutputSlot(s)&&(t.addOutput(s,n),e.querySelector(".name").value="",e.querySelector(".type").value="",o())}return r.querySelector(".name").addEventListener("keydown",function(t){13==t.keyCode&&a.apply(this)}),r.querySelector("button").addEventListener("click",function(t){a.apply(this)}),o(),this.canvas.parentNode.appendChild(s),s},LGraphCanvas.prototype.checkPanels=function(){if(this.canvas)for(var t=this.canvas.parentNode.querySelectorAll(".litegraph.dialog"),e=0;e<t.length;++e){var s=t[e];s.node&&(!s.node.graph||s.graph!=this.graph)&&s.close()}},LGraphCanvas.onMenuNodeCollapse=function(t,e,s,o,n){n.graph.beforeChange();var r=function(t){t.collapse()},a=LGraphCanvas.active_canvas;if(!a.selected_nodes||Object.keys(a.selected_nodes).length<=1)r(n);else for(var u in a.selected_nodes)r(a.selected_nodes[u]);n.graph.afterChange()},LGraphCanvas.onMenuNodePin=function(t,e,s,o,n){n.pin()},LGraphCanvas.onMenuNodeMode=function(t,e,s,o,n){function r(t){if(n){var e=Object.values(LiteGraph.NODE_MODES).indexOf(t),s=function(s){e>=0&&LiteGraph.NODE_MODES[e]?s.changeMode(e):(console.warn("unexpected mode: "+t),s.changeMode(LiteGraph.ALWAYS))},o=LGraphCanvas.active_canvas;if(!o.selected_nodes||Object.keys(o.selected_nodes).length<=1)s(n);else for(var r in o.selected_nodes)s(o.selected_nodes[r])}}return new LiteGraph.ContextMenu(LiteGraph.NODE_MODES,{event:s,callback:r,parentMenu:o,node:n}),!1},LGraphCanvas.onMenuNodeColors=function(t,e,s,o,n){if(!n)throw"no node for color";var r=[];for(var a in r.push({value:null,content:"<span style='display: block; padding-left: 4px;'>No color</span>"}),LGraphCanvas.node_colors){var u=LGraphCanvas.node_colors[a],t={value:a,content:"<span style='display: block; color: #999; padding-left: 4px; border-left: 8px solid "+u.color+"; background-color:"+u.bgcolor+"'>"+a+"</span>"};r.push(t)}function h(t){if(n){var e=t.value?LGraphCanvas.node_colors[t.value]:null,s=function(t){e?t.constructor===LiteGraph.LGraphGroup?t.color=e.groupcolor:(t.color=e.color,t.bgcolor=e.bgcolor):(delete t.color,delete t.bgcolor)},o=LGraphCanvas.active_canvas;if(!o.selected_nodes||Object.keys(o.selected_nodes).length<=1)s(n);else for(var r in o.selected_nodes)s(o.selected_nodes[r]);n.setDirtyCanvas(!0,!0)}}return new LiteGraph.ContextMenu(r,{event:s,callback:h,parentMenu:o,node:n}),!1},LGraphCanvas.onMenuNodeShapes=function(t,e,s,o,n){if(!n)throw"no node passed";function r(t){if(n){n.graph.beforeChange();var e=function(e){e.shape=t},s=LGraphCanvas.active_canvas;if(!s.selected_nodes||Object.keys(s.selected_nodes).length<=1)e(n);else for(var o in s.selected_nodes)e(s.selected_nodes[o]);n.graph.afterChange(),n.setDirtyCanvas(!0)}}return new LiteGraph.ContextMenu(LiteGraph.VALID_SHAPES,{event:s,callback:r,parentMenu:o,node:n}),!1},LGraphCanvas.onMenuNodeRemove=function(t,e,s,o,n){if(!n)throw"no node passed";var r=n.graph;r.beforeChange();var a=function(t){!1!==t.removable&&r.remove(t)},u=LGraphCanvas.active_canvas;if(!u.selected_nodes||Object.keys(u.selected_nodes).length<=1)a(n);else for(var h in u.selected_nodes)a(u.selected_nodes[h]);r.afterChange(),n.setDirtyCanvas(!0,!0)},LGraphCanvas.onMenuNodeToSubgraph=function(t,e,s,o,n){var r=n.graph,a=LGraphCanvas.active_canvas;if(a){var u=Object.values(a.selected_nodes||{});u.length||(u=[n]);var h=LiteGraph.createNode("graph/subgraph");h.pos=n.pos.concat(),r.add(h),h.buildFromNodes(u),a.deselectAllNodes(),n.setDirtyCanvas(!0,!0)}},LGraphCanvas.onMenuNodeClone=function(t,e,s,o,n){n.graph.beforeChange();var r={},a=function(t){if(!1!==t.clonable){var e=t.clone();e&&(e.pos=[t.pos[0]+5,t.pos[1]+5],t.graph.add(e),r[e.id]=e)}},u=LGraphCanvas.active_canvas;if(!u.selected_nodes||Object.keys(u.selected_nodes).length<=1)a(n);else for(var h in u.selected_nodes)a(u.selected_nodes[h]);Object.keys(r).length&&u.selectNodes(r),n.graph.afterChange(),n.setDirtyCanvas(!0,!0)},LGraphCanvas.node_colors={red:{color:"#322",bgcolor:"#533",groupcolor:"#A88"},brown:{color:"#332922",bgcolor:"#593930",groupcolor:"#b06634"},green:{color:"#232",bgcolor:"#353",groupcolor:"#8A8"},blue:{color:"#223",bgcolor:"#335",groupcolor:"#88A"},pale_blue:{color:"#2a363b",bgcolor:"#3f5159",groupcolor:"#3f789e"},cyan:{color:"#233",bgcolor:"#355",groupcolor:"#8AA"},purple:{color:"#323",bgcolor:"#535",groupcolor:"#a1309b"},yellow:{color:"#432",bgcolor:"#653",groupcolor:"#b58b2a"},black:{color:"#222",bgcolor:"#000",groupcolor:"#444"}},LGraphCanvas.prototype.getCanvasMenuOptions=function(){var t=null;if(this.getMenuOptions?t=this.getMenuOptions():(t=[{content:"Add Node",has_submenu:!0,callback:LGraphCanvas.onMenuAdd},{content:"Add Group",callback:LGraphCanvas.onGroupAdd}],Object.keys(this.selected_nodes).length>1&&t.push({content:"Align",has_submenu:!0,callback:LGraphCanvas.onGroupAlign}),this._graph_stack&&this._graph_stack.length>0&&t.push(null,{content:"Close subgraph",callback:this.closeSubgraph.bind(this)})),this.getExtraMenuOptions){var e=this.getExtraMenuOptions(this,t);e&&(t=t.concat(e))}return t},LGraphCanvas.prototype.getNodeMenuOptions=function(t){var e=null;if(t.getMenuOptions?e=t.getMenuOptions(this):(e=[{content:"Inputs",has_submenu:!0,disabled:!0,callback:LGraphCanvas.showMenuNodeOptionalInputs},{content:"Outputs",has_submenu:!0,disabled:!0,callback:LGraphCanvas.showMenuNodeOptionalOutputs},null,{content:"Properties",has_submenu:!0,callback:LGraphCanvas.onShowMenuNodeProperties},null,{content:"Title",callback:LGraphCanvas.onShowPropertyEditor},{content:"Mode",has_submenu:!0,callback:LGraphCanvas.onMenuNodeMode}],!1!==t.resizable&&e.push({content:"Resize",callback:LGraphCanvas.onMenuResizeNode}),e.push({content:"Collapse",callback:LGraphCanvas.onMenuNodeCollapse},{content:"Pin",callback:LGraphCanvas.onMenuNodePin},{content:"Colors",has_submenu:!0,callback:LGraphCanvas.onMenuNodeColors},{content:"Shapes",has_submenu:!0,callback:LGraphCanvas.onMenuNodeShapes},null)),t.onGetInputs){var s=t.onGetInputs();s&&s.length&&(e[0].disabled=!1)}if(t.onGetOutputs){var o=t.onGetOutputs();o&&o.length&&(e[1].disabled=!1)}if(t.getExtraMenuOptions){var n=t.getExtraMenuOptions(this,e);n&&(n.push(null),e=n.concat(e))}return!1!==t.clonable&&e.push({content:"Clone",callback:LGraphCanvas.onMenuNodeClone}),Object.keys(this.selected_nodes).length>1&&e.push({content:"Align Selected To",has_submenu:!0,callback:LGraphCanvas.onNodeAlign}),e.push(null,{content:"Remove",disabled:!(!1!==t.removable&&!t.block_delete),callback:LGraphCanvas.onMenuNodeRemove}),t.graph&&t.graph.onGetNodeMenuOptions&&t.graph.onGetNodeMenuOptions(e,t),e},LGraphCanvas.prototype.getGroupMenuOptions=function(t){return[{content:"Title",callback:LGraphCanvas.onShowPropertyEditor},{content:"Color",has_submenu:!0,callback:LGraphCanvas.onMenuNodeColors},{content:"Font size",property:"font_size",type:"Number",callback:LGraphCanvas.onShowPropertyEditor},null,{content:"Remove",callback:LGraphCanvas.onMenuNodeRemove}]},LGraphCanvas.prototype.processContextMenu=function(t,e){var s=this,o=LGraphCanvas.active_canvas.getCanvasWindow(),n=null,r={event:e,callback:l,extra:t};t&&(r.title=t.type);var a=null;if(t&&(a=t.getSlotInPosition(e.canvasX,e.canvasY),LGraphCanvas.active_node=t),a){if(n=[],t.getSlotMenuOptions)n=t.getSlotMenuOptions(a);else{a&&a.output&&a.output.links&&a.output.links.length&&n.push({content:"Disconnect Links",slot:a});var u=a.input||a.output;u.removable&&n.push(u.locked?"Cannot remove":{content:"Remove Slot",slot:a}),u.nameLocked||n.push({content:"Rename Slot",slot:a})}r.title=(a.input?a.input.type:a.output.type)||"*",a.input&&a.input.type==LiteGraph.ACTION&&(r.title="Action"),a.output&&a.output.type==LiteGraph.EVENT&&(r.title="Event")}else if(t)n=this.getNodeMenuOptions(t);else{n=this.getCanvasMenuOptions();var h=this.graph.getGroupOnPos(e.canvasX,e.canvasY);h&&n.push(null,{content:"Edit Group",has_submenu:!0,submenu:{title:"Group",extra:h,options:this.getGroupMenuOptions(h)}})}function l(e,o,n){if(e){if("Remove Slot"==e.content){var r=e.slot;t.graph.beforeChange(),r.input?t.removeInput(r.slot):r.output&&t.removeOutput(r.slot),t.graph.afterChange();return}if("Disconnect Links"==e.content){var r=e.slot;t.graph.beforeChange(),r.output?t.disconnectOutput(r.slot):r.input&&t.disconnectInput(r.slot),t.graph.afterChange();return}if("Rename Slot"==e.content){var r=e.slot,a=r.input?t.getInputInfo(r.slot):t.getOutputInfo(r.slot),u=s.createDialog("<span class='name'>Name</span><input autofocus type='text'/><button>OK</button>",o),h=u.querySelector("input");h&&a&&(h.value=a.label||"");var l=function(){t.graph.beforeChange(),h.value&&(a&&(a.label=h.value),s.setDirty(!0)),u.close(),t.graph.afterChange()};u.querySelector("button").addEventListener("click",l),h.addEventListener("keydown",function(t){if(u.is_modified=!0,27==t.keyCode)u.close();else if(13==t.keyCode)l();else if(13!=t.keyCode&&"textarea"!=t.target.localName)return;t.preventDefault(),t.stopPropagation()}),h.focus()}}}n&&new LiteGraph.ContextMenu(n,r,o)},LiteGraph.compareObjects=compareObjects,LiteGraph.distance=distance,LiteGraph.colorToString=colorToString,LiteGraph.isInsideRectangle=isInsideRectangle,LiteGraph.growBounding=growBounding,LiteGraph.isInsideBounding=isInsideBounding,LiteGraph.overlapBounding=overlapBounding,LiteGraph.hex2num=hex2num,LiteGraph.num2hex=num2hex,ContextMenu.prototype.addItem=function(t,e,s){var o=this;s=s||{};var n=document.createElement("div");n.className="litemenu-entry submenu";var r=!1;function a(t){var e=this.value;e&&e.has_submenu&&u.call(this,t)}function u(t){var e=this.value,n=!0;if(o.current_submenu&&o.current_submenu.close(t),s.callback){var r=s.callback.call(this,e,s,t,o,s.node);!0===r&&(n=!1)}if(e){if(e.callback&&!s.ignore_item_callbacks&&!0!==e.disabled){var r=e.callback.call(this,e,s,t,o,s.extra);!0===r&&(n=!1)}if(e.submenu){if(!e.submenu.options)throw"ContextMenu submenu needs options";new o.constructor(e.submenu.options,{callback:e.submenu.callback,event:t,parentMenu:o,ignore_item_callbacks:e.submenu.ignore_item_callbacks,title:e.submenu.title,extra:e.submenu.extra,autoopen:s.autoopen}),n=!1}}n&&!o.lock&&o.close()}return null===e?n.classList.add("separator"):(n.innerHTML=e&&e.title?e.title:t,n.value=e,e&&(e.disabled&&(r=!0,n.classList.add("disabled")),(e.submenu||e.has_submenu)&&n.classList.add("has_submenu")),"function"==typeof e?(n.dataset.value=t,n.onclick_callback=e):n.dataset.value=e,e.className&&(n.className+=" "+e.className)),this.root.appendChild(n),r||n.addEventListener("click",u),!r&&s.autoopen&&LiteGraph.pointerListenerAdd(n,"enter",a),n},ContextMenu.prototype.close=function(t,e){this.root.parentNode&&this.root.parentNode.removeChild(this.root),this.parentMenu&&!e&&(this.parentMenu.lock=!1,this.parentMenu.current_submenu=null,void 0===t?this.parentMenu.close():t&&!ContextMenu.isCursorOverElement(t,this.parentMenu.root)&&ContextMenu.trigger(this.parentMenu.root,LiteGraph.pointerevents_method+"leave",t)),this.current_submenu&&this.current_submenu.close(t,!0),this.root.closing_timer&&clearTimeout(this.root.closing_timer)},ContextMenu.trigger=function(t,e,s,o){var n=document.createEvent("CustomEvent");return n.initCustomEvent(e,!0,!0,s),n.srcElement=o,t.dispatchEvent?t.dispatchEvent(n):t.__events&&t.__events.dispatchEvent(n),n},ContextMenu.prototype.getTopMenu=function(){return this.options.parentMenu?this.options.parentMenu.getTopMenu():this},ContextMenu.prototype.getFirstEvent=function(){return this.options.parentMenu?this.options.parentMenu.getFirstEvent():this.options.event},ContextMenu.isCursorOverElement=function(t,e){var s=t.clientX,o=t.clientY,n=e.getBoundingClientRect();return!!n&&!!(o>n.top)&&!!(o<n.top+n.height)&&!!(s>n.left)&&!!(s<n.left+n.width)},LiteGraph.ContextMenu=ContextMenu,LiteGraph.closeAllContextMenus=function(t){var e=(t=t||window).document.querySelectorAll(".litecontextmenu");if(e.length){for(var s=[],o=0;o<e.length;o++)s.push(e[o]);for(var o=0;o<s.length;o++)s[o].close?s[o].close():s[o].parentNode&&s[o].parentNode.removeChild(s[o])}},LiteGraph.extendClass=function(t,e){for(var s in e)!t.hasOwnProperty(s)&&(t[s]=e[s]);if(e.prototype)for(var s in e.prototype)!(!e.prototype.hasOwnProperty(s)||t.prototype.hasOwnProperty(s))&&(e.prototype.__lookupGetter__(s)?t.prototype.__defineGetter__(s,e.prototype.__lookupGetter__(s)):t.prototype[s]=e.prototype[s],e.prototype.__lookupSetter__(s)&&t.prototype.__defineSetter__(s,e.prototype.__lookupSetter__(s)))},CurveEditor.sampleCurve=function(t,e){if(e){for(var s=0;s<e.length-1;++s){var o=e[s],n=e[s+1];if(!(n[0]<t)){var r=n[0]-o[0];if(1e-5>Math.abs(r))return o[1];var a=(t-o[0])/r;return o[1]*(1-a)+n[1]*a}}return 0}},CurveEditor.prototype.draw=function(t,e,s,o,n,r){var a=this.points;if(a){this.size=e;var u=e[0]-2*this.margin,h=e[1]-2*this.margin;n=n||"#666",t.save(),t.translate(this.margin,this.margin),o&&(t.fillStyle="#111",t.fillRect(0,0,u,h),t.fillStyle="#222",t.fillRect(.5*u,0,1,h),t.strokeStyle="#333",t.strokeRect(0,0,u,h)),t.strokeStyle=n,r&&(t.globalAlpha=.5),t.beginPath();for(var l=0;l<a.length;++l){var d=a[l];t.lineTo(d[0]*u,(1-d[1])*h)}if(t.stroke(),t.globalAlpha=1,!r)for(var l=0;l<a.length;++l){var d=a[l];t.fillStyle=this.selected==l?"#FFF":this.nearest==l?"#DDD":"#AAA",t.beginPath(),t.arc(d[0]*u,(1-d[1])*h,2,0,2*Math.PI),t.fill()}t.restore()}},CurveEditor.prototype.onMouseDown=function(t,e){var s=this.points;if(s&&!(t[1]<0)){var o=this.size[0]-2*this.margin,n=this.size[1]-2*this.margin,r=t[0]-this.margin,a=t[1]-this.margin,u=[r,a],h=30/e.ds.scale;if(this.selected=this.getCloserPoint(u,h),-1==this.selected){var l=[r/o,1-a/n];s.push(l),s.sort(function(t,e){return t[0]-e[0]}),this.selected=s.indexOf(l),this.must_update=!0}if(-1!=this.selected)return!0}},CurveEditor.prototype.onMouseMove=function(t,e){var s=this.points;if(s){var o=this.selected;if(!(o<0)){var n=(t[0]-this.margin)/(this.size[0]-2*this.margin),r=(t[1]-this.margin)/(this.size[1]-2*this.margin),a=[t[0]-this.margin,t[1]-this.margin],u=30/e.ds.scale;this._nearest=this.getCloserPoint(a,u);var h=s[o];if(h){var l=0==o||o==s.length-1;if(!l&&(t[0]<-10||t[0]>this.size[0]+10||t[1]<-10||t[1]>this.size[1]+10)){s.splice(o,1),this.selected=-1;return}l?h[0]=0==o?0:1:h[0]=clamp(n,0,1),h[1]=1-clamp(r,0,1),s.sort(function(t,e){return t[0]-e[0]}),this.selected=s.indexOf(h),this.must_update=!0}}}},CurveEditor.prototype.onMouseUp=function(t,e){return this.selected=-1,!1},CurveEditor.prototype.getCloserPoint=function(t,e){var s=this.points;if(!s)return -1;e=e||30;for(var o=this.size[0]-2*this.margin,n=this.size[1]-2*this.margin,r=s.length,a=[0,0],u=1e6,h=-1,l=-1,d=0;d<r;++d){var c=s[d];a[0]=c[0]*o,a[1]=(1-c[1])*n,a[0]<t[0]&&(l=d);var f=vec2.distance(t,a);f>u||f>e||(h=d,u=f)}return h},LiteGraph.CurveEditor=CurveEditor,LiteGraph.getParameterNames=function(t){return(t+"").replace(/[/][/].*$/gm,"").replace(/\s+/g,"").replace(/[/][*][^/*]*[*][/]/g,"").split("){",1)[0].replace(/^[^(]*[(]/,"").replace(/=[^,]+/g,"").split(",").filter(Boolean)},LiteGraph.pointerListenerAdd=function(t,e,s,o=!1){if(t&&t.addEventListener&&e&&"function"==typeof s){var n=LiteGraph.pointerevents_method,r=e;if("pointer"==n&&!window.PointerEvent)switch(console.warn("sMethod=='pointer' && !window.PointerEvent"),console.log("Converting pointer["+r+"] : down move up cancel enter TO touchstart touchmove touchend, etc .."),r){case"down":n="touch",r="start";break;case"move":case"cancel":n="touch";break;case"up":n="touch",r="end";break;case"enter":console.log("debug: Should I send a move event?");break;default:console.warn("PointerEvent not available in this browser ? The event "+r+" would not be called")}switch(r){case"down":case"up":case"move":case"over":case"out":case"enter":t.addEventListener(n+r,s,o);case"leave":case"cancel":case"gotpointercapture":case"lostpointercapture":if("mouse"!=n)return t.addEventListener(n+r,s,o);default:return t.addEventListener(r,s,o)}}},LiteGraph.pointerListenerRemove=function(t,e,s,o=!1){if(t&&t.removeEventListener&&e&&"function"==typeof s)switch(e){case"down":case"up":case"move":case"over":case"out":case"enter":("pointer"==LiteGraph.pointerevents_method||"mouse"==LiteGraph.pointerevents_method)&&t.removeEventListener(LiteGraph.pointerevents_method+e,s,o);case"leave":case"cancel":case"gotpointercapture":case"lostpointercapture":if("pointer"==LiteGraph.pointerevents_method)return t.removeEventListener(LiteGraph.pointerevents_method+e,s,o);default:return t.removeEventListener(e,s,o)}},global.clamp=clamp,"undefined"==typeof window||window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)})}(this),"undefined"!=typeof exports&&(exports.LiteGraph=this.LiteGraph,exports.LGraph=this.LGraph,exports.LLink=this.LLink,exports.LGraphNode=this.LGraphNode,exports.LGraphGroup=this.LGraphGroup,exports.DragAndScale=this.DragAndScale,exports.LGraphCanvas=this.LGraphCanvas,exports.ContextMenu=this.ContextMenu),function(t){var e=t.LiteGraph;function s(){this.addOutput("in ms","number"),this.addOutput("in sec","number")}function o(){this.size=[140,80],this.properties={enabled:!0},this.enabled=!0,this.subgraph=new e.LGraph,this.subgraph._subgraph_node=this,this.subgraph._is_subgraph=!0,this.subgraph.onTrigger=this.onSubgraphTrigger.bind(this),this.subgraph.onInputAdded=this.onSubgraphNewInput.bind(this),this.subgraph.onInputRenamed=this.onSubgraphRenamedInput.bind(this),this.subgraph.onInputTypeChanged=this.onSubgraphTypeChangeInput.bind(this),this.subgraph.onInputRemoved=this.onSubgraphRemovedInput.bind(this),this.subgraph.onOutputAdded=this.onSubgraphNewOutput.bind(this),this.subgraph.onOutputRenamed=this.onSubgraphRenamedOutput.bind(this),this.subgraph.onOutputTypeChanged=this.onSubgraphTypeChangeOutput.bind(this),this.subgraph.onOutputRemoved=this.onSubgraphRemovedOutput.bind(this)}function n(){this.addOutput("","number"),this.name_in_graph="",this.properties={name:"",type:"number",value:0};var t=this;this.name_widget=this.addWidget("text","Name",this.properties.name,function(e){e&&t.setProperty("name",e)}),this.type_widget=this.addWidget("text","Type",this.properties.type,function(e){t.setProperty("type",e)}),this.value_widget=this.addWidget("number","Value",this.properties.value,function(e){t.setProperty("value",e)}),this.widgets_up=!0,this.size=[180,90]}function r(){this.addInput("",""),this.name_in_graph="",this.properties={name:"",type:""},this.name_widget=this.addWidget("text","Name",this.properties.name,"name"),this.type_widget=this.addWidget("text","Type",this.properties.type,"type"),this.widgets_up=!0,this.size=[180,60]}function a(){this.addOutput("value","number"),this.addProperty("value",1),this.widget=this.addWidget("number","value",1,"value"),this.widgets_up=!0,this.size=[180,30]}function u(){this.addOutput("bool","boolean"),this.addProperty("value",!0),this.widget=this.addWidget("toggle","value",!0,"value"),this.serialize_widgets=!0,this.widgets_up=!0,this.size=[140,30]}function h(){this.addOutput("string","string"),this.addProperty("value",""),this.widget=this.addWidget("text","value","","value"),this.widgets_up=!0,this.size=[180,30]}function l(){this.addOutput("obj","object"),this.size=[120,30],this._object={}}function d(){this.addInput("url","string"),this.addOutput("file","string"),this.addProperty("url",""),this.addProperty("type","text"),this.widget=this.addWidget("text","url","","url"),this._data=null}function c(){this.addInput("parse",e.ACTION),this.addInput("json","string"),this.addOutput("done",e.EVENT),this.addOutput("object","object"),this.widget=this.addWidget("button","parse","",this.parse.bind(this)),this._str=null,this._obj=null}function f(){this.addOutput("data","object"),this.addProperty("value",""),this.widget=this.addWidget("text","json","","value"),this.widgets_up=!0,this.size=[140,30],this._value=null}function g(){this._value=[],this.addInput("json",""),this.addOutput("arrayOut","array"),this.addOutput("length","number"),this.addProperty("value","[]"),this.widget=this.addWidget("text","array",this.properties.value,"value"),this.widgets_up=!0,this.size=[140,50]}function v(){this.addInput("arr","array"),this.addInput("value",""),this.addOutput("arr","array"),this.properties={index:0},this.widget=this.addWidget("number","i",this.properties.index,"index",{precision:0,step:10,min:0})}function $(){this.addInput("array","array,table,string"),this.addInput("index","number"),this.addOutput("value",""),this.addProperty("index",0)}function m(){this.addInput("table","table"),this.addInput("row","number"),this.addInput("col","number"),this.addOutput("value",""),this.addProperty("row",0),this.addProperty("column",0)}function y(){this.addInput("obj","object"),this.addOutput("property",0),this.addProperty("value",0),this.widget=this.addWidget("text","prop.","",this.setValue.bind(this)),this.widgets_up=!0,this.size=[140,30],this._value=null}function x(){this.addInput("obj",""),this.addOutput("keys","array"),this.size=[140,30]}function _(){this.addInput("obj",""),this.addInput("value",""),this.addOutput("obj",""),this.properties={property:""},this.name_widget=this.addWidget("text","prop.",this.properties.property,"property")}function b(){this.addInput("A","object"),this.addInput("B","object"),this.addOutput("out","object"),this._result={};var t=this;this.addWidget("button","clear","",function(){t._result={}}),this.size=this.computeSize()}function T(){this.size=[60,30],this.addInput("in"),this.addOutput("out"),this.properties={varname:"myname",container:T.LITEGRAPH},this.value=null}function E(t){return t&&null!=t.length?Number(t.length):0}function E(t){return t&&null!=t.length?Number(t.length):0}function w(){this.size=[60,30],this.addInput("data",0),this.addInput("download",e.ACTION),this.properties={filename:"data.json"},this.value=null;var t=this;this.addWidget("button","Download","",function(e){t.value&&t.downloadAsFile()})}function O(){this.size=[60,30],this.addInput("value",0,{label:""}),this.value=0}function I(){this.addInput("in",0),this.addOutput("out",0),this.size=[40,30]}function D(){this.mode=e.ON_EVENT,this.size=[80,30],this.addProperty("msg",""),this.addInput("log",e.EVENT),this.addInput("msg",0)}function N(){this.mode=e.ON_EVENT,this.addProperty("msg",""),this.addInput("",e.EVENT),this.widget=this.addWidget("text","Text","","msg"),this.widgets_up=!0,this.size=[200,30]}function C(){this.size=[60,30],this.addProperty("onExecute","return A;"),this.addInput("A",0),this.addInput("B",0),this.addOutput("out",0),this._func=null,this.data={}}function S(){this.addInput("A",0),this.addInput("B",0),this.addOutput("true","boolean"),this.addOutput("false","boolean"),this.addProperty("A",1),this.addProperty("B",1),this.addProperty("OP","==","enum",{values:S.values}),this.addWidget("combo","Op.",this.properties.OP,{property:"OP",values:S.values}),this.size=[80,60]}s.title="Time",s.desc="Time",s.prototype.onExecute=function(){this.setOutputData(0,1e3*this.graph.globaltime),this.setOutputData(1,this.graph.globaltime)},e.registerNodeType("basic/time",s),o.title="Subgraph",o.desc="Graph inside a node",o.title_color="#334",o.prototype.onGetInputs=function(){return[["enabled","boolean"]]},o.prototype.onDblClick=function(t,e,s){var o=this;setTimeout(function(){s.openSubgraph(o.subgraph)},10)},o.prototype.onAction=function(t,e){this.subgraph.onAction(t,e)},o.prototype.onExecute=function(){if(this.enabled=this.getInputOrProperty("enabled"),this.enabled){if(this.inputs)for(var t=0;t<this.inputs.length;t++){var e=this.inputs[t],s=this.getInputData(t);this.subgraph.setInputData(e.name,s)}if(this.subgraph.runStep(),this.outputs)for(var t=0;t<this.outputs.length;t++){var o=this.outputs[t],s=this.subgraph.getOutputData(o.name);this.setOutputData(t,s)}}},o.prototype.sendEventToAllNodes=function(t,e,s){this.enabled&&this.subgraph.sendEventToAllNodes(t,e,s)},o.prototype.onDrawBackground=function(t,s,o,n){if(this.flags.collapsed)return;var r=this.size[1]-e.NODE_TITLE_HEIGHT+.5,a=e.isInsideRectangle(n[0],n[1],this.pos[0],this.pos[1]+r,this.size[0],e.NODE_TITLE_HEIGHT);let u=e.isInsideRectangle(n[0],n[1],this.pos[0],this.pos[1]+r,this.size[0]/2,e.NODE_TITLE_HEIGHT);t.fillStyle=a?"#555":"#222",t.beginPath(),this._shape==e.BOX_SHAPE?u?t.rect(0,r,this.size[0]/2+1,e.NODE_TITLE_HEIGHT):t.rect(this.size[0]/2,r,this.size[0]/2+1,e.NODE_TITLE_HEIGHT):u?t.roundRect(0,r,this.size[0]/2+1,e.NODE_TITLE_HEIGHT,[0,0,8,8]):t.roundRect(this.size[0]/2,r,this.size[0]/2+1,e.NODE_TITLE_HEIGHT,[0,0,8,8]),a?t.fill():t.fillRect(0,r,this.size[0]+1,e.NODE_TITLE_HEIGHT),t.textAlign="center",t.font="24px Arial",t.fillStyle=a?"#DDD":"#999",t.fillText("+",.25*this.size[0],r+24),t.fillText("+",.75*this.size[0],r+24)},o.prototype.onMouseDown=function(t,s,o){var n=this.size[1]-e.NODE_TITLE_HEIGHT+.5;console.log(0),s[1]>n&&(s[0]<this.size[0]/2?(console.log(1),o.showSubgraphPropertiesDialog(this)):(console.log(2),o.showSubgraphPropertiesDialogRight(this)))},o.prototype.computeSize=function(){var t;return[200,Math.max(this.inputs?this.inputs.length:0,this.outputs?this.outputs.length:0)*e.NODE_SLOT_HEIGHT+e.NODE_TITLE_HEIGHT]},o.prototype.onSubgraphTrigger=function(t,e){var s=this.findOutputSlot(t);-1!=s&&this.triggerSlot(s)},o.prototype.onSubgraphNewInput=function(t,e){-1==this.findInputSlot(t)&&this.addInput(t,e)},o.prototype.onSubgraphRenamedInput=function(t,e){var s=this.findInputSlot(t);-1!=s&&(this.getInputInfo(s).name=e)},o.prototype.onSubgraphTypeChangeInput=function(t,e){var s=this.findInputSlot(t);-1!=s&&(this.getInputInfo(s).type=e)},o.prototype.onSubgraphRemovedInput=function(t){var e=this.findInputSlot(t);-1!=e&&this.removeInput(e)},o.prototype.onSubgraphNewOutput=function(t,e){-1==this.findOutputSlot(t)&&this.addOutput(t,e)},o.prototype.onSubgraphRenamedOutput=function(t,e){var s=this.findOutputSlot(t);-1!=s&&(this.getOutputInfo(s).name=e)},o.prototype.onSubgraphTypeChangeOutput=function(t,e){var s=this.findOutputSlot(t);-1!=s&&(this.getOutputInfo(s).type=e)},o.prototype.onSubgraphRemovedOutput=function(t){var e=this.findOutputSlot(t);-1!=e&&this.removeOutput(e)},o.prototype.getExtraMenuOptions=function(t){var e=this;return[{content:"Open",callback:function(){t.openSubgraph(e.subgraph)}}]},o.prototype.onResize=function(t){t[1]+=20},o.prototype.serialize=function(){var t=e.LGraphNode.prototype.serialize.call(this);return t.subgraph=this.subgraph.serialize(),t},o.prototype.reassignSubgraphUUIDs=function(t){let s={nodeIDs:{},linkIDs:{}};for(let o of t.nodes){let n=o.id,r=e.uuidv4();if(o.id=r,s.nodeIDs[n]||s.nodeIDs[r])throw Error(`New/old node UUID wasn't unique in changed map! ${n} ${r}`);s.nodeIDs[n]=r,s.nodeIDs[r]=n}for(let a of t.links){let u=a[0],h=e.uuidv4();if(a[0]=h,s.linkIDs[u]||s.linkIDs[h])throw Error(`New/old link UUID wasn't unique in changed map! ${u} ${h}`);s.linkIDs[u]=h,s.linkIDs[h]=u;let l=a[1],d=a[3];if(!s.nodeIDs[l])throw Error(`Old node UUID not found in mapping! ${l}`);if(a[1]=s.nodeIDs[l],!s.nodeIDs[d])throw Error(`Old node UUID not found in mapping! ${d}`);a[3]=s.nodeIDs[d]}for(let c of t.nodes){if(c.inputs)for(let f of c.inputs)f.link&&(f.link=s.linkIDs[f.link]);if(c.outputs)for(let g of c.outputs)g.links&&(g.links=g.links.map(t=>s.linkIDs[t]))}for(let v of t.nodes)if("graph/subgraph"===v.type){let $=reassignGraphUUIDs(v.subgraph);s.nodeIDs.assign($.nodeIDs),s.linkIDs.assign($.linkIDs)}},o.prototype.clone=function(){var t=e.createNode(this.type),s=this.serialize();if(e.use_uuids){let o=e.cloneObject(s.subgraph);this.reassignSubgraphUUIDs(o),s.subgraph=o}return delete s.id,delete s.inputs,delete s.outputs,t.configure(s),t},o.prototype.buildFromNodes=function(t){for(var e={},s=0,o=0,n=0;n<t.length;++n){var r=t[n];e[r.id]=r,s=Math.min(r.pos[0],s),o=Math.max(r.pos[0],s)}for(var n=0;n<t.length;++n){var r=t[n];if(r.inputs)for(var a=0;a<r.inputs.length;++a){var u=r.inputs[a];if(u&&u.link){var h=r.graph.links[u.link];h&&(e[h.origin_id]||this.subgraph.addInput(u.name,h.type))}}if(r.outputs)for(var a=0;a<r.outputs.length;++a){var l=r.outputs[a];if(l&&l.links&&l.links.length){for(var d=!1,c=0;c<l.links.length;++c){var h=r.graph.links[l.links[c]];if(h&&!e[h.target_id]){d=!0;break}}if(!d)continue}}}},e.Subgraph=o,e.registerNodeType("graph/subgraph",o),n.title="Input",n.desc="Input of the graph",n.prototype.onConfigure=function(){this.updateType()},n.prototype.updateType=function(){var t=this.properties.type;this.type_widget.value=t,this.outputs[0].type!=t&&(e.isValidConnection(this.outputs[0].type,t)||this.disconnectOutput(0),this.outputs[0].type=t),"number"==t?(this.value_widget.type="number",this.value_widget.value=0):"boolean"==t?(this.value_widget.type="toggle",this.value_widget.value=!0):"string"==t?(this.value_widget.type="text",this.value_widget.value=""):(this.value_widget.type=null,this.value_widget.value=null),this.properties.value=this.value_widget.value,this.graph&&this.name_in_graph&&this.graph.changeInputType(this.name_in_graph,t)},n.prototype.onPropertyChanged=function(t,e){if("name"==t){if(""==e||e==this.name_in_graph||"enabled"==e)return!1;this.graph&&(this.name_in_graph?this.graph.renameInput(this.name_in_graph,e):this.graph.addInput(e,this.properties.type)),this.name_widget.value=e,this.name_in_graph=e}else"type"==t&&this.updateType()},n.prototype.getTitle=function(){return this.flags.collapsed?this.properties.name:this.title},n.prototype.onAction=function(t,s){this.properties.type==e.EVENT&&this.triggerSlot(0,s)},n.prototype.onExecute=function(){var t=this.properties.name,e=this.graph.inputs[t];if(!e){this.setOutputData(0,this.properties.value);return}this.setOutputData(0,void 0!==e.value?e.value:this.properties.value)},n.prototype.onRemoved=function(){this.name_in_graph&&this.graph.removeInput(this.name_in_graph)},e.GraphInput=n,e.registerNodeType("graph/input",n),r.title="Output",r.desc="Output of the graph",r.prototype.onPropertyChanged=function(t,e){if("name"==t){if(""==e||e==this.name_in_graph||"enabled"==e)return!1;this.graph&&(this.name_in_graph?this.graph.renameOutput(this.name_in_graph,e):this.graph.addOutput(e,this.properties.type)),this.name_widget.value=e,this.name_in_graph=e}else"type"==t&&this.updateType()},r.prototype.updateType=function(){var t=this.properties.type;this.type_widget&&(this.type_widget.value=t),this.inputs[0].type!=t&&(("action"==t||"event"==t)&&(t=e.EVENT),e.isValidConnection(this.inputs[0].type,t)||this.disconnectInput(0),this.inputs[0].type=t),this.graph&&this.name_in_graph&&this.graph.changeOutputType(this.name_in_graph,t)},r.prototype.onExecute=function(){this._value=this.getInputData(0),this.graph.setOutputData(this.properties.name,this._value)},r.prototype.onAction=function(t,s){this.properties.type==e.ACTION&&this.graph.trigger(this.properties.name,s)},r.prototype.onRemoved=function(){this.name_in_graph&&this.graph.removeOutput(this.name_in_graph)},r.prototype.getTitle=function(){return this.flags.collapsed?this.properties.name:this.title},e.GraphOutput=r,e.registerNodeType("graph/output",r),a.title="Const Number",a.desc="Constant number",a.prototype.onExecute=function(){this.setOutputData(0,parseFloat(this.properties.value))},a.prototype.getTitle=function(){return this.flags.collapsed?this.properties.value:this.title},a.prototype.setValue=function(t){this.setProperty("value",t)},a.prototype.onDrawBackground=function(t){this.outputs[0].label=this.properties.value.toFixed(3)},e.registerNodeType("basic/const",a),u.title="Const Boolean",u.desc="Constant boolean",u.prototype.getTitle=a.prototype.getTitle,u.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)},u.prototype.setValue=a.prototype.setValue,u.prototype.onGetInputs=function(){return[["toggle",e.ACTION]]},u.prototype.onAction=function(t){this.setValue(!this.properties.value)},e.registerNodeType("basic/boolean",u),h.title="Const String",h.desc="Constant string",h.prototype.getTitle=a.prototype.getTitle,h.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)},h.prototype.setValue=a.prototype.setValue,h.prototype.onDropFile=function(t){var e=this,s=new FileReader;s.onload=function(t){e.setProperty("value",t.target.result)},s.readAsText(t)},e.registerNodeType("basic/string",h),l.title="Const Object",l.desc="Constant Object",l.prototype.onExecute=function(){this.setOutputData(0,this._object)},e.registerNodeType("basic/object",l),d.title="Const File",d.desc="Fetches a file from an url",d["@type"]={type:"enum",values:["text","arraybuffer","blob","json"]},d.prototype.onPropertyChanged=function(t,e){"url"==t&&(null==e||""==e?this._data=null:this.fetchFile(e))},d.prototype.onExecute=function(){var t=this.getInputData(0)||this.properties.url;t&&(t!=this._url||this._type!=this.properties.type)&&this.fetchFile(t),this.setOutputData(0,this._data)},d.prototype.setValue=a.prototype.setValue,d.prototype.fetchFile=function(t){var s=this;if(!t||t.constructor!==String){s._data=null,s.boxcolor=null;return}this._url=t,this._type=this.properties.type,"http"==t.substr(0,4)&&e.proxy&&(t=e.proxy+t.substr(t.indexOf(":")+3)),fetch(t).then(function(t){if(!t.ok)throw Error("File not found");return"arraybuffer"==s.properties.type?t.arrayBuffer():"text"==s.properties.type?t.text():"json"==s.properties.type?t.json():"blob"==s.properties.type?t.blob():void 0}).then(function(t){s._data=t,s.boxcolor="#AEA"}).catch(function(e){s._data=null,s.boxcolor="red",console.error("error fetching file:",t)})},d.prototype.onDropFile=function(t){var e=this;this._url=t.name,this._type=this.properties.type,this.properties.url=t.name;var s=new FileReader;if(s.onload=function(t){e.boxcolor="#AEA";var s=t.target.result;"json"==e.properties.type&&(s=JSON.parse(s)),e._data=s},"arraybuffer"==e.properties.type)s.readAsArrayBuffer(t);else if("text"==e.properties.type||"json"==e.properties.type)s.readAsText(t);else if("blob"==e.properties.type)return s.readAsBinaryString(t)},e.registerNodeType("basic/file",d),c.title="JSON Parse",c.desc="Parses JSON String into object",c.prototype.parse=function(){if(this._str)try{this._str=this.getInputData(1),this._obj=JSON.parse(this._str),this.boxcolor="#AEA",this.triggerSlot(0)}catch(t){this.boxcolor="red"}},c.prototype.onExecute=function(){this._str=this.getInputData(1),this.setOutputData(1,this._obj)},c.prototype.onAction=function(t){"parse"==t&&this.parse()},e.registerNodeType("basic/jsonparse",c),f.title="Const Data",f.desc="Constant Data",f.prototype.onPropertyChanged=function(t,e){if(this.widget.value=e,null!=e&&""!=e)try{this._value=JSON.parse(e),this.boxcolor="#AEA"}catch(s){this.boxcolor="red"}},f.prototype.onExecute=function(){this.setOutputData(0,this._value)},f.prototype.setValue=a.prototype.setValue,e.registerNodeType("basic/data",f),g.title="Const Array",g.desc="Constant Array",g.prototype.onPropertyChanged=function(t,e){if(this.widget.value=e,null!=e&&""!=e)try{"["!=e[0]?this._value=JSON.parse("["+e+"]"):this._value=JSON.parse(e),this.boxcolor="#AEA"}catch(s){this.boxcolor="red"}},g.prototype.onExecute=function(){var t=this.getInputData(0);if(t&&t.length){this._value||(this._value=[]),this._value.length=t.length;for(var e=0;e<t.length;++e)this._value[e]=t[e]}this.setOutputData(0,this._value),this.setOutputData(1,this._value&&this._value.length||0)},g.prototype.setValue=a.prototype.setValue,e.registerNodeType("basic/array",g),v.title="Set Array",v.desc="Sets index of array",v.prototype.onExecute=function(){var t=this.getInputData(0);if(t){var e=this.getInputData(1);void 0!==e&&(this.properties.index&&(t[Math.floor(this.properties.index)]=e),this.setOutputData(0,t))}},e.registerNodeType("basic/set_array",v),$.title="Array[i]",$.desc="Returns an element from an array",$.prototype.onExecute=function(){var t=this.getInputData(0),e=this.getInputData(1);null==e&&(e=this.properties.index),null!=t&&null!=e&&this.setOutputData(0,t[Math.floor(Number(e))])},e.registerNodeType("basic/array[]",$),m.title="Table[row][col]",m.desc="Returns an element from a table",m.prototype.onExecute=function(){var t=this.getInputData(0),e=this.getInputData(1),s=this.getInputData(2);if(null==e&&(e=this.properties.row),null==s&&(s=this.properties.column),null!=t&&null!=e&&null!=s){var e=t[Math.floor(Number(e))];e?this.setOutputData(0,e[Math.floor(Number(s))]):this.setOutputData(0,null)}},e.registerNodeType("basic/table[][]",m),y.title="Object property",y.desc="Outputs the property of an object",y.prototype.setValue=function(t){this.properties.value=t,this.widget.value=t},y.prototype.getTitle=function(){return this.flags.collapsed?"in."+this.properties.value:this.title},y.prototype.onPropertyChanged=function(t,e){this.widget.value=e},y.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&this.setOutputData(0,t[this.properties.value])},e.registerNodeType("basic/object_property",y),x.title="Object keys",x.desc="Outputs an array with the keys of an object",x.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&this.setOutputData(0,Object.keys(t))},e.registerNodeType("basic/object_keys",x),_.title="Set Object",_.desc="Adds propertiesrty to object",_.prototype.onExecute=function(){var t=this.getInputData(0);if(t){var e=this.getInputData(1);void 0!==e&&(this.properties.property&&(t[this.properties.property]=e),this.setOutputData(0,t))}},e.registerNodeType("basic/set_object",_),b.title="Merge Objects",b.desc="Creates an object copying properties from others",b.prototype.onExecute=function(){var t=this.getInputData(0),e=this.getInputData(1),s=this._result;if(t)for(var o in t)s[o]=t[o];if(e)for(var o in e)s[o]=e[o];this.setOutputData(0,s)},e.registerNodeType("basic/merge_objects",b),T.title="Variable",T.desc="store/read variable value",T.LITEGRAPH=0,T.GRAPH=1,T.GLOBALSCOPE=2,T["@container"]={type:"enum",values:{litegraph:T.LITEGRAPH,graph:T.GRAPH,global:T.GLOBALSCOPE}},T.prototype.onExecute=function(){var t=this.getContainer();if(this.isInputConnected(0)){this.value=this.getInputData(0),t[this.properties.varname]=this.value,this.setOutputData(0,this.value);return}this.setOutputData(0,t[this.properties.varname])},T.prototype.getContainer=function(){switch(this.properties.container){case T.GRAPH:if(this.graph)return this.graph.vars;return{};case T.GLOBALSCOPE:return t;case T.LITEGRAPH:default:return e.Globals}},T.prototype.getTitle=function(){return this.properties.varname},e.registerNodeType("basic/variable",T),e.wrapFunctionAsNode("basic/length",E,[""],"number"),e.wrapFunctionAsNode("basic/not",function(t){return!t},[""],"boolean"),w.title="Download",w.desc="Download some data",w.prototype.downloadAsFile=function(){if(null!=this.value){var t=null;t=this.value.constructor===String?this.value:JSON.stringify(this.value);var e=new Blob([t]),s=URL.createObjectURL(e),o=document.createElement("a");o.setAttribute("href",s),o.setAttribute("download",this.properties.filename),o.style.display="none",document.body.appendChild(o),o.click(),document.body.removeChild(o),setTimeout(function(){URL.revokeObjectURL(s)},6e4)}},w.prototype.onAction=function(t,e){var s=this;setTimeout(function(){s.downloadAsFile()},100)},w.prototype.onExecute=function(){this.inputs[0]&&(this.value=this.getInputData(0))},w.prototype.getTitle=function(){return this.flags.collapsed?this.properties.filename:this.title},e.registerNodeType("basic/download",w),O.title="Watch",O.desc="Show value of input",O.prototype.onExecute=function(){this.inputs[0]&&(this.value=this.getInputData(0))},O.prototype.getTitle=function(){return this.flags.collapsed?this.inputs[0].label:this.title},O.toString=function(t){if(null==t)return"null";if(t.constructor===Number)return t.toFixed(3);if(t.constructor!==Array)return String(t);for(var e="[",s=0;s<t.length;++s)e+=O.toString(t[s])+(s+1!=t.length?",":"");return e+"]"},O.prototype.onDrawBackground=function(t){this.inputs[0].label=O.toString(this.value)},e.registerNodeType("basic/watch",O),I.title="Cast",I.desc="Allows to connect different types",I.prototype.onExecute=function(){this.setOutputData(0,this.getInputData(0))},e.registerNodeType("basic/cast",I),D.title="Console",D.desc="Show value inside the console",D.prototype.onAction=function(t,e){var s=this.getInputData(1);s||(s=this.properties.msg),s||(s="Event: "+e),"log"==t?console.log(s):"warn"==t?console.warn(s):"error"==t&&console.error(s)},D.prototype.onExecute=function(){var t=this.getInputData(1);t||(t=this.properties.msg),null!=t&&void 0!==t&&(this.properties.msg=t,console.log(t))},D.prototype.onGetInputs=function(){return[["log",e.ACTION],["warn",e.ACTION],["error",e.ACTION]]},e.registerNodeType("basic/console",D),N.title="Alert",N.desc="Show an alert window",N.color="#510",N.prototype.onConfigure=function(t){this.widget.value=t.properties.msg},N.prototype.onAction=function(t,e){var s=this.properties.msg;setTimeout(function(){alert(s)},10)},e.registerNodeType("basic/alert",N),C.prototype.onConfigure=function(t){t.properties.onExecute&&e.allow_scripts?this.compileCode(t.properties.onExecute):console.warn("Script not compiled, LiteGraph.allow_scripts is false")},C.title="Script",C.desc="executes a code (max 256 characters)",C.widgets_info={onExecute:{type:"code"}},C.prototype.onPropertyChanged=function(t,s){"onExecute"==t&&e.allow_scripts?this.compileCode(s):console.warn("Script not compiled, LiteGraph.allow_scripts is false")},C.prototype.compileCode=function(t){if(this._func=null,t.length>256)console.warn("Script too long, max 256 chars");else{for(var e=t.toLowerCase(),s=["script","body","document","eval","nodescript","function"],o=0;o<s.length;++o)if(-1!=e.indexOf(s[o])){console.warn("invalid script");return}try{this._func=Function("A","B","C","DATA","node",t)}catch(n){console.error("Error parsing script"),console.error(n)}}},C.prototype.onExecute=function(){if(this._func)try{var t=this.getInputData(0),e=this.getInputData(1),s=this.getInputData(2);this.setOutputData(0,this._func(t,e,s,this.data,this))}catch(o){console.error("Error in script"),console.error(o)}},C.prototype.onGetOutputs=function(){return[["C",""]]},e.registerNodeType("basic/script",C),S.values=["==","!="],S["@OP"]={type:"enum",title:"operation",values:S.values},S.title="Compare *",S.desc="evaluates condition between A and B",S.prototype.getTitle=function(){return"*A "+this.properties.OP+" *B"},S.prototype.onExecute=function(){var t=this.getInputData(0);void 0===t?t=this.properties.A:this.properties.A=t;var e=this.getInputData(1);void 0===e?e=this.properties.B:this.properties.B=e;var s=!1;if(typeof t==typeof e)switch(this.properties.OP){case"==":case"!=":switch(s=!0,typeof t){case"object":var o=Object.getOwnPropertyNames(t),n=Object.getOwnPropertyNames(e);if(o.length!=n.length){s=!1;break}for(var r=0;r<o.length;r++){var a=o[r];if(t[a]!==e[a]){s=!1;break}}break;default:s=t==e}"!="==this.properties.OP&&(s=!s)}this.setOutputData(0,s),this.setOutputData(1,!s)},e.registerNodeType("basic/CompareValues",S)}(this),function(t){var e=t.LiteGraph;function s(){this.size=[60,30],this.addInput("event",e.ACTION)}function o(){this.size=[60,30],this.addInput("if",""),this.addOutput("true",e.EVENT),this.addOutput("change",e.EVENT),this.addOutput("false",e.EVENT),this.properties={only_on_change:!0},this.prev=0}function n(){var t=this;this.addInput("",e.ACTION),this.addInput("",e.ACTION),this.addInput("",e.ACTION),this.addOutput("",e.EVENT),this.addOutput("",e.EVENT),this.addOutput("",e.EVENT),this.addWidget("button","+",null,function(){t.addInput("",e.ACTION),t.addOutput("",e.EVENT)}),this.size=[90,70],this.flags={horizontal:!0,render_box:!1}}function r(){var t=this;this.addInput("",e.ACTION),this.addInput("",e.ACTION),this.addOutput("",e.EVENT),this.addWidget("button","+",null,function(){t.addInput("",e.ACTION),t.size[0]=90}),this.size=[90,70],this.ready=[]}function a(){var t=this;this.properties={index:0},this.addInput("index","number"),this.addInput("step",e.ACTION),this.addInput("reset",e.ACTION),this.addOutput("index","number"),this.addOutput("",e.EVENT),this.addOutput("",e.EVENT),this.addOutput("",e.EVENT,{removable:!0}),this.addWidget("button","+",null,function(){t.addOutput("",e.EVENT,{removable:!0})}),this.size=[120,120],this.flags={render_box:!1}}function u(){this.size=[60,30],this.addInput("event",e.ACTION),this.addOutput("event",e.EVENT),this.properties={equal_to:"",has_property:"",property_equal_to:""}}function h(){this.addInput("in",e.ACTION),this.addInput("cond","boolean"),this.addOutput("true",e.EVENT),this.addOutput("false",e.EVENT),this.size=[120,60],this._value=!1}function l(){this.addInput("inc",e.ACTION),this.addInput("dec",e.ACTION),this.addInput("reset",e.ACTION),this.addOutput("change",e.EVENT),this.addOutput("num","number"),this.addProperty("doCountExecution",!1,"boolean",{name:"Count Executions"}),this.addWidget("toggle","Count Exec.",this.properties.doCountExecution,"doCountExecution"),this.num=0}function d(){this.size=[60,30],this.addProperty("time_in_ms",1e3),this.addInput("event",e.ACTION),this.addOutput("on_time",e.EVENT),this._pending=[]}function c(){this.addProperty("interval",1e3),this.addProperty("event","tick"),this.addOutput("on_tick",e.EVENT),this.time=0,this.last_interval=1e3,this.triggered=!1}function f(){this.addInput("go",e.ACTION),this.addInput("green",e.ACTION),this.addInput("red",e.ACTION),this.addOutput("continue",e.EVENT),this.addOutput("blocked",e.EVENT),this.addOutput("is_green","boolean"),this._ready=!1,this.properties={};var t=this;this.addWidget("button","reset","",function(){t._ready=!1})}function g(){this.addInput("in",e.ACTION),this.addInput("reset",e.ACTION),this.addOutput("out",e.EVENT),this._once=!1,this.properties={};var t=this;this.addWidget("button","reset","",function(){t._once=!1})}function v(){this.addInput("data",0),this.addInput("assign",e.ACTION),this.addOutput("data",0),this._last_value=null,this.properties={data:null,serialize:!0};var t=this;this.addWidget("button","store","",function(){t.properties.data=t._last_value})}s.title="Log Event",s.desc="Log event in console",s.prototype.onAction=function(t,e,s){console.log(t,e)},e.registerNodeType("events/log",s),o.title="TriggerEvent",o.desc="Triggers event if input evaluates to true",o.prototype.onExecute=function(t,e){var s=this.getInputData(0),o=s!=this.prev;0===this.prev&&(o=!1);var n=o&&this.properties.only_on_change||!o&&!this.properties.only_on_change;s&&n&&this.triggerSlot(0,t,null,e),!s&&n&&this.triggerSlot(2,t,null,e),o&&this.triggerSlot(1,t,null,e),this.prev=s},e.registerNodeType("events/trigger",o),n.title="Sequence",n.desc="Triggers a sequence of events when an event arrives",n.prototype.getTitle=function(){return""},n.prototype.onAction=function(t,e,s){if(this.outputs){s=s||{};for(var o=0;o<this.outputs.length;++o)this.outputs[o],s.action_call?s.action_call=s.action_call+"_seq_"+o:s.action_call=this.id+"_"+(t||"action")+"_seq_"+o+"_"+Math.floor(9999*Math.random()),this.triggerSlot(o,e,null,s)}},e.registerNodeType("events/sequence",n),r.title="WaitAll",r.desc="Wait until all input events arrive then triggers output",r.prototype.getTitle=function(){return""},r.prototype.onDrawBackground=function(t){if(!this.flags.collapsed)for(var s=0;s<this.inputs.length;++s){var o=s*e.NODE_SLOT_HEIGHT+10;t.fillStyle=this.ready[s]?"#AFB":"#000",t.fillRect(20,o,10,10)}},r.prototype.onAction=function(t,e,s,o){if(null!=o){this.ready.length=this.outputs.length,this.ready[o]=!0;for(var n=0;n<this.ready.length;++n)if(!this.ready[n])return;this.reset(),this.triggerSlot(0)}},r.prototype.reset=function(){this.ready.length=0},e.registerNodeType("events/waitAll",r),a.title="Stepper",a.desc="Trigger events sequentially when an tick arrives",a.prototype.onDrawBackground=function(t){if(!this.flags.collapsed){var s=this.properties.index||0;t.fillStyle="#AFB";var o=this.size[0],n=(s+1)*e.NODE_SLOT_HEIGHT+4;t.beginPath(),t.moveTo(o-30,n),t.lineTo(o-30,n+e.NODE_SLOT_HEIGHT),t.lineTo(o-15,n+.5*e.NODE_SLOT_HEIGHT),t.fill()}},a.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&(t=clamp(t=Math.floor(t),0,this.outputs?this.outputs.length-2:0))!=this.properties.index&&(this.properties.index=t,this.triggerSlot(t+1)),this.setOutputData(0,this.properties.index)},a.prototype.onAction=function(t,e){if("reset"==t)this.properties.index=0;else if("step"==t){this.triggerSlot(this.properties.index+1,e);var s=this.outputs?this.outputs.length-1:0;this.properties.index=(this.properties.index+1)%s}},e.registerNodeType("events/stepper",a),u.title="Filter Event",u.desc="Blocks events that do not match the filter",u.prototype.onAction=function(t,e,s){if(null!=e&&(!this.properties.equal_to||this.properties.equal_to==e)){if(this.properties.has_property){var o=e[this.properties.has_property];if(null==o||this.properties.property_equal_to&&this.properties.property_equal_to!=o)return}this.triggerSlot(0,e,null,s)}},e.registerNodeType("events/filter",u),h.title="Branch",h.desc="If condition is true, outputs triggers true, otherwise false",h.prototype.onExecute=function(){this._value=this.getInputData(1)},h.prototype.onAction=function(t,e,s){this._value=this.getInputData(1),this.triggerSlot(this._value?0:1,e,null,s)},e.registerNodeType("events/branch",h),l.title="Counter",l.desc="Counts events",l.prototype.getTitle=function(){return this.flags.collapsed?String(this.num):this.title},l.prototype.onAction=function(t,e,s){var o=this.num;"inc"==t?this.num+=1:"dec"==t?this.num-=1:"reset"==t&&(this.num=0),this.num!=o&&this.trigger("change",this.num)},l.prototype.onDrawBackground=function(t){!this.flags.collapsed&&(t.fillStyle="#AAA",t.font="20px Arial",t.textAlign="center",t.fillText(this.num,.5*this.size[0],.5*this.size[1]))},l.prototype.onExecute=function(){this.properties.doCountExecution&&(this.num+=1),this.setOutputData(1,this.num)},e.registerNodeType("events/counter",l),d.title="Delay",d.desc="Delays one event",d.prototype.onAction=function(t,e,s){var o=this.properties.time_in_ms;o<=0?this.trigger(null,e,s):this._pending.push([o,e])},d.prototype.onExecute=function(t,e){var s=1e3*this.graph.elapsed_time;this.isInputConnected(1)&&(this.properties.time_in_ms=this.getInputData(1));for(var o=0;o<this._pending.length;++o){var n=this._pending[o];n[0]-=s,!(n[0]>0)&&(this._pending.splice(o,1),--o,this.trigger(null,n[1],e))}},d.prototype.onGetInputs=function(){return[["event",e.ACTION],["time_in_ms","number"]]},e.registerNodeType("events/delay",d),c.title="Timer",c.desc="Sends an event every N milliseconds",c.prototype.onStart=function(){this.time=0},c.prototype.getTitle=function(){return"Timer: "+this.last_interval.toString()+"ms"},c.on_color="#AAA",c.off_color="#222",c.prototype.onDrawBackground=function(){this.boxcolor=this.triggered?c.on_color:c.off_color,this.triggered=!1},c.prototype.onExecute=function(){var t=1e3*this.graph.elapsed_time,e=0==this.time;if(this.time+=t,this.last_interval=Math.max(1,0|this.getInputOrProperty("interval")),!e&&(this.time<this.last_interval||isNaN(this.last_interval))){this.inputs&&this.inputs.length>1&&this.inputs[1]&&this.setOutputData(1,!1);return}this.triggered=!0,this.time=this.time%this.last_interval,this.trigger("on_tick",this.properties.event),this.inputs&&this.inputs.length>1&&this.inputs[1]&&this.setOutputData(1,!0)},c.prototype.onGetInputs=function(){return[["interval","number"]]},c.prototype.onGetOutputs=function(){return[["tick","boolean"]]},e.registerNodeType("events/timer",c),f.title="Semaphore Event",f.desc="Until both events are not triggered, it doesnt continue.",f.prototype.onExecute=function(){this.setOutputData(1,this._ready),this.boxcolor=this._ready?"#9F9":"#FA5"},f.prototype.onAction=function(t,e){"go"==t?this.triggerSlot(this._ready?0:1):"green"==t?this._ready=!0:"red"==t&&(this._ready=!1)},e.registerNodeType("events/semaphore",f),g.title="Once",g.desc="Only passes an event once, then gets locked",g.prototype.onAction=function(t,e){"in"!=t||this._once?"reset"==t&&(this._once=!1):(this._once=!0,this.triggerSlot(0,e))},e.registerNodeType("events/once",g),v.title="Data Store",v.desc="Stores data and only changes when event is received",v.prototype.onExecute=function(){this._last_value=this.getInputData(0),this.setOutputData(0,this.properties.data)},v.prototype.onAction=function(t,e,s){this.properties.data=this._last_value},v.prototype.onSerialize=function(t){null!=t.data&&(!1==this.properties.serialize||t.data.constructor!==String&&t.data.constructor!==Number&&t.data.constructor!==Boolean&&t.data.constructor!==Array&&t.data.constructor!==Object)&&(t.data=null)},e.registerNodeType("basic/data_store",v)}(this),function(t){var e=t.LiteGraph;function s(){this.addOutput("",e.EVENT),this.addOutput("","boolean"),this.addProperty("text","click me"),this.addProperty("font_size",30),this.addProperty("message",""),this.size=[164,84],this.clicked=!1}function o(){this.addInput("","boolean"),this.addInput("e",e.ACTION),this.addOutput("v","boolean"),this.addOutput("e",e.EVENT),this.properties={font:"",value:!1},this.size=[160,44]}function n(){this.addOutput("","number"),this.size=[80,60],this.properties={min:-1e3,max:1e3,value:1,step:1},this.old_y=-1,this._remainder=0,this._precision=0,this.mouse_captured=!1}function r(){this.addOutput("","string"),this.addOutput("change",e.EVENT),this.size=[80,60],this.properties={value:"A",values:"A;B;C"},this.old_y=-1,this.mouse_captured=!1,this._values=this.properties.values.split(";");var t=this;this.widgets_up=!0,this.widget=this.addWidget("combo","",this.properties.value,function(e){t.properties.value=e,t.triggerSlot(1,e)},{property:"value",values:this._values})}function a(){this.addOutput("","number"),this.size=[64,84],this.properties={min:0,max:1,value:.5,color:"#7AF",precision:2},this.value=-1}function u(){this.addOutput("","number"),this.properties={value:.5,min:0,max:1,text:"V"};var t=this;this.size=[140,40],this.slider=this.addWidget("slider","V",this.properties.value,function(e){t.properties.value=e},this.properties),this.widgets_up=!0}function h(){this.size=[160,26],this.addOutput("","number"),this.properties={color:"#7AF",min:0,max:1,value:.5},this.value=-1}function l(){this.size=[160,26],this.addInput("","number"),this.properties={min:0,max:1,value:0,color:"#AAF"}}function d(){this.addInputs("",0),this.properties={value:"...",font:"Arial",fontsize:18,color:"#AAA",align:"left",glowSize:0,decimals:1}}function c(){this.size=[200,100],this.properties={borderColor:"#ffffff",bgcolorTop:"#f0f0f0",bgcolorBottom:"#e0e0e0",shadowSize:2,borderRadius:3}}s.title="Button",s.desc="Triggers an event",s.font="Arial",s.prototype.onDrawForeground=function(t){if(!this.flags.collapsed){var e=10;if(t.fillStyle="black",t.fillRect(e+1,e+1,this.size[0]-2*e,this.size[1]-2*e),t.fillStyle="#AAF",t.fillRect(e-1,e-1,this.size[0]-2*e,this.size[1]-2*e),t.fillStyle=this.clicked?"white":this.mouseOver?"#668":"#334",t.fillRect(e,e,this.size[0]-2*e,this.size[1]-2*e),this.properties.text||0===this.properties.text){var o=this.properties.font_size||30;t.textAlign="center",t.fillStyle=this.clicked?"black":"white",t.font=o+"px "+s.font,t.fillText(this.properties.text,.5*this.size[0],.5*this.size[1]+.3*o),t.textAlign="left"}}},s.prototype.onMouseDown=function(t,e){if(e[0]>1&&e[1]>1&&e[0]<this.size[0]-2&&e[1]<this.size[1]-2)return this.clicked=!0,this.setOutputData(1,this.clicked),this.triggerSlot(0,this.properties.message),!0},s.prototype.onExecute=function(){this.setOutputData(1,this.clicked)},s.prototype.onMouseUp=function(t){this.clicked=!1},e.registerNodeType("widget/button",s),o.title="Toggle",o.desc="Toggles between true or false",o.prototype.onDrawForeground=function(t){if(!this.flags.collapsed){var e=.5*this.size[1],s=.25,o=.8*this.size[1];t.font=this.properties.font||(.8*e).toFixed(0)+"px Arial";var n=t.measureText(this.title).width,r=(this.size[0]-(n+e))*.5;t.fillStyle="#AAA",t.fillRect(r,o-e,e,e),t.fillStyle=this.properties.value?"#AEF":"#000",t.fillRect(r+e*s,o-e+e*s,e*(1-2*s),e*(1-2*s)),t.textAlign="left",t.fillStyle="#AAA",t.fillText(this.title,1.2*e+r,.85*o),t.textAlign="left"}},o.prototype.onAction=function(t){this.properties.value=!this.properties.value,this.trigger("e",this.properties.value)},o.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&(this.properties.value=t),this.setOutputData(0,this.properties.value)},o.prototype.onMouseDown=function(t,e){if(e[0]>1&&e[1]>1&&e[0]<this.size[0]-2&&e[1]<this.size[1]-2)return this.properties.value=!this.properties.value,this.graph._version++,this.trigger("e",this.properties.value),!0},e.registerNodeType("widget/toggle",o),n.title="Number",n.desc="Widget to select number value",n.pixels_threshold=10,n.markers_color="#666",n.prototype.onDrawForeground=function(t){var e=.5*this.size[0],s=this.size[1];s>30?(t.fillStyle=n.markers_color,t.beginPath(),t.moveTo(e,.1*s),t.lineTo(e+.1*s,.2*s),t.lineTo(e+-.1*s,.2*s),t.fill(),t.beginPath(),t.moveTo(e,.9*s),t.lineTo(e+.1*s,.8*s),t.lineTo(e+-.1*s,.8*s),t.fill(),t.font=(.7*s).toFixed(1)+"px Arial"):t.font=(.8*s).toFixed(1)+"px Arial",t.textAlign="center",t.font=(.7*s).toFixed(1)+"px Arial",t.fillStyle="#EEE",t.fillText(this.properties.value.toFixed(this._precision),e,.75*s)},n.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)},n.prototype.onPropertyChanged=function(t,e){var s=(this.properties.step+"").split(".");this._precision=s.length>1?s[1].length:0},n.prototype.onMouseDown=function(t,e){if(!(e[1]<0))return this.old_y=t.canvasY,this.captureInput(!0),this.mouse_captured=!0,!0},n.prototype.onMouseMove=function(t){if(this.mouse_captured){var e=this.old_y-t.canvasY;t.shiftKey&&(e*=10),(t.metaKey||t.altKey)&&(e*=.1),this.old_y=t.canvasY;var s=this._remainder+e/n.pixels_threshold;this._remainder=s%1,s|=0;var o=clamp(this.properties.value+s*this.properties.step,this.properties.min,this.properties.max);this.properties.value=o,this.graph._version++,this.setDirtyCanvas(!0)}},n.prototype.onMouseUp=function(t,e){if(t.click_time<200){var s=e[1]>.5*this.size[1]?-1:1;this.properties.value=clamp(this.properties.value+s*this.properties.step,this.properties.min,this.properties.max),this.graph._version++,this.setDirtyCanvas(!0)}this.mouse_captured&&(this.mouse_captured=!1,this.captureInput(!1))},e.registerNodeType("widget/number",n),r.title="Combo",r.desc="Widget to select from a list",r.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)},r.prototype.onPropertyChanged=function(t,e){"values"==t?(this._values=e.split(";"),this.widget.options.values=this._values):"value"==t&&(this.widget.value=e)},e.registerNodeType("widget/combo",r),a.title="Knob",a.desc="Circular controller",a.size=[80,100],a.prototype.onDrawForeground=function(t){if(!this.flags.collapsed){-1==this.value&&(this.value=(this.properties.value-this.properties.min)/(this.properties.max-this.properties.min));var e=.5*this.size[0],s=.5*this.size[1],o=.5*Math.min(this.size[0],this.size[1])-5;t.globalAlpha=1,t.save(),t.translate(e,s),t.rotate(.75*Math.PI),t.fillStyle="rgba(0,0,0,0.5)",t.beginPath(),t.moveTo(0,0),t.arc(0,0,o,0,1.5*Math.PI),t.fill(),t.strokeStyle="black",t.fillStyle=this.properties.color,t.lineWidth=2,t.beginPath(),t.moveTo(0,0),t.arc(0,0,o-4,0,1.5*Math.PI*Math.max(.01,this.value)),t.closePath(),t.fill(),t.lineWidth=1,t.globalAlpha=1,t.restore(),t.fillStyle="black",t.beginPath(),t.arc(e,s,.75*o,0,2*Math.PI,!0),t.fill(),t.fillStyle=this.mouseOver?"white":this.properties.color,t.beginPath();var n=this.value*Math.PI*1.5+.75*Math.PI;t.arc(e+Math.cos(n)*o*.65,s+Math.sin(n)*o*.65,.05*o,0,2*Math.PI,!0),t.fill(),t.fillStyle=this.mouseOver?"white":"#AAA",t.font=Math.floor(.5*o)+"px Arial",t.textAlign="center",t.fillText(this.properties.value.toFixed(this.properties.precision),e,s+.15*o)}},a.prototype.onExecute=function(){this.setOutputData(0,this.properties.value),this.boxcolor=e.colorToString([this.value,this.value,this.value])},a.prototype.onMouseDown=function(t){return this.center=[.5*this.size[0],.5*this.size[1]+20],this.radius=.5*this.size[0],!(t.canvasY-this.pos[1]<20||e.distance([t.canvasX,t.canvasY],[this.pos[0]+this.center[0],this.pos[1]+this.center[1]])>this.radius)&&(this.oldmouse=[t.canvasX-this.pos[0],t.canvasY-this.pos[1]],this.captureInput(!0),!0)},a.prototype.onMouseMove=function(t){if(this.oldmouse){var e=[t.canvasX-this.pos[0],t.canvasY-this.pos[1]],s=this.value;(s-=(e[1]-this.oldmouse[1])*.01)>1?s=1:s<0&&(s=0),this.value=s,this.properties.value=this.properties.min+(this.properties.max-this.properties.min)*this.value,this.oldmouse=e,this.setDirtyCanvas(!0)}},a.prototype.onMouseUp=function(t){this.oldmouse&&(this.oldmouse=null,this.captureInput(!1))},a.prototype.onPropertyChanged=function(t,e){if("min"==t||"max"==t||"value"==t)return this.properties[t]=parseFloat(e),!0},e.registerNodeType("widget/knob",a),u.title="Inner Slider",u.prototype.onPropertyChanged=function(t,e){"value"==t&&(this.slider.value=e)},u.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)},e.registerNodeType("widget/internal_slider",u),h.title="H.Slider",h.desc="Linear slider controller",h.prototype.onDrawForeground=function(t){-1==this.value&&(this.value=(this.properties.value-this.properties.min)/(this.properties.max-this.properties.min)),t.globalAlpha=1,t.lineWidth=1,t.fillStyle="#000",t.fillRect(2,2,this.size[0]-4,this.size[1]-4),t.fillStyle=this.properties.color,t.beginPath(),t.rect(4,4,(this.size[0]-8)*this.value,this.size[1]-8),t.fill()},h.prototype.onExecute=function(){this.properties.value=this.properties.min+(this.properties.max-this.properties.min)*this.value,this.setOutputData(0,this.properties.value),this.boxcolor=e.colorToString([this.value,this.value,this.value])},h.prototype.onMouseDown=function(t){return!(t.canvasY-this.pos[1]<0)&&(this.oldmouse=[t.canvasX-this.pos[0],t.canvasY-this.pos[1]],this.captureInput(!0),!0)},h.prototype.onMouseMove=function(t){if(this.oldmouse){var e,s=[t.canvasX-this.pos[0],t.canvasY-this.pos[1]],o=this.value;(o+=(s[0]-this.oldmouse[0])/this.size[0])>1?o=1:o<0&&(o=0),this.value=o,this.oldmouse=s,this.setDirtyCanvas(!0)}},h.prototype.onMouseUp=function(t){this.oldmouse=null,this.captureInput(!1)},h.prototype.onMouseLeave=function(t){},e.registerNodeType("widget/hslider",h),l.title="Progress",l.desc="Shows data in linear progress",l.prototype.onExecute=function(){var t=this.getInputData(0);void 0!=t&&(this.properties.value=t)},l.prototype.onDrawForeground=function(t){t.lineWidth=1,t.fillStyle=this.properties.color;var e=(this.properties.value-this.properties.min)/(this.properties.max-this.properties.min);e=Math.max(0,e=Math.min(1,e)),t.fillRect(2,2,(this.size[0]-4)*e,this.size[1]-4)},e.registerNodeType("widget/progress",l),d.title="Text",d.desc="Shows the input value",d.widgets=[{name:"resize",text:"Resize box",type:"button"},{name:"led_text",text:"LED",type:"minibutton"},{name:"normal_text",text:"Normal",type:"minibutton"}],d.prototype.onDrawForeground=function(t){t.fillStyle=this.properties.color;var e=this.properties.value;this.properties.glowSize?(t.shadowColor=this.properties.color,t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=this.properties.glowSize):t.shadowColor="transparent";var s=this.properties.fontsize;if(t.textAlign=this.properties.align,t.font=s.toString()+"px "+this.properties.font,this.str="number"==typeof e?e.toFixed(this.properties.decimals):e,"string"==typeof this.str)for(var o=this.str.replace(/[\r\n]/g,"\\n").split("\\n"),n=0;n<o.length;n++)t.fillText(o[n],"left"==this.properties.align?15:this.size[0]-15,-.15*s+s*(parseInt(n)+1));t.shadowColor="transparent",this.last_ctx=t,t.textAlign="left"},d.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&(this.properties.value=t)},d.prototype.resize=function(){if(this.last_ctx){var t=this.str.split("\\n");this.last_ctx.font=this.properties.fontsize+"px "+this.properties.font;for(var e=0,s=0;s<t.length;s++){var o=this.last_ctx.measureText(t[s]).width;e<o&&(e=o)}this.size[0]=e+20,this.size[1]=4+t.length*this.properties.fontsize,this.setDirtyCanvas(!0)}},d.prototype.onPropertyChanged=function(t,e){return this.properties[t]=e,this.str="number"==typeof e?e.toFixed(3):e,!0},e.registerNodeType("widget/text",d),c.title="Panel",c.desc="Non interactive panel",c.widgets=[{name:"update",text:"Update",type:"button"}],c.prototype.createGradient=function(t){if(""==this.properties.bgcolorTop||""==this.properties.bgcolorBottom){this.lineargradient=0;return}this.lineargradient=t.createLinearGradient(0,0,0,this.size[1]),this.lineargradient.addColorStop(0,this.properties.bgcolorTop),this.lineargradient.addColorStop(1,this.properties.bgcolorBottom)},c.prototype.onDrawForeground=function(t){if(!this.flags.collapsed)null==this.lineargradient&&this.createGradient(t),this.lineargradient&&(t.lineWidth=1,t.strokeStyle=this.properties.borderColor,t.fillStyle=this.lineargradient,this.properties.shadowSize?(t.shadowColor="#000",t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=this.properties.shadowSize):t.shadowColor="transparent",t.roundRect(0,0,this.size[0]-1,this.size[1]-1,this.properties.shadowSize),t.fill(),t.shadowColor="transparent",t.stroke())},e.registerNodeType("widget/panel",c)}(this),function(t){var e=t.LiteGraph;function s(){this.addOutput("left_x_axis","number"),this.addOutput("left_y_axis","number"),this.addOutput("button_pressed",e.EVENT),this.properties={gamepad_index:0,threshold:.1},this._left_axis=new Float32Array(2),this._right_axis=new Float32Array(2),this._triggers=new Float32Array(2),this._previous_buttons=new Uint8Array(17),this._current_buttons=new Uint8Array(17)}s.title="Gamepad",s.desc="gets the input of the gamepad",s.CENTER=0,s.LEFT=1,s.RIGHT=2,s.UP=4,s.DOWN=8,s.zero=new Float32Array(2),s.buttons=["a","b","x","y","lb","rb","lt","rt","back","start","ls","rs","home"],s.prototype.onExecute=function(){var t=this.getGamepad(),e=this.properties.threshold||0;if(t&&(this._left_axis[0]=Math.abs(t.xbox.axes.lx)>e?t.xbox.axes.lx:0,this._left_axis[1]=Math.abs(t.xbox.axes.ly)>e?t.xbox.axes.ly:0,this._right_axis[0]=Math.abs(t.xbox.axes.rx)>e?t.xbox.axes.rx:0,this._right_axis[1]=Math.abs(t.xbox.axes.ry)>e?t.xbox.axes.ry:0,this._triggers[0]=Math.abs(t.xbox.axes.ltrigger)>e?t.xbox.axes.ltrigger:0,this._triggers[1]=Math.abs(t.xbox.axes.rtrigger)>e?t.xbox.axes.rtrigger:0),this.outputs)for(var o=0;o<this.outputs.length;o++){var n=this.outputs[o];if(n.links&&n.links.length){var r=null;if(t)switch(n.name){case"left_axis":r=this._left_axis;break;case"right_axis":r=this._right_axis;break;case"left_x_axis":r=this._left_axis[0];break;case"left_y_axis":r=this._left_axis[1];break;case"right_x_axis":r=this._right_axis[0];break;case"right_y_axis":r=this._right_axis[1];break;case"trigger_left":r=this._triggers[0];break;case"trigger_right":r=this._triggers[1];break;case"a_button":r=t.xbox.buttons.a?1:0;break;case"b_button":r=t.xbox.buttons.b?1:0;break;case"x_button":r=t.xbox.buttons.x?1:0;break;case"y_button":r=t.xbox.buttons.y?1:0;break;case"lb_button":r=t.xbox.buttons.lb?1:0;break;case"rb_button":r=t.xbox.buttons.rb?1:0;break;case"ls_button":r=t.xbox.buttons.ls?1:0;break;case"rs_button":r=t.xbox.buttons.rs?1:0;break;case"hat_left":r=t.xbox.hatmap&s.LEFT;break;case"hat_right":r=t.xbox.hatmap&s.RIGHT;break;case"hat_up":r=t.xbox.hatmap&s.UP;break;case"hat_down":r=t.xbox.hatmap&s.DOWN;break;case"hat":r=t.xbox.hatmap;break;case"start_button":r=t.xbox.buttons.start?1:0;break;case"back_button":r=t.xbox.buttons.back?1:0;break;case"button_pressed":for(var a=0;a<this._current_buttons.length;++a)this._current_buttons[a]&&!this._previous_buttons[a]&&this.triggerSlot(o,s.buttons[a])}else switch(n.name){case"button_pressed":break;case"left_axis":case"right_axis":r=s.zero;break;default:r=0}this.setOutputData(o,r)}}},s.mapping={a:0,b:1,x:2,y:3,lb:4,rb:5,lt:6,rt:7,back:8,start:9,ls:10,rs:11},s.mapping_array=["a","b","x","y","lb","rb","lt","rt","back","start","ls","rs"],s.prototype.getGamepad=function(){var t=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;if(!t)return null;var e=t.call(navigator),o=null;this._previous_buttons.set(this._current_buttons);for(var n=this.properties.gamepad_index;n<4;n++)if(e[n]){o=e[n];var r=this.xbox_mapping;r||(r=this.xbox_mapping={axes:[],buttons:{},hat:"",hatmap:s.CENTER}),r.axes.lx=o.axes[0],r.axes.ly=o.axes[1],r.axes.rx=o.axes[2],r.axes.ry=o.axes[3],r.axes.ltrigger=o.buttons[6].value,r.axes.rtrigger=o.buttons[7].value,r.hat="",r.hatmap=s.CENTER;for(var a=0;a<o.buttons.length;a++)if(this._current_buttons[a]=o.buttons[a].pressed,a<12)r.buttons[s.mapping_array[a]]=o.buttons[a].pressed,o.buttons[a].was_pressed&&this.trigger(s.mapping_array[a]+"_button_event");else switch(a){case 12:o.buttons[a].pressed&&(r.hat+="up",r.hatmap|=s.UP);break;case 13:o.buttons[a].pressed&&(r.hat+="down",r.hatmap|=s.DOWN);break;case 14:o.buttons[a].pressed&&(r.hat+="left",r.hatmap|=s.LEFT);break;case 15:o.buttons[a].pressed&&(r.hat+="right",r.hatmap|=s.RIGHT);break;case 16:r.buttons.home=o.buttons[a].pressed}return o.xbox=r,o}},s.prototype.onDrawBackground=function(t){if(!this.flags.collapsed){var e=this._left_axis,s=this._right_axis;t.strokeStyle="#88A",t.strokeRect((e[0]+1)*.5*this.size[0]-4,(e[1]+1)*.5*this.size[1]-4,8,8),t.strokeStyle="#8A8",t.strokeRect((s[0]+1)*.5*this.size[0]-4,(s[1]+1)*.5*this.size[1]-4,8,8);var o=this.size[1]/this._current_buttons.length;t.fillStyle="#AEB";for(var n=0;n<this._current_buttons.length;++n)this._current_buttons[n]&&t.fillRect(0,o*n,6,o)}},s.prototype.onGetOutputs=function(){return[["left_axis","vec2"],["right_axis","vec2"],["left_x_axis","number"],["left_y_axis","number"],["right_x_axis","number"],["right_y_axis","number"],["trigger_left","number"],["trigger_right","number"],["a_button","number"],["b_button","number"],["x_button","number"],["y_button","number"],["lb_button","number"],["rb_button","number"],["ls_button","number"],["rs_button","number"],["start_button","number"],["back_button","number"],["a_button_event",e.EVENT],["b_button_event",e.EVENT],["x_button_event",e.EVENT],["y_button_event",e.EVENT],["lb_button_event",e.EVENT],["rb_button_event",e.EVENT],["ls_button_event",e.EVENT],["rs_button_event",e.EVENT],["start_button_event",e.EVENT],["back_button_event",e.EVENT],["hat_left","number"],["hat_right","number"],["hat_up","number"],["hat_down","number"],["hat","number"],["button_pressed",e.EVENT]]},e.registerNodeType("input/gamepad",s)}(this),function(t){var e=t.LiteGraph;function s(){this.addInput("in",0),this.addOutput("out",0),this.size=[80,30]}function o(){this.addInput("in"),this.addOutput("out"),this.size=[80,30]}function n(){this.addInput("in"),this.addOutput("out")}function r(){this.addInput("in","number",{locked:!0}),this.addOutput("out","number",{locked:!0}),this.addOutput("clamped","number",{locked:!0}),this.addProperty("in",0),this.addProperty("in_min",0),this.addProperty("in_max",1),this.addProperty("out_min",0),this.addProperty("out_max",1),this.size=[120,50]}function a(){this.addOutput("value","number"),this.addProperty("min",0),this.addProperty("max",1),this.size=[80,30]}function u(){this.addInput("in","number"),this.addOutput("out","number"),this.addProperty("min",0),this.addProperty("max",1),this.addProperty("smooth",!0),this.addProperty("seed",0),this.addProperty("octaves",1),this.addProperty("persistence",.8),this.addProperty("speed",1),this.size=[90,30]}function h(){this.addOutput("out","number"),this.addProperty("min_time",1),this.addProperty("max_time",2),this.addProperty("duration",.2),this.size=[90,30],this._remaining_time=0,this._blink_time=0}function l(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30],this.addProperty("min",0),this.addProperty("max",1)}function d(){this.properties={f:.5},this.addInput("A","number"),this.addInput("B","number"),this.addOutput("out","number")}function c(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30]}function f(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30]}function g(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30]}function v(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30],this.properties={A:0,B:1}}function $(){this.addInput("in","number",{label:""}),this.addOutput("out","number",{label:""}),this.size=[80,30],this.addProperty("factor",1)}function m(){this.addInput("v","boolean"),this.addInput("A"),this.addInput("B"),this.addOutput("out")}function y(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30],this.addProperty("samples",10),this._values=new Float32Array(10),this._current=0}function x(){this.addInput("in","number"),this.addOutput("out","number"),this.addProperty("factor",.1),this.size=[80,30],this._value=null}function _(){this.addInput("A","number,array,object"),this.addInput("B","number"),this.addOutput("=","number"),this.addProperty("A",1),this.addProperty("B",1),this.addProperty("OP","+","enum",{values:_.values}),this._func=_.funcs[this.properties.OP],this._result=[]}function b(){this.addInput("A","number"),this.addInput("B","number"),this.addOutput("A==B","boolean"),this.addOutput("A!=B","boolean"),this.addProperty("A",0),this.addProperty("B",0)}function T(){this.addInput("A","number"),this.addInput("B","number"),this.addOutput("true","boolean"),this.addOutput("false","boolean"),this.addProperty("A",1),this.addProperty("B",1),this.addProperty("OP",">","enum",{values:T.values}),this.addWidget("combo","Cond.",this.properties.OP,{property:"OP",values:T.values}),this.size=[80,60]}function E(){this.addInput("in",0),this.addInput("cond","boolean"),this.addOutput("true",0),this.addOutput("false",0),this.size=[80,60]}function w(){this.addInput("inc","number"),this.addOutput("total","number"),this.addProperty("increment",1),this.addProperty("value",0)}function O(){this.addInput("v","number"),this.addOutput("sin","number"),this.addProperty("amplitude",1),this.addProperty("offset",0),this.bgImageUrl="nodes/imgs/icon-sin.png"}function I(){this.addInput("x","number"),this.addInput("y","number"),this.addOutput("","number"),this.properties={x:1,y:1,formula:"x+y"},this.code_widget=this.addWidget("text","F(x,y)",this.properties.formula,function(t,e,s){s.properties.formula=t}),this.addWidget("toggle","allow",e.allow_scripts,function(t){e.allow_scripts=t}),this._func=null}function D(){this.addInput("vec2","vec2"),this.addOutput("x","number"),this.addOutput("y","number")}function N(){this.addInputs([["x","number"],["y","number"]]),this.addOutput("vec2","vec2"),this.properties={x:0,y:0},this._data=new Float32Array(2)}function C(){this.addInput("vec3","vec3"),this.addOutput("x","number"),this.addOutput("y","number"),this.addOutput("z","number")}function S(){this.addInputs([["x","number"],["y","number"],["z","number"]]),this.addOutput("vec3","vec3"),this.properties={x:0,y:0,z:0},this._data=new Float32Array(3)}function A(){this.addInput("vec4","vec4"),this.addOutput("x","number"),this.addOutput("y","number"),this.addOutput("z","number"),this.addOutput("w","number")}function k(){this.addInputs([["x","number"],["y","number"],["z","number"],["w","number"]]),this.addOutput("vec4","vec4"),this.properties={x:0,y:0,z:0,w:0},this._data=new Float32Array(4)}s.title="Converter",s.desc="type A to type B",s.prototype.onExecute=function(){var t=this.getInputData(0);if(null!=t&&this.outputs)for(var e=0;e<this.outputs.length;e++){var s=this.outputs[e];if(s.links&&s.links.length){var o=null;switch(s.name){case"number":o=t.length?t[0]:parseFloat(t);break;case"vec2":case"vec3":case"vec4":var o=null,n=1;switch(s.name){case"vec2":n=2;break;case"vec3":n=3;break;case"vec4":n=4}var o=new Float32Array(n);if(t.length)for(var r=0;r<t.length&&r<o.length;r++)o[r]=t[r];else o[0]=parseFloat(t)}this.setOutputData(e,o)}}},s.prototype.onGetOutputs=function(){return[["number","number"],["vec2","vec2"],["vec3","vec3"],["vec4","vec4"]]},e.registerNodeType("math/converter",s),o.title="Bypass",o.desc="removes the type",o.prototype.onExecute=function(){var t=this.getInputData(0);this.setOutputData(0,t)},e.registerNodeType("math/bypass",o),n.title="to Number",n.desc="Cast to number",n.prototype.onExecute=function(){var t=this.getInputData(0);this.setOutputData(0,Number(t))},e.registerNodeType("math/to_number",n),r.title="Range",r.desc="Convert a number from one range to another",r.prototype.getTitle=function(){return this.flags.collapsed?(this._last_v||0).toFixed(2):this.title},r.prototype.onExecute=function(){if(this.inputs)for(var t=0;t<this.inputs.length;t++){var e=this.inputs[t],s=this.getInputData(t);void 0!==s&&(this.properties[e.name]=s)}var s=this.properties.in;(null==s||s.constructor!==Number)&&(s=0);var o=this.properties.in_min,n=this.properties.in_max,r=this.properties.out_min,a=this.properties.out_max;this._last_v=(s-o)/(n-o)*(a-r)+r,this.setOutputData(0,this._last_v),this.setOutputData(1,clamp(this._last_v,r,a))},r.prototype.onDrawBackground=function(t){this._last_v?this.outputs[0].label=this._last_v.toFixed(3):this.outputs[0].label="?"},r.prototype.onGetInputs=function(){return[["in_min","number"],["in_max","number"],["out_min","number"],["out_max","number"]]},e.registerNodeType("math/range",r),a.title="Rand",a.desc="Random number",a.prototype.onExecute=function(){if(this.inputs)for(var t=0;t<this.inputs.length;t++){var e=this.inputs[t],s=this.getInputData(t);void 0!==s&&(this.properties[e.name]=s)}var o=this.properties.min,n=this.properties.max;this._last_v=Math.random()*(n-o)+o,this.setOutputData(0,this._last_v)},a.prototype.onDrawBackground=function(t){this.outputs[0].label=(this._last_v||0).toFixed(3)},a.prototype.onGetInputs=function(){return[["min","number"],["max","number"]]},e.registerNodeType("math/rand",a),u.title="Noise",u.desc="Random number with temporal continuity",u.data=null,u.getValue=function(t,e){if(!u.data){u.data=new Float32Array(1024);for(var s=0;s<u.data.length;++s)u.data[s]=Math.random()}(t%=1024)<0&&(t+=1024);var o,n=Math.floor(t),t=t-n,r=u.data[n];return e&&(t=t*t*t*(t*(6*t-15)+10)),r*(1-t)+u.data[1023==n?0:n+1]*t},u.prototype.onExecute=function(){var t=this.getInputData(0)||0,e=this.properties.octaves||1,s=0,o=1;t+=this.properties.seed||0;for(var n=this.properties.speed||1,r=0,a=0;a<e&&(s+=u.getValue(t*(1+a)*n,this.properties.smooth)*o,r+=o,!((o*=this.properties.persistence)<.001));++a);s/=r;var h=this.properties.min,l=this.properties.max;this._last_v=s*(l-h)+h,this.setOutputData(0,this._last_v)},u.prototype.onDrawBackground=function(t){this.outputs[0].label=(this._last_v||0).toFixed(3)},e.registerNodeType("math/noise",u),h.title="Spikes",h.desc="spike every random time",h.prototype.onExecute=function(){var t=this.graph.elapsed_time;this._remaining_time-=t,this._blink_time-=t;var e=0;this._blink_time>0&&(e=1/(Math.pow(8*(this._blink_time/this.properties.duration)-4,4)+1)),this._remaining_time<0?(this._remaining_time=Math.random()*(this.properties.max_time-this.properties.min_time)+this.properties.min_time,this._blink_time=this.properties.duration,this.boxcolor="#FFF"):this.boxcolor="#000",this.setOutputData(0,e)},e.registerNodeType("math/spikes",h),l.title="Clamp",l.desc="Clamp number between min and max",l.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&(t=Math.max(this.properties.min,t),t=Math.min(this.properties.max,t),this.setOutputData(0,t))},l.prototype.getCode=function(t){var e="";return this.isInputConnected(0)&&(e+="clamp({{0}},"+this.properties.min+","+this.properties.max+")"),e},e.registerNodeType("math/clamp",l),d.title="Lerp",d.desc="Linear Interpolation",d.prototype.onExecute=function(){var t=this.getInputData(0);null==t&&(t=0);var e=this.getInputData(1);null==e&&(e=0);var s=this.properties.f,o=this.getInputData(2);void 0!==o&&(s=o),this.setOutputData(0,t*(1-s)+e*s)},d.prototype.onGetInputs=function(){return[["f","number"]]},e.registerNodeType("math/lerp",d),c.title="Abs",c.desc="Absolute",c.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&this.setOutputData(0,Math.abs(t))},e.registerNodeType("math/abs",c),f.title="Floor",f.desc="Floor number to remove fractional part",f.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&this.setOutputData(0,Math.floor(t))},e.registerNodeType("math/floor",f),g.title="Frac",g.desc="Returns fractional part",g.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&this.setOutputData(0,t%1)},e.registerNodeType("math/frac",g),v.title="Smoothstep",v.desc="Smoothstep",v.prototype.onExecute=function(){var t=this.getInputData(0);if(void 0!==t){var e,s=this.properties.A;t=(t=clamp((t-s)/(this.properties.B-s),0,1))*t*(3-2*t),this.setOutputData(0,t)}},e.registerNodeType("math/smoothstep",v),$.title="Scale",$.desc="v * factor",$.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&this.setOutputData(0,t*this.properties.factor)},e.registerNodeType("math/scale",$),m.title="Gate",m.desc="if v is true, then outputs A, otherwise B",m.prototype.onExecute=function(){var t=this.getInputData(0);this.setOutputData(0,this.getInputData(t?1:2))},e.registerNodeType("math/gate",m),y.title="Average",y.desc="Average Filter",y.prototype.onExecute=function(){var t=this.getInputData(0);null==t&&(t=0);var e=this._values.length;this._values[this._current%e]=t,this._current+=1,this._current>e&&(this._current=0);for(var s=0,o=0;o<e;++o)s+=this._values[o];this.setOutputData(0,s/e)},y.prototype.onPropertyChanged=function(t,e){e<1&&(e=1),this.properties.samples=Math.round(e);var s=this._values;this._values=new Float32Array(this.properties.samples),s.length<=this._values.length?this._values.set(s):this._values.set(s.subarray(0,this._values.length))},e.registerNodeType("math/average",y),x.title="TendTo",x.desc="moves the output value always closer to the input",x.prototype.onExecute=function(){var t=this.getInputData(0);null==t&&(t=0);var e=this.properties.factor;null==this._value?this._value=t:this._value=this._value*(1-e)+t*e,this.setOutputData(0,this._value)},e.registerNodeType("math/tendTo",x),_.values=["+","-","*","/","%","^","max","min"],_.funcs={"+":function(t,e){return t+e},"-":function(t,e){return t-e},x:function(t,e){return t*e},X:function(t,e){return t*e},"*":function(t,e){return t*e},"/":function(t,e){return t/e},"%":function(t,e){return t%e},"^":function(t,e){return Math.pow(t,e)},max:function(t,e){return Math.max(t,e)},min:function(t,e){return Math.min(t,e)}},_.title="Operation",_.desc="Easy math operators",_["@OP"]={type:"enum",title:"operation",values:_.values},_.size=[100,60],_.prototype.getTitle=function(){return"max"==this.properties.OP||"min"==this.properties.OP?this.properties.OP+"(A,B)":"A "+this.properties.OP+" B"},_.prototype.setValue=function(t){"string"==typeof t&&(t=parseFloat(t)),this.properties.value=t},_.prototype.onPropertyChanged=function(t,e){"OP"!=t||(this._func=_.funcs[this.properties.OP],this._func||(console.warn("Unknown operation: "+this.properties.OP),this._func=function(t){return t}))},_.prototype.onExecute=function(){var t,e=this.getInputData(0),s=this.getInputData(1);null!=e?e.constructor===Number&&(this.properties.A=e):e=this.properties.A,null!=s?this.properties.B=s:s=this.properties.B;var o=_.funcs[this.properties.OP];if(e.constructor===Number)t=0,t=o(e,s);else if(e.constructor===Array){(t=this._result).length=e.length;for(var n=0;n<e.length;++n)t[n]=o(e[n],s)}else for(var n in t={},e)t[n]=o(e[n],s);this.setOutputData(0,t)},_.prototype.onDrawBackground=function(t){!this.flags.collapsed&&(t.font="40px Arial",t.fillStyle="#666",t.textAlign="center",t.fillText(this.properties.OP,.5*this.size[0],(this.size[1]+e.NODE_TITLE_HEIGHT)*.5),t.textAlign="left")},e.registerNodeType("math/operation",_),e.registerSearchboxExtra("math/operation","MAX",{properties:{OP:"max"},title:"MAX()"}),e.registerSearchboxExtra("math/operation","MIN",{properties:{OP:"min"},title:"MIN()"}),b.title="Compare",b.desc="compares between two values",b.prototype.onExecute=function(){var t=this.getInputData(0),e=this.getInputData(1);void 0!==t?this.properties.A=t:t=this.properties.A,void 0!==e?this.properties.B=e:e=this.properties.B;for(var s=0,o=this.outputs.length;s<o;++s){var n,r=this.outputs[s];if(r.links&&r.links.length){switch(r.name){case"A==B":n=t==e;break;case"A!=B":n=t!=e;break;case"A>B":n=t>e;break;case"A<B":n=t<e;break;case"A<=B":n=t<=e;break;case"A>=B":n=t>=e}this.setOutputData(s,n)}}},b.prototype.onGetOutputs=function(){return[["A==B","boolean"],["A!=B","boolean"],["A>B","boolean"],["A<B","boolean"],["A>=B","boolean"],["A<=B","boolean"]]},e.registerNodeType("math/compare",b),e.registerSearchboxExtra("math/compare","==",{outputs:[["A==B","boolean"]],title:"A==B"}),e.registerSearchboxExtra("math/compare","!=",{outputs:[["A!=B","boolean"]],title:"A!=B"}),e.registerSearchboxExtra("math/compare",">",{outputs:[["A>B","boolean"]],title:"A>B"}),e.registerSearchboxExtra("math/compare","<",{outputs:[["A<B","boolean"]],title:"A<B"}),e.registerSearchboxExtra("math/compare",">=",{outputs:[["A>=B","boolean"]],title:"A>=B"}),e.registerSearchboxExtra("math/compare","<=",{outputs:[["A<=B","boolean"]],title:"A<=B"}),T.values=[">","<","==","!=","<=",">=","||","&&"],T["@OP"]={type:"enum",title:"operation",values:T.values},T.title="Condition",T.desc="evaluates condition between A and B",T.prototype.getTitle=function(){return"A "+this.properties.OP+" B"},T.prototype.onExecute=function(){var t=this.getInputData(0);void 0===t?t=this.properties.A:this.properties.A=t;var e=this.getInputData(1);void 0===e?e=this.properties.B:this.properties.B=e;var s=!0;switch(this.properties.OP){case">":s=t>e;break;case"<":s=t<e;break;case"==":s=t==e;break;case"!=":s=t!=e;break;case"<=":s=t<=e;break;case">=":s=t>=e;break;case"||":s=t||e;break;case"&&":s=t&&e}this.setOutputData(0,s),this.setOutputData(1,!s)},e.registerNodeType("math/condition",T),E.title="Branch",E.desc="If condition is true, outputs IN in true, otherwise in false",E.prototype.onExecute=function(){var t=this.getInputData(0);this.getInputData(1)?(this.setOutputData(0,t),this.setOutputData(1,null)):(this.setOutputData(0,null),this.setOutputData(1,t))},e.registerNodeType("math/branch",E),w.title="Accumulate",w.desc="Increments a value every time",w.prototype.onExecute=function(){null===this.properties.value&&(this.properties.value=0);var t=this.getInputData(0);null!==t?this.properties.value+=t:this.properties.value+=this.properties.increment,this.setOutputData(0,this.properties.value)},e.registerNodeType("math/accumulate",w),O.title="Trigonometry",O.desc="Sin Cos Tan",O.prototype.onExecute=function(){var t=this.getInputData(0);null==t&&(t=0);var e=this.properties.amplitude,s=this.findInputSlot("amplitude");-1!=s&&(e=this.getInputData(s));var o=this.properties.offset;-1!=(s=this.findInputSlot("offset"))&&(o=this.getInputData(s));for(var n=0,r=this.outputs.length;n<r;++n){var a,u=this.outputs[n];switch(u.name){case"sin":a=Math.sin(t);break;case"cos":a=Math.cos(t);break;case"tan":a=Math.tan(t);break;case"asin":a=Math.asin(t);break;case"acos":a=Math.acos(t);break;case"atan":a=Math.atan(t)}this.setOutputData(n,e*a+o)}},O.prototype.onGetInputs=function(){return[["v","number"],["amplitude","number"],["offset","number"]]},O.prototype.onGetOutputs=function(){return[["sin","number"],["cos","number"],["tan","number"],["asin","number"],["acos","number"],["atan","number"]]},e.registerNodeType("math/trigonometry",O),e.registerSearchboxExtra("math/trigonometry","SIN()",{outputs:[["sin","number"]],title:"SIN()"}),e.registerSearchboxExtra("math/trigonometry","COS()",{outputs:[["cos","number"]],title:"COS()"}),e.registerSearchboxExtra("math/trigonometry","TAN()",{outputs:[["tan","number"]],title:"TAN()"}),I.title="Formula",I.desc="Compute formula",I.size=[160,100],y.prototype.onPropertyChanged=function(t,e){"formula"==t&&(this.code_widget.value=e)},I.prototype.onExecute=function(){if(e.allow_scripts){var t,s=this.getInputData(0),o=this.getInputData(1);null!=s?this.properties.x=s:s=this.properties.x,null!=o?this.properties.y=o:o=this.properties.y,this.properties.formula;try{this._func&&this._func_code==this.properties.formula||(this._func=Function("x","y","TIME","return "+this.properties.formula),this._func_code=this.properties.formula),t=this._func(s,o,this.graph.globaltime),this.boxcolor=null}catch(n){this.boxcolor="red"}this.setOutputData(0,t)}},I.prototype.getTitle=function(){return this._func_code||"Formula"},I.prototype.onDrawBackground=function(){var t=this.properties.formula;this.outputs&&this.outputs.length&&(this.outputs[0].label=t)},e.registerNodeType("math/formula",I),D.title="Vec2->XY",D.desc="vector 2 to components",D.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&(this.setOutputData(0,t[0]),this.setOutputData(1,t[1]))},e.registerNodeType("math3d/vec2-to-xy",D),N.title="XY->Vec2",N.desc="components to vector2",N.prototype.onExecute=function(){var t=this.getInputData(0);null==t&&(t=this.properties.x);var e=this.getInputData(1);null==e&&(e=this.properties.y);var s=this._data;s[0]=t,s[1]=e,this.setOutputData(0,s)},e.registerNodeType("math3d/xy-to-vec2",N),C.title="Vec3->XYZ",C.desc="vector 3 to components",C.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&(this.setOutputData(0,t[0]),this.setOutputData(1,t[1]),this.setOutputData(2,t[2]))},e.registerNodeType("math3d/vec3-to-xyz",C),S.title="XYZ->Vec3",S.desc="components to vector3",S.prototype.onExecute=function(){var t=this.getInputData(0);null==t&&(t=this.properties.x);var e=this.getInputData(1);null==e&&(e=this.properties.y);var s=this.getInputData(2);null==s&&(s=this.properties.z);var o=this._data;o[0]=t,o[1]=e,o[2]=s,this.setOutputData(0,o)},e.registerNodeType("math3d/xyz-to-vec3",S),A.title="Vec4->XYZW",A.desc="vector 4 to components",A.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&(this.setOutputData(0,t[0]),this.setOutputData(1,t[1]),this.setOutputData(2,t[2]),this.setOutputData(3,t[3]))},e.registerNodeType("math3d/vec4-to-xyzw",A),k.title="XYZW->Vec4",k.desc="components to vector4",k.prototype.onExecute=function(){var t=this.getInputData(0);null==t&&(t=this.properties.x);var e=this.getInputData(1);null==e&&(e=this.properties.y);var s=this.getInputData(2);null==s&&(s=this.properties.z);var o=this.getInputData(3);null==o&&(o=this.properties.w);var n=this._data;n[0]=t,n[1]=e,n[2]=s,n[3]=o,this.setOutputData(0,n)},e.registerNodeType("math3d/xyzw-to-vec4",k)}(this),function(t){var e=t.LiteGraph;function s(){this.addInput("T","vec3"),this.addInput("R","vec3"),this.addInput("S","vec3"),this.addOutput("mat4","mat4"),this.properties={T:[0,0,0],R:[0,0,0],S:[1,1,1],R_in_degrees:!0},this._result=mat4.create(),this._must_update=!0}function o(){this.addInput("A","number,vec3"),this.addInput("B","number,vec3"),this.addOutput("=","number,vec3"),this.addProperty("OP","+","enum",{values:o.values}),this._result=vec3.create()}function n(){this.addInput("in","vec3"),this.addInput("f","number"),this.addOutput("out","vec3"),this.properties={f:1},this._data=new Float32Array(3)}function r(){this.addInput("in","vec3"),this.addOutput("out","number")}function a(){this.addInput("in","vec3"),this.addOutput("out","vec3"),this._data=new Float32Array(3)}function u(){this.addInput("A","vec3"),this.addInput("B","vec3"),this.addInput("f","vec3"),this.addOutput("out","vec3"),this.properties={f:.5},this._data=new Float32Array(3)}function h(){this.addInput("A","vec3"),this.addInput("B","vec3"),this.addOutput("out","number")}if(s.title="mat4",s.temp_quat=new Float32Array([0,0,0,1]),s.temp_mat4=new Float32Array(16),s.temp_vec3=new Float32Array(3),s.prototype.onPropertyChanged=function(t,e){this._must_update=!0},s.prototype.onExecute=function(){var t=this._result,e=s.temp_quat,o=s.temp_mat4,n=s.temp_vec3,r=this.getInputData(0),a=this.getInputData(1),u=this.getInputData(2);(this._must_update||r||a||u)&&(r=r||this.properties.T,a=a||this.properties.R,u=u||this.properties.S,mat4.identity(t),mat4.translate(t,t,r),this.properties.R_in_degrees?(n.set(a),vec3.scale(n,n,DEG2RAD),quat.fromEuler(e,n)):quat.fromEuler(e,a),mat4.fromQuat(o,e),mat4.multiply(t,t,o),mat4.scale(t,t,u)),this.setOutputData(0,t)},e.registerNodeType("math3d/mat4",s),o.values=["+","-","*","/","%","^","max","min","dot","cross"],e.registerSearchboxExtra("math3d/operation","CROSS()",{properties:{OP:"cross"},title:"CROSS()"}),e.registerSearchboxExtra("math3d/operation","DOT()",{properties:{OP:"dot"},title:"DOT()"}),o.title="Operation",o.desc="Easy math 3D operators",o["@OP"]={type:"enum",title:"operation",values:o.values},o.size=[100,60],o.prototype.getTitle=function(){return"max"==this.properties.OP||"min"==this.properties.OP?this.properties.OP+"(A,B)":"A "+this.properties.OP+" B"},o.prototype.onExecute=function(){var t=this.getInputData(0),e=this.getInputData(1);if(null!=t&&null!=e){t.constructor===Number&&(t=[t,t,t]),e.constructor===Number&&(e=[e,e,e]);var s=this._result;switch(this.properties.OP){case"+":s=vec3.add(s,t,e);break;case"-":s=vec3.sub(s,t,e);break;case"x":case"X":case"*":s=vec3.mul(s,t,e);break;case"/":s=vec3.div(s,t,e);break;case"%":s[0]=t[0]%e[0],s[1]=t[1]%e[1],s[2]=t[2]%e[2];break;case"^":s[0]=Math.pow(t[0],e[0]),s[1]=Math.pow(t[1],e[1]),s[2]=Math.pow(t[2],e[2]);break;case"max":s[0]=Math.max(t[0],e[0]),s[1]=Math.max(t[1],e[1]),s[2]=Math.max(t[2],e[2]);break;case"min":s[0]=Math.min(t[0],e[0]),s[1]=Math.min(t[1],e[1]),s[2]=Math.min(t[2],e[2]);case"dot":s=vec3.dot(t,e);break;case"cross":vec3.cross(s,t,e);break;default:console.warn("Unknown operation: "+this.properties.OP)}this.setOutputData(0,s)}},o.prototype.onDrawBackground=function(t){!this.flags.collapsed&&(t.font="40px Arial",t.fillStyle="#666",t.textAlign="center",t.fillText(this.properties.OP,.5*this.size[0],(this.size[1]+e.NODE_TITLE_HEIGHT)*.5),t.textAlign="left")},e.registerNodeType("math3d/operation",o),n.title="vec3_scale",n.desc="scales the components of a vec3",n.prototype.onExecute=function(){var t=this.getInputData(0);if(null!=t){var e=this.getInputData(1);null==e&&(e=this.properties.f);var s=this._data;s[0]=t[0]*e,s[1]=t[1]*e,s[2]=t[2]*e,this.setOutputData(0,s)}},e.registerNodeType("math3d/vec3-scale",n),r.title="vec3_length",r.desc="returns the module of a vector",r.prototype.onExecute=function(){var t=this.getInputData(0);if(null!=t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);this.setOutputData(0,e)}},e.registerNodeType("math3d/vec3-length",r),a.title="vec3_normalize",a.desc="returns the vector normalized",a.prototype.onExecute=function(){var t=this.getInputData(0);if(null!=t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),s=this._data;s[0]=t[0]/e,s[1]=t[1]/e,s[2]=t[2]/e,this.setOutputData(0,s)}},e.registerNodeType("math3d/vec3-normalize",a),u.title="vec3_lerp",u.desc="returns the interpolated vector",u.prototype.onExecute=function(){var t=this.getInputData(0);if(null!=t){var e=this.getInputData(1);if(null!=e){var s=this.getInputOrProperty("f"),o=this._data;o[0]=t[0]*(1-s)+e[0]*s,o[1]=t[1]*(1-s)+e[1]*s,o[2]=t[2]*(1-s)+e[2]*s,this.setOutputData(0,o)}}},e.registerNodeType("math3d/vec3-lerp",u),h.title="vec3_dot",h.desc="returns the dot product",h.prototype.onExecute=function(){var t=this.getInputData(0);if(null!=t){var e=this.getInputData(1);if(null!=e){var s=t[0]*e[0]+t[1]*e[1]+t[2]*e[2];this.setOutputData(0,s)}}},e.registerNodeType("math3d/vec3-dot",h),t.glMatrix){function l(){this.addOutput("quat","quat"),this.properties={x:0,y:0,z:0,w:1,normalize:!1},this._value=quat.create()}function d(){this.addInputs([["degrees","number"],["axis","vec3"]]),this.addOutput("quat","quat"),this.properties={angle:90,axis:vec3.fromValues(0,1,0)},this._value=quat.create()}function c(){this.addInput("euler","vec3"),this.addOutput("quat","quat"),this.properties={euler:[0,0,0],use_yaw_pitch_roll:!1},this._degs=vec3.create(),this._value=quat.create()}function f(){this.addInput(["quat","quat"]),this.addOutput("euler","vec3"),this._value=vec3.create()}function g(){this.addInputs([["vec3","vec3"],["quat","quat"]]),this.addOutput("result","vec3"),this.properties={vec:[0,0,1]}}function v(){this.addInputs([["A","quat"],["B","quat"]]),this.addOutput("A*B","quat"),this._value=quat.create()}function $(){this.addInputs([["A","quat"],["B","quat"],["factor","number"]]),this.addOutput("slerp","quat"),this.addProperty("factor",.5),this._value=quat.create()}function m(){this.addInput("vec3","vec3"),this.addOutput("remap","vec3"),this.addOutput("clamped","vec3"),this.properties={clamp:!0,range_min:[-1,-1,0],range_max:[1,1,0],target_min:[-1,-1,0],target_max:[1,1,0]},this._value=vec3.create(),this._clamped=vec3.create()}l.title="Quaternion",l.desc="quaternion",l.prototype.onExecute=function(){this._value[0]=this.getInputOrProperty("x"),this._value[1]=this.getInputOrProperty("y"),this._value[2]=this.getInputOrProperty("z"),this._value[3]=this.getInputOrProperty("w"),this.properties.normalize&&quat.normalize(this._value,this._value),this.setOutputData(0,this._value)},l.prototype.onGetInputs=function(){return[["x","number"],["y","number"],["z","number"],["w","number"]]},e.registerNodeType("math3d/quaternion",l),d.title="Rotation",d.desc="quaternion rotation",d.prototype.onExecute=function(){var t=this.getInputData(0);null==t&&(t=this.properties.angle);var e=this.getInputData(1);null==e&&(e=this.properties.axis);var s=quat.setAxisAngle(this._value,e,.0174532925*t);this.setOutputData(0,s)},e.registerNodeType("math3d/rotation",d),c.title="Euler->Quat",c.desc="Converts euler angles (in degrees) to quaternion",c.prototype.onExecute=function(){var t=this.getInputData(0);null==t&&(t=this.properties.euler),vec3.scale(this._degs,t,DEG2RAD),this.properties.use_yaw_pitch_roll&&(this._degs=[this._degs[2],this._degs[0],this._degs[1]]);var e=quat.fromEuler(this._value,this._degs);this.setOutputData(0,e)},e.registerNodeType("math3d/euler_to_quat",c),f.title="Euler->Quat",f.desc="Converts rotX,rotY,rotZ in degrees to quat",f.prototype.onExecute=function(){var t=this.getInputData(0);if(t){var e=quat.toEuler(this._value,t);vec3.scale(this._value,this._value,DEG2RAD),this.setOutputData(0,this._value)}},e.registerNodeType("math3d/quat_to_euler",f),g.title="Rot. Vec3",g.desc="rotate a point",g.prototype.onExecute=function(){var t=this.getInputData(0);null==t&&(t=this.properties.vec);var e=this.getInputData(1);null==e?this.setOutputData(t):this.setOutputData(0,vec3.transformQuat(vec3.create(),t,e))},e.registerNodeType("math3d/rotate_vec3",g),v.title="Mult. Quat",v.desc="rotate quaternion",v.prototype.onExecute=function(){var t=this.getInputData(0);if(null!=t){var e=this.getInputData(1);if(null!=e){var s=quat.multiply(this._value,t,e);this.setOutputData(0,s)}}},e.registerNodeType("math3d/mult-quat",v),$.title="Quat Slerp",$.desc="quaternion spherical interpolation",$.prototype.onExecute=function(){var t=this.getInputData(0);if(null!=t){var e=this.getInputData(1);if(null!=e){var s=this.properties.factor;null!=this.getInputData(2)&&(s=this.getInputData(2));var o=quat.slerp(this._value,t,e,s);this.setOutputData(0,o)}}},e.registerNodeType("math3d/quat-slerp",$),m.title="Remap Range",m.desc="remap a 3D range",m.prototype.onExecute=function(){var t=this.getInputData(0);t&&this._value.set(t);for(var e=this.properties.range_min,s=this.properties.range_max,o=this.properties.target_min,n=this.properties.target_max,r=0;r<3;++r){var a=s[r]-e[r];if(this._clamped[r]=clamp(this._value[r],e[r],s[r]),0==a){this._value[r]=(o[r]+n[r])*.5;continue}var u=(this._value[r]-e[r])/a;this.properties.clamp&&(u=clamp(u,0,1));var h=n[r]-o[r];this._value[r]=o[r]+u*h}this.setOutputData(0,this._value),this.setOutputData(1,this._clamped)},e.registerNodeType("math3d/remap_range",m)}else e.debug&&console.warn("No glmatrix found, some Math3D nodes may not work")}(this),function(t){var e=t.LiteGraph;function s(t){if(t&&t.constructor===Object)try{return JSON.stringify(t)}catch(e){}return String(t)}function o(t,e){return t==e}function n(t,e){return void 0===t?e:void 0===e?t:t+e}function r(t,e){return void 0!==t&&void 0!==e&&-1!=t.indexOf(e)}function a(t){return null!=t&&t.constructor===String?t.toUpperCase():t}function u(t,e){if(null==e&&(e=this.properties.separator),null==t)return[];if(t.constructor===String)return t.split(e||" ");if(t.constructor===Array){for(var s=[],o=0;o<t.length;++o)"string"==typeof t[o]&&(s[o]=t[o].split(e||" "));return s}return null}function h(t){return null!=t&&t.constructor===Number?t.toFixed(this.properties.precision):t}function l(){this.addInput("","string"),this.addOutput("table","table"),this.addOutput("rows","number"),this.addProperty("value",""),this.addProperty("separator",","),this._table=null}e.wrapFunctionAsNode("string/toString",s,[""],"string"),e.wrapFunctionAsNode("string/compare",o,["string","string"],"boolean"),e.wrapFunctionAsNode("string/concatenate",n,["string","string"],"string"),e.wrapFunctionAsNode("string/contains",r,["string","string"],"boolean"),e.wrapFunctionAsNode("string/toUpperCase",a,["string"],"string"),e.wrapFunctionAsNode("string/split",u,["string,array","string"],"array",{separator:","}),e.wrapFunctionAsNode("string/toFixed",h,["number"],"string",{precision:0}),l.title="toTable",l.desc="Splits a string to table",l.prototype.onExecute=function(){var t=this.getInputData(0);if(t){var e=this.properties.separator||",";(t!=this._str||e!=this._last_separator)&&(this._last_separator=e,this._str=t,this._table=t.split("\n").map(function(t){return t.trim().split(e)})),this.setOutputData(0,this._table),this.setOutputData(1,this._table?this._table.length:0)}},e.registerNodeType("string/toTable",l)}(this),function(t){var e=t.LiteGraph;function s(){this.addInput("sel","number"),this.addInput("A"),this.addInput("B"),this.addInput("C"),this.addInput("D"),this.addOutput("out"),this.selected=0}function o(){this.properties={sequence:"A,B,C"},this.addInput("index","number"),this.addInput("seq"),this.addOutput("out"),this.index=0,this.values=this.properties.sequence.split(",")}function n(){this.properties={},this.addInput("a","boolean"),this.addInput("b","boolean"),this.addOutput("out","boolean")}function r(){this.properties={},this.addInput("a","boolean"),this.addInput("b","boolean"),this.addOutput("out","boolean")}function a(){this.properties={},this.addInput("in","boolean"),this.addOutput("out","boolean")}function u(){this.properties={},this.addInput("a","boolean"),this.addInput("b","boolean"),this.addOutput("out","boolean")}function h(){this.properties={},this.addInput("onTrigger",e.ACTION),this.addInput("condition","boolean"),this.addOutput("true",e.EVENT),this.addOutput("false",e.EVENT),this.mode=e.ON_TRIGGER}s.title="Selector",s.desc="selects an output",s.prototype.onDrawBackground=function(t){if(!this.flags.collapsed){t.fillStyle="#AFB";var s=(this.selected+1)*e.NODE_SLOT_HEIGHT+6;t.beginPath(),t.moveTo(50,s),t.lineTo(50,s+e.NODE_SLOT_HEIGHT),t.lineTo(34,s+.5*e.NODE_SLOT_HEIGHT),t.fill()}},s.prototype.onExecute=function(){var t=this.getInputData(0);(null==t||t.constructor!==Number)&&(t=0),this.selected=t=Math.round(t)%(this.inputs.length-1);var e=this.getInputData(t+1);void 0!==e&&this.setOutputData(0,e)},s.prototype.onGetInputs=function(){return[["E",0],["F",0],["G",0],["H",0]]},e.registerNodeType("logic/selector",s),o.title="Sequence",o.desc="select one element from a sequence from a string",o.prototype.onPropertyChanged=function(t,e){"sequence"==t&&(this.values=e.split(","))},o.prototype.onExecute=function(){var t=this.getInputData(1);t&&t!=this.current_sequence&&(this.values=t.split(","),this.current_sequence=t);var e=this.getInputData(0);null==e&&(e=0),this.index=e=Math.round(e)%this.values.length,this.setOutputData(0,this.values[e])},e.registerNodeType("logic/sequence",o),n.title="AND",n.desc="Return true if all inputs are true",n.prototype.onExecute=function(){var t=!0;for(var e in this.inputs)if(!this.getInputData(e)){var t=!1;break}this.setOutputData(0,t)},n.prototype.onGetInputs=function(){return[["and","boolean"]]},e.registerNodeType("logic/AND",n),r.title="OR",r.desc="Return true if at least one input is true",r.prototype.onExecute=function(){var t=!1;for(var e in this.inputs)if(this.getInputData(e)){t=!0;break}this.setOutputData(0,t)},r.prototype.onGetInputs=function(){return[["or","boolean"]]},e.registerNodeType("logic/OR",r),a.title="NOT",a.desc="Return the logical negation",a.prototype.onExecute=function(){var t=!this.getInputData(0);this.setOutputData(0,t)},e.registerNodeType("logic/NOT",a),u.title="bool == bool",u.desc="Compare for logical equality",u.prototype.onExecute=function(){var t=null,e=!0;for(var s in this.inputs)if(null===t)t=this.getInputData(s);else if(t!=this.getInputData(s)){e=!1;break}this.setOutputData(0,e)},u.prototype.onGetInputs=function(){return[["bool","boolean"]]},e.registerNodeType("logic/CompareBool",u),h.title="Branch",h.desc="Branch execution on condition",h.prototype.onExecute=function(t,e){this.getInputData(1)?this.triggerSlot(0):this.triggerSlot(1)},e.registerNodeType("logic/IF",h)}(this),function(t){var e=t.LiteGraph;function s(){this.addInput("A","Number"),this.addInput("B","Number"),this.addInput("C","Number"),this.addInput("D","Number"),this.values=[[],[],[],[]],this.properties={scale:2}}function o(){this.addOutput("frame","image"),this.properties={url:""}}function n(){this.addInput("f","number"),this.addOutput("Color","color"),this.properties={colorA:"#444444",colorB:"#44AAFF",colorC:"#44FFAA",colorD:"#FFFFFF"}}function r(){this.addInput("","image,canvas"),this.size=[200,200]}function a(){this.addInputs([["img1","image"],["img2","image"],["fade","number"]]),this.addOutput("","image"),this.properties={fade:.5,width:512,height:512}}function u(){this.addInput("","image"),this.addOutput("","image"),this.properties={width:256,height:256,x:0,y:0,scale:1},this.size=[50,20]}function h(){this.addInput("clear",e.ACTION),this.addOutput("","canvas"),this.properties={width:512,height:512,autoclear:!0},this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d")}function l(){this.addInput("canvas","canvas"),this.addInput("img","image,canvas"),this.addInput("x","number"),this.addInput("y","number"),this.properties={x:0,y:0,opacity:1}}function d(){this.addInput("canvas","canvas"),this.addInput("x","number"),this.addInput("y","number"),this.addInput("w","number"),this.addInput("h","number"),this.properties={x:0,y:0,w:10,h:10,color:"white",opacity:1}}function c(){this.addInput("t","number"),this.addOutputs([["frame","image"],["t","number"],["d","number"]]),this.properties={url:"",use_proxy:!0}}function f(){this.addOutput("Webcam","image"),this.properties={filterFacingMode:!1,facingMode:"user"},this.boxcolor="black",this.frame=0}s.title="Plot",s.desc="Plots data over time",s.colors=["#FFF","#F99","#9F9","#99F"],s.prototype.onExecute=function(t){if(!this.flags.collapsed)for(var e=this.size,s=0;s<4;++s){var o=this.getInputData(s);if(null!=o){var n=this.values[s];n.push(o),n.length>e[0]&&n.shift()}}},s.prototype.onDrawBackground=function(t){if(!this.flags.collapsed){var e=this.size,o=.5*e[1]/this.properties.scale,n=s.colors,r=.5*e[1];if(t.fillStyle="#000",t.fillRect(0,0,e[0],e[1]),t.strokeStyle="#555",t.beginPath(),t.moveTo(0,r),t.lineTo(e[0],r),t.stroke(),this.inputs)for(var a=0;a<4;++a){var u=this.values[a];if(this.inputs[a]&&this.inputs[a].link){t.strokeStyle=n[a],t.beginPath();var h=-(u[0]*o*1)+r;t.moveTo(0,clamp(h,0,e[1]));for(var l=1;l<u.length&&l<e[0];++l){var h=-(u[l]*o*1)+r;t.lineTo(l,clamp(h,0,e[1]))}t.stroke()}}}},e.registerNodeType("graphics/plot",s),o.title="Image",o.desc="Image loader",o.widgets=[{name:"load",text:"Load",type:"button"}],o.supported_extensions=["jpg","jpeg","png","gif"],o.prototype.onAdded=function(){""!=this.properties.url&&null==this.img&&this.loadImage(this.properties.url)},o.prototype.onDrawBackground=function(t){!this.flags.collapsed&&this.img&&this.size[0]>5&&this.size[1]>5&&this.img.width&&t.drawImage(this.img,0,0,this.size[0],this.size[1])},o.prototype.onExecute=function(){this.img||(this.boxcolor="#000"),this.img&&this.img.width?this.setOutputData(0,this.img):this.setOutputData(0,null),this.img&&this.img.dirty&&(this.img.dirty=!1)},o.prototype.onPropertyChanged=function(t,e){return this.properties[t]=e,"url"==t&&""!=e&&this.loadImage(e),!0},o.prototype.loadImage=function(t,s){if(""==t){this.img=null;return}this.img=document.createElement("img"),"http"==t.substr(0,4)&&e.proxy&&(t=e.proxy+t.substr(t.indexOf(":")+3)),this.img.src=t,this.boxcolor="#F95";var o=this;this.img.onload=function(){s&&s(this),console.log("Image loaded, size: "+o.img.width+"x"+o.img.height),this.dirty=!0,o.boxcolor="#9F9",o.setDirtyCanvas(!0)},this.img.onerror=function(){console.log("error loading the image:"+t)}},o.prototype.onWidget=function(t,e){"load"==e.name&&this.loadImage(this.properties.url)},o.prototype.onDropFile=function(t){var e=this;this._url&&URL.revokeObjectURL(this._url),this._url=URL.createObjectURL(t),this.properties.url=this._url,this.loadImage(this._url,function(t){e.size[1]=t.height/t.width*e.size[0]})},e.registerNodeType("graphics/image",o),n.title="Palette",n.desc="Generates a color",n.prototype.onExecute=function(){var t=[];null!=this.properties.colorA&&t.push(hex2num(this.properties.colorA)),null!=this.properties.colorB&&t.push(hex2num(this.properties.colorB)),null!=this.properties.colorC&&t.push(hex2num(this.properties.colorC)),null!=this.properties.colorD&&t.push(hex2num(this.properties.colorD));var e=this.getInputData(0);if(null==e&&(e=.5),e>1?e=1:e<0&&(e=0),0!=t.length){var s=[0,0,0];if(0==e)s=t[0];else if(1==e)s=t[t.length-1];else{var o=(t.length-1)*e,n=t[Math.floor(o)],r=t[Math.floor(o)+1],a=o-Math.floor(o);s[0]=n[0]*(1-a)+r[0]*a,s[1]=n[1]*(1-a)+r[1]*a,s[2]=n[2]*(1-a)+r[2]*a}for(var u=0;u<s.length;u++)s[u]/=255;this.boxcolor=colorToString(s),this.setOutputData(0,s)}},e.registerNodeType("color/palette",n),r.title="Frame",r.desc="Frame viewerew",r.widgets=[{name:"resize",text:"Resize box",type:"button"},{name:"view",text:"View Image",type:"button"}],r.prototype.onDrawBackground=function(t){this.frame&&!this.flags.collapsed&&t.drawImage(this.frame,0,0,this.size[0],this.size[1])},r.prototype.onExecute=function(){this.frame=this.getInputData(0),this.setDirtyCanvas(!0)},r.prototype.onWidget=function(t,e){if("resize"==e.name&&this.frame){var s=this.frame.width,o=this.frame.height;s||null==this.frame.videoWidth||(s=this.frame.videoWidth,o=this.frame.videoHeight),s&&o&&(this.size=[s,o]),this.setDirtyCanvas(!0,!0)}else"view"==e.name&&this.show()},r.prototype.show=function(){showElement&&this.frame&&showElement(this.frame)},e.registerNodeType("graphics/frame",r),a.title="Image fade",a.desc="Fades between images",a.widgets=[{name:"resizeA",text:"Resize to A",type:"button"},{name:"resizeB",text:"Resize to B",type:"button"}],a.prototype.onAdded=function(){this.createCanvas();var t=this.canvas.getContext("2d");t.fillStyle="#000",t.fillRect(0,0,this.properties.width,this.properties.height)},a.prototype.createCanvas=function(){this.canvas=document.createElement("canvas"),this.canvas.width=this.properties.width,this.canvas.height=this.properties.height},a.prototype.onExecute=function(){var t=this.canvas.getContext("2d");this.canvas.width=this.canvas.width;var e=this.getInputData(0);null!=e&&t.drawImage(e,0,0,this.canvas.width,this.canvas.height);var s=this.getInputData(2);null==s?s=this.properties.fade:this.properties.fade=s,t.globalAlpha=s;var o=this.getInputData(1);null!=o&&t.drawImage(o,0,0,this.canvas.width,this.canvas.height),t.globalAlpha=1,this.setOutputData(0,this.canvas),this.setDirtyCanvas(!0)},e.registerNodeType("graphics/imagefade",a),u.title="Crop",u.desc="Crop Image",u.prototype.onAdded=function(){this.createCanvas()},u.prototype.createCanvas=function(){this.canvas=document.createElement("canvas"),this.canvas.width=this.properties.width,this.canvas.height=this.properties.height},u.prototype.onExecute=function(){var t=this.getInputData(0);t&&(t.width?(this.canvas.getContext("2d").drawImage(t,-this.properties.x,-this.properties.y,t.width*this.properties.scale,t.height*this.properties.scale),this.setOutputData(0,this.canvas)):this.setOutputData(0,null))},u.prototype.onDrawBackground=function(t){!this.flags.collapsed&&this.canvas&&t.drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height,0,0,this.size[0],this.size[1])},u.prototype.onPropertyChanged=function(t,e){return this.properties[t]=e,"scale"==t?(this.properties[t]=parseFloat(e),0==this.properties[t]&&(console.error("Error in scale"),this.properties[t]=1)):this.properties[t]=parseInt(e),this.createCanvas(),!0},e.registerNodeType("graphics/cropImage",u),h.title="Canvas",h.desc="Canvas to render stuff",h.prototype.onExecute=function(){var t=this.canvas,e=0|this.properties.width,s=0|this.properties.height;t.width!=e&&(t.width=e),t.height!=s&&(t.height=s),this.properties.autoclear&&this.ctx.clearRect(0,0,t.width,t.height),this.setOutputData(0,t)},h.prototype.onAction=function(t,e){"clear"==t&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)},e.registerNodeType("graphics/canvas",h),l.title="DrawImage",l.desc="Draws image into a canvas",l.prototype.onExecute=function(){var t=this.getInputData(0);if(t){var e=this.getInputOrProperty("img");if(e){var s,o=this.getInputOrProperty("x"),n=this.getInputOrProperty("y");t.getContext("2d").drawImage(e,o,n)}}},e.registerNodeType("graphics/drawImage",l),d.title="DrawRectangle",d.desc="Draws rectangle in canvas",d.prototype.onExecute=function(){var t=this.getInputData(0);if(t){var e,s=this.getInputOrProperty("x"),o=this.getInputOrProperty("y"),n=this.getInputOrProperty("w"),r=this.getInputOrProperty("h");t.getContext("2d").fillRect(s,o,n,r)}},e.registerNodeType("graphics/drawRectangle",d),c.title="Video",c.desc="Video playback",c.widgets=[{name:"play",text:"PLAY",type:"minibutton"},{name:"stop",text:"STOP",type:"minibutton"},{name:"demo",text:"Demo video",type:"button"},{name:"mute",text:"Mute video",type:"button"}],c.prototype.onExecute=function(){if(this.properties.url){if(this.properties.url!=this._video_url&&this.loadVideo(this.properties.url),this._video&&0!=this._video.width){var t=this.getInputData(0);t&&t>=0&&t<=1&&(this._video.currentTime=t*this._video.duration,this._video.pause()),this._video.dirty=!0,this.setOutputData(0,this._video),this.setOutputData(1,this._video.currentTime),this.setOutputData(2,this._video.duration),this.setDirtyCanvas(!0)}}},c.prototype.onStart=function(){this.play()},c.prototype.onStop=function(){this.stop()},c.prototype.loadVideo=function(t){this._video_url=t;var s=t.substr(0,10).indexOf(":"),o="";-1!=s&&(o=t.substr(0,s));var n="";o&&(n=(n=t.substr(0,t.indexOf("/",o.length+3))).substr(o.length+3)),this.properties.use_proxy&&o&&e.proxy&&n!=location.host&&(t=e.proxy+t.substr(t.indexOf(":")+3)),this._video=document.createElement("video"),this._video.src=t,this._video.type="type=video/mp4",this._video.muted=!0,this._video.autoplay=!0;var r=this;this._video.addEventListener("loadedmetadata",function(t){console.log("Duration: "+this.duration+" seconds"),console.log("Size: "+this.videoWidth+","+this.videoHeight),r.setDirtyCanvas(!0),this.width=this.videoWidth,this.height=this.videoHeight}),this._video.addEventListener("progress",function(t){console.log("video loading...")}),this._video.addEventListener("error",function(t){if(console.error("Error loading video: "+this.src),this.error)switch(this.error.code){case this.error.MEDIA_ERR_ABORTED:console.error("You stopped the video.");break;case this.error.MEDIA_ERR_NETWORK:console.error("Network error - please try again later.");break;case this.error.MEDIA_ERR_DECODE:console.error("Video is broken..");break;case this.error.MEDIA_ERR_SRC_NOT_SUPPORTED:console.error("Sorry, your browser can't play this video.")}}),this._video.addEventListener("ended",function(t){console.log("Video Ended."),this.play()})},c.prototype.onPropertyChanged=function(t,e){return this.properties[t]=e,"url"==t&&""!=e&&this.loadVideo(e),!0},c.prototype.play=function(){this._video&&this._video.videoWidth&&this._video.play()},c.prototype.playPause=function(){this._video&&(this._video.paused?this.play():this.pause())},c.prototype.stop=function(){this._video&&(this._video.pause(),this._video.currentTime=0)},c.prototype.pause=function(){this._video&&(console.log("Video paused"),this._video.pause())},c.prototype.onWidget=function(t,e){},e.registerNodeType("graphics/video",c),f.title="Webcam",f.desc="Webcam image",f.is_webcam_open=!1,f.prototype.openStream=function(){if(!navigator.mediaDevices.getUserMedia){console.log("getUserMedia() is not supported in your browser, use chrome and enable WebRTC from about://flags");return}this._waiting_confirmation=!0;var t={audio:!1,video:!this.properties.filterFacingMode||{facingMode:this.properties.facingMode}};navigator.mediaDevices.getUserMedia(t).then(this.streamReady.bind(this)).catch(s);var e=this;function s(t){console.log("Webcam rejected",t),e._webcam_stream=!1,f.is_webcam_open=!1,e.boxcolor="red",e.trigger("stream_error")}},f.prototype.closeStream=function(){if(this._webcam_stream){var t=this._webcam_stream.getTracks();if(t.length)for(var e=0;e<t.length;++e)t[e].stop();f.is_webcam_open=!1,this._webcam_stream=null,this._video=null,this.boxcolor="black",this.trigger("stream_closed")}},f.prototype.onPropertyChanged=function(t,e){"facingMode"==t&&(this.properties.facingMode=e,this.closeStream(),this.openStream())},f.prototype.onRemoved=function(){this.closeStream()},f.prototype.streamReady=function(t){this._webcam_stream=t,this.boxcolor="green";var e=this._video;e||((e=document.createElement("video")).autoplay=!0,e.srcObject=t,this._video=e,e.onloadedmetadata=function(t){console.log(t),f.is_webcam_open=!0}),this.trigger("stream_ready",e)},f.prototype.onExecute=function(){if(null!=this._webcam_stream||this._waiting_confirmation||this.openStream(),this._video&&this._video.videoWidth){this._video.frame=++this.frame,this._video.width=this._video.videoWidth,this._video.height=this._video.videoHeight,this.setOutputData(0,this._video);for(var t=1;t<this.outputs.length;++t)if(this.outputs[t])switch(this.outputs[t].name){case"width":this.setOutputData(t,this._video.videoWidth);break;case"height":this.setOutputData(t,this._video.videoHeight)}}},f.prototype.getExtraMenuOptions=function(t){var e=this;return[{content:e.properties.show?"Hide Frame":"Show Frame",callback:function(){e.properties.show=!e.properties.show}}]},f.prototype.onDrawBackground=function(t){!this.flags.collapsed&&!(this.size[1]<=20)&&this.properties.show&&this._video&&(t.save(),t.drawImage(this._video,0,0,this.size[0],this.size[1]),t.restore())},f.prototype.onGetOutputs=function(){return[["width","number"],["height","number"],["stream_ready",e.EVENT],["stream_closed",e.EVENT],["stream_error",e.EVENT]]},e.registerNodeType("graphics/webcam",f)}(this),function(t){var e=t.LiteGraph,s=t.LGraphCanvas;function o(){this.addOutput("tex","Texture"),this.addOutput("name","string"),this.properties={name:"",filter:!0},this.size=[o.image_preview_size,o.image_preview_size]}function n(){this.addInput("Texture","Texture"),this.properties={flipY:!1},this.size=[o.image_preview_size,o.image_preview_size]}function r(){this.addInput("Texture","Texture"),this.addOutput("tex","Texture"),this.addOutput("name","string"),this.properties={name:"",generate_mipmaps:!1}}function a(){this.addInput("Texture","Texture"),this.addInput("TextureB","Texture"),this.addInput("value","number"),this.addOutput("Texture","Texture"),this.help="<p>pixelcode must be vec3, uvcode must be vec2, is optional</p>		<p><strong>uv:</strong> tex. coords</p><p><strong>color:</strong> texture <strong>colorB:</strong> textureB</p><p><strong>time:</strong> scene time <strong>value:</strong> input value</p><p>For multiline you must type: result = ...</p>",this.properties={value:1,pixelcode:"color + colorB * value",uvcode:"",precision:o.DEFAULT},this.has_error=!1}function u(){this.addOutput("out","Texture"),this.properties={code:"",u_value:1,u_color:[1,1,1,1],width:512,height:512,precision:o.DEFAULT},this.properties.code=u.pixel_shader,this._uniforms={u_value:1,u_color:vec4.create(),in_texture:0,texSize:vec4.create(),time:0}}function h(){this.addInput("in","Texture"),this.addInput("scale","vec2"),this.addInput("offset","vec2"),this.addOutput("out","Texture"),this.properties={offset:vec2.fromValues(0,0),scale:vec2.fromValues(1,1),precision:o.DEFAULT}}function l(){this.addInput("in","Texture"),this.addInput("warp","Texture"),this.addInput("factor","number"),this.addOutput("out","Texture"),this.properties={factor:.01,scale:[1,1],offset:[0,0],precision:o.DEFAULT},this._uniforms={u_texture:0,u_textureB:1,u_factor:1,u_scale:vec2.create(),u_offset:vec2.create()}}function d(){this.addInput("Texture","Texture"),this.properties={additive:!1,antialiasing:!1,filter:!0,disable_alpha:!1,gamma:1,viewport:[0,0,1,1]},this.size[0]=130}function c(){this.addInput("Texture","Texture"),this.addOutput("","Texture"),this.properties={size:0,generate_mipmaps:!1,precision:o.DEFAULT}}function f(){this.addInput("Texture","Texture"),this.addOutput("","Texture"),this.properties={iterations:1,generate_mipmaps:!1,precision:o.DEFAULT}}function g(){this.addInput("Texture","Texture"),this.addOutput("","Texture"),this.properties={size:[512,512],generate_mipmaps:!1,precision:o.DEFAULT}}function v(){this.addInput("Texture","Texture"),this.addOutput("tex","Texture"),this.addOutput("avg","vec4"),this.addOutput("lum","number"),this.properties={use_previous_frame:!0,high_quality:!1},this._uniforms={u_texture:0,u_mipmap_offset:0},this._luminance=new Float32Array(4)}function $(){this.addInput("Texture","Texture"),this.addOutput("min_t","Texture"),this.addOutput("max_t","Texture"),this.addOutput("min","vec4"),this.addOutput("max","vec4"),this.properties={mode:"max",use_previous_frame:!0},this._uniforms={u_texture:0},this._max=new Float32Array(4),this._min=new Float32Array(4),this._textures_chain=[]}function m(){this.addInput("in","Texture"),this.addInput("factor","Number"),this.addOutput("out","Texture"),this.properties={factor:.5},this._uniforms={u_texture:0,u_textureB:1,u_factor:this.properties.factor}}function y(){this.addInput("in","Texture"),this.addOutput("avg","Texture"),this.addOutput("array","Texture"),this.properties={samples:64,frames_interval:1},this._uniforms={u_texture:0,u_textureB:1,u_samples:this.properties.samples,u_isamples:1/this.properties.samples},this.frame=0}function x(){this.addInput("Image","image"),this.addOutput("","Texture"),this.properties={}}function _(){this.addInput("Texture","Texture"),this.addInput("LUT","Texture"),this.addInput("Intensity","number"),this.addOutput("","Texture"),this.properties={enabled:!0,intensity:1,precision:o.DEFAULT,texture:null},_._shader||(_._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,_.pixel_shader))}function b(){this.addInput("Texture","Texture"),this.addInput("Atlas","Texture"),this.addOutput("","Texture"),this.properties={enabled:!0,num_row_symbols:4,symbol_size:16,brightness:1,colorize:!1,filter:!1,invert:!1,precision:o.DEFAULT,generate_mipmaps:!1,texture:null},b._shader||(b._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,b.pixel_shader)),this._uniforms={u_texture:0,u_textureB:1,u_row_simbols:4,u_simbol_size:16,u_res:vec2.create()}}function T(){this.addInput("Texture","Texture"),this.addOutput("R","Texture"),this.addOutput("G","Texture"),this.addOutput("B","Texture"),this.addOutput("A","Texture"),T._shader||(T._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,T.pixel_shader))}function E(){this.addInput("R","Texture"),this.addInput("G","Texture"),this.addInput("B","Texture"),this.addInput("A","Texture"),this.addOutput("Texture","Texture"),this.properties={precision:o.DEFAULT,R:1,G:1,B:1,A:1},this._color=vec4.create(),this._uniforms={u_textureR:0,u_textureG:1,u_textureB:2,u_textureA:3,u_color:this._color}}function w(){this.addOutput("Texture","Texture"),this._tex_color=vec4.create(),this.properties={color:vec4.create(),precision:o.DEFAULT}}function O(){this.addInput("A","color"),this.addInput("B","color"),this.addOutput("Texture","Texture"),this.properties={angle:0,scale:1,A:[0,0,0],B:[1,1,1],texture_size:32},O._shader||(O._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,O.pixel_shader)),this._uniforms={u_angle:0,u_colorA:vec3.create(),u_colorB:vec3.create()}}function I(){this.addInput("A","Texture"),this.addInput("B","Texture"),this.addInput("Mixer","Texture"),this.addOutput("Texture","Texture"),this.properties={factor:.5,size_from_biggest:!0,invert:!1,precision:o.DEFAULT},this._uniforms={u_textureA:0,u_textureB:1,u_textureMix:2,u_mix:vec4.create()}}function D(){this.addInput("Tex.","Texture"),this.addOutput("Edges","Texture"),this.properties={invert:!0,threshold:!1,factor:1,precision:o.DEFAULT},D._shader||(D._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,D.pixel_shader))}function N(){this.addInput("Texture","Texture"),this.addInput("Distance","number"),this.addInput("Range","number"),this.addOutput("Texture","Texture"),this.properties={distance:100,range:50,only_depth:!1,high_precision:!1},this._uniforms={u_texture:0,u_distance:100,u_range:50,u_camera_planes:null}}function C(){this.addInput("Texture","Texture"),this.addOutput("Texture","Texture"),this.properties={precision:o.DEFAULT,invert:!1},this._uniforms={u_texture:0,u_camera_planes:null,u_ires:vec2.create()}}function S(){this.addInput("Texture","Texture"),this.addInput("Iterations","number"),this.addInput("Intensity","number"),this.addOutput("Blurred","Texture"),this.properties={intensity:1,iterations:1,preserve_aspect:!1,scale:[1,1],precision:o.DEFAULT}}function A(){this.intensity=.5,this.persistence=.6,this.iterations=8,this.threshold=.8,this.scale=1,this.dirt_texture=null,this.dirt_factor=.5,this._textures=[],this._uniforms={u_intensity:1,u_texture:0,u_glow_texture:1,u_threshold:0,u_texel_size:vec2.create()}}function k(){this.addInput("in","Texture"),this.addInput("dirt","Texture"),this.addOutput("out","Texture"),this.addOutput("glow","Texture"),this.properties={enabled:!0,intensity:1,persistence:.99,iterations:16,threshold:0,scale:1,dirt_factor:.5,precision:o.DEFAULT},this.fx=new A}function R(){this.addInput("Texture","Texture"),this.addOutput("Filtered","Texture"),this.properties={intensity:1,radius:5}}function P(){this.addInput("Texture","Texture"),this.addOutput("Filtered","Texture"),this.properties={sigma:1.4,k:1.6,p:21.7,epsilon:79,phi:.017}}function L(){this.addOutput("Webcam","Texture"),this.properties={texture_name:"",facingMode:"user"},this.boxcolor="black",this.version=0}function z(){this.addInput("in","Texture"),this.addInput("f","number"),this.addOutput("out","Texture"),this.properties={enabled:!0,factor:1,precision:o.LOW},this._uniforms={u_texture:0,u_factor:1}}function G(){this.addInput("in",""),this.properties={precision:o.LOW,width:0,height:0,channels:1},this.addOutput("out","Texture")}function B(){this.addInput("in","Texture"),this.addOutput("out","Texture"),this.properties={precision:o.LOW,split_channels:!1},this._values=new Uint8Array(1024),this._values.fill(255),this._curve_texture=null,this._uniforms={u_texture:0,u_curve:1,u_range:1},this._must_update=!0,this._points={RGB:[[0,0],[1,1]],R:[[0,0],[1,1]],G:[[0,0],[1,1]],B:[[0,0],[1,1]]},this.curve_editor=null,this.addWidget("toggle","Split Channels",!1,"split_channels"),this.addWidget("combo","Channel","RGB",{values:["RGB","R","G","B"]}),this.curve_offset=68,this.size=[240,160]}function F(){this.addInput("in","Texture"),this.addInput("exp","number"),this.addOutput("out","Texture"),this.properties={exposition:1,precision:o.LOW},this._uniforms={u_texture:0,u_exposition:1}}function M(){this.addInput("in","Texture"),this.addInput("avg","number,Texture"),this.addOutput("out","Texture"),this.properties={enabled:!0,scale:1,gamma:1,average_lum:1,lum_white:1,precision:o.LOW},this._uniforms={u_texture:0,u_lumwhite2:1,u_igamma:1,u_scale:1,u_average_lum:1}}function H(){this.addOutput("out","Texture"),this.properties={width:512,height:512,seed:0,persistence:.1,octaves:8,scale:1,offset:[0,0],amplitude:1,precision:o.DEFAULT},this._key=0,this._texture=null,this._uniforms={u_persistence:.1,u_seed:0,u_offset:vec2.create(),u_scale:1,u_viewport:vec2.create()}}function U(){this.addInput("v"),this.addOutput("out","Texture"),this.properties={code:U.default_code,width:512,height:512,clear:!0,precision:o.DEFAULT,use_html_canvas:!1},this._func=null,this._temp_texture=null,this.compileCode()}function V(){this.addInput("in","Texture"),this.addOutput("out","Texture"),this.properties={key_color:vec3.fromValues(0,1,0),threshold:.8,slope:.2,precision:o.DEFAULT}}function W(){this.addInput("in","texture"),this.addInput("yaw","number"),this.addOutput("out","texture"),this.properties={yaw:0}}t.LGraphTexture=null,"undefined"!=typeof GL&&(s.link_type_colors.Texture="#987",t.LGraphTexture=o,o.title="Texture",o.desc="Texture",o.widgets_info={name:{widget:"texture"},filter:{widget:"checkbox"}},o.loadTextureCallback=null,o.image_preview_size=256,o.UNDEFINED=0,o.PASS_THROUGH=1,o.COPY=2,o.LOW=3,o.HIGH=4,o.REUSE=5,o.DEFAULT=2,o.MODE_VALUES={undefined:o.UNDEFINED,"pass through":o.PASS_THROUGH,copy:o.COPY,low:o.LOW,high:o.HIGH,reuse:o.REUSE,default:o.DEFAULT},o.getTexturesContainer=function(){return gl.textures},o.loadTexture=function(t,s){s=s||{};var n=t;return"http://"==n.substr(0,7)&&e.proxy&&(n=e.proxy+n.substr(7)),o.getTexturesContainer()[t]=GL.Texture.fromURL(n,s)},o.getTexture=function(t){var e=this.getTexturesContainer();if(!e)throw"Cannot load texture, container of textures not found";var s=e[t];return!s&&t&&":"!=t[0]?this.loadTexture(t):s},o.getTargetTexture=function(t,e,s){if(!t)throw"LGraphTexture.getTargetTexture expects a reference texture";var n=null;switch(s){case o.LOW:n=gl.UNSIGNED_BYTE;break;case o.HIGH:n=gl.HIGH_PRECISION_FORMAT;break;case o.REUSE:return t;case o.COPY:default:n=t?t.type:gl.UNSIGNED_BYTE}return e&&e.width==t.width&&e.height==t.height&&e.type==n&&e.format==t.format||(e=new GL.Texture(t.width,t.height,{type:n,format:t.format,filter:gl.LINEAR})),e},o.getTextureType=function(t,e){var s=e?e.type:gl.UNSIGNED_BYTE;switch(t){case o.HIGH:s=gl.HIGH_PRECISION_FORMAT;break;case o.LOW:s=gl.UNSIGNED_BYTE}return s},o.getWhiteTexture=function(){return this._white_texture?this._white_texture:this._white_texture=GL.Texture.fromMemory(1,1,[255,255,255,255],{format:gl.RGBA,wrap:gl.REPEAT,filter:gl.NEAREST})},o.getNoiseTexture=function(){if(this._noise_texture)return this._noise_texture;for(var t=new Uint8Array(1048576),e=0;e<1048576;++e)t[e]=255*Math.random();var s=GL.Texture.fromMemory(512,512,t,{format:gl.RGBA,wrap:gl.REPEAT,filter:gl.NEAREST});return this._noise_texture=s,s},o.prototype.onDropFile=function(t,e,s){if(t){var o=null;if("string"==typeof t)o=GL.Texture.fromURL(t);else if(-1!=e.toLowerCase().indexOf(".dds"))o=GL.Texture.fromDDSInMemory(t);else{var n=new Blob([s]),r=URL.createObjectURL(n);o=GL.Texture.fromURL(r)}this._drop_texture=o,this.properties.name=e}else this._drop_texture=null,this.properties.name=""},o.prototype.getExtraMenuOptions=function(t){var e=this;if(this._drop_texture)return[{content:"Clear",callback:function(){e._drop_texture=null,e.properties.name=""}}]},o.prototype.onExecute=function(){var t=null;if(this.isOutputConnected(1)&&(t=this.getInputData(0)),!t&&this._drop_texture&&(t=this._drop_texture),!t&&this.properties.name&&(t=o.getTexture(this.properties.name)),!t){this.setOutputData(0,null),this.setOutputData(1,"");return}this._last_tex=t,!1===this.properties.filter?t.setParameter(gl.TEXTURE_MAG_FILTER,gl.NEAREST):t.setParameter(gl.TEXTURE_MAG_FILTER,gl.LINEAR),this.setOutputData(0,t),this.setOutputData(1,t.fullpath||t.filename);for(var e=2;e<this.outputs.length;e++){var s=this.outputs[e];if(s){var n=null;"width"==s.name?n=t.width:"height"==s.name?n=t.height:"aspect"==s.name&&(n=t.width/t.height),this.setOutputData(e,n)}}},o.prototype.onResourceRenamed=function(t,e){this.properties.name==t&&(this.properties.name=e)},o.prototype.onDrawBackground=function(t){if(!this.flags.collapsed&&!(this.size[1]<=20)){if(this._drop_texture&&t.webgl){t.drawImage(this._drop_texture,0,0,this.size[0],this.size[1]);return}if(this._last_preview_tex!=this._last_tex){if(t.webgl)this._canvas=this._last_tex;else{var e=o.generateLowResTexturePreview(this._last_tex);if(!e)return;this._last_preview_tex=this._last_tex,this._canvas=cloneCanvas(e)}}this._canvas&&(t.save(),t.webgl||(t.translate(0,this.size[1]),t.scale(1,-1)),t.drawImage(this._canvas,0,0,this.size[0],this.size[1]),t.restore())}},o.generateLowResTexturePreview=function(t){if(!t)return null;var e=o.image_preview_size,s=t;if(t.format==gl.DEPTH_COMPONENT)return null;(t.width>e||t.height>e)&&(s=this._preview_temp_tex,this._preview_temp_tex||(s=new GL.Texture(e,e,{minFilter:gl.NEAREST}),this._preview_temp_tex=s),t.copyTo(s),t=s);var n=this._preview_canvas;return n||(n=createCanvas(e,e),this._preview_canvas=n),s&&s.toCanvas(n),n},o.prototype.getResources=function(t){return this.properties.name&&(t[this.properties.name]=GL.Texture),t},o.prototype.onGetInputs=function(){return[["in","Texture"]]},o.prototype.onGetOutputs=function(){return[["width","number"],["height","number"],["aspect","number"]]},o.replaceCode=function(t,e){return t.replace(/\{\{[a-zA-Z0-9_]*\}\}/g,function(t){return e[t=t.replace(/[\{\}]/g,"")]||""})},e.registerNodeType("texture/texture",o),n.title="Preview",n.desc="Show a texture in the graph canvas",n.allow_preview=!1,n.prototype.onDrawBackground=function(t){if(!this.flags.collapsed&&(t.webgl||n.allow_preview)){var e=this.getInputData(0);if(e){var s=null;s=!e.handle&&t.webgl?e:o.generateLowResTexturePreview(e),t.save(),this.properties.flipY&&(t.translate(0,this.size[1]),t.scale(1,-1)),t.drawImage(s,0,0,this.size[0],this.size[1]),t.restore()}}},e.registerNodeType("texture/preview",n),r.title="Save",r.desc="Save a texture in the repository",r.prototype.getPreviewTexture=function(){return this._texture},r.prototype.onExecute=function(){var t=this.getInputData(0);t&&(this.properties.generate_mipmaps&&(t.bind(0),t.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_LINEAR),gl.generateMipmap(t.texture_type),t.unbind(0)),this.properties.name&&(o.storeTexture?o.storeTexture(this.properties.name,t):o.getTexturesContainer()[this.properties.name]=t),this._texture=t,this.setOutputData(0,t),this.setOutputData(1,this.properties.name))},e.registerNodeType("texture/save",r),a.widgets_info={uvcode:{widget:"code"},pixelcode:{widget:"code"},precision:{widget:"combo",values:o.MODE_VALUES}},a.title="Operation",a.desc="Texture shader operation",a.presets={},a.prototype.getExtraMenuOptions=function(t){var e=this;return[{content:e.properties.show?"Hide Texture":"Show Texture",callback:function(){e.properties.show=!e.properties.show}}]},a.prototype.onPropertyChanged=function(){this.has_error=!1},a.prototype.onDrawBackground=function(t){!this.flags.collapsed&&!(this.size[1]<=20)&&this.properties.show&&this._tex&&this._tex.gl==t&&(t.save(),t.drawImage(this._tex,0,0,this.size[0],this.size[1]),t.restore())},a.prototype.onExecute=function(){var t=this.getInputData(0);if(this.isOutputConnected(0)){if(this.properties.precision===o.PASS_THROUGH){this.setOutputData(0,t);return}var e=this.getInputData(1);if(this.properties.uvcode||this.properties.pixelcode){var s=512,n=512;t?(s=t.width,n=t.height):e&&(s=e.width,n=e.height),e||(e=GL.Texture.getWhiteTexture());var r=o.getTextureType(this.properties.precision,t);t||this._tex?this._tex=o.getTargetTexture(t||this._tex,this._tex,this.properties.precision):this._tex=new GL.Texture(s,n,{type:r,format:gl.RGBA,filter:gl.LINEAR});var u="";this.properties.uvcode&&(u="uv = "+this.properties.uvcode,-1!=this.properties.uvcode.indexOf(";")&&(u=this.properties.uvcode));var h="";this.properties.pixelcode&&(h="result = "+this.properties.pixelcode,-1!=this.properties.pixelcode.indexOf(";")&&(h=this.properties.pixelcode));var l=this._shader;if(!this.has_error&&(!l||this._shader_code!=u+"|"+h)){var d=o.replaceCode(a.pixel_shader,{UV_CODE:u,PIXEL_CODE:h});try{l=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,d),this.boxcolor="#00FF00"}catch(c){GL.Shader.dumpErrorToConsole(c,Shader.SCREEN_VERTEX_SHADER,d),this.boxcolor="#FF0000",this.has_error=!0;return}this._shader=l,this._shader_code=u+"|"+h}if(this._shader){var f=this.getInputData(2);null!=f?this.properties.value=f:f=parseFloat(this.properties.value);var g=this.graph.getTime();this._tex.drawTo(function(){gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.disable(gl.BLEND),t&&t.bind(0),e&&e.bind(1);var o=Mesh.getScreenQuad();l.uniforms({u_texture:0,u_textureB:1,value:f,texSize:[s,n,1/s,1/n],time:g}).draw(o)}),this.setOutputData(0,this._tex)}}}},a.pixel_shader="precision highp float;\n		\n		uniform sampler2D u_texture;\n		uniform sampler2D u_textureB;\n		varying vec2 v_coord;\n		uniform vec4 texSize;\n		uniform float time;\n		uniform float value;\n		\n		void main() {\n			vec2 uv = v_coord;\n			{{UV_CODE}};\n			vec4 color4 = texture2D(u_texture, uv);\n			vec3 color = color4.rgb;\n			vec4 color4B = texture2D(u_textureB, uv);\n			vec3 colorB = color4B.rgb;\n			vec3 result = color;\n			float alpha = 1.0;\n			{{PIXEL_CODE}};\n			gl_FragColor = vec4(result, alpha);\n		}\n		",a.registerPreset=function(t,e){a.presets[t]=e},a.registerPreset("",""),a.registerPreset("bypass","color"),a.registerPreset("add","color + colorB * value"),a.registerPreset("substract","(color - colorB) * value"),a.registerPreset("mate","mix( color, colorB, color4B.a * value)"),a.registerPreset("invert","vec3(1.0) - color"),a.registerPreset("multiply","color * colorB * value"),a.registerPreset("divide","(color / colorB) / value"),a.registerPreset("difference","abs(color - colorB) * value"),a.registerPreset("max","max(color, colorB) * value"),a.registerPreset("min","min(color, colorB) * value"),a.registerPreset("displace","texture2D(u_texture, uv + (colorB.xy - vec2(0.5)) * value).xyz"),a.registerPreset("grayscale","vec3(color.x + color.y + color.z) * value / 3.0"),a.registerPreset("saturation","mix( vec3(color.x + color.y + color.z) / 3.0, color, value )"),a.registerPreset("normalmap","\n		float z0 = texture2D(u_texture, uv + vec2(-texSize.z, -texSize.w) ).x;\n		float z1 = texture2D(u_texture, uv + vec2(0.0, -texSize.w) ).x;\n		float z2 = texture2D(u_texture, uv + vec2(texSize.z, -texSize.w) ).x;\n		float z3 = texture2D(u_texture, uv + vec2(-texSize.z, 0.0) ).x;\n		float z4 = color.x;\n		float z5 = texture2D(u_texture, uv + vec2(texSize.z, 0.0) ).x;\n		float z6 = texture2D(u_texture, uv + vec2(-texSize.z, texSize.w) ).x;\n		float z7 = texture2D(u_texture, uv + vec2(0.0, texSize.w) ).x;\n		float z8 = texture2D(u_texture, uv + vec2(texSize.z, texSize.w) ).x;\n		vec3 normal = vec3( z2 + 2.0*z4 + z7 - z0 - 2.0*z3 - z5, z5 + 2.0*z6 + z7 -z0 - 2.0*z1 - z2, 1.0 );\n		normal.xy *= value;\n		result.xyz = normalize(normal) * 0.5 + vec3(0.5);\n	"),a.registerPreset("threshold","vec3(color.x > colorB.x * value ? 1.0 : 0.0,color.y > colorB.y * value ? 1.0 : 0.0,color.z > colorB.z * value ? 1.0 : 0.0)"),a.prototype.onInspect=function(t){var e=this;t.addCombo("Presets","",{values:Object.keys(a.presets),callback:function(s){var o=a.presets[s];o&&(e.setProperty("pixelcode",o),e.title=s,t.refresh())}})},e.registerNodeType("texture/operation",a),u.title="Shader",u.desc="Texture shader",u.widgets_info={code:{type:"code",lang:"glsl"},precision:{widget:"combo",values:o.MODE_VALUES}},u.prototype.onPropertyChanged=function(t,e){if("code"==t){var s=this.getShader();if(s){var o=s.uniformInfo;if(this.inputs)for(var n={},r=0;r<this.inputs.length;++r){var a=this.getInputInfo(r);if(a){if(o[a.name]&&!n[a.name]){n[a.name]=!0;continue}this.removeInput(r),r--}}for(var r in o){var a=s.uniformInfo[r];if(null!==a.loc&&"time"!=r){var u="number";if(this._shader.samplers[r])u="texture";else switch(a.size){case 1:u="number";break;case 2:u="vec2";break;case 3:u="vec3";break;case 4:u="vec4";break;case 9:u="mat3";break;case 16:u="mat4";break;default:continue}var h=this.findInputSlot(r);if(-1==h){this.addInput(r,u);continue}var l=this.getInputInfo(h);if(l){if(l.type==u)continue;this.removeInput(h,u),this.addInput(r,u)}else this.addInput(r,u)}}}}},u.prototype.getShader=function(){return this._shader&&this._shader_code==this.properties.code?this._shader:(this._shader_code=this.properties.code,this._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,this.properties.code),this._shader)?(this.boxcolor="green",this._shader):(this.boxcolor="red",null)},u.prototype.onExecute=function(){if(this.isOutputConnected(0)){var t=this.getShader();if(t){var e=0,s=null;if(this.inputs)for(var n=0;n<this.inputs.length;++n){var r=this.getInputInfo(n),a=this.getInputData(n);null!=a&&(a.constructor===GL.Texture&&(a.bind(e),s||(s=a),a=e,e++),t.setUniform(r.name,a))}var u,h=this._uniforms,l=o.getTextureType(this.properties.precision,s),d=0|this.properties.width,c=0|this.properties.height;0==d&&(d=s?s.width:gl.canvas.width),0==c&&(c=s?s.height:gl.canvas.height),h.texSize[0]=d,h.texSize[1]=c,h.texSize[2]=1/d,h.texSize[3]=1/c,h.time=this.graph.getTime(),h.u_value=this.properties.u_value,h.u_color.set(this.properties.u_color),this._tex&&this._tex.type==l&&this._tex.width==d&&this._tex.height==c||(this._tex=new GL.Texture(d,c,{type:l,format:gl.RGBA,filter:gl.LINEAR})),this._tex.drawTo(function(){t.uniforms(h).draw(GL.Mesh.getScreenQuad())}),this.setOutputData(0,this._tex)}}},u.pixel_shader="precision highp float;\n\nvarying vec2 v_coord;\nuniform float time; //time in seconds\nuniform vec4 texSize; //tex resolution\nuniform float u_value;\nuniform vec4 u_color;\n\nvoid main() {\n	vec2 uv = v_coord;\n	vec3 color = vec3(0.0);\n	//your code here\n	color.xy=uv;\n\n	gl_FragColor = vec4(color, 1.0);\n}\n",e.registerNodeType("texture/shader",u),h.widgets_info={precision:{widget:"combo",values:o.MODE_VALUES}},h.title="Scale/Offset",h.desc="Applies an scaling and offseting",h.prototype.onExecute=function(){var t=this.getInputData(0);if(this.isOutputConnected(0)&&t){if(this.properties.precision===o.PASS_THROUGH){this.setOutputData(0,t);return}var e=t.width,s=t.height,n=this.precision===o.LOW?gl.UNSIGNED_BYTE:gl.HIGH_PRECISION_FORMAT;this.precision===o.DEFAULT&&(n=t.type),this._tex&&this._tex.width==e&&this._tex.height==s&&this._tex.type==n||(this._tex=new GL.Texture(e,s,{type:n,format:gl.RGBA,filter:gl.LINEAR}));var r=this._shader;r||(r=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,h.pixel_shader));var a=this.getInputData(1);a?(this.properties.scale[0]=a[0],this.properties.scale[1]=a[1]):a=this.properties.scale;var u=this.getInputData(2);u?(this.properties.offset[0]=u[0],this.properties.offset[1]=u[1]):u=this.properties.offset,this._tex.drawTo(function(){gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.disable(gl.BLEND),t.bind(0);var e=Mesh.getScreenQuad();r.uniforms({u_texture:0,u_scale:a,u_offset:u}).draw(e)}),this.setOutputData(0,this._tex)}},h.pixel_shader="precision highp float;\n		\n		uniform sampler2D u_texture;\n		uniform sampler2D u_textureB;\n		varying vec2 v_coord;\n		uniform vec2 u_scale;\n		uniform vec2 u_offset;\n		\n		void main() {\n			vec2 uv = v_coord;\n			uv = uv / u_scale - u_offset;\n			gl_FragColor = texture2D(u_texture, uv);\n		}\n		",e.registerNodeType("texture/scaleOffset",h),l.widgets_info={precision:{widget:"combo",values:o.MODE_VALUES}},l.title="Warp",l.desc="Texture warp operation",l.prototype.onExecute=function(){var t=this.getInputData(0);if(this.isOutputConnected(0)){if(this.properties.precision===o.PASS_THROUGH){this.setOutputData(0,t);return}var e=this.getInputData(1),s=512,n=512,r=gl.UNSIGNED_BYTE;t?(s=t.width,n=t.height,r=t.type):e&&(s=e.width,n=e.height,r=e.type),t||this._tex?this._tex=o.getTargetTexture(t||this._tex,this._tex,this.properties.precision):this._tex=new GL.Texture(s,n,{type:this.precision===o.LOW?gl.UNSIGNED_BYTE:gl.HIGH_PRECISION_FORMAT,format:gl.RGBA,filter:gl.LINEAR});var a=this._shader;a||(a=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,l.pixel_shader));var u=this.getInputData(2);null!=u?this.properties.factor=u:u=parseFloat(this.properties.factor);var h=this._uniforms;h.u_factor=u,h.u_scale.set(this.properties.scale),h.u_offset.set(this.properties.offset),this._tex.drawTo(function(){gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.disable(gl.BLEND),t&&t.bind(0),e&&e.bind(1);var s=Mesh.getScreenQuad();a.uniforms(h).draw(s)}),this.setOutputData(0,this._tex)}},l.pixel_shader="precision highp float;\n		\n		uniform sampler2D u_texture;\n		uniform sampler2D u_textureB;\n		varying vec2 v_coord;\n		uniform float u_factor;\n		uniform vec2 u_scale;\n		uniform vec2 u_offset;\n		\n		void main() {\n			vec2 uv = v_coord;\n			uv += ( texture2D(u_textureB, uv).rg - vec2(0.5)) * u_factor * u_scale + u_offset;\n			gl_FragColor = texture2D(u_texture, uv);\n		}\n		",e.registerNodeType("texture/warp",l),d.title="to Viewport",d.desc="Texture to viewport",d._prev_viewport=new Float32Array(4),d.prototype.onDrawBackground=function(t){if(!this.flags.collapsed&&!(this.size[1]<=40)){var e=this.getInputData(0);e&&t.drawImage(t==gl?e:gl.canvas,10,30,this.size[0]-20,this.size[1]-40)}},d.prototype.onExecute=function(){var t=this.getInputData(0);if(t){this.properties.disable_alpha?gl.disable(gl.BLEND):(gl.enable(gl.BLEND),this.properties.additive?gl.blendFunc(gl.SRC_ALPHA,gl.ONE):gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA)),gl.disable(gl.DEPTH_TEST);var e=this.properties.gamma||1;this.isInputConnected(1)&&(e=this.getInputData(1)),t.setParameter(gl.TEXTURE_MAG_FILTER,this.properties.filter?gl.LINEAR:gl.NEAREST);var s=d._prev_viewport;s.set(gl.viewport_data);var o=this.properties.viewport;if(gl.viewport(s[0]+s[2]*o[0],s[1]+s[3]*o[1],s[2]*o[2],s[3]*o[3]),gl.getViewport(),this.properties.antialiasing){d._shader||(d._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,d.aa_pixel_shader));var n=Mesh.getScreenQuad();t.bind(0),d._shader.uniforms({u_texture:0,uViewportSize:[t.width,t.height],u_igamma:1/e,inverseVP:[1/t.width,1/t.height]}).draw(n)}else 1!=e?(d._gamma_shader||(d._gamma_shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,d.gamma_pixel_shader)),t.toViewport(d._gamma_shader,{u_texture:0,u_igamma:1/e})):t.toViewport();gl.viewport(s[0],s[1],s[2],s[3])}},d.prototype.onGetInputs=function(){return[["gamma","number"]]},d.aa_pixel_shader="precision highp float;\n		precision highp float;\n		varying vec2 v_coord;\n		uniform sampler2D u_texture;\n		uniform vec2 uViewportSize;\n		uniform vec2 inverseVP;\n		uniform float u_igamma;\n		#define FXAA_REDUCE_MIN   (1.0/ 128.0)\n		#define FXAA_REDUCE_MUL   (1.0 / 8.0)\n		#define FXAA_SPAN_MAX     8.0\n		\n		/* from mitsuhiko/webgl-meincraft based on the code on geeks3d.com */\n		vec4 applyFXAA(sampler2D tex, vec2 fragCoord)\n		{\n			vec4 color = vec4(0.0);\n			/*vec2 inverseVP = vec2(1.0 / uViewportSize.x, 1.0 / uViewportSize.y);*/\n			vec3 rgbNW = texture2D(tex, (fragCoord + vec2(-1.0, -1.0)) * inverseVP).xyz;\n			vec3 rgbNE = texture2D(tex, (fragCoord + vec2(1.0, -1.0)) * inverseVP).xyz;\n			vec3 rgbSW = texture2D(tex, (fragCoord + vec2(-1.0, 1.0)) * inverseVP).xyz;\n			vec3 rgbSE = texture2D(tex, (fragCoord + vec2(1.0, 1.0)) * inverseVP).xyz;\n			vec3 rgbM  = texture2D(tex, fragCoord  * inverseVP).xyz;\n			vec3 luma = vec3(0.299, 0.587, 0.114);\n			float lumaNW = dot(rgbNW, luma);\n			float lumaNE = dot(rgbNE, luma);\n			float lumaSW = dot(rgbSW, luma);\n			float lumaSE = dot(rgbSE, luma);\n			float lumaM  = dot(rgbM,  luma);\n			float lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\n			float lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\n			\n			vec2 dir;\n			dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\n			dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\n			\n			float dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);\n			\n			float rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\n			dir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX), max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), dir * rcpDirMin)) * inverseVP;\n			\n			vec3 rgbA = 0.5 * (texture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz + \n				texture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\n			vec3 rgbB = rgbA * 0.5 + 0.25 * (texture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz + \n				texture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);\n			\n			//return vec4(rgbA,1.0);\n			float lumaB = dot(rgbB, luma);\n			if ((lumaB < lumaMin) || (lumaB > lumaMax))\n				color = vec4(rgbA, 1.0);\n			else\n				color = vec4(rgbB, 1.0);\n			if(u_igamma != 1.0)\n				color.xyz = pow( color.xyz, vec3(u_igamma) );\n			return color;\n		}\n		\n		void main() {\n		   gl_FragColor = applyFXAA( u_texture, v_coord * uViewportSize) ;\n		}\n		",d.gamma_pixel_shader="precision highp float;\n		precision highp float;\n		varying vec2 v_coord;\n		uniform sampler2D u_texture;\n		uniform float u_igamma;\n		void main() {\n			vec4 color = texture2D( u_texture, v_coord);\n			color.xyz = pow(color.xyz, vec3(u_igamma) );\n		   gl_FragColor = color;\n		}\n		",e.registerNodeType("texture/toviewport",d),c.title="Copy",c.desc="Copy Texture",c.widgets_info={size:{widget:"combo",values:[0,32,64,128,256,512,1024,2048]},precision:{widget:"combo",values:o.MODE_VALUES}},c.prototype.onExecute=function(){var t=this.getInputData(0);if((t||this._temp_texture)&&this.isOutputConnected(0)){if(t){var e=t.width,s=t.height;0!=this.properties.size&&(e=this.properties.size,s=this.properties.size);var n=this._temp_texture,r=t.type;if(this.properties.precision===o.LOW?r=gl.UNSIGNED_BYTE:this.properties.precision===o.HIGH&&(r=gl.HIGH_PRECISION_FORMAT),!n||n.width!=e||n.height!=s||n.type!=r){var a=gl.LINEAR;this.properties.generate_mipmaps&&isPowerOfTwo(e)&&isPowerOfTwo(s)&&(a=gl.LINEAR_MIPMAP_LINEAR),this._temp_texture=new GL.Texture(e,s,{type:r,format:gl.RGBA,minFilter:a,magFilter:gl.LINEAR})}t.copyTo(this._temp_texture),this.properties.generate_mipmaps&&(this._temp_texture.bind(0),gl.generateMipmap(this._temp_texture.texture_type),this._temp_texture.unbind(0))}this.setOutputData(0,this._temp_texture)}},e.registerNodeType("texture/copy",c),f.title="Downsample",f.desc="Downsample Texture",f.widgets_info={iterations:{type:"number",step:1,precision:0,min:0},precision:{widget:"combo",values:o.MODE_VALUES}},f.prototype.onExecute=function(){var t=this.getInputData(0);if((t||this._temp_texture)&&this.isOutputConnected(0)&&t&&t.texture_type===GL.TEXTURE_2D){if(this.properties.iterations<1){this.setOutputData(0,t);return}var e=f._shader;e||(f._shader=e=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,f.pixel_shader));var s=0|t.width,n=0|t.height,r=t.type;this.properties.precision===o.LOW?r=gl.UNSIGNED_BYTE:this.properties.precision===o.HIGH&&(r=gl.HIGH_PRECISION_FORMAT);var a=this.properties.iterations||1,u=t,h=null,l=[],d={type:r,format:t.format},c=vec2.create(),g={u_offset:c};this._texture&&GL.Texture.releaseTemporary(this._texture);for(var v=0;v<a&&(c[0]=1/s,c[1]=1/n,s=s>>1||0,n=n>>1||0,l.push(h=GL.Texture.getTemporary(s,n,d)),u.setParameter(GL.TEXTURE_MAG_FILTER,GL.NEAREST),u.copyTo(h,e,g),1!=s||1!=n);++v)u=h;this._texture=l.pop();for(var v=0;v<l.length;++v)GL.Texture.releaseTemporary(l[v]);this.properties.generate_mipmaps&&(this._texture.bind(0),gl.generateMipmap(this._texture.texture_type),this._texture.unbind(0)),this.setOutputData(0,this._texture)}},f.pixel_shader="precision highp float;\n		precision highp float;\n		uniform sampler2D u_texture;\n		uniform vec2 u_offset;\n		varying vec2 v_coord;\n		\n		void main() {\n			vec4 color = texture2D(u_texture, v_coord );\n			color += texture2D(u_texture, v_coord + vec2( u_offset.x, 0.0 ) );\n			color += texture2D(u_texture, v_coord + vec2( 0.0, u_offset.y ) );\n			color += texture2D(u_texture, v_coord + vec2( u_offset.x, u_offset.y ) );\n		   gl_FragColor = color * 0.25;\n		}\n		",e.registerNodeType("texture/downsample",f),g.title="Resize",g.desc="Resize Texture",g.widgets_info={iterations:{type:"number",step:1,precision:0,min:0},precision:{widget:"combo",values:o.MODE_VALUES}},g.prototype.onExecute=function(){var t=this.getInputData(0);if((t||this._temp_texture)&&this.isOutputConnected(0)&&t&&t.texture_type===GL.TEXTURE_2D){var e=0|this.properties.size[0],s=0|this.properties.size[1];0==e&&(e=t.width),0==s&&(s=t.height);var n=t.type;this.properties.precision===o.LOW?n=gl.UNSIGNED_BYTE:this.properties.precision===o.HIGH&&(n=gl.HIGH_PRECISION_FORMAT),this._texture&&this._texture.width==e&&this._texture.height==s&&this._texture.type==n||(this._texture=new GL.Texture(e,s,{type:n})),t.copyTo(this._texture),this.properties.generate_mipmaps&&(this._texture.bind(0),gl.generateMipmap(this._texture.texture_type),this._texture.unbind(0)),this.setOutputData(0,this._texture)}},e.registerNodeType("texture/resize",g),v.title="Average",v.desc="Compute a partial average (32 random samples) of a texture and stores it as a 1x1 pixel texture.\n If high_quality is true, then it generates the mipmaps first and reads from the lower one.",v.prototype.onExecute=function(){this.properties.use_previous_frame||this.updateAverage();var t=this._luminance;this.setOutputData(0,this._temp_texture),this.setOutputData(1,t),this.setOutputData(2,(t[0]+t[1]+t[2])/3)},v.prototype.onPreRenderExecute=function(){this.updateAverage()},v.prototype.updateAverage=function(){var t=this.getInputData(0);if(t&&(this.isOutputConnected(0)||this.isOutputConnected(1)||this.isOutputConnected(2))){if(!v._shader){v._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,v.pixel_shader);for(var e=new Float32Array(16),s=0;s<e.length;++s)e[s]=Math.random();v._shader.uniforms({u_samples_a:e.subarray(0,16),u_samples_b:e.subarray(16,32)})}var o=this._temp_texture,n=gl.UNSIGNED_BYTE;t.type!=n&&(n=gl.FLOAT),o&&o.type==n||(this._temp_texture=new GL.Texture(1,1,{type:n,format:gl.RGBA,filter:gl.NEAREST})),this._uniforms.u_mipmap_offset=0,this.properties.high_quality&&(this._temp_pot2_texture&&this._temp_pot2_texture.type==n||(this._temp_pot2_texture=new GL.Texture(512,512,{type:n,format:gl.RGBA,minFilter:gl.LINEAR_MIPMAP_LINEAR,magFilter:gl.LINEAR})),t.copyTo(this._temp_pot2_texture),(t=this._temp_pot2_texture).bind(0),gl.generateMipmap(GL.TEXTURE_2D),this._uniforms.u_mipmap_offset=9);var r=v._shader,a=this._uniforms;if(a.u_mipmap_offset=this.properties.mipmap_offset,gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND),this._temp_texture.drawTo(function(){t.toViewport(r,a)}),this.isOutputConnected(1)||this.isOutputConnected(2)){var u=this._temp_texture.getPixels();if(u){var h=this._luminance,n=this._temp_texture.type;h.set(u),n==gl.UNSIGNED_BYTE?vec4.scale(h,h,1/255):n==GL.HALF_FLOAT||GL.HALF_FLOAT_OES}}}},v.pixel_shader="precision highp float;\n		precision highp float;\n		uniform mat4 u_samples_a;\n		uniform mat4 u_samples_b;\n		uniform sampler2D u_texture;\n		uniform float u_mipmap_offset;\n		varying vec2 v_coord;\n		\n		void main() {\n			vec4 color = vec4(0.0);\n			//random average\n			for(int i = 0; i < 4; ++i)\n				for(int j = 0; j < 4; ++j)\n				{\n					color += texture2D(u_texture, vec2( u_samples_a[i][j], u_samples_b[i][j] ), u_mipmap_offset );\n					color += texture2D(u_texture, vec2( 1.0 - u_samples_a[i][j], 1.0 - u_samples_b[i][j] ), u_mipmap_offset );\n				}\n		   gl_FragColor = color * 0.03125;\n		}\n		",e.registerNodeType("texture/average",v),$.widgets_info={mode:{widget:"combo",values:["min","max","avg"]}},$.title="MinMax",$.desc="Compute the scene min max",$.prototype.onExecute=function(){this.properties.use_previous_frame||this.update(),this.setOutputData(0,this._temp_texture),this.setOutputData(1,this._luminance)},$.prototype.onPreRenderExecute=function(){this.update()},$.prototype.update=function(){var t=this.getInputData(0);if(t&&(this.isOutputConnected(0)||this.isOutputConnected(1))){$._shader||($._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,$.pixel_shader)),this._temp_texture;var e=gl.UNSIGNED_BYTE;t.type!=e&&(e=gl.FLOAT);var s=512;if(!this._textures_chain.length||this._textures_chain[0].type!=e)for(;n&&(this._textures_chain[n]=new GL.Texture(s,s,{type:e,format:gl.RGBA,filter:gl.NEAREST}),s>>=2,n++,1!=s););t.copyTo(this._textures_chain[0]);for(var o=this._textures_chain[0],n=1;n<=this._textures_chain.length;++n){var t=this._textures_chain[n];o=t}var r=$._shader,a=this._uniforms;a.u_mipmap_offset=this.properties.mipmap_offset,gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND),this._temp_texture.drawTo(function(){t.toViewport(r,a)})}},$.pixel_shader="precision highp float;\n		precision highp float;\n		uniform mat4 u_samples_a;\n		uniform mat4 u_samples_b;\n		uniform sampler2D u_texture;\n		uniform float u_mipmap_offset;\n		varying vec2 v_coord;\n		\n		void main() {\n			vec4 color = vec4(0.0);\n			//random average\n			for(int i = 0; i < 4; ++i)\n				for(int j = 0; j < 4; ++j)\n				{\n					color += texture2D(u_texture, vec2( u_samples_a[i][j], u_samples_b[i][j] ), u_mipmap_offset );\n					color += texture2D(u_texture, vec2( 1.0 - u_samples_a[i][j], 1.0 - u_samples_b[i][j] ), u_mipmap_offset );\n				}\n		   gl_FragColor = color * 0.03125;\n		}\n		",m.title="Smooth",m.desc="Smooth texture over time",m.prototype.onExecute=function(){var t=this.getInputData(0);if(t&&this.isOutputConnected(0)){m._shader||(m._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,m.pixel_shader));var e=this._temp_texture;if(!e||e.type!=t.type||e.width!=t.width||e.height!=t.height){var s={type:t.type,format:gl.RGBA,filter:gl.NEAREST};this._temp_texture=new GL.Texture(t.width,t.height,s),this._temp_texture2=new GL.Texture(t.width,t.height,s),t.copyTo(this._temp_texture2)}var o=this._temp_texture,n=this._temp_texture2,r=m._shader,a=this._uniforms;a.u_factor=1-this.getInputOrProperty("factor"),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),o.drawTo(function(){n.bind(1),t.toViewport(r,a)}),this.setOutputData(0,o),this._temp_texture=n,this._temp_texture2=o}},m.pixel_shader="precision highp float;\n		precision highp float;\n		uniform sampler2D u_texture;\n		uniform sampler2D u_textureB;\n		uniform float u_factor;\n		varying vec2 v_coord;\n		\n		void main() {\n			gl_FragColor = mix( texture2D( u_texture, v_coord ), texture2D( u_textureB, v_coord ), u_factor );\n		}\n		",e.registerNodeType("texture/temporal_smooth",m),y.title="Lineal Avg Smooth",y.desc="Smooth texture linearly over time",y["@samples"]={type:"number",min:1,max:64,step:1,precision:1},y.prototype.getPreviewTexture=function(){return this._temp_texture2},y.prototype.onExecute=function(){var t=this.getInputData(0);if(t&&this.isOutputConnected(0)){y._shader||(y._shader_copy=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,y.pixel_shader_copy),y._shader_avg=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,y.pixel_shader_avg));var e=clamp(this.properties.samples,0,64),s=this.frame,o=this.properties.frames_interval;if(0==o||s%o==0){var n=this._temp_texture;if(!n||n.type!=t.type||n.width!=e){var r={type:t.type,format:gl.RGBA,filter:gl.NEAREST};this._temp_texture=new GL.Texture(e,1,r),this._temp_texture2=new GL.Texture(e,1,r),this._temp_texture_out=new GL.Texture(1,1,r)}var a=this._temp_texture,u=this._temp_texture2,h=y._shader_copy,l=y._shader_avg,d=this._uniforms;d.u_samples=e,d.u_isamples=1/e,gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),a.drawTo(function(){u.bind(1),t.toViewport(h,d)}),this._temp_texture_out.drawTo(function(){a.toViewport(l,d)}),this.setOutputData(0,this._temp_texture_out),this._temp_texture=u,this._temp_texture2=a}else this.setOutputData(0,this._temp_texture_out);this.setOutputData(1,this._temp_texture2),this.frame++}},y.pixel_shader_copy="precision highp float;\n		precision highp float;\n		uniform sampler2D u_texture;\n		uniform sampler2D u_textureB;\n		uniform float u_isamples;\n		varying vec2 v_coord;\n		\n		void main() {\n			if( v_coord.x <= u_isamples )\n				gl_FragColor = texture2D( u_texture, vec2(0.5) );\n			else\n				gl_FragColor = texture2D( u_textureB, v_coord - vec2(u_isamples,0.0) );\n		}\n		",y.pixel_shader_avg="precision highp float;\n		precision highp float;\n		uniform sampler2D u_texture;\n		uniform int u_samples;\n		uniform float u_isamples;\n		varying vec2 v_coord;\n		\n		void main() {\n			vec4 color = vec4(0.0);\n			for(int i = 0; i < 64; ++i)\n			{\n				color += texture2D( u_texture, vec2( float(i)*u_isamples,0.0) );\n				if(i == (u_samples - 1))\n					break;\n			}\n			gl_FragColor = color * u_isamples;\n		}\n		",e.registerNodeType("texture/linear_avg_smooth",y),x.title="Image to Texture",x.desc="Uploads an image to the GPU",x.prototype.onExecute=function(){var t=this.getInputData(0);if(t){var e=t.videoWidth||t.width,s=t.videoHeight||t.height;if(t.gltexture){this.setOutputData(0,t.gltexture);return}var o=this._temp_texture;o&&o.width==e&&o.height==s||(this._temp_texture=new GL.Texture(e,s,{format:gl.RGBA,filter:gl.LINEAR}));try{this._temp_texture.uploadImage(t)}catch(n){console.error("image comes from an unsafe location, cannot be uploaded to webgl: "+n);return}this.setOutputData(0,this._temp_texture)}},e.registerNodeType("texture/imageToTexture",x),_.widgets_info={texture:{widget:"texture"},precision:{widget:"combo",values:o.MODE_VALUES}},_.title="LUT",_.desc="Apply LUT to Texture",_.prototype.onExecute=function(){if(this.isOutputConnected(0)){var t=this.getInputData(0);if(this.properties.precision===o.PASS_THROUGH||!1===this.properties.enabled){this.setOutputData(0,t);return}if(t){var e=this.getInputData(1);if(e||(e=o.getTexture(this.properties.texture)),!e){this.setOutputData(0,t);return}e.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.bindTexture(gl.TEXTURE_2D,null);var s=this.properties.intensity;this.isInputConnected(2)&&(this.properties.intensity=s=this.getInputData(2)),this._tex=o.getTargetTexture(t,this._tex,this.properties.precision),this._tex.drawTo(function(){e.bind(1),t.toViewport(_._shader,{u_texture:0,u_textureB:1,u_amount:s})}),this.setOutputData(0,this._tex)}}},_.pixel_shader="precision highp float;\n		precision highp float;\n		varying vec2 v_coord;\n		uniform sampler2D u_texture;\n		uniform sampler2D u_textureB;\n		uniform float u_amount;\n		\n		void main() {\n			 lowp vec4 textureColor = clamp( texture2D(u_texture, v_coord), vec4(0.0), vec4(1.0) );\n			 mediump float blueColor = textureColor.b * 63.0;\n			 mediump vec2 quad1;\n			 quad1.y = floor(floor(blueColor) / 8.0);\n			 quad1.x = floor(blueColor) - (quad1.y * 8.0);\n			 mediump vec2 quad2;\n			 quad2.y = floor(ceil(blueColor) / 8.0);\n			 quad2.x = ceil(blueColor) - (quad2.y * 8.0);\n			 highp vec2 texPos1;\n			 texPos1.x = (quad1.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.r);\n			 texPos1.y = 1.0 - ((quad1.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.g));\n			 highp vec2 texPos2;\n			 texPos2.x = (quad2.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.r);\n			 texPos2.y = 1.0 - ((quad2.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.g));\n			 lowp vec4 newColor1 = texture2D(u_textureB, texPos1);\n			 lowp vec4 newColor2 = texture2D(u_textureB, texPos2);\n			 lowp vec4 newColor = mix(newColor1, newColor2, fract(blueColor));\n			 gl_FragColor = vec4( mix( textureColor.rgb, newColor.rgb, u_amount), textureColor.w);\n		}\n		",e.registerNodeType("texture/LUT",_),b.widgets_info={texture:{widget:"texture"},precision:{widget:"combo",values:o.MODE_VALUES}},b.title="Encode",b.desc="Apply a texture atlas to encode a texture",b.prototype.onExecute=function(){if(this.isOutputConnected(0)){var t=this.getInputData(0);if(this.properties.precision===o.PASS_THROUGH||!1===this.properties.enabled){this.setOutputData(0,t);return}if(t){var e=this.getInputData(1);if(e||(e=o.getTexture(this.properties.texture)),!e){this.setOutputData(0,t);return}e.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,this.properties.filter?gl.LINEAR:gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,this.properties.filter?gl.LINEAR:gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.bindTexture(gl.TEXTURE_2D,null);var s=this._uniforms;s.u_row_simbols=Math.floor(this.properties.num_row_symbols),s.u_symbol_size=this.properties.symbol_size,s.u_brightness=this.properties.brightness,s.u_invert=this.properties.invert?1:0,s.u_colorize=this.properties.colorize?1:0,this._tex=o.getTargetTexture(t,this._tex,this.properties.precision),s.u_res[0]=this._tex.width,s.u_res[1]=this._tex.height,this._tex.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),this._tex.drawTo(function(){e.bind(1),t.toViewport(b._shader,s)}),this.properties.generate_mipmaps&&(this._tex.bind(0),gl.generateMipmap(this._tex.texture_type),this._tex.unbind(0)),this.setOutputData(0,this._tex)}}},b.pixel_shader="precision highp float;\n		precision highp float;\n		varying vec2 v_coord;\n		uniform sampler2D u_texture;\n		uniform sampler2D u_textureB;\n		uniform float u_row_simbols;\n		uniform float u_symbol_size;\n		uniform float u_brightness;\n		uniform float u_invert;\n		uniform float u_colorize;\n		uniform vec2 u_res;\n		\n		void main() {\n			vec2 total_symbols = u_res / u_symbol_size;\n			vec2 uv = floor(v_coord * total_symbols) / total_symbols; //pixelate \n			vec2 local_uv = mod(v_coord * u_res, u_symbol_size) / u_symbol_size;\n			lowp vec4 textureColor = texture2D(u_texture, uv );\n			float lum = clamp(u_brightness * (textureColor.x + textureColor.y + textureColor.z)/3.0,0.0,1.0);\n			if( u_invert == 1.0 ) lum = 1.0 - lum;\n			float index = floor( lum * (u_row_simbols * u_row_simbols - 1.0));\n			float col = mod( index, u_row_simbols );\n			float row = u_row_simbols - floor( index / u_row_simbols ) - 1.0;\n			vec2 simbol_uv = ( vec2( col, row ) + local_uv ) / u_row_simbols;\n			vec4 color = texture2D( u_textureB, simbol_uv );\n			if(u_colorize == 1.0)\n				color *= textureColor;\n			gl_FragColor = color;\n		}\n		",e.registerNodeType("texture/encode",b),T.title="Texture to Channels",T.desc="Split texture channels",T.prototype.onExecute=function(){var t=this.getInputData(0);if(t){this._channels||(this._channels=[,,,,]);for(var e=gl.RGB,s=0,o=0;o<4;o++)this.isOutputConnected(o)?(this._channels[o]&&this._channels[o].width==t.width&&this._channels[o].height==t.height&&this._channels[o].type==t.type&&this._channels[o].format==e||(this._channels[o]=new GL.Texture(t.width,t.height,{type:t.type,format:e,filter:gl.LINEAR})),s++):this._channels[o]=null;if(s){gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);for(var n=Mesh.getScreenQuad(),r=T._shader,a=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]],o=0;o<4;o++)this._channels[o]&&(this._channels[o].drawTo(function(){t.bind(0),r.uniforms({u_texture:0,u_mask:a[o]}).draw(n)}),this.setOutputData(o,this._channels[o]))}}},T.pixel_shader="precision highp float;\n		precision highp float;\n		varying vec2 v_coord;\n		uniform sampler2D u_texture;\n		uniform vec4 u_mask;\n		\n		void main() {\n		   gl_FragColor = vec4( vec3( length( texture2D(u_texture, v_coord) * u_mask )), 1.0 );\n		}\n		",e.registerNodeType("texture/textureChannels",T),E.title="Channels to Texture",E.desc="Split texture channels",E.widgets_info={precision:{widget:"combo",values:o.MODE_VALUES}},E.prototype.onExecute=function(){var t=o.getWhiteTexture(),e=this.getInputData(0)||t,s=this.getInputData(1)||t,n=this.getInputData(2)||t,r=this.getInputData(3)||t;gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var a=Mesh.getScreenQuad();E._shader||(E._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,E.pixel_shader));var u=E._shader,h=Math.max(e.width,s.width,n.width,r.width),l=Math.max(e.height,s.height,n.height,r.height),d=this.properties.precision==o.HIGH?o.HIGH_PRECISION_FORMAT:gl.UNSIGNED_BYTE;this._texture&&this._texture.width==h&&this._texture.height==l&&this._texture.type==d||(this._texture=new GL.Texture(h,l,{type:d,format:gl.RGBA,filter:gl.LINEAR}));var c=this._color;c[0]=this.properties.R,c[1]=this.properties.G,c[2]=this.properties.B,c[3]=this.properties.A;var f=this._uniforms;this._texture.drawTo(function(){e.bind(0),s.bind(1),n.bind(2),r.bind(3),u.uniforms(f).draw(a)}),this.setOutputData(0,this._texture)},E.pixel_shader="precision highp float;\n		precision highp float;\n		varying vec2 v_coord;\n		uniform sampler2D u_textureR;\n		uniform sampler2D u_textureG;\n		uniform sampler2D u_textureB;\n		uniform sampler2D u_textureA;\n		uniform vec4 u_color;\n		\n		void main() {\n		   gl_FragColor = u_color * vec4( 					texture2D(u_textureR, v_coord).r,					texture2D(u_textureG, v_coord).r,					texture2D(u_textureB, v_coord).r,					texture2D(u_textureA, v_coord).r);\n		}\n		",e.registerNodeType("texture/channelsTexture",E),w.title="Color",w.desc="Generates a 1x1 texture with a constant color",w.widgets_info={precision:{widget:"combo",values:o.MODE_VALUES}},w.prototype.onDrawBackground=function(t){var e=this.properties.color;t.fillStyle="rgb("+Math.floor(255*clamp(e[0],0,1))+","+Math.floor(255*clamp(e[1],0,1))+","+Math.floor(255*clamp(e[2],0,1))+")",this.flags.collapsed?this.boxcolor=t.fillStyle:t.fillRect(0,0,this.size[0],this.size[1])},w.prototype.onExecute=function(){var t=this.properties.precision==o.HIGH?o.HIGH_PRECISION_FORMAT:gl.UNSIGNED_BYTE;this._tex&&this._tex.type==t||(this._tex=new GL.Texture(1,1,{format:gl.RGBA,type:t,minFilter:gl.NEAREST}));var e=this.properties.color;if(this.inputs)for(var s=0;s<this.inputs.length;s++){var n=this.inputs[s],r=this.getInputData(s);if(void 0!==r)switch(n.name){case"RGB":case"RGBA":e.set(r);break;case"R":e[0]=r;break;case"G":e[1]=r;break;case"B":e[2]=r;break;case"A":e[3]=r}}vec4.sqrDist(this._tex_color,e)>.001&&(this._tex_color.set(e),this._tex.fill(e)),this.setOutputData(0,this._tex)},w.prototype.onGetInputs=function(){return[["RGB","vec3"],["RGBA","vec4"],["R","number"],["G","number"],["B","number"],["A","number"]]},e.registerNodeType("texture/color",w),O.title="Gradient",O.desc="Generates a gradient",O["@A"]={type:"color"},O["@B"]={type:"color"},O["@texture_size"]={type:"enum",values:[32,64,128,256,512]},O.prototype.onExecute=function(){gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var t=GL.Mesh.getScreenQuad(),e=O._shader,s=this.getInputData(0);s||(s=this.properties.A);var o=this.getInputData(1);o||(o=this.properties.B);for(var n=2;n<this.inputs.length;n++){var r=this.inputs[n],a=this.getInputData(n);void 0!==a&&(this.properties[r.name]=a)}var u=this._uniforms;this._uniforms.u_angle=this.properties.angle*DEG2RAD,this._uniforms.u_scale=this.properties.scale,vec3.copy(u.u_colorA,s),vec3.copy(u.u_colorB,o);var h=parseInt(this.properties.texture_size);this._tex&&this._tex.width==h||(this._tex=new GL.Texture(h,h,{format:gl.RGB,filter:gl.LINEAR})),this._tex.drawTo(function(){e.uniforms(u).draw(t)}),this.setOutputData(0,this._tex)},O.prototype.onGetInputs=function(){return[["angle","number"],["scale","number"]]},O.pixel_shader="precision highp float;\n		precision highp float;\n		varying vec2 v_coord;\n		uniform float u_angle;\n		uniform float u_scale;\n		uniform vec3 u_colorA;\n		uniform vec3 u_colorB;\n		\n		vec2 rotate(vec2 v, float angle)\n		{\n			vec2 result;\n			float _cos = cos(angle);\n			float _sin = sin(angle);\n			result.x = v.x * _cos - v.y * _sin;\n			result.y = v.x * _sin + v.y * _cos;\n			return result;\n		}\n		void main() {\n			float f = (rotate(u_scale * (v_coord - vec2(0.5)), u_angle) + vec2(0.5)).x;\n			vec3 color = mix(u_colorA,u_colorB,clamp(f,0.0,1.0));\n		   gl_FragColor = vec4(color,1.0);\n		}\n		",e.registerNodeType("texture/gradient",O),I.title="Mix",I.desc="Generates a texture mixing two textures",I.widgets_info={precision:{widget:"combo",values:o.MODE_VALUES}},I.prototype.onExecute=function(){var t=this.getInputData(0);if(this.isOutputConnected(0)){if(this.properties.precision===o.PASS_THROUGH){this.setOutputData(0,t);return}var e=this.getInputData(1);if(t&&e){var s=this.getInputData(2),n=this.getInputData(3);this._tex=o.getTargetTexture(this.properties.size_from_biggest&&e.width>t.width?e:t,this._tex,this.properties.precision),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var r=Mesh.getScreenQuad(),a=null,u=this._uniforms;if(s)(a=I._shader_tex)||(a=I._shader_tex=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,I.pixel_shader,{MIX_TEX:""}));else{(a=I._shader_factor)||(a=I._shader_factor=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,I.pixel_shader));var h=null==n?this.properties.factor:n;u.u_mix.set([h,h,h,h])}var l=this.properties.invert;this._tex.drawTo(function(){t.bind(l?1:0),e.bind(l?0:1),s&&s.bind(2),a.uniforms(u).draw(r)}),this.setOutputData(0,this._tex)}}},I.prototype.onGetInputs=function(){return[["factor","number"]]},I.pixel_shader="precision highp float;\n		precision highp float;\n		varying vec2 v_coord;\n		uniform sampler2D u_textureA;\n		uniform sampler2D u_textureB;\n		#ifdef MIX_TEX\n			uniform sampler2D u_textureMix;\n		#else\n			uniform vec4 u_mix;\n		#endif\n		\n		void main() {\n			#ifdef MIX_TEX\n			   vec4 f = texture2D(u_textureMix, v_coord);\n			#else\n			   vec4 f = u_mix;\n			#endif\n		   gl_FragColor = mix( texture2D(u_textureA, v_coord), texture2D(u_textureB, v_coord), f );\n		}\n		",e.registerNodeType("texture/mix",I),D.title="Edges",D.desc="Detects edges",D.widgets_info={precision:{widget:"combo",values:o.MODE_VALUES}},D.prototype.onExecute=function(){if(this.isOutputConnected(0)){var t=this.getInputData(0);if(this.properties.precision===o.PASS_THROUGH){this.setOutputData(0,t);return}if(t){this._tex=o.getTargetTexture(t,this._tex,this.properties.precision),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var e=Mesh.getScreenQuad(),s=D._shader,n=this.properties.invert,r=this.properties.factor,a=this.properties.threshold?1:0;this._tex.drawTo(function(){t.bind(0),s.uniforms({u_texture:0,u_isize:[1/t.width,1/t.height],u_factor:r,u_threshold:a,u_invert:n?1:0}).draw(e)}),this.setOutputData(0,this._tex)}}},D.pixel_shader="precision highp float;\n		precision highp float;\n		varying vec2 v_coord;\n		uniform sampler2D u_texture;\n		uniform vec2 u_isize;\n		uniform int u_invert;\n		uniform float u_factor;\n		uniform float u_threshold;\n		\n		void main() {\n			vec4 center = texture2D(u_texture, v_coord);\n			vec4 up = texture2D(u_texture, v_coord + u_isize * vec2(0.0,1.0) );\n			vec4 down = texture2D(u_texture, v_coord + u_isize * vec2(0.0,-1.0) );\n			vec4 left = texture2D(u_texture, v_coord + u_isize * vec2(1.0,0.0) );\n			vec4 right = texture2D(u_texture, v_coord + u_isize * vec2(-1.0,0.0) );\n			vec4 diff = abs(center - up) + abs(center - down) + abs(center - left) + abs(center - right);\n			diff *= u_factor;\n			if(u_invert == 1)\n				diff.xyz = vec3(1.0) - diff.xyz;\n			if( u_threshold == 0.0 )\n				gl_FragColor = vec4( diff.xyz, center.a );\n			else\n				gl_FragColor = vec4( diff.x > 0.5 ? 1.0 : 0.0, diff.y > 0.5 ? 1.0 : 0.0, diff.z > 0.5 ? 1.0 : 0.0, center.a );\n		}\n		",e.registerNodeType("texture/edges",D),N.title="Depth Range",N.desc="Generates a texture with a depth range",N.prototype.onExecute=function(){if(this.isOutputConnected(0)){var t=this.getInputData(0);if(t){var e=gl.UNSIGNED_BYTE;this.properties.high_precision&&(e=gl.half_float_ext?gl.HALF_FLOAT_OES:gl.FLOAT),this._temp_texture&&this._temp_texture.type==e&&this._temp_texture.width==t.width&&this._temp_texture.height==t.height||(this._temp_texture=new GL.Texture(t.width,t.height,{type:e,format:gl.RGBA,filter:gl.LINEAR}));var s=this._uniforms,o=this.properties.distance;this.isInputConnected(1)&&(o=this.getInputData(1),this.properties.distance=o);var n=this.properties.range;this.isInputConnected(2)&&(n=this.getInputData(2),this.properties.range=n),s.u_distance=o,s.u_range=n,gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var r=Mesh.getScreenQuad();N._shader||(N._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,N.pixel_shader),N._shader_onlydepth=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,N.pixel_shader,{ONLY_DEPTH:""}));var a=this.properties.only_depth?N._shader_onlydepth:N._shader,u=null;u=t.near_far_planes?t.near_far_planes:window.LS&&LS.Renderer._main_camera?LS.Renderer._main_camera._uniforms.u_camera_planes:[.1,1e3],s.u_camera_planes=u,this._temp_texture.drawTo(function(){t.bind(0),a.uniforms(s).draw(r)}),this._temp_texture.near_far_planes=u,this.setOutputData(0,this._temp_texture)}}},N.pixel_shader="precision highp float;\n		precision highp float;\n		varying vec2 v_coord;\n		uniform sampler2D u_texture;\n		uniform vec2 u_camera_planes;\n		uniform float u_distance;\n		uniform float u_range;\n		\n		float LinearDepth()\n		{\n			float zNear = u_camera_planes.x;\n			float zFar = u_camera_planes.y;\n			float depth = texture2D(u_texture, v_coord).x;\n			depth = depth * 2.0 - 1.0;\n			return zNear * (depth + 1.0) / (zFar + zNear - depth * (zFar - zNear));\n		}\n		\n		void main() {\n			float depth = LinearDepth();\n			#ifdef ONLY_DEPTH\n			   gl_FragColor = vec4(depth);\n			#else\n				float diff = abs(depth * u_camera_planes.y - u_distance);\n				float dof = 1.0;\n				if(diff <= u_range)\n					dof = diff / u_range;\n			   gl_FragColor = vec4(dof);\n			#endif\n		}\n		",e.registerNodeType("texture/depth_range",N),C.widgets_info={precision:{widget:"combo",values:o.MODE_VALUES}},C.title="Linear Depth",C.desc="Creates a color texture with linear depth",C.prototype.onExecute=function(){if(this.isOutputConnected(0)){var t=this.getInputData(0);if(t&&(t.format==gl.DEPTH_COMPONENT||t.format==gl.DEPTH_STENCIL)){var e=this.properties.precision==o.HIGH?gl.HIGH_PRECISION_FORMAT:gl.UNSIGNED_BYTE;this._temp_texture&&this._temp_texture.type==e&&this._temp_texture.width==t.width&&this._temp_texture.height==t.height||(this._temp_texture=new GL.Texture(t.width,t.height,{type:e,format:gl.RGB,filter:gl.LINEAR}));var s=this._uniforms;s.u_invert=this.properties.invert?1:0,gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var n=Mesh.getScreenQuad();C._shader||(C._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,C.pixel_shader));var r=C._shader,a=null;a=t.near_far_planes?t.near_far_planes:window.LS&&LS.Renderer._main_camera?LS.Renderer._main_camera._uniforms.u_camera_planes:[.1,1e3],s.u_camera_planes=a,s.u_ires.set([0,0]),this._temp_texture.drawTo(function(){t.bind(0),r.uniforms(s).draw(n)}),this._temp_texture.near_far_planes=a,this.setOutputData(0,this._temp_texture)}}},C.pixel_shader="precision highp float;\n		precision highp float;\n		varying vec2 v_coord;\n		uniform sampler2D u_texture;\n		uniform vec2 u_camera_planes;\n		uniform int u_invert;\n		uniform vec2 u_ires;\n		\n		void main() {\n			float zNear = u_camera_planes.x;\n			float zFar = u_camera_planes.y;\n			float depth = texture2D(u_texture, v_coord + u_ires*0.5).x * 2.0 - 1.0;\n			float f = zNear * (depth + 1.0) / (zFar + zNear - depth * (zFar - zNear));\n			if( u_invert == 1 )\n				f = 1.0 - f;\n			gl_FragColor = vec4(vec3(f),1.0);\n		}\n		",e.registerNodeType("texture/linear_depth",C),S.title="Blur",S.desc="Blur a texture",S.widgets_info={precision:{widget:"combo",values:o.MODE_VALUES}},S.max_iterations=20,S.prototype.onExecute=function(){var t=this.getInputData(0);if(t&&this.isOutputConnected(0)){var s=this._final_texture;s&&s.width==t.width&&s.height==t.height&&s.type==t.type||(s=this._final_texture=new GL.Texture(t.width,t.height,{type:t.type,format:gl.RGBA,filter:gl.LINEAR}));var o=this.properties.iterations;if(this.isInputConnected(1)&&(o=this.getInputData(1),this.properties.iterations=o),0==(o=Math.min(Math.floor(o),S.max_iterations))){this.setOutputData(0,t);return}var n=this.properties.intensity;this.isInputConnected(2)&&(n=this.getInputData(2),this.properties.intensity=n);var r=e.camera_aspect;r||void 0===window.gl||(r=gl.canvas.height/gl.canvas.width),r||(r=1),r=this.properties.preserve_aspect?r:1;var a=this.properties.scale||[1,1];t.applyBlur(r*a[0],a[1],n,s);for(var u=1;u<o;++u)s.applyBlur(r*a[0]*(u+1),a[1]*(u+1),n);this.setOutputData(0,s)}},e.registerNodeType("texture/blur",S),A.prototype.applyFX=function(t,e,s,o){var n=t.width,r=t.height,a={format:t.format,type:t.type,minFilter:GL.LINEAR,magFilter:GL.LINEAR,wrap:gl.CLAMP_TO_EDGE},u=this._uniforms,h=this._textures,l=A._cut_shader;l||(l=A._cut_shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,A.cut_pixel_shader)),gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND),u.u_threshold=this.threshold;var d=h[0]=GL.Texture.getTemporary(n,r,a);t.blit(d,l.uniforms(u));var c=d,f=this.iterations;f=0|clamp(f,1,16);var g=u.u_texel_size,v=this.intensity;u.u_intensity=1,u.u_delta=this.scale;var l=A._shader;l||(l=A._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,A.scale_pixel_shader));for(var $=1;$<f&&((0|r)>1&&(r>>=1),!((n>>=1)<2));$++)d=h[$]=GL.Texture.getTemporary(n,r,a),g[0]=1/c.width,g[1]=1/c.height,c.blit(d,l.uniforms(u)),c=d;for(o&&(g[0]=1/c.width,g[1]=1/c.height,u.u_intensity=v,u.u_delta=1,c.blit(o,l.uniforms(u))),gl.enable(gl.BLEND),gl.blendFunc(gl.ONE,gl.ONE),u.u_intensity=this.persistence,u.u_delta=.5,$-=2;$>=0;$--)d=h[$],h[$]=null,g[0]=1/c.width,g[1]=1/c.height,c.blit(d,l.uniforms(u)),GL.Texture.releaseTemporary(c),c=d;if(gl.disable(gl.BLEND),s&&c.blit(s),e){var m=e,y=this.dirt_texture,x=this.dirt_factor;u.u_intensity=v,(l=y?A._dirt_final_shader:A._final_shader)||(l=y?A._dirt_final_shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,A.final_pixel_shader,{USE_DIRT:""}):A._final_shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,A.final_pixel_shader)),m.drawTo(function(){t.bind(0),c.bind(1),y&&(l.setUniform("u_dirt_factor",x),l.setUniform("u_dirt_texture",y.bind(2))),l.toViewport(u)})}GL.Texture.releaseTemporary(c)},A.cut_pixel_shader="precision highp float;\n	varying vec2 v_coord;\n	uniform sampler2D u_texture;\n	uniform float u_threshold;\n	void main() {\n		gl_FragColor = max( texture2D( u_texture, v_coord ) - vec4( u_threshold ), vec4(0.0) );\n	}",A.scale_pixel_shader="precision highp float;\n	varying vec2 v_coord;\n	uniform sampler2D u_texture;\n	uniform vec2 u_texel_size;\n	uniform float u_delta;\n	uniform float u_intensity;\n	\n	vec4 sampleBox(vec2 uv) {\n		vec4 o = u_texel_size.xyxy * vec2(-u_delta, u_delta).xxyy;\n		vec4 s = texture2D( u_texture, uv + o.xy ) + texture2D( u_texture, uv + o.zy) + texture2D( u_texture, uv + o.xw) + texture2D( u_texture, uv + o.zw);\n		return s * 0.25;\n	}\n	void main() {\n		gl_FragColor = u_intensity * sampleBox( v_coord );\n	}",A.final_pixel_shader="precision highp float;\n	varying vec2 v_coord;\n	uniform sampler2D u_texture;\n	uniform sampler2D u_glow_texture;\n	#ifdef USE_DIRT\n		uniform sampler2D u_dirt_texture;\n	#endif\n	uniform vec2 u_texel_size;\n	uniform float u_delta;\n	uniform float u_intensity;\n	uniform float u_dirt_factor;\n	\n	vec4 sampleBox(vec2 uv) {\n		vec4 o = u_texel_size.xyxy * vec2(-u_delta, u_delta).xxyy;\n		vec4 s = texture2D( u_glow_texture, uv + o.xy ) + texture2D( u_glow_texture, uv + o.zy) + texture2D( u_glow_texture, uv + o.xw) + texture2D( u_glow_texture, uv + o.zw);\n		return s * 0.25;\n	}\n	void main() {\n		vec4 glow = sampleBox( v_coord );\n		#ifdef USE_DIRT\n			glow = mix( glow, glow * texture2D( u_dirt_texture, v_coord ), u_dirt_factor );\n		#endif\n		gl_FragColor = texture2D( u_texture, v_coord ) + u_intensity * glow;\n	}",k.title="Glow",k.desc="Filters a texture giving it a glow effect",k.widgets_info={iterations:{type:"number",min:0,max:16,step:1,precision:0},threshold:{type:"number",min:0,max:10,step:.01,precision:2},precision:{widget:"combo",values:o.MODE_VALUES}},k.prototype.onGetInputs=function(){return[["enabled","boolean"],["threshold","number"],["intensity","number"],["persistence","number"],["iterations","number"],["dirt_factor","number"]]},k.prototype.onGetOutputs=function(){return[["average","Texture"]]},k.prototype.onExecute=function(){var t=this.getInputData(0);if(t&&this.isAnyOutputConnected()){if(this.properties.precision===o.PASS_THROUGH||!1===this.getInputOrProperty("enabled")){this.setOutputData(0,t);return}t.width,t.height;var e=this.fx;e.threshold=this.getInputOrProperty("threshold"),e.iterations=this.getInputOrProperty("iterations"),e.intensity=this.getInputOrProperty("intensity"),e.persistence=this.getInputOrProperty("persistence"),e.dirt_texture=this.getInputData(1),e.dirt_factor=this.getInputOrProperty("dirt_factor"),e.scale=this.properties.scale;var s=o.getTextureType(this.properties.precision,t),n=null;!this.isOutputConnected(2)||(n=this._average_texture)&&n.type==t.type&&n.format==t.format||(n=this._average_texture=new GL.Texture(1,1,{type:t.type,format:t.format,filter:gl.LINEAR}));var r=null;!this.isOutputConnected(1)||(r=this._glow_texture)&&r.width==t.width&&r.height==t.height&&r.type==s&&r.format==t.format||(r=this._glow_texture=new GL.Texture(t.width,t.height,{type:s,format:t.format,filter:gl.LINEAR}));var a=null;!this.isOutputConnected(0)||(a=this._final_texture)&&a.width==t.width&&a.height==t.height&&a.type==s&&a.format==t.format||(a=this._final_texture=new GL.Texture(t.width,t.height,{type:s,format:t.format,filter:gl.LINEAR})),e.applyFX(t,a,r,n),this.isOutputConnected(0)&&this.setOutputData(0,a),this.isOutputConnected(1)&&this.setOutputData(1,n),this.isOutputConnected(2)&&this.setOutputData(2,r)}},e.registerNodeType("texture/glow",k),R.title="Kuwahara Filter",R.desc="Filters a texture giving an artistic oil canvas painting",R.max_radius=10,R._shaders=[],R.prototype.onExecute=function(){var t=this.getInputData(0);if(t&&this.isOutputConnected(0)){var s=this._temp_texture;s&&s.width==t.width&&s.height==t.height&&s.type==t.type||(this._temp_texture=new GL.Texture(t.width,t.height,{type:t.type,format:gl.RGBA,filter:gl.LINEAR}));var o=this.properties.radius;if(0==(o=Math.min(Math.floor(o),R.max_radius))){this.setOutputData(0,t);return}var n=this.properties.intensity,r=e.camera_aspect;r||void 0===window.gl||(r=gl.canvas.height/gl.canvas.width),r||(r=1),r=this.properties.preserve_aspect?r:1,R._shaders[o]||(R._shaders[o]=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,R.pixel_shader,{RADIUS:o.toFixed(0)}));var a=R._shaders[o],u=GL.Mesh.getScreenQuad();t.bind(0),this._temp_texture.drawTo(function(){a.uniforms({u_texture:0,u_intensity:n,u_resolution:[t.width,t.height],u_iResolution:[1/t.width,1/t.height]}).draw(u)}),this.setOutputData(0,this._temp_texture)}},R.pixel_shader="\nprecision highp float;\nvarying vec2 v_coord;\nuniform sampler2D u_texture;\nuniform float u_intensity;\nuniform vec2 u_resolution;\nuniform vec2 u_iResolution;\n#ifndef RADIUS\n	#define RADIUS 7\n#endif\nvoid main() {\n\n	const int radius = RADIUS;\n	vec2 fragCoord = v_coord;\n	vec2 src_size = u_iResolution;\n	vec2 uv = v_coord;\n	float n = float((radius + 1) * (radius + 1));\n	int i;\n	int j;\n	vec3 m0 = vec3(0.0); vec3 m1 = vec3(0.0); vec3 m2 = vec3(0.0); vec3 m3 = vec3(0.0);\n	vec3 s0 = vec3(0.0); vec3 s1 = vec3(0.0); vec3 s2 = vec3(0.0); vec3 s3 = vec3(0.0);\n	vec3 c;\n	\n	for (int j = -radius; j <= 0; ++j)  {\n		for (int i = -radius; i <= 0; ++i)  {\n			c = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;\n			m0 += c;\n			s0 += c * c;\n		}\n	}\n	\n	for (int j = -radius; j <= 0; ++j)  {\n		for (int i = 0; i <= radius; ++i)  {\n			c = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;\n			m1 += c;\n			s1 += c * c;\n		}\n	}\n	\n	for (int j = 0; j <= radius; ++j)  {\n		for (int i = 0; i <= radius; ++i)  {\n			c = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;\n			m2 += c;\n			s2 += c * c;\n		}\n	}\n	\n	for (int j = 0; j <= radius; ++j)  {\n		for (int i = -radius; i <= 0; ++i)  {\n			c = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;\n			m3 += c;\n			s3 += c * c;\n		}\n	}\n	\n	float min_sigma2 = 1e+2;\n	m0 /= n;\n	s0 = abs(s0 / n - m0 * m0);\n	\n	float sigma2 = s0.r + s0.g + s0.b;\n	if (sigma2 < min_sigma2) {\n		min_sigma2 = sigma2;\n		gl_FragColor = vec4(m0, 1.0);\n	}\n	\n	m1 /= n;\n	s1 = abs(s1 / n - m1 * m1);\n	\n	sigma2 = s1.r + s1.g + s1.b;\n	if (sigma2 < min_sigma2) {\n		min_sigma2 = sigma2;\n		gl_FragColor = vec4(m1, 1.0);\n	}\n	\n	m2 /= n;\n	s2 = abs(s2 / n - m2 * m2);\n	\n	sigma2 = s2.r + s2.g + s2.b;\n	if (sigma2 < min_sigma2) {\n		min_sigma2 = sigma2;\n		gl_FragColor = vec4(m2, 1.0);\n	}\n	\n	m3 /= n;\n	s3 = abs(s3 / n - m3 * m3);\n	\n	sigma2 = s3.r + s3.g + s3.b;\n	if (sigma2 < min_sigma2) {\n		min_sigma2 = sigma2;\n		gl_FragColor = vec4(m3, 1.0);\n	}\n}\n",e.registerNodeType("texture/kuwahara",R),P.title="XDoG Filter",P.desc="Filters a texture giving an artistic ink style",P.max_radius=10,P._shaders=[],P.prototype.onExecute=function(){var t=this.getInputData(0);if(t&&this.isOutputConnected(0)){var e=this._temp_texture;e&&e.width==t.width&&e.height==t.height&&e.type==t.type||(this._temp_texture=new GL.Texture(t.width,t.height,{type:t.type,format:gl.RGBA,filter:gl.LINEAR})),P._xdog_shader||(P._xdog_shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,P.xdog_pixel_shader));var s=P._xdog_shader,o=GL.Mesh.getScreenQuad(),n=this.properties.sigma,r=this.properties.k,a=this.properties.p,u=this.properties.epsilon,h=this.properties.phi;t.bind(0),this._temp_texture.drawTo(function(){s.uniforms({src:0,sigma:n,k:r,p:a,epsilon:u,phi:h,cvsWidth:t.width,cvsHeight:t.height}).draw(o)}),this.setOutputData(0,this._temp_texture)}},P.xdog_pixel_shader="\nprecision highp float;\nuniform sampler2D src;\n\nuniform float cvsHeight;\nuniform float cvsWidth;\n\nuniform float sigma;\nuniform float k;\nuniform float p;\nuniform float epsilon;\nuniform float phi;\nvarying vec2 v_coord;\n\nfloat cosh(float val)\n{\n	float tmp = exp(val);\n	float cosH = (tmp + 1.0 / tmp) / 2.0;\n	return cosH;\n}\n\nfloat tanh(float val)\n{\n	float tmp = exp(val);\n	float tanH = (tmp - 1.0 / tmp) / (tmp + 1.0 / tmp);\n	return tanH;\n}\n\nfloat sinh(float val)\n{\n	float tmp = exp(val);\n	float sinH = (tmp - 1.0 / tmp) / 2.0;\n	return sinH;\n}\n\nvoid main(void){\n	vec3 destColor = vec3(0.0);\n	float tFrag = 1.0 / cvsHeight;\n	float sFrag = 1.0 / cvsWidth;\n	vec2 Frag = vec2(sFrag,tFrag);\n	vec2 uv = gl_FragCoord.st;\n	float twoSigmaESquared = 2.0 * sigma * sigma;\n	float twoSigmaRSquared = twoSigmaESquared * k * k;\n	int halfWidth = int(ceil( 1.0 * sigma * k ));\n\n	const int MAX_NUM_ITERATION = 99999;\n	vec2 sum = vec2(0.0);\n	vec2 norm = vec2(0.0);\n\n	for(int cnt=0;cnt<MAX_NUM_ITERATION;cnt++){\n		if(cnt > (2*halfWidth+1)*(2*halfWidth+1)){break;}\n		int i = int(cnt / (2*halfWidth+1)) - halfWidth;\n		int j = cnt - halfWidth - int(cnt / (2*halfWidth+1)) * (2*halfWidth+1);\n\n		float d = length(vec2(i,j));\n		vec2 kernel = vec2( exp( -d * d / twoSigmaESquared ), \n							exp( -d * d / twoSigmaRSquared ));\n\n		vec2 L = texture2D(src, (uv + vec2(i,j)) * Frag).xx;\n\n		norm += kernel;\n		sum += kernel * L;\n	}\n\n	sum /= norm;\n\n	float H = 100.0 * ((1.0 + p) * sum.x - p * sum.y);\n	float edge = ( H > epsilon )? 1.0 : 1.0 + tanh( phi * (H - epsilon));\n	destColor = vec3(edge);\n	gl_FragColor = vec4(destColor, 1.0);\n}",e.registerNodeType("texture/xDoG",P),L.title="Webcam",L.desc="Webcam texture",L.is_webcam_open=!1,L.prototype.openStream=function(){if(navigator.getUserMedia){this._waiting_confirmation=!0;var t={audio:!1,video:{facingMode:this.properties.facingMode}};navigator.mediaDevices.getUserMedia(t).then(this.streamReady.bind(this)).catch(s);var e=this}function s(t){L.is_webcam_open=!1,console.log("Webcam rejected",t),e._webcam_stream=!1,e.boxcolor="red",e.trigger("stream_error")}},L.prototype.closeStream=function(){if(this._webcam_stream){var t=this._webcam_stream.getTracks();if(t.length)for(var e=0;e<t.length;++e)t[e].stop();L.is_webcam_open=!1,this._webcam_stream=null,this._video=null,this.boxcolor="black",this.trigger("stream_closed")}},L.prototype.streamReady=function(t){this._webcam_stream=t,this.boxcolor="green";var e=this._video;e||((e=document.createElement("video")).autoplay=!0,e.srcObject=t,this._video=e,e.onloadedmetadata=function(t){L.is_webcam_open=!0,console.log(t)}),this.trigger("stream_ready",e)},L.prototype.onPropertyChanged=function(t,e){"facingMode"==t&&(this.properties.facingMode=e,this.closeStream(),this.openStream())},L.prototype.onRemoved=function(){if(this._webcam_stream){var t=this._webcam_stream.getTracks();if(t.length)for(var e=0;e<t.length;++e)t[e].stop();this._webcam_stream=null,this._video=null}},L.prototype.onDrawBackground=function(t){!this.flags.collapsed&&!(this.size[1]<=20)&&this._video&&(t.save(),t.webgl?this._video_texture&&t.drawImage(this._video_texture,0,0,this.size[0],this.size[1]):t.drawImage(this._video,0,0,this.size[0],this.size[1]),t.restore())},L.prototype.onExecute=function(){if(null!=this._webcam_stream||this._waiting_confirmation||this.openStream(),this._video&&this._video.videoWidth){var t,e=this._video.videoWidth,s=this._video.videoHeight,n=this._video_texture;n&&n.width==e&&n.height==s||(this._video_texture=new GL.Texture(e,s,{format:gl.RGB,filter:gl.LINEAR})),this._video_texture.uploadImage(this._video),this._video_texture.version=++this.version,this.properties.texture_name&&(o.getTexturesContainer()[this.properties.texture_name]=this._video_texture),this.setOutputData(0,this._video_texture);for(var r=1;r<this.outputs.length;++r)if(this.outputs[r])switch(this.outputs[r].name){case"width":this.setOutputData(r,this._video.videoWidth);break;case"height":this.setOutputData(r,this._video.videoHeight)}}},L.prototype.onGetOutputs=function(){return[["width","number"],["height","number"],["stream_ready",e.EVENT],["stream_closed",e.EVENT],["stream_error",e.EVENT]]},e.registerNodeType("texture/webcam",L),z.title="Lens FX",z.desc="distortion and chromatic aberration",z.widgets_info={precision:{widget:"combo",values:o.MODE_VALUES}},z.prototype.onGetInputs=function(){return[["enabled","boolean"]]},z.prototype.onExecute=function(){var t=this.getInputData(0);if(t&&this.isOutputConnected(0)){if(this.properties.precision===o.PASS_THROUGH||!1===this.getInputOrProperty("enabled")){this.setOutputData(0,t);return}var e=this._temp_texture;e&&e.width==t.width&&e.height==t.height&&e.type==t.type||(e=this._temp_texture=new GL.Texture(t.width,t.height,{type:t.type,format:gl.RGBA,filter:gl.LINEAR}));var s=z._shader;s||(s=z._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,z.pixel_shader));var n=this.getInputData(1);null==n&&(n=this.properties.factor);var r=this._uniforms;r.u_factor=n,gl.disable(gl.DEPTH_TEST),e.drawTo(function(){t.bind(0),s.uniforms(r).draw(GL.Mesh.getScreenQuad())}),this.setOutputData(0,e)}},z.pixel_shader="precision highp float;\n		varying vec2 v_coord;\n		uniform sampler2D u_texture;\n		uniform float u_factor;\n		vec2 barrelDistortion(vec2 coord, float amt) {\n			vec2 cc = coord - 0.5;\n			float dist = dot(cc, cc);\n			return coord + cc * dist * amt;\n		}\n		\n		float sat( float t )\n		{\n			return clamp( t, 0.0, 1.0 );\n		}\n		\n		float linterp( float t ) {\n			return sat( 1.0 - abs( 2.0*t - 1.0 ) );\n		}\n		\n		float remap( float t, float a, float b ) {\n			return sat( (t - a) / (b - a) );\n		}\n		\n		vec4 spectrum_offset( float t ) {\n			vec4 ret;\n			float lo = step(t,0.5);\n			float hi = 1.0-lo;\n			float w = linterp( remap( t, 1.0/6.0, 5.0/6.0 ) );\n			ret = vec4(lo,1.0,hi, 1.) * vec4(1.0-w, w, 1.0-w, 1.);\n		\n			return pow( ret, vec4(1.0/2.2) );\n		}\n		\n		const float max_distort = 2.2;\n		const int num_iter = 12;\n		const float reci_num_iter_f = 1.0 / float(num_iter);\n		\n		void main()\n		{	\n			vec2 uv=v_coord;\n			vec4 sumcol = vec4(0.0);\n			vec4 sumw = vec4(0.0);	\n			for ( int i=0; i<num_iter;++i )\n			{\n				float t = float(i) * reci_num_iter_f;\n				vec4 w = spectrum_offset( t );\n				sumw += w;\n				sumcol += w * texture2D( u_texture, barrelDistortion(uv, .6 * max_distort*t * u_factor ) );\n			}\n			gl_FragColor = sumcol / sumw;\n		}",e.registerNodeType("texture/lensfx",z),G.title="Data->Tex",G.desc="Generates or applies a curve to a texture",G.widgets_info={precision:{widget:"combo",values:o.MODE_VALUES}},G.prototype.onExecute=function(){if(this.isOutputConnected(0)){var t=this.getInputData(0);if(t){var e=this.properties.channels,s=this.properties.width,n=this.properties.height;s&&n||(s=Math.floor(t.length/e),n=1);var r=gl.RGBA;3==e?r=gl.RGB:1==e&&(r=gl.LUMINANCE);var a=this._temp_texture,u=o.getTextureType(this.properties.precision);a&&a.width==s&&a.height==n&&a.type==u||(a=this._temp_texture=new GL.Texture(s,n,{type:u,format:r,filter:gl.LINEAR})),a.uploadData(t),this.setOutputData(0,a)}}},e.registerNodeType("texture/fromdata",G),B.title="Curve",B.desc="Generates or applies a curve to a texture",B.widgets_info={precision:{widget:"combo",values:o.MODE_VALUES}},B.prototype.onExecute=function(){if(this.isOutputConnected(0)){var t=this.getInputData(0),e=this._temp_texture;if(!t){(this._must_update||!this._curve_texture)&&this.updateCurve(),this.setOutputData(0,this._curve_texture);return}var s=o.getTextureType(this.properties.precision,t);e&&e.type==s&&e.width==t.width&&e.height==t.height&&e.format==t.format||(e=this._temp_texture=new GL.Texture(t.width,t.height,{type:s,format:t.format,filter:gl.LINEAR}));var n=B._shader;n||(n=B._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,B.pixel_shader)),(this._must_update||!this._curve_texture)&&this.updateCurve();var r=this._uniforms,a=this._curve_texture;e.drawTo(function(){gl.disable(gl.DEPTH_TEST),t.bind(0),a.bind(1),n.uniforms(r).draw(GL.Mesh.getScreenQuad())}),this.setOutputData(0,e)}},B.prototype.sampleCurve=function(t,e){var e=e||this._points.RGB;if(e){for(var s=0;s<e.length-1;++s){var o=e[s],n=e[s+1];if(!(n[0]<t)){var r=n[0]-o[0];if(1e-5>Math.abs(r))return o[1];var a=(t-o[0])/r;return o[1]*(1-a)+n[1]*a}}return 0}},B.prototype.updateCurve=function(){for(var t=this._values,e=t.length/4,s=this.properties.split_channels,o=0;o<e;++o){if(s)t[4*o]=clamp(255*this.sampleCurve(o/e,this._points.R),0,255),t[4*o+1]=clamp(255*this.sampleCurve(o/e,this._points.G),0,255),t[4*o+2]=clamp(255*this.sampleCurve(o/e,this._points.B),0,255);else{var n=this.sampleCurve(o/e);t[4*o]=t[4*o+1]=t[4*o+2]=clamp(255*n,0,255)}t[4*o+3]=255}this._curve_texture||(this._curve_texture=new GL.Texture(256,1,{format:gl.RGBA,magFilter:gl.LINEAR,wrap:gl.CLAMP_TO_EDGE})),this._curve_texture.uploadData(t,null,!0)},B.prototype.onSerialize=function(t){var e={};for(var s in this._points)e[s]=this._points[s].concat();t.curves=e},B.prototype.onConfigure=function(t){this._points=t.curves,this.curve_editor&&(curve_editor.points=this._points),this._must_update=!0},B.prototype.onMouseDown=function(t,e,s){if(this.curve_editor){var o=this.curve_editor.onMouseDown([e[0],e[1]-this.curve_offset],s);return o&&this.captureInput(!0),o}},B.prototype.onMouseMove=function(t,e,s){if(this.curve_editor)return this.curve_editor.onMouseMove([e[0],e[1]-this.curve_offset],s)},B.prototype.onMouseUp=function(t,e,s){if(this.curve_editor)return this.curve_editor.onMouseUp([e[0],e[1]-this.curve_offset],s);this.captureInput(!1)},B.channel_line_colors={RGB:"#666",R:"#F33",G:"#3F3",B:"#33F"},B.prototype.onDrawBackground=function(t,s){if(!this.flags.collapsed){this.curve_editor||(this.curve_editor=new e.CurveEditor(this._points.R)),t.save(),t.translate(0,this.curve_offset);var o=this.widgets[1].value;this.properties.split_channels?("RGB"==o&&(this.widgets[1].value=o="R",this.widgets[1].disabled=!1),this.curve_editor.points=this._points.R,this.curve_editor.draw(t,[this.size[0],this.size[1]-this.curve_offset],s,"#111",B.channel_line_colors.R,!0),t.globalCompositeOperation="lighten",this.curve_editor.points=this._points.G,this.curve_editor.draw(t,[this.size[0],this.size[1]-this.curve_offset],s,null,B.channel_line_colors.G,!0),this.curve_editor.points=this._points.B,this.curve_editor.draw(t,[this.size[0],this.size[1]-this.curve_offset],s,null,B.channel_line_colors.B,!0),t.globalCompositeOperation="source-over"):(this.widgets[1].value=o="RGB",this.widgets[1].disabled=!0),this.curve_editor.points=this._points[o],this.curve_editor.draw(t,[this.size[0],this.size[1]-this.curve_offset],s,this.properties.split_channels?null:"#111",B.channel_line_colors[o]),t.restore()}},B.pixel_shader="precision highp float;\n		varying vec2 v_coord;\n		uniform sampler2D u_texture;\n		uniform sampler2D u_curve;\n		uniform float u_range;\n		\n		void main() {\n			vec4 color = texture2D( u_texture, v_coord ) * u_range;\n			color.x = texture2D( u_curve, vec2( color.x, 0.5 ) ).x;\n			color.y = texture2D( u_curve, vec2( color.y, 0.5 ) ).y;\n			color.z = texture2D( u_curve, vec2( color.z, 0.5 ) ).z;\n			//color.w = texture2D( u_curve, vec2( color.w, 0.5 ) ).w;\n			gl_FragColor = color;\n		}",e.registerNodeType("texture/curve",B),F.title="Exposition",F.desc="Controls texture exposition",F.widgets_info={exposition:{widget:"slider",min:0,max:3},precision:{widget:"combo",values:o.MODE_VALUES}},F.prototype.onExecute=function(){var t=this.getInputData(0);if(t&&this.isOutputConnected(0)){var e=this._temp_texture;e&&e.width==t.width&&e.height==t.height&&e.type==t.type||(e=this._temp_texture=new GL.Texture(t.width,t.height,{type:t.type,format:gl.RGBA,filter:gl.LINEAR}));var s=F._shader;s||(s=F._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,F.pixel_shader));var o=this.properties.exposition,n=this.getInputData(1);null!=n&&(o=this.properties.exposition=n);var r=this._uniforms;e.drawTo(function(){gl.disable(gl.DEPTH_TEST),t.bind(0),s.uniforms(r).draw(GL.Mesh.getScreenQuad())}),this.setOutputData(0,e)}},F.pixel_shader="precision highp float;\n		varying vec2 v_coord;\n		uniform sampler2D u_texture;\n		uniform float u_exposition;\n		\n		void main() {\n			vec4 color = texture2D( u_texture, v_coord );\n			gl_FragColor = vec4( color.xyz * u_exposition, color.a );\n		}",e.registerNodeType("texture/exposition",F),M.title="Tone Mapping",M.desc="Applies Tone Mapping to convert from high to low",M.widgets_info={precision:{widget:"combo",values:o.MODE_VALUES}},M.prototype.onGetInputs=function(){return[["enabled","boolean"]]},M.prototype.onExecute=function(){var t=this.getInputData(0);if(t&&this.isOutputConnected(0)){if(this.properties.precision===o.PASS_THROUGH||!1===this.getInputOrProperty("enabled")){this.setOutputData(0,t);return}var e=this._temp_texture;e&&e.width==t.width&&e.height==t.height&&e.type==t.type||(e=this._temp_texture=new GL.Texture(t.width,t.height,{type:t.type,format:gl.RGBA,filter:gl.LINEAR}));var s=this.getInputData(1);null==s&&(s=this.properties.average_lum);var n=this._uniforms,r=null;s.constructor===Number?(this.properties.average_lum=s,n.u_average_lum=this.properties.average_lum,(r=M._shader)||(r=M._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,M.pixel_shader))):s.constructor!==GL.Texture||(n.u_average_texture=s.bind(1),(r=M._shader_texture)||(r=M._shader_texture=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,M.pixel_shader,{AVG_TEXTURE:""}))),n.u_lumwhite2=this.properties.lum_white*this.properties.lum_white,n.u_scale=this.properties.scale,n.u_igamma=1/this.properties.gamma,gl.disable(gl.DEPTH_TEST),e.drawTo(function(){t.bind(0),r.uniforms(n).draw(GL.Mesh.getScreenQuad())}),this.setOutputData(0,this._temp_texture)}},M.pixel_shader="precision highp float;\n		varying vec2 v_coord;\n		uniform sampler2D u_texture;\n		uniform float u_scale;\n		#ifdef AVG_TEXTURE\n			uniform sampler2D u_average_texture;\n		#else\n			uniform float u_average_lum;\n		#endif\n		uniform float u_lumwhite2;\n		uniform float u_igamma;\n		vec3 RGB2xyY (vec3 rgb)\n		{\n			 const mat3 RGB2XYZ = mat3(0.4124, 0.3576, 0.1805,\n									   0.2126, 0.7152, 0.0722,\n									   0.0193, 0.1192, 0.9505);\n			vec3 XYZ = RGB2XYZ * rgb;\n			\n			float f = (XYZ.x + XYZ.y + XYZ.z);\n			return vec3(XYZ.x / f,\n						XYZ.y / f,\n						XYZ.y);\n		}\n		\n		void main() {\n			vec4 color = texture2D( u_texture, v_coord );\n			vec3 rgb = color.xyz;\n			float average_lum = 0.0;\n			#ifdef AVG_TEXTURE\n				vec3 pixel = texture2D(u_average_texture,vec2(0.5)).xyz;\n				average_lum = (pixel.x + pixel.y + pixel.z) / 3.0;\n			#else\n				average_lum = u_average_lum;\n			#endif\n			//Ld - this part of the code is the same for both versions\n			float lum = dot(rgb, vec3(0.2126, 0.7152, 0.0722));\n			float L = (u_scale / average_lum) * lum;\n			float Ld = (L * (1.0 + L / u_lumwhite2)) / (1.0 + L);\n			//first\n			//vec3 xyY = RGB2xyY(rgb);\n			//xyY.z *= Ld;\n			//rgb = xyYtoRGB(xyY);\n			//second\n			rgb = (rgb / lum) * Ld;\n			rgb = max(rgb,vec3(0.001));\n			rgb = pow( rgb, vec3( u_igamma ) );\n			gl_FragColor = vec4( rgb, color.a );\n		}",e.registerNodeType("texture/tonemapping",M),H.title="Perlin",H.desc="Generates a perlin noise texture",H.widgets_info={precision:{widget:"combo",values:o.MODE_VALUES},width:{type:"number",precision:0,step:1},height:{type:"number",precision:0,step:1},octaves:{type:"number",precision:0,step:1,min:1,max:50}},H.prototype.onGetInputs=function(){return[["seed","number"],["persistence","number"],["octaves","number"],["scale","number"],["amplitude","number"],["offset","vec2"]]},H.prototype.onExecute=function(){if(this.isOutputConnected(0)){var t=0|this.properties.width,e=0|this.properties.height;0==t&&(t=gl.viewport_data[2]),0==e&&(e=gl.viewport_data[3]);var s=o.getTextureType(this.properties.precision),n=this._texture;n&&n.width==t&&n.height==e&&n.type==s||(n=this._texture=new GL.Texture(t,e,{type:s,format:gl.RGB,filter:gl.LINEAR}));var r=this.getInputOrProperty("persistence"),a=this.getInputOrProperty("octaves"),u=this.getInputOrProperty("offset"),h=this.getInputOrProperty("scale"),l=this.getInputOrProperty("amplitude"),d=this.getInputOrProperty("seed"),c=""+t+e+s+r+a+h+d+u[0]+u[1]+l;if(c==this._key){this.setOutputData(0,n);return}this._key=c;var f=this._uniforms;f.u_persistence=r,f.u_octaves=a,f.u_offset.set(u),f.u_scale=h,f.u_amplitude=l,f.u_seed=128*d,f.u_viewport[0]=t,f.u_viewport[1]=e;var g=H._shader;g||(g=H._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,H.pixel_shader)),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),n.drawTo(function(){g.uniforms(f).draw(GL.Mesh.getScreenQuad())}),this.setOutputData(0,n)}},H.pixel_shader="precision highp float;\n		varying vec2 v_coord;\n		uniform vec2 u_offset;\n		uniform float u_scale;\n		uniform float u_persistence;\n		uniform int u_octaves;\n		uniform float u_amplitude;\n		uniform vec2 u_viewport;\n		uniform float u_seed;\n		#define M_PI 3.14159265358979323846\n		\n		float rand(vec2 c){	return fract(sin(dot(c.xy ,vec2( 12.9898 + u_seed,78.233 + u_seed))) * 43758.5453); }\n		\n		float noise(vec2 p, float freq ){\n			float unit = u_viewport.x/freq;\n			vec2 ij = floor(p/unit);\n			vec2 xy = mod(p,unit)/unit;\n			//xy = 3.*xy*xy-2.*xy*xy*xy;\n			xy = .5*(1.-cos(M_PI*xy));\n			float a = rand((ij+vec2(0.,0.)));\n			float b = rand((ij+vec2(1.,0.)));\n			float c = rand((ij+vec2(0.,1.)));\n			float d = rand((ij+vec2(1.,1.)));\n			float x1 = mix(a, b, xy.x);\n			float x2 = mix(c, d, xy.x);\n			return mix(x1, x2, xy.y);\n		}\n		\n		float pNoise(vec2 p, int res){\n			float persistance = u_persistence;\n			float n = 0.;\n			float normK = 0.;\n			float f = 4.;\n			float amp = 1.0;\n			int iCount = 0;\n			for (int i = 0; i<50; i++){\n				n+=amp*noise(p, f);\n				f*=2.;\n				normK+=amp;\n				amp*=persistance;\n				if (iCount >= res)\n					break;\n				iCount++;\n			}\n			float nf = n/normK;\n			return nf*nf*nf*nf;\n		}\n		void main() {\n			vec2 uv = v_coord * u_scale * u_viewport + u_offset * u_scale;\n			vec4 color = vec4( pNoise( uv, u_octaves ) * u_amplitude );\n			gl_FragColor = color;\n		}",e.registerNodeType("texture/perlin",H),U.title="Canvas2D",U.desc="Executes Canvas2D code inside a texture or the viewport.",U.help="Set width and height to 0 to match viewport size.",U.default_code="//vars: canvas,ctx,time\nctx.fillStyle='red';\nctx.fillRect(0,0,50,50);\n",U.widgets_info={precision:{widget:"combo",values:o.MODE_VALUES},code:{type:"code"},width:{type:"number",precision:0,step:1},height:{type:"number",precision:0,step:1}},U.prototype.onPropertyChanged=function(t,e){"code"==t&&this.compileCode(e)},U.prototype.compileCode=function(t){if(this._func=null,e.allow_scripts)try{this._func=Function("canvas","ctx","time","script","v",t),this.boxcolor="#00FF00"}catch(s){this.boxcolor="#FF0000",console.error("Error parsing script"),console.error(s)}},U.prototype.onExecute=function(){var t=this._func;t&&this.isOutputConnected(0)&&this.executeDraw(t)},U.prototype.executeDraw=function(e){var s=this.properties.width||gl.canvas.width,n=this.properties.height||gl.canvas.height,r=this._temp_texture,a=o.getTextureType(this.properties.precision);r&&r.width==s&&r.height==n&&r.type==a||(r=this._temp_texture=new GL.Texture(s,n,{format:gl.RGBA,filter:gl.LINEAR,type:a}));var u=this.getInputData(0),h=this.properties,l=this,d=this.graph.getTime(),c=gl,f=gl.canvas;if((this.properties.use_html_canvas||!t.enableWebGLCanvas)&&(this._canvas?(f=this._canvas,c=this._ctx):(f=this._canvas=createCanvas(s.height),c=this._ctx=f.getContext("2d")),f.width=s,f.height=n),c==gl)r.drawTo(function(){gl.start2D(),h.clear&&(gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT));try{e.draw?e.draw.call(l,f,c,d,e,u):e.call(l,f,c,d,e,u),l.boxcolor="#00FF00"}catch(t){l.boxcolor="#FF0000",console.error("Error executing script"),console.error(t)}gl.finish2D()});else{h.clear&&c.clearRect(0,0,f.width,f.height);try{e.draw?e.draw.call(this,f,c,d,e,u):e.call(this,f,c,d,e,u),this.boxcolor="#00FF00"}catch(g){this.boxcolor="#FF0000",console.error("Error executing script"),console.error(g)}r.uploadImage(f)}this.setOutputData(0,r)},e.registerNodeType("texture/canvas2D",U),V.title="Matte",V.desc="Extracts background",V.widgets_info={key_color:{widget:"color"},precision:{widget:"combo",values:o.MODE_VALUES}},V.prototype.onExecute=function(){if(this.isOutputConnected(0)){var t=this.getInputData(0);if(this.properties.precision===o.PASS_THROUGH){this.setOutputData(0,t);return}if(t){this._tex=o.getTargetTexture(t,this._tex,this.properties.precision),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),this._uniforms||(this._uniforms={u_texture:0,u_key_color:this.properties.key_color,u_threshold:1,u_slope:1});var e=this._uniforms,s=Mesh.getScreenQuad(),n=V._shader;n||(n=V._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,V.pixel_shader)),e.u_key_color=this.properties.key_color,e.u_threshold=this.properties.threshold,e.u_slope=this.properties.slope,this._tex.drawTo(function(){t.bind(0),n.uniforms(e).draw(s)}),this.setOutputData(0,this._tex)}}},V.pixel_shader="precision highp float;\n		varying vec2 v_coord;\n		uniform sampler2D u_texture;\n		uniform vec3 u_key_color;\n		uniform float u_threshold;\n		uniform float u_slope;\n		\n		void main() {\n			vec3 color = texture2D( u_texture, v_coord ).xyz;\n			float diff = length( normalize(color) - normalize(u_key_color) );\n			float edge = u_threshold * (1.0 - u_slope);\n			float alpha = smoothstep( edge, u_threshold, diff);\n			gl_FragColor = vec4( color, alpha );\n		}",e.registerNodeType("texture/matte",V),W.title="CubemapToTexture2D",W.desc="Transforms a CUBEMAP texture into a TEXTURE2D in Polar Representation",W.prototype.onExecute=function(){if(this.isOutputConnected(0)){var t=this.getInputData(0);if(t&&t.texture_type==GL.TEXTURE_CUBE_MAP){this._last_tex&&(this._last_tex.height!=t.height||this._last_tex.type!=t.type)&&(this._last_tex=null);var e=this.getInputOrProperty("yaw");this._last_tex=GL.Texture.cubemapToTexture2D(t,t.height,this._last_tex,!0,e),this.setOutputData(0,this._last_tex)}}},e.registerNodeType("texture/cubemapToTexture2D",W))}(this),function(t){if("undefined"!=typeof GL){var e=t.LiteGraph,s=t.LGraphCanvas,o="#345",n=e.Shaders={},r=n.GLSL_types=["float","vec2","vec3","vec4","mat3","mat4","sampler2D","samplerCube"],a=n.GLSL_types_const=["float","vec2","vec3","vec4"],u={radians:"T radians(T degrees)",degrees:"T degrees(T radians)",sin:"T sin(T angle)",cos:"T cos(T angle)",tan:"T tan(T angle)",asin:"T asin(T x)",acos:"T acos(T x)",atan:"T atan(T x)",atan2:"T atan(T x,T y)",pow:"T pow(T x,T y)",exp:"T exp(T x)",log:"T log(T x)",exp2:"T exp2(T x)",log2:"T log2(T x)",sqrt:"T sqrt(T x)",inversesqrt:"T inversesqrt(T x)",abs:"T abs(T x)",sign:"T sign(T x)",floor:"T floor(T x)",round:"T round(T x)",ceil:"T ceil(T x)",fract:"T fract(T x)",mod:"T mod(T x,T y)",min:"T min(T x,T y)",max:"T max(T x,T y)",clamp:"T clamp(T x,T minVal = 0.0,T maxVal = 1.0)",mix:"T mix(T x,T y,T a)",step:"T step(T edge, T edge2, T x)",smoothstep:"T smoothstep(T edge, T edge2, T x)",length:"float length(T x)",distance:"float distance(T p0, T p1)",normalize:"T normalize(T x)",dot:"float dot(T x,T y)",cross:"vec3 cross(vec3 x,vec3 y)",reflect:"vec3 reflect(vec3 V,vec3 N)",refract:"vec3 refract(vec3 V,vec3 N, float IOR)"},h={},l=[];g(),n.ALL_TYPES="float,vec2,vec3,vec4",n.registerShaderNode=v,n.getInputLinkID=m,n.getOutputLinkID=y,n.getShaderNodeVarName=$,n.parseGLSLDescriptions=g;var d=e.valueToGLSL=function t(e,s,o){var n=5;if(null!=o&&(n=o),!s){if(e.constructor===Number)s="float";else if(e.length)switch(e.length){case 2:s="vec2";break;case 3:s="vec3";break;case 4:s="vec4";break;case 9:s="mat3";break;case 16:s="mat4";break;default:throw"unknown type for glsl value size"}else throw"unknown type for glsl value: "+e.constructor}switch(s){case"float":return e.toFixed(n);case"vec2":return"vec2("+e[0].toFixed(n)+","+e[1].toFixed(n)+")";case"color3":case"vec3":return"vec3("+e[0].toFixed(n)+","+e[1].toFixed(n)+","+e[2].toFixed(n)+")";case"color4":case"vec4":return"vec4("+e[0].toFixed(n)+","+e[1].toFixed(n)+","+e[2].toFixed(n)+","+e[3].toFixed(n)+")";case"mat3":return"mat3(1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,1.0)";case"mat4":return"mat4(1.0,0.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,0.0,1.0)";default:throw s}return""},c=e.varToTypeGLSL=function t(e,s,o){if(s==o)return e;if(null==e)switch(o){case"float":return"0.0";case"vec2":return"vec2(0.0)";case"vec3":return"vec3(0.0)";case"vec4":return"vec4(0.0,0.0,0.0,1.0)";default:return null}if(!o)throw"error: no output type specified";if("float"==o)switch(s){case"vec2":case"vec3":case"vec4":return e+".x";default:return"0.0"}else if("vec2"==o)switch(s){case"float":return"vec2("+e+")";case"vec3":case"vec4":return e+".xy";default:return"vec2(0.0)"}else if("vec3"==o)switch(s){case"float":return"vec3("+e+")";case"vec2":return"vec3("+e+",0.0)";case"vec4":return e+".xyz";default:return"vec3(0.0)"}else if("vec4"==o)switch(s){case"float":return"vec4("+e+")";case"vec2":return"vec4("+e+",0.0,1.0)";case"vec3":return"vec4("+e+",1.0)";default:return"vec4(0.0,0.0,0.0,1.0)"}throw"type cannot be converted"},f=e.convertVarToGLSLType=function t(e,s,o){if(s==o)return e;if("float"==s)return o+"("+e+")";if("vec2"==o)return"vec2("+e+".xy)";if("vec3"==o){if("vec2"==s)return"vec3("+e+",0.0)";if("vec4"==s)return"vec4("+e+".xyz)"}if("vec4"==o){if("vec2"==s)return"vec4("+e+",0.0,0.0)";if("vec3"==o)return"vec4("+e+",1.0)"}return null};x.prototype.clear=function(){this._uniforms={},this._functions={},this._codeparts={},this._uniform_value=null,this.extra={}},x.prototype.addUniform=function(t,e,s){this._uniforms[t]=e,null!=s&&(this._uniform_value||(this._uniform_value={}),this._uniform_value[t]=s)},x.prototype.addFunction=function(t,e){this._functions[t]=e},x.prototype.addCode=function(t,e,s){for(var o in s=s||{"":""}){var n=o?o+"_"+t:t;this._codeparts[n]?this._codeparts[n]+=e+"\n":this._codeparts[n]=e+"\n"}},x.prototype.computeCodeBlocks=function(t,e){this.clear();var s=t.findNodesByType("shader::output/vertex");s=s&&s.length?s[0]:null;var o=t.findNodesByType("shader::output/fragcolor");if(!(o=o&&o.length?o[0]:null))return null;t.sendEventToAllNodes("clearDestination"),s&&s.propagateDestination("vs"),o&&o.propagateDestination("fs"),t.sendEventToAllNodes("onGetCode",this);var n="";for(var r in this._uniforms)n+="uniform "+this._uniforms[r]+" "+r+";\n";if(e)for(var r in e)n+="uniform "+e[r]+" "+r+";\n";var a="";for(var r in this._functions)a+="//"+r+"\n"+this._functions[r]+"\n";var u=this._codeparts;return u.uniforms=n,u.functions=a,u},x.prototype.computeShaderCode=function(t){var e=this.computeCodeBlocks(t),s=GL.Shader.replaceCodeUsingContext(this.vs_template,e),o=GL.Shader.replaceCodeUsingContext(this.fs_template,e);return{vs_code:s,fs_code:o}},x.prototype.computeShader=function(t,s){var o=this.computeShaderCode(t);if(console.log(o.vs_code,o.fs_code),!e.catch_exceptions)return this._shader_error=!0,s?s.updateShader(o.vs_code,o.fs_code):s=new GL.Shader(o.vs_code,o.fs_code),this._shader_error=!1,s;try{return s?s.updateShader(o.vs_code,o.fs_code):s=new GL.Shader(o.vs_code,o.fs_code),this._shader_error=!1,s}catch(n){this._shader_error||(console.error(n),-1!=n.indexOf("Fragment shader")?console.log(o.fs_code.split("\n").map(function(t,e){return e+".- "+t}).join("\n")):console.log(o.vs_code)),this._shader_error=!0}return null},x.prototype.getShader=function(t){if(this._shader&&this._shader._version==t._version)return this._shader;var e=this.computeShader(t,this._shader);return e?(this._shader=e,e._version=t._version,e):null},x.prototype.fillUniforms=function(t,e){if(this._uniform_value)for(var s in this._uniform_value){var o=this._uniform_value[s];null!=o&&(o.constructor===Function?t[s]=o.call(this,e):o.constructor===GL.Texture||(t[s]=o))}},e.ShaderContext=e.Shaders.Context=x,_.template="\n#define FRAGMENT\nprecision highp float;\nvarying vec2 v_coord;\n{{varying}}\n{{uniforms}}\n{{functions}}\n{{fs_functions}}\nvoid main() {\n\nvec2 uv = v_coord;\nvec4 fragcolor = vec4(0.0);\nvec4 fragcolor1 = vec4(0.0);\n{{fs_code}}\ngl_FragColor = fragcolor;\n}\n	",_.widgets_info={precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}},_.title="ShaderGraph",_.desc="Builds a shader using a graph",_.input_node_type="input/uniform",_.output_node_type="output/fragcolor",_.title_color=o,_.prototype.onSerialize=function(t){t.subgraph=this.subgraph.serialize()},_.prototype.onConfigure=function(t){this.subgraph.configure(t.subgraph)},_.prototype.onExecute=function(){if(this.isOutputConnected(0)){var t=this.getInputData(0);t&&t.constructor!=GL.Texture&&(t=null);var e=0|this.properties.width,s=0|this.properties.height;0==e&&(e=t?t.width:gl.viewport_data[2]),0==s&&(s=t?t.height:gl.viewport_data[3]);var o=LGraphTexture.getTextureType(this.properties.precision,t),n=this._texture;n&&n.width==e&&n.height==s&&n.type==o||(n=this._texture=new GL.Texture(e,s,{type:o,format:this.alpha?gl.RGBA:gl.RGB,filter:gl.LINEAR}));var r=this.getShader(this.subgraph);if(r){var a=this._uniforms;this._context.fillUniforms(a);var u=0;if(this.inputs)for(var h=0;h<this.inputs.length;++h){var l=this.inputs[h],d=this.getInputData(h);"texture"==l.type&&(d||(d=GL.Texture.getWhiteTexture()),d=d.bind(u++)),null!=d&&(a["u_"+l.name]=d)}var c=GL.Mesh.getScreenQuad();gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND),n.drawTo(function(){r.uniforms(a),r.draw(c)}),this.setOutputData(0,n)}}},_.prototype.onInputAdded=function(t){var s=e.createNode("shader::input/uniform");s.setProperty("name",t.name),s.setProperty("type",t.type),this.subgraph.add(s)},_.prototype.onInputRemoved=function(t,e){for(var s=this.subgraph.findNodesByType("shader::input/uniform"),o=0;o<s.length;++o){var n=s[o];n.properties.name==e.name&&this.subgraph.remove(n)}},_.prototype.computeSize=function(){var t;return[200,Math.max(this.inputs?this.inputs.length:0,this.outputs?this.outputs.length:0)*e.NODE_SLOT_HEIGHT+e.NODE_TITLE_HEIGHT+10]},_.prototype.getShader=function(){var t=this._context.getShader(this.subgraph);return t?this.boxcolor=null:this.boxcolor="red",t},_.prototype.onDrawBackground=function(t,s,o,n){if(!this.flags.collapsed){var r=this.getOutputData(0),a=this.inputs?this.inputs.length*e.NODE_SLOT_HEIGHT:0;r&&t==r.gl&&this.size[1]>a+e.NODE_TITLE_HEIGHT&&t.drawImage(r,10,u,this.size[0]-20,this.size[1]-a-e.NODE_TITLE_HEIGHT);var u=this.size[1]-e.NODE_TITLE_HEIGHT+.5,h=e.isInsideRectangle(n[0],n[1],this.pos[0],this.pos[1]+u,this.size[0],e.NODE_TITLE_HEIGHT);t.fillStyle=h?"#555":"#222",t.beginPath(),this._shape==e.BOX_SHAPE?t.rect(0,u,this.size[0]+1,e.NODE_TITLE_HEIGHT):t.roundRect(0,u,this.size[0]+1,e.NODE_TITLE_HEIGHT,0,8),t.fill(),t.textAlign="center",t.font="24px Arial",t.fillStyle=h?"#DDD":"#999",t.fillText("+",.5*this.size[0],u+24)}},_.prototype.onMouseDown=function(t,s,o){var n=this.size[1]-e.NODE_TITLE_HEIGHT+.5;s[1]>n&&o.showSubgraphPropertiesDialog(this)},_.prototype.onDrawSubgraphBackground=function(t){},_.prototype.getExtraMenuOptions=function(t){var e=this;return[{content:"Print Code",callback:function(){var t=e._context.computeShaderCode();console.log(t.vs_code,t.fs_code)}}]},e.registerNodeType("texture/shaderGraph",_),T.title="Uniform",T.desc="Input data for the shader",T.prototype.getTitle=function(){return this.properties.name&&this.flags.collapsed?this.properties.type+" "+this.properties.name:"Uniform"},T.prototype.onPropertyChanged=function(t,e){this.outputs[0].name=this.properties.type+" "+this.properties.name},T.prototype.onGetCode=function(t){if(this.shader_destination){var e=this.properties.type;if(!e){if(!t.onGetPropertyInfo)return;var s=t.onGetPropertyInfo(this.property.name);if(!s)return;e=s.type}"number"==e?e="float":"texture"==e&&(e="sampler2D"),-1!=n.GLSL_types.indexOf(e)&&(t.addUniform("u_"+this.properties.name,e),this.setOutputData(0,e))}},T.prototype.getOutputVarName=function(t){return"u_"+this.properties.name},v("input/uniform",T),E.title="Attribute",E.desc="Input data from mesh attribute",E.prototype.getTitle=function(){return"att. "+this.properties.name},E.prototype.onGetCode=function(t){if(this.shader_destination){var e=this.properties.type;e&&-1!=n.GLSL_types.indexOf(e)&&("number"==e&&(e="float"),"coord"!=this.properties.name&&t.addCode("varying"," varying "+e+" v_"+this.properties.name+";"),this.setOutputData(0,e))}},E.prototype.getOutputVarName=function(t){return"v_"+this.properties.name},v("input/attribute",E),w.title="Sampler2D",w.desc="Reads a pixel from a texture",w.prototype.onGetCode=function(t){if(this.shader_destination){var e,s,o=m(this,0),n=$(this),r="vec4 "+n+" = vec4(0.0);\n";if(o){var a=m(this,1)||t.buffer_names.uvs;r+=n+" = texture2D("+o+","+a+");\n"}y(this,0)&&(r+="vec4 "+y(this,0)+" = "+n+";\n"),y(this,1)&&(r+="vec3 "+y(this,1)+" = "+n+".xyz;\n"),t.addCode("code",r,this.shader_destination),this.setOutputData(0,"vec4"),this.setOutputData(1,"vec3")}},v("texture/sampler2D",w),O.title="const",O.prototype.getTitle=function(){return this.flags.collapsed?d(this.properties.value,this.properties.type,2):"Const"},O.prototype.onPropertyChanged=function(t,e){"type"==t&&(this.outputs[0].type!=e&&(this.disconnectOutput(0),this.outputs[0].type=e),this.widgets.length=1,this.updateWidgets()),"value"==t&&(e.length?(this.widgets[1].value=e[1],e.length>2&&(this.widgets[2].value=e[2]),e.length>3&&(this.widgets[3].value=e[3])):this.widgets[1].value=e)},O.prototype.updateWidgets=function(t){var e=this,t=this.properties.value,s={step:.01};switch(this.properties.type){case"float":this.properties.value=0,this.addWidget("number","v",0,{step:.01,property:"value"});break;case"vec2":this.properties.value=t&&2==t.length?[t[0],t[1]]:[0,0,0],this.addWidget("number","x",this.properties.value[0],function(t){e.properties.value[0]=t},s),this.addWidget("number","y",this.properties.value[1],function(t){e.properties.value[1]=t},s);break;case"vec3":this.properties.value=t&&3==t.length?[t[0],t[1],t[2]]:[0,0,0],this.addWidget("number","x",this.properties.value[0],function(t){e.properties.value[0]=t},s),this.addWidget("number","y",this.properties.value[1],function(t){e.properties.value[1]=t},s),this.addWidget("number","z",this.properties.value[2],function(t){e.properties.value[2]=t},s);break;case"vec4":this.properties.value=t&&4==t.length?[t[0],t[1],t[2],t[3]]:[0,0,0,0],this.addWidget("number","x",this.properties.value[0],function(t){e.properties.value[0]=t},s),this.addWidget("number","y",this.properties.value[1],function(t){e.properties.value[1]=t},s),this.addWidget("number","z",this.properties.value[2],function(t){e.properties.value[2]=t},s),this.addWidget("number","w",this.properties.value[3],function(t){e.properties.value[3]=t},s);break;default:console.error("unknown type for constant")}},O.prototype.onGetCode=function(t){if(this.shader_destination){var e=d(this.properties.value,this.properties.type),s=y(this,0);if(s){var o="	"+this.properties.type+" "+s+" = "+e+";";t.addCode("code",o,this.shader_destination),this.setOutputData(0,this.properties.type)}}},v("const/const",O),I.title="vec2",I.varmodes=["xy","x","y"],I.prototype.onPropertyChanged=function(){this.graph&&this.graph._version++},I.prototype.onGetCode=function(t){if(this.shader_destination){for(var e=this.properties,s=$(this),o="	vec2 "+s+" = "+d([e.x,e.y])+";\n",n=0;n<I.varmodes.length;++n){var r=I.varmodes[n],u=m(this,n);u&&(o+="	"+s+"."+r+" = "+u+";\n")}for(var n=0;n<I.varmodes.length;++n){var r=I.varmodes[n],h=y(this,n);if(h){var l=a[r.length-1];o+="	"+l+" "+h+" = "+s+"."+r+";\n",this.setOutputData(n,l)}}t.addCode("code",o,this.shader_destination)}},v("const/vec2",I),D.title="vec3",D.varmodes=["xyz","x","y","z","xy","xz","yz"],D.prototype.onPropertyChanged=function(){this.graph&&this.graph._version++},D.prototype.onGetCode=function(t){if(this.shader_destination){for(var e=this.properties,s=$(this),o="vec3 "+s+" = "+d([e.x,e.y,e.z])+";\n",n=0;n<D.varmodes.length;++n){var r=D.varmodes[n],u=m(this,n);u&&(o+="	"+s+"."+r+" = "+u+";\n")}for(var n=0;n<D.varmodes.length;++n){var r=D.varmodes[n],h=y(this,n);if(h){var l=a[r.length-1];o+="	"+l+" "+h+" = "+s+"."+r+";\n",this.setOutputData(n,l)}}t.addCode("code",o,this.shader_destination)}},v("const/vec3",D),N.title="vec4",N.varmodes=["xyzw","xyz","x","y","z","w","xy","yz","zw"],N.prototype.onPropertyChanged=function(){this.graph&&this.graph._version++},N.prototype.onGetCode=function(t){if(this.shader_destination){for(var e=this.properties,s=$(this),o="vec4 "+s+" = "+d([e.x,e.y,e.z,e.w])+";\n",n=0;n<N.varmodes.length;++n){var r=N.varmodes[n],u=m(this,n);u&&(o+="	"+s+"."+r+" = "+u+";\n")}for(var n=0;n<N.varmodes.length;++n){var r=N.varmodes[n],h=y(this,n);if(h){var l=a[r.length-1];o+="	"+l+" "+h+" = "+s+"."+r+";\n",this.setOutputData(n,l)}}t.addCode("code",o,this.shader_destination)}},v("const/vec4",N),C.title="FragColor",C.desc="Pixel final color",C.prototype.onGetCode=function(t){var e=m(this,0);if(e){var s,o=c(e,this.getInputData(0),"vec4");t.addCode("fs_code","fragcolor = "+o+";")}},v("output/fragcolor",C),S.title="Operation",S.operations=["+","-","*","/"],S.prototype.getTitle=function(){return this.flags.collapsed?"A"+this.properties.operation+"B":"Operation"},S.prototype.onGetCode=function(t){if(this.shader_destination&&this.isOutputConnected(0)){for(var e=[],s=0;s<3;++s)e.push({name:m(this,s),type:this.getInputData(s)||"float"});var o=y(this,0);if(o){for(var n=e[0].type,r=n,a=this.properties.operation,u=[],s=0;s<2;++s){var h=e[s].name;null==h&&(h=null!=p.value?p.value:"(1.0)",e[s].type="float"),e[s].type!=n&&("float"==e[s].type&&("*"==a||"/"==a)||(h=f(h,e[s].type,n))),u.push(h)}t.addCode("code",r+" "+o+" = "+u[0]+a+u[1]+";",this.shader_destination),this.setOutputData(0,r)}}},v("math/operation",S),A.title="Func",A.prototype.onPropertyChanged=function(t,e){if(this.graph&&this.graph._version++,"func"==t){var s=h[e];if(s){for(var o=s.params.length;o<this.inputs.length;++o)this.removeInput(o);for(var o=0;o<s.params.length;++o){var r=s.params[o];this.inputs[o]?this.inputs[o].name=r.name+(r.value?" ("+r.value+")":""):this.addInput(r.name,n.ALL_TYPES)}}}},A.prototype.getTitle=function(){return this.flags.collapsed?this.properties.func:"Func"},A.prototype.onGetCode=function(t){if(this.shader_destination&&this.isOutputConnected(0)){for(var e=[],s=0;s<3;++s)e.push({name:m(this,s),type:this.getInputData(s)||"float"});var o=y(this,0);if(o){var n=h[this.properties.func];if(n){var r=e[0].type,a=n.return_type;"T"==a&&(a=r);for(var u=[],s=0;s<n.params.length;++s){var l=n.params[s],d=e[s].name;null==d&&(d=null!=l.value?l.value:"(1.0)",e[s].type="float"),("T"==l.type&&e[s].type!=r||"T"!=l.type&&e[s].type!=r)&&(d=f(d,e[s].type,r)),u.push(d)}t.addFunction("round","float round(float v){ return floor(v+0.5); }\nvec2 round(vec2 v){ return floor(v+vec2(0.5));}\nvec3 round(vec3 v){ return floor(v+vec3(0.5));}\nvec4 round(vec4 v){ return floor(v+vec4(0.5)); }\n"),t.addCode("code",a+" "+o+" = "+n.func+"("+u.join(",")+");",this.shader_destination),this.setOutputData(0,a)}}}},v("math/func",A),k.title="Snippet",k.prototype.onPropertyChanged=function(t,e){this.graph&&this.graph._version++,"type"==t&&this.outputs[0].type!=e&&(this.disconnectOutput(0),this.outputs[0].type=e)},k.prototype.getTitle=function(){return this.flags.collapsed?this.properties.code:"Snippet"},k.prototype.onGetCode=function(t){if(this.shader_destination&&this.isOutputConnected(0)){var e=m(this,0);e||(e="1.0");var s=m(this,1);s||(s="1.0");var o=y(this,0);if(o){var n=this.getInputData(0)||"float",r=this.getInputData(1)||"float",a=this.properties.type;if("T"==n||"T"==r)return null;var u="funcSnippet"+this.id,h="\n"+a+" "+u+"( "+n+" A, "+r+" B) {\n";h+="	"+a+" C = "+a+"(0.0);\n",h+="	"+this.properties.code+";\n",h+="	return C;\n}\n",t.addCode("functions",h,this.shader_destination),t.addCode("code",a+" "+o+" = "+u+"("+e+","+s+");",this.shader_destination),this.setOutputData(0,a)}}},v("utils/snippet",k),R.title="Rand",R.prototype.onGetCode=function(t){if(this.shader_destination&&this.isOutputConnected(0)){var e=y(this,0);t.addUniform("u_rand"+this.id,"float",function(){return Math.random()}),t.addCode("code","float "+e+" = u_rand"+this.id+";",this.shader_destination),this.setOutputData(0,"float")}},v("input/rand",R),P.NOISE_TYPES=["noise","rand"],P.title="noise",P.prototype.onGetCode=function(t){if(this.shader_destination&&this.isOutputConnected(0)){var e=m(this,0),s=y(this,0),o=this.getInputData(0);e||(o="vec2",e=t.buffer_names.uvs),t.addFunction("noise",P.shader_functions),t.addUniform("u_noise_scale"+this.id,"float",this.properties.scale),"float"==o?t.addCode("code","float "+s+" = snoise( vec2("+e+") * u_noise_scale"+this.id+");",this.shader_destination):"vec2"==o||"vec3"==o?t.addCode("code","float "+s+" = snoise("+e+" * u_noise_scale"+this.id+");",this.shader_destination):"vec4"==o&&t.addCode("code","float "+s+" = snoise("+e+".xyz * u_noise_scale"+this.id+");",this.shader_destination),this.setOutputData(0,"float")}},v("math/noise",P),P.shader_functions="\nvec3 permute(vec3 x) { return mod(((x*34.0)+1.0)*x, 289.0); }\n\nfloat snoise(vec2 v){\n  const vec4 C = vec4(0.211324865405187, 0.366025403784439,-0.577350269189626, 0.024390243902439);\n  vec2 i  = floor(v + dot(v, C.yy) );\n  vec2 x0 = v -   i + dot(i, C.xx);\n  vec2 i1;\n  i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);\n  vec4 x12 = x0.xyxy + C.xxzz;\n  x12.xy -= i1;\n  i = mod(i, 289.0);\n  vec3 p = permute( permute( i.y + vec3(0.0, i1.y, 1.0 ))\n  + i.x + vec3(0.0, i1.x, 1.0 ));\n  vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy),dot(x12.zw,x12.zw)), 0.0);\n  m = m*m ;\n  m = m*m ;\n  vec3 x = 2.0 * fract(p * C.www) - 1.0;\n  vec3 h = abs(x) - 0.5;\n  vec3 ox = floor(x + 0.5);\n  vec3 a0 = x - ox;\n  m *= 1.79284291400159 - 0.85373472095314 * ( a0*a0 + h*h );\n  vec3 g;\n  g.x  = a0.x  * x0.x  + h.x  * x0.y;\n  g.yz = a0.yz * x12.xz + h.yz * x12.yw;\n  return 130.0 * dot(m, g);\n}\nvec4 permute(vec4 x){return mod(((x*34.0)+1.0)*x, 289.0);}\nvec4 taylorInvSqrt(vec4 r){return 1.79284291400159 - 0.85373472095314 * r;}\n\nfloat snoise(vec3 v){ \n  const vec2  C = vec2(1.0/6.0, 1.0/3.0) ;\n  const vec4  D = vec4(0.0, 0.5, 1.0, 2.0);\n\n// First corner\n  vec3 i  = floor(v + dot(v, C.yyy) );\n  vec3 x0 =   v - i + dot(i, C.xxx) ;\n\n// Other corners\n  vec3 g = step(x0.yzx, x0.xyz);\n  vec3 l = 1.0 - g;\n  vec3 i1 = min( g.xyz, l.zxy );\n  vec3 i2 = max( g.xyz, l.zxy );\n\n  //  x0 = x0 - 0. + 0.0 * C \n  vec3 x1 = x0 - i1 + 1.0 * C.xxx;\n  vec3 x2 = x0 - i2 + 2.0 * C.xxx;\n  vec3 x3 = x0 - 1. + 3.0 * C.xxx;\n\n// Permutations\n  i = mod(i, 289.0 ); \n  vec4 p = permute( permute( permute( \n             i.z + vec4(0.0, i1.z, i2.z, 1.0 ))\n           + i.y + vec4(0.0, i1.y, i2.y, 1.0 )) \n           + i.x + vec4(0.0, i1.x, i2.x, 1.0 ));\n\n// Gradients\n// ( N*N points uniformly over a square, mapped onto an octahedron.)\n  float n_ = 1.0/7.0; // N=7\n  vec3  ns = n_ * D.wyz - D.xzx;\n\n  vec4 j = p - 49.0 * floor(p * ns.z *ns.z);  //  mod(p,N*N)\n\n  vec4 x_ = floor(j * ns.z);\n  vec4 y_ = floor(j - 7.0 * x_ );    // mod(j,N)\n\n  vec4 x = x_ *ns.x + ns.yyyy;\n  vec4 y = y_ *ns.x + ns.yyyy;\n  vec4 h = 1.0 - abs(x) - abs(y);\n\n  vec4 b0 = vec4( x.xy, y.xy );\n  vec4 b1 = vec4( x.zw, y.zw );\n\n  vec4 s0 = floor(b0)*2.0 + 1.0;\n  vec4 s1 = floor(b1)*2.0 + 1.0;\n  vec4 sh = -step(h, vec4(0.0));\n\n  vec4 a0 = b0.xzyw + s0.xzyw*sh.xxyy ;\n  vec4 a1 = b1.xzyw + s1.xzyw*sh.zzww ;\n\n  vec3 p0 = vec3(a0.xy,h.x);\n  vec3 p1 = vec3(a0.zw,h.y);\n  vec3 p2 = vec3(a1.xy,h.z);\n  vec3 p3 = vec3(a1.zw,h.w);\n\n//Normalise gradients\n  vec4 norm = taylorInvSqrt(vec4(dot(p0,p0), dot(p1,p1), dot(p2, p2), dot(p3,p3)));\n  p0 *= norm.x;\n  p1 *= norm.y;\n  p2 *= norm.z;\n  p3 *= norm.w;\n\n// Mix final noise value\n  vec4 m = max(0.6 - vec4(dot(x0,x0), dot(x1,x1), dot(x2,x2), dot(x3,x3)), 0.0);\n  m = m * m;\n  return 42.0 * dot( m*m, vec4( dot(p0,x0), dot(p1,x1),dot(p2,x2), dot(p3,x3) ) );\n}\n\nvec3 hash3( vec2 p ){\n    vec3 q = vec3( dot(p,vec2(127.1,311.7)), \n				   dot(p,vec2(269.5,183.3)), \n				   dot(p,vec2(419.2,371.9)) );\n	return fract(sin(q)*43758.5453);\n}\nvec4 hash4( vec3 p ){\n    vec4 q = vec4( dot(p,vec3(127.1,311.7,257.3)), \n				   dot(p,vec3(269.5,183.3,335.1)), \n				   dot(p,vec3(314.5,235.1,467.3)), \n				   dot(p,vec3(419.2,371.9,114.9)) );\n	return fract(sin(q)*43758.5453);\n}\n\nfloat iqnoise( in vec2 x, float u, float v ){\n    vec2 p = floor(x);\n    vec2 f = fract(x);\n	\n	float k = 1.0+63.0*pow(1.0-v,4.0);\n	\n	float va = 0.0;\n	float wt = 0.0;\n    for( int j=-2; j<=2; j++ )\n    for( int i=-2; i<=2; i++ )\n    {\n        vec2 g = vec2( float(i),float(j) );\n		vec3 o = hash3( p + g )*vec3(u,u,1.0);\n		vec2 r = g - f + o.xy;\n		float d = dot(r,r);\n		float ww = pow( 1.0-smoothstep(0.0,1.414,sqrt(d)), k );\n		va += o.z*ww;\n		wt += ww;\n    }\n	\n    return va/wt;\n}\n",L.title="Time",L.prototype.onGetCode=function(t){if(this.shader_destination&&this.isOutputConnected(0)){var e=y(this,0);t.addUniform("u_time"+this.id,"float",function(){return .001*getTime()}),t.addCode("code","float "+e+" = u_time"+this.id+";",this.shader_destination),this.setOutputData(0,"float")}},v("input/time",L),z.title="Dither",z.prototype.onGetCode=function(t){if(this.shader_destination&&this.isOutputConnected(0)){var e,s=m(this,0),o="float",n=y(this,0);s=c(s,this.getInputData(0),"float"),t.addFunction("dither8x8",z.dither_func),t.addCode("code",o+" "+n+" = dither8x8("+s+");",this.shader_destination),this.setOutputData(0,o)}},z.dither_values=[.515625,.140625,.640625,.046875,.546875,.171875,.671875,.765625,.265625,.890625,.390625,.796875,.296875,.921875,.421875,.203125,.703125,.078125,.578125,.234375,.734375,.109375,.609375,.953125,.453125,.828125,.328125,.984375,.484375,.859375,.359375,.0625,.5625,.1875,.6875,.03125,.53125,.15625,.65625,.8125,.3125,.9375,.4375,.78125,.28125,.90625,.40625,.25,.75,.125,.625,.21875,.71875,.09375,.59375,1.0001,.5,.875,.375,.96875,.46875,.84375,.34375],z.dither_func="\n		float dither8x8(float brightness) {\n		  vec2 position = vec2(0.0);\n		  #ifdef FRAGMENT\n			position = gl_FragCoord.xy;\n		  #endif\n		  int x = int(mod(position.x, 8.0));\n		  int y = int(mod(position.y, 8.0));\n		  int index = x + y * 8;\n		  float limit = 0.0;\n		  if (x < 8) {\n			if(index==0) limit = 0.015625;\n			"+z.dither_values.map(function(t,e){return"else if(index== "+(e+1)+") limit = "+t+";"}).join("\n")+"\n		  }\n		  return brightness < limit ? 0.0 : 1.0;\n		}\n",v("math/dither",z),G.title="Remap",G.prototype.onPropertyChanged=function(){this.graph&&this.graph._version++},G.prototype.onConnectionsChange=function(){var t=this.getInputDataType(0);this.outputs[0].type=t||"T"},G.prototype.onGetCode=function(t){if(this.shader_destination&&this.isOutputConnected(0)){var e=m(this,0),s=y(this,0);if(e||s){var o=this.getInputDataType(0);if(this.outputs[0].type=o,"T"==o){console.warn("node type is T and cannot be resolved");return}if(!e){t.addCode("code","	"+o+" "+s+" = "+o+"(0.0);\n");return}var n=d(this.properties.min_value),r=d(this.properties.max_value),a=d(this.properties.min_value2),u=d(this.properties.max_value2);t.addCode("code",o+" "+s+" = ( ("+e+" - "+n+") / ("+r+" - "+n+") ) * ("+u+" - "+a+") + "+a+";",this.shader_destination),this.setOutputData(0,o)}}},v("math/remap",G)}function g(){for(var t in l.length=0,u){var e=u[t],s=e.indexOf(" "),o=e.substr(0,s),n=e.indexOf("(",s),r=e.substr(s,n-s).trim(),a=e.substr(n+1,e.length-n-2).split(",");for(var d in a){var c=a[d].split(" ").filter(function(t){return t});a[d]={type:c[0].trim(),name:c[1].trim()},"="==c[2]&&(a[d].value=c[3].trim())}h[t]={return_type:o,func:r,params:a},l.push(r)}}function v(t,s){s.color=o,s.filter="shader",s.prototype.clearDestination=function(){this.shader_destination={}},s.prototype.propagateDestination=function t(e){if(this.shader_destination[e]=!0,this.inputs)for(var s=0;s<this.inputs.length;++s){var o=this.getInputNode(s);o&&o.propagateDestination(e)}},s.prototype.onPropertyChanged||(s.prototype.onPropertyChanged=function(){this.graph&&this.graph._version++}),e.registerNodeType("shader::"+t,s)}function $(t,e){return"VAR_"+(e||"TEMP")+"_"+t.id}function m(t,e){if(!t.inputs)return null;var s=t.getInputLink(e);if(!s)return null;var o=t.graph.getNodeById(s.origin_id);return o?o.getOutputVarName?o.getOutputVarName(s.origin_slot):"link_"+o.id+"_"+s.origin_slot:null}function y(t,e){return t.isOutputConnected(e)?"link_"+t.id+"_"+e:null}function x(){this.vs_template="",this.fs_template="",this.buffer_names={uvs:"v_coord"},this.extra={},this._functions={},this._uniforms={},this._codeparts={},this._uniform_value=null}function _(){this.subgraph=new e.LGraph,this.subgraph._subgraph_node=this,this.subgraph._is_subgraph=!0,this.subgraph.filter="shader",this.addInput("in","texture"),this.addOutput("out","texture"),this.properties={width:0,height:0,alpha:!1,precision:"undefined"!=typeof LGraphTexture?LGraphTexture.DEFAULT:2};var t=this.subgraph.findNodesByType("shader::input/uniform")[0];t.pos=[200,300];var s=e.createNode("shader::texture/sampler2D");s.pos=[400,300],this.subgraph.add(s);var o=e.createNode("shader::output/fragcolor");o.pos=[600,300],this.subgraph.add(o),t.connect(0,s),s.connect(0,o),this.size=[180,60],this.redraw_on_mouse=!0,this._uniforms={},this._shader=null,this._context=new x,this._context.vs_template="#define VERTEX\n"+GL.Shader.SCREEN_VERTEX_SHADER,this._context.fs_template=_.template}function b(t,e,s,o){}function T(){this.addOutput("out",""),this.properties={name:"",type:""}}function E(){this.addOutput("out","vec2"),this.properties={name:"coord",type:"vec2"}}function w(){this.addInput("tex","sampler2D"),this.addInput("uv","vec2"),this.addOutput("rgba","vec4"),this.addOutput("rgb","vec3")}function O(){this.addOutput("","float"),this.properties={type:"float",value:0},this.addWidget("combo","type","float",null,{values:a,property:"type"}),this.updateWidgets()}function I(){this.addInput("xy","vec2"),this.addInput("x","float"),this.addInput("y","float"),this.addOutput("xy","vec2"),this.addOutput("x","float"),this.addOutput("y","float"),this.properties={x:0,y:0}}function D(){this.addInput("xyz","vec3"),this.addInput("x","float"),this.addInput("y","float"),this.addInput("z","float"),this.addInput("xy","vec2"),this.addInput("xz","vec2"),this.addInput("yz","vec2"),this.addOutput("xyz","vec3"),this.addOutput("x","float"),this.addOutput("y","float"),this.addOutput("z","float"),this.addOutput("xy","vec2"),this.addOutput("xz","vec2"),this.addOutput("yz","vec2"),this.properties={x:0,y:0,z:0}}function N(){this.addInput("xyzw","vec4"),this.addInput("xyz","vec3"),this.addInput("x","float"),this.addInput("y","float"),this.addInput("z","float"),this.addInput("w","float"),this.addInput("xy","vec2"),this.addInput("yz","vec2"),this.addInput("zw","vec2"),this.addOutput("xyzw","vec4"),this.addOutput("xyz","vec3"),this.addOutput("x","float"),this.addOutput("y","float"),this.addOutput("z","float"),this.addOutput("xy","vec2"),this.addOutput("yz","vec2"),this.addOutput("zw","vec2"),this.properties={x:0,y:0,z:0,w:0}}function C(){this.addInput("color",n.ALL_TYPES),this.block_delete=!0}function S(){this.addInput("A",n.ALL_TYPES),this.addInput("B",n.ALL_TYPES),this.addOutput("out",""),this.properties={operation:"*"},this.addWidget("combo","op.",this.properties.operation,{property:"operation",values:S.operations})}function A(){this.addInput("A",n.ALL_TYPES),this.addInput("B",n.ALL_TYPES),this.addOutput("out",""),this.properties={func:"floor"},this._current="floor",this.addWidget("combo","func",this.properties.func,{property:"func",values:l})}function k(){this.addInput("A",n.ALL_TYPES),this.addInput("B",n.ALL_TYPES),this.addOutput("C","vec4"),this.properties={code:"C = A+B",type:"vec4"},this.addWidget("text","code",this.properties.code,{property:"code"}),this.addWidget("combo","type",this.properties.type,{values:["float","vec2","vec3","vec4"],property:"type"})}function R(){this.addOutput("out","float")}function P(){this.addInput("out",n.ALL_TYPES),this.addInput("scale","float"),this.addOutput("out","float"),this.properties={type:"noise",scale:1},this.addWidget("combo","type",this.properties.type,{property:"type",values:P.NOISE_TYPES}),this.addWidget("number","scale",this.properties.scale,{property:"scale"})}function L(){this.addOutput("out","float")}function z(){this.addInput("in","T"),this.addOutput("out","float")}function G(){this.addInput("",n.ALL_TYPES),this.addOutput("",""),this.properties={min_value:0,max_value:1,min_value2:0,max_value2:1},this.addWidget("number","min",0,{step:.1,property:"min_value"}),this.addWidget("number","max",1,{step:.1,property:"max_value"}),this.addWidget("number","min2",0,{step:.1,property:"min_value2"}),this.addWidget("number","max2",1,{step:.1,property:"max_value2"})}}(this),function(t){var e=t.LiteGraph,s=new Float32Array(16),o=new Float32Array(16),n=new Float32Array(16),r=new Float32Array(16),a={u_view:s,u_projection:o,u_viewprojection:n,u_model:r};function u(){return 1e5*Math.random()|0}function h(){this.addInput("obj",""),this.addInput("radius","number"),this.addOutput("out","geometry"),this.addOutput("points","[vec3]"),this.properties={radius:1,num_points:4096,generate_normals:!0,regular:!1,mode:h.SPHERE,force_update:!1},this.points=new Float32Array(3*this.properties.num_points),this.normals=new Float32Array(3*this.properties.num_points),this.must_update=!0,this.version=0;var t=this;this.addWidget("button","update",null,function(){t.must_update=!0}),this.geometry={vertices:null,_id:u()},this._old_obj=null,this._last_radius=null}function l(t,e){var s=t.length,o=0,n=0,r=s;if(0==s)return -1;if(1==s)return 0;for(;r>=o;){var a=t[n=(r+o)*.5|0];if(a==e)break;if(o==r-1)return o;a<e?o=n:r=n}return n}function d(){this.addInput("points","geometry"),this.addOutput("instances","[mat4]"),this.properties={mode:1,autoupdate:!0},this.must_update=!0,this.matrices=[],this.first_time=!0}function c(){this.addInput("in","geometry,[mat4]"),this.addInput("mat4","mat4"),this.addOutput("out","geometry"),this.properties={},this.geometry={type:"triangles",vertices:null,_id:u(),_version:0},this._last_geometry_id=-1,this._last_version=-1,this._last_key="",this.must_update=!0}function f(){this.addInput("sides","number"),this.addInput("radius","number"),this.addOutput("out","geometry"),this.properties={sides:6,radius:1,uvs:!1},this.geometry={type:"line_loop",vertices:null,_id:u()},this.geometry_id=-1,this.version=-1,this.must_update=!0,this.last_info={sides:-1,radius:-1}}function g(){this.addInput("","geometry"),this.addOutput("","geometry"),this.properties={top_cap:!0,bottom_cap:!0,offset:[0,100,0]},this.version=-1,this._last_geo_version=-1,this._must_update=!0}function v(){this.addInput("in","geometry"),this.addOutput("out","geometry"),this.properties={code:"V[1] += 0.01 * Math.sin(I + T*0.001);",execute_every_frame:!1},this.geometry=null,this.geometry_id=-1,this.version=-1,this.must_update=!0,this.vertices=null,this.func=null}function $(){this.addInput("in","geometry"),this.addOutput("out","geometry"),this.properties={min_dist:.4,max_dist:.5,max_connections:0,probability:1},this.geometry_id=-1,this.version=-1,this.my_version=1,this.must_update=!0}function m(){this.addInput("mesh","mesh"),this.addOutput("out","geometry"),this.geometry={},this.last_mesh=null}function y(){this.addInput("in","geometry"),this.addOutput("mesh","mesh"),this.properties={},this.version=-1,this.mesh=null}function x(){this.addInput("mesh","mesh"),this.addInput("mat4","mat4"),this.addInput("tex","texture"),this.properties={enabled:!0,primitive:GL.TRIANGLES,additive:!1,color:[1,1,1],opacity:1},this.color=vec4.create([1,1,1,1]),this.model_matrix=mat4.create(),this.uniforms={u_color:this.color,u_model:this.model_matrix}}function _(){this.addInput("size","number"),this.addOutput("out","mesh"),this.properties={type:1,size:1,subdivisions:32},this.version=1e5*Math.random()|0,this.last_info={type:-1,size:-1,subdivisions:-1}}function b(){this.addInput("in","geometry"),this.addInput("mat4","mat4"),this.addInput("tex","texture"),this.properties={enabled:!0,point_size:.1,fixed_size:!1,additive:!0,color:[1,1,1],opacity:1},this.color=vec4.create([1,1,1,1]),this.uniforms={u_point_size:1,u_perspective:1,u_point_perspective:1,u_color:this.color},this.geometry_id=-1,this.version=-1,this.mesh=null}e.LGraphRender={onRequestCameraMatrices:null},t.LGraphPoints3D=h,h.RECTANGLE=1,h.CIRCLE=2,h.CUBE=10,h.SPHERE=11,h.HEMISPHERE=12,h.INSIDE_SPHERE=13,h.OBJECT=20,h.OBJECT_UNIFORMLY=21,h.OBJECT_INSIDE=22,h.MODE_VALUES={rectangle:h.RECTANGLE,circle:h.CIRCLE,cube:h.CUBE,sphere:h.SPHERE,hemisphere:h.HEMISPHERE,inside_sphere:h.INSIDE_SPHERE,object:h.OBJECT,object_uniformly:h.OBJECT_UNIFORMLY,object_inside:h.OBJECT_INSIDE},h.widgets_info={mode:{widget:"combo",values:h.MODE_VALUES}},h.title="list of points",h.desc="returns an array of points",h.prototype.onPropertyChanged=function(t,e){this.must_update=!0},h.prototype.onExecute=function(){var t=this.getInputData(0);(t!=this._old_obj||t&&t._version!=this._old_obj_version)&&(this._old_obj=t,this.must_update=!0);var e=this.getInputData(1);null==e&&(e=this.properties.radius),this._last_radius!=e&&(this._last_radius=e,this.must_update=!0),(this.must_update||this.properties.force_update)&&(this.must_update=!1,this.updatePoints()),this.geometry.vertices=this.points,this.geometry.normals=this.normals,this.geometry._version=this.version,this.setOutputData(0,this.geometry)},h.prototype.updatePoints=function(){var t=0|this.properties.num_points;t<1&&(t=1),this.points&&this.points.length==3*t||(this.points=new Float32Array(3*t)),this.properties.generate_normals?this.normals&&this.normals.length==this.points.length||(this.normals=new Float32Array(this.points.length)):this.normals=null;var e=this._last_radius||this.properties.radius,s=this.properties.mode,o=this.getInputData(0);this._old_obj_version=o?o._version:null,this.points=h.generatePoints(e,t,s,this.points,this.normals,this.properties.regular,o),this.version++},h.generatePoints=function(t,e,s,o,n,r,a){var u=3*e;o&&o.length==u||(o=new Float32Array(u));var l=new Float32Array(3),d=new Float32Array([0,1,0]);if(r){if(s==h.RECTANGLE){for(var c=Math.floor(Math.sqrt(e)),f=0;f<c;++f)for(var g=0;g<c;++g){var v=3*f+3*g*c;o[v]=(f/c-.5)*t*2,o[v+1]=0,o[v+2]=(g/c-.5)*t*2}if(o=new Float32Array(o.subarray(0,c*c*3)),n)for(var f=0;f<n.length;f+=3)n.set(d,f)}else if(s==h.SPHERE){for(var c=Math.floor(Math.sqrt(e)),f=0;f<c;++f)for(var g=0;g<c;++g){var v=3*f+3*g*c;polarToCartesian(l,f/c*2*Math.PI,(g/c-.5)*2*Math.PI,t),o[v]=l[0],o[v+1]=l[1],o[v+2]=l[2]}o=new Float32Array(o.subarray(0,c*c*3)),n&&h.generateSphericalNormals(o,n)}else if(s==h.CIRCLE){for(var f=0;f<u;f+=3){var $=2*Math.PI*(f/u);o[f]=Math.cos($)*t,o[f+1]=0,o[f+2]=Math.sin($)*t}if(n)for(var f=0;f<n.length;f+=3)n.set(d,f)}}else if(s==h.RECTANGLE){for(var f=0;f<u;f+=3)o[f]=(Math.random()-.5)*t*2,o[f+1]=0,o[f+2]=(Math.random()-.5)*t*2;if(n)for(var f=0;f<n.length;f+=3)n.set(d,f)}else if(s==h.CUBE){for(var f=0;f<u;f+=3)o[f]=(Math.random()-.5)*t*2,o[f+1]=(Math.random()-.5)*t*2,o[f+2]=(Math.random()-.5)*t*2;if(n)for(var f=0;f<n.length;f+=3)n.set(d,f)}else s==h.SPHERE?(h.generateSphere(o,u,t),n&&h.generateSphericalNormals(o,n)):s==h.HEMISPHERE?(h.generateHemisphere(o,u,t),n&&h.generateSphericalNormals(o,n)):s==h.CIRCLE?(h.generateInsideCircle(o,u,t),n&&h.generateSphericalNormals(o,n)):s==h.INSIDE_SPHERE?(h.generateInsideSphere(o,u,t),n&&h.generateSphericalNormals(o,n)):s==h.OBJECT?h.generateFromObject(o,n,u,a,!1):s==h.OBJECT_UNIFORMLY?h.generateFromObject(o,n,u,a,!0):s==h.OBJECT_INSIDE?h.generateFromInsideObject(o,u,a):console.warn("wrong mode in LGraphPoints3D");return o},h.generateSphericalNormals=function(t,e){for(var s=new Float32Array(3),o=0;o<e.length;o+=3)s[0]=t[o],s[1]=t[o+1],s[2]=t[o+2],vec3.normalize(s,s),e.set(s,o)},h.generateSphere=function(t,e,s){for(var o=0;o<e;o+=3){var n=Math.random(),r=Math.random(),a=2*Math.cos(2*Math.PI*n)*Math.sqrt(r*(1-r)),u=1-2*r,h=2*Math.sin(2*Math.PI*n)*Math.sqrt(r*(1-r));t[o]=a*s,t[o+1]=u*s,t[o+2]=h*s}},h.generateHemisphere=function(t,e,s){for(var o=0;o<e;o+=3){var n=Math.random(),r=Math.random(),a=Math.cos(2*Math.PI*n)*Math.sqrt(1-r*r),u=r,h=Math.sin(2*Math.PI*n)*Math.sqrt(1-r*r);t[o]=a*s,t[o+1]=u*s,t[o+2]=h*s}},h.generateInsideCircle=function(t,e,s){for(var o=0;o<e;o+=3){var n=Math.random(),r=Math.random(),a=Math.cos(2*Math.PI*n)*Math.sqrt(1-r*r),u=Math.sin(2*Math.PI*n)*Math.sqrt(1-r*r);t[o]=a*s,t[o+1]=0,t[o+2]=u*s}},h.generateInsideSphere=function(t,e,s){for(var o=0;o<e;o+=3){var n=2*Math.random()*Math.PI,r=Math.acos(2*Math.random()-1),a=Math.cbrt(Math.random())*s,u=Math.sin(n),h=Math.cos(n),l=Math.sin(r),d=Math.cos(r);t[o]=a*l*h,t[o+1]=a*l*u,t[o+2]=a*d}},h.generateFromObject=function(t,e,s,o,n){if(o){var r=null,a=null,u=null,h=null;if(o.constructor!==GL.Mesh||(r=o.vertexBuffers.vertices.data,a=o.vertexBuffers.normals?o.vertexBuffers.normals.data:null,(u=o.indexBuffers.indices?o.indexBuffers.indices.data:null)||(u=o.indexBuffers.triangles?o.indexBuffers.triangles.data:null)),!r)return null;var d=u?u.length/3:r.length/9,c=0;if(n){h=new Float32Array(d);for(var f=0;f<d;++f){u?(E=3*u[3*f],w=3*u[3*f+1],O=3*u[3*f+2]):(E=9*f,w=9*f+3,O=9*f+6);var g=r.subarray(E,E+3),v=r.subarray(w,w+3),$=r.subarray(O,O+3),m=vec3.distance(g,v),y=vec3.distance(v,$),x=vec3.distance($,g),_=(m+y+x)/2;c+=Math.sqrt(_*(_-m)*(_-y)*(_-x)),h[f]=c}for(var f=0;f<d;++f)h[f]/=c}for(var f=0;f<s;f+=3){var b=Math.random(),T=n?l(h,b):Math.floor(b*d),E=0,w=0,O=0;u?(E=3*u[3*T],w=3*u[3*T+1],O=3*u[3*T+2]):(E=9*T,w=9*T+3,O=9*T+6);var _=Math.random(),I=Math.random(),D=Math.sqrt(_),N=1-D,C=D*(1-I),S=I*D;if(t[f]=N*r[E]+C*r[w]+S*r[O],t[f+1]=N*r[E+1]+C*r[w+1]+S*r[O+1],t[f+2]=N*r[E+2]+C*r[w+2]+S*r[O+2],e&&a){e[f]=N*a[E]+C*a[w]+S*a[O],e[f+1]=N*a[E+1]+C*a[w+1]+S*a[O+1],e[f+2]=N*a[E+2]+C*a[w+2]+S*a[O+2];var A=e.subarray(f,f+3);vec3.normalize(A,A)}}}},h.generateFromInsideObject=function(t,e,s){if(s&&s.constructor===GL.Mesh){var o=s.getBoundingBox();s.octree||(s.octree=new GL.Octree(s));for(var n=s.octree,r=vec3.create(),a=vec3.fromValues(1,0,0),u=vec3.create(),h=0,l=0;h<e&&l<10*t.length;){l+=1;var d=vec3.random(u);d[0]=(2*d[0]-1)*o[3]+o[0],d[1]=(2*d[1]-1)*o[4]+o[1],d[2]=(2*d[2]-1)*o[5]+o[2],r.set(d);var c=n.testRay(r,a,0,1e4,!0,GL.Octree.ALL);c&&c.length%2!=0&&(t.set(d,h),h+=3)}}},e.registerNodeType("geometry/points3D",h),d.NORMAL=0,d.VERTICAL=1,d.SPHERICAL=2,d.RANDOM=3,d.RANDOM_VERTICAL=4,d.modes={normal:0,vertical:1,spherical:2,random:3,random_vertical:4},d.widgets_info={mode:{widget:"combo",values:d.modes}},d.title="points to inst",d.prototype.onExecute=function(){var t=this.getInputData(0);if(!t){this.setOutputData(0,null);return}this.isOutputConnected(0)&&(((t._version!=this._version||t._id!=this._geometry_id)&&this.properties.autoupdate||this.first_time)&&(this.first_time=!1,this.updateInstances(t)),this.setOutputData(0,this.matrices))},d.prototype.updateInstances=function(t){var e=t.vertices;if(!e)return null;var s=t.normals,o=this.matrices,n=e.length/3;o.length!=n&&(o.length=n);var r=mat4.create(),a=vec3.create();vec3.create();var u=vec3.fromValues(0,1,0),h=vec3.fromValues(0,0,-1);vec3.fromValues(1,0,0);for(var l=quat.create(),c=vec3.create(),f=vec3.create(),g=vec3.create(),v=0;v<e.length;v+=3){var $=v/3,m=o[$];m||(m=o[$]=mat4.create()),m.set(r);var y=e.subarray(v,v+3);switch(this.properties.mode){case d.NORMAL:if(mat4.setTranslation(m,y),s){var x=s.subarray(v,v+3);g.set(x),vec3.normalize(g,g),vec3.cross(f,h,g),vec3.normalize(f,f),vec3.cross(c,f,g),vec3.normalize(c,c),m.set(f,0),m.set(g,4),m.set(c,8),mat4.setTranslation(m,y)}break;case d.VERTICAL:mat4.setTranslation(m,y);break;case d.SPHERICAL:c.set(y),vec3.normalize(c,c),vec3.cross(f,u,c),vec3.normalize(f,f),vec3.cross(g,c,f),vec3.normalize(g,g),m.set(f,0),m.set(g,4),m.set(c,8),mat4.setTranslation(m,y);break;case d.RANDOM:a[0]=2*Math.random()-1,a[1]=2*Math.random()-1,a[2]=2*Math.random()-1,vec3.normalize(a,a),quat.setAxisAngle(l,a,2*Math.random()*Math.PI),mat4.fromQuat(m,l),mat4.setTranslation(m,y);break;case d.RANDOM_VERTICAL:quat.setAxisAngle(l,u,2*Math.random()*Math.PI),mat4.fromQuat(m,l),mat4.setTranslation(m,y)}}this._version=t._version,this._geometry_id=t._id},e.registerNodeType("geometry/points_to_instances",d),c.title="Transform",c.prototype.onExecute=function(){var t=this.getInputData(0),e=this.getInputData(1);if(t){if(t.constructor===Array){if(0==t.length||(this.outputs[0].type="[mat4]",!this.isOutputConnected(0)))return;if(!e){this.setOutputData(0,t);return}this._output||(this._output=[]),this._output.length!=t.length&&(this._output.length=t.length);for(var s=0;s<t.length;++s){var o=this._output[s];o||(o=this._output[s]=mat4.create()),mat4.multiply(o,t[s],e)}this.setOutputData(0,this._output);return}if(t.vertices&&t.vertices.length){var n=t;if(this.outputs[0].type="geometry",this.isOutputConnected(0)){if(!e){this.setOutputData(0,n);return}var r=typedArrayToArray(e).join(",");(this.must_update||n._id!=this._last_geometry_id||n._version!=this._last_version||r!=this._last_key)&&(this.updateGeometry(n,e),this._last_key=r,this._last_version=n._version,this._last_geometry_id=n._id,this.must_update=!1),this.setOutputData(0,this.geometry)}}}},c.prototype.updateGeometry=function(t,e){var s=t.vertices,o=this.geometry.vertices;o&&o.length==s.length||(o=this.geometry.vertices=new Float32Array(s.length));for(var n=vec3.create(),r=0,a=o.length;r<a;r+=3)n[0]=s[r],n[1]=s[r+1],n[2]=s[r+2],mat4.multiplyVec3(n,e,n),o[r]=n[0],o[r+1]=n[1],o[r+2]=n[2];if(t.normals){this.geometry.normals&&this.geometry.normals.length==t.normals.length||(this.geometry.normals=new Float32Array(t.normals.length));var u=this.geometry.normals,h=mat4.invert(mat4.create(),e);h&&mat4.transpose(h,h);for(var l=t.normals,r=0,a=u.length;r<a;r+=3)n[0]=l[r],n[1]=l[r+1],n[2]=l[r+2],mat4.multiplyVec3(n,h,n),u[r]=n[0],u[r+1]=n[1],u[r+2]=n[2]}this.geometry.type=t.type,this.geometry._version++},e.registerNodeType("geometry/transform",c),f.title="Polygon",f.prototype.onExecute=function(){if(this.isOutputConnected(0)){var t=this.getInputOrProperty("sides"),e=this.getInputOrProperty("radius");t=0|Math.max(3,t),(this.last_info.sides!=t||this.last_info.radius!=e)&&this.updateGeometry(t,e),this.setOutputData(0,this.geometry)}},f.prototype.updateGeometry=function(t,e){var s=3*t,o=this.geometry.vertices;o&&o.length==s||(o=this.geometry.vertices=new Float32Array(3*t));var n,r=2*Math.PI/t;this.properties.uvs&&(uvs=this.geometry.coords=new Float32Array(3*t));for(var a=0;a<t;++a){var u=-(r*a),h=Math.cos(u)*e,l=0,d=Math.sin(u)*e;o[3*a]=h,o[3*a+1]=l,o[3*a+2]=d}this.geometry._id=++this.geometry_id,this.geometry._version=++this.version,this.last_info.sides=t,this.last_info.radius=e},e.registerNodeType("geometry/polygon",f),g.title="extrude",g.prototype.onPropertyChanged=function(t,e){this._must_update=!0},g.prototype.onExecute=function(){var t=this.getInputData(0);t&&this.isOutputConnected(0)&&((t.version!=this._last_geo_version||this._must_update)&&(this._geo=this.extrudeGeometry(t,this._geo),this._geo&&(this._geo.version=this.version++),this._must_update=!1),this.setOutputData(0,this._geo))},g.prototype.extrudeGeometry=function(t){var e=t.vertices,s=e.length/3,o=vec3.create(),n=vec3.create(),r=vec3.create(),a=vec3.create(),h=new Float32Array(this.properties.offset);if("line_loop"==t.type)for(var l=new Float32Array(18*s),d=0,c=0,f=e.length;c<f;c+=3)o[0]=e[c],o[1]=e[c+1],o[2]=e[c+2],c+3<f?(n[0]=e[c+3],n[1]=e[c+4],n[2]=e[c+5]):(n[0]=e[0],n[1]=e[1],n[2]=e[2]),vec3.add(r,o,h),vec3.add(a,n,h),l.set(o,d),d+=3,l.set(n,d),d+=3,l.set(r,d),d+=3,l.set(n,d),d+=3,l.set(a,d),d+=3,l.set(r,d),d+=3;return{_id:u(),type:"triangles",vertices:l}},e.registerNodeType("geometry/extrude",g),v.title="geoeval",v.desc="eval code",v.widgets_info={code:{widget:"code"}},v.prototype.onConfigure=function(t){this.compileCode()},v.prototype.compileCode=function(){if(this.properties.code)try{this.func=Function("V","I","T",this.properties.code),this.boxcolor="#AFA",this.must_update=!0}catch(t){this.boxcolor="red"}},v.prototype.onPropertyChanged=function(t,e){"code"==t&&(this.properties.code=e,this.compileCode())},v.prototype.onExecute=function(){var t=this.getInputData(0);if(t){if(!this.func){this.setOutputData(0,t);return}if(this.geometry_id!=t._id||this.version!=t._version||this.must_update||this.properties.execute_every_frame){this.must_update=!1,this.geometry_id=t._id,this.properties.execute_every_frame?this.version++:this.version=t._version;var e=this.func,s=getTime();for(var o in this.geometry||(this.geometry={}),t)null!=t[o]&&(t[o].constructor==Float32Array?this.geometry[o]=new Float32Array(t[o]):this.geometry[o]=t[o]);this.geometry._id=t._id,this.properties.execute_every_frame?this.geometry._version=this.version:this.geometry._version=t._version+1;var n=vec3.create(),r=this.vertices;r&&this.vertices.length==t.vertices.length?r.set(t.vertices):r=this.vertices=new Float32Array(t.vertices);for(var o=0;o<r.length;o+=3)n[0]=r[o],n[1]=r[o+1],n[2]=r[o+2],e(n,o/3,s),r[o]=n[0],r[o+1]=n[1],r[o+2]=n[2];this.geometry.vertices=r}this.setOutputData(0,this.geometry)}},e.registerNodeType("geometry/eval",v),$.title="connect points",$.desc="adds indices between near points",$.prototype.onPropertyChanged=function(t,e){this.must_update=!0},$.prototype.onExecute=function(){var t=this.getInputData(0);if(t){if(this.geometry_id!=t._id||this.version!=t._version||this.must_update){for(var e in this.must_update=!1,this.geometry_id=t._id,this.version=t._version,this.geometry={},t)this.geometry[e]=t[e];this.geometry._id=u(),this.geometry._version=this.my_version++;for(var s=t.vertices,o=s.length,n=this.properties.min_dist,r=this.properties.max_dist,a=this.properties.probability,h=this.properties.max_connections,l=[],e=0;e<o;e+=3)for(var d=s[e],c=s[e+1],f=s[e+2],g=0,v=e+3;v<o;v+=3){var $=s[v],m=s[v+1],y=s[v+2],x=Math.sqrt((d-$)*(d-$)+(c-m)*(c-m)+(f-y)*(f-y));if(!(x>r||x<n||a<1&&a<Math.random())&&(l.push(e/3,v/3),g+=1,h&&g>h))break}this.geometry.indices=this.indices=new Uint32Array(l)}this.indices&&this.indices.length?(this.geometry.indices=this.indices,this.setOutputData(0,this.geometry)):this.setOutputData(0,null)}},e.registerNodeType("geometry/connectPoints",$),"undefined"!=typeof GL&&(m.title="to geometry",m.desc="converts a mesh to geometry",m.prototype.onExecute=function(){var t=this.getInputData(0);if(t){if(t!=this.last_mesh){for(i in this.last_mesh=t,t.vertexBuffers){var e=t.vertexBuffers[i];this.geometry[i]=e.data}t.indexBuffers.triangles&&(this.geometry.indices=t.indexBuffers.triangles.data),this.geometry._id=u(),this.geometry._version=0}this.setOutputData(0,this.geometry),this.geometry&&this.setOutputData(1,this.geometry.vertices)}},e.registerNodeType("geometry/toGeometry",m),y.title="Geo to Mesh",y.prototype.updateMesh=function(t){for(var e in this.mesh||(this.mesh=new GL.Mesh),t)if("_"!=e[0]){var s=t[e],o=GL.Mesh.common_buffers[e];if(o||"indices"==e){var n=o?o.spacing:3,r=this.mesh.vertexBuffers[e];r&&r.data.length==s.length?(r.data.set(s),r.upload(GL.DYNAMIC_DRAW)):r=new GL.Buffer("indices"==e?GL.ELEMENT_ARRAY_BUFFER:GL.ARRAY_BUFFER,s,n,GL.DYNAMIC_DRAW),this.mesh.addBuffer(e,r)}}if(this.mesh.vertexBuffers.normals&&this.mesh.vertexBuffers.normals.data.length!=this.mesh.vertexBuffers.vertices.data.length){for(var a=new Float32Array([0,1,0]),u=new Float32Array(this.mesh.vertexBuffers.vertices.data.length),e=0;e<u.length;e+=3)u.set(a,e);r=new GL.Buffer(GL.ARRAY_BUFFER,u,3),this.mesh.addBuffer("normals",r)}return this.mesh.updateBoundingBox(),this.geometry_id=this.mesh.id=t._id,this.version=this.mesh.version=t._version,this.mesh},y.prototype.onExecute=function(){var t=this.getInputData(0);t&&((this.version!=t._version||this.geometry_id!=t._id)&&this.updateMesh(t),this.setOutputData(0,this.mesh))},e.registerNodeType("geometry/toMesh",y),x.title="Render Mesh",x.desc="renders a mesh flat",x.PRIMITIVE_VALUES={points:GL.POINTS,lines:GL.LINES,line_loop:GL.LINE_LOOP,line_strip:GL.LINE_STRIP,triangles:GL.TRIANGLES,triangle_fan:GL.TRIANGLE_FAN,triangle_strip:GL.TRIANGLE_STRIP},x.widgets_info={primitive:{widget:"combo",values:x.PRIMITIVE_VALUES},color:{widget:"color"}},x.prototype.onExecute=function(){if(this.properties.enabled){var t=this.getInputData(0);if(t){if(!e.LGraphRender.onRequestCameraMatrices){console.warn("cannot render geometry, LiteGraph.onRequestCameraMatrices is null, remember to fill this with a callback(view_matrix, projection_matrix,viewprojection_matrix) to use 3D rendering from the graph");return}e.LGraphRender.onRequestCameraMatrices(s,o,n);var r,u=null;this.getInputData(2)?(u=gl.shaders.textured)||(u=gl.shaders.textured=new GL.Shader(b.vertex_shader_code,b.fragment_shader_code,{USE_TEXTURE:""})):(u=gl.shaders.flat)||(u=gl.shaders.flat=new GL.Shader(b.vertex_shader_code,b.fragment_shader_code)),this.color.set(this.properties.color),this.color[3]=this.properties.opacity;var h=this.model_matrix,l=this.getInputData(1);l?h.set(l):mat4.identity(h),this.uniforms.u_point_size=1;var d=this.properties.primitive;u.uniforms(a),u.uniforms(this.uniforms),this.properties.opacity>=1?gl.disable(gl.BLEND):gl.enable(gl.BLEND),gl.enable(gl.DEPTH_TEST),this.properties.additive?(gl.blendFunc(gl.SRC_ALPHA,gl.ONE),gl.depthMask(!1)):gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);var c="indices";t.indexBuffers.triangles&&(c="triangles"),u.draw(t,d,c),gl.disable(gl.BLEND),gl.depthMask(!0)}}},e.registerNodeType("geometry/render_mesh",x),_.title="Primitive",_.VALID={CUBE:1,PLANE:2,CYLINDER:3,SPHERE:4,CIRCLE:5,HEMISPHERE:6,ICOSAHEDRON:7,CONE:8,QUAD:9},_.widgets_info={type:{widget:"combo",values:_.VALID}},_.prototype.onExecute=function(){if(this.isOutputConnected(0)){var t=this.getInputOrProperty("size");(this.last_info.type!=this.properties.type||this.last_info.size!=t||this.last_info.subdivisions!=this.properties.subdivisions)&&this.updateMesh(this.properties.type,t,this.properties.subdivisions),this.setOutputData(0,this._mesh)}},_.prototype.updateMesh=function(t,e,s){switch(s=0|Math.max(0,s),t){case 1:this._mesh=GL.Mesh.cube({size:e,normals:!0,coords:!0});break;case 2:this._mesh=GL.Mesh.plane({size:e,xz:!0,detail:s,normals:!0,coords:!0});break;case 3:this._mesh=GL.Mesh.cylinder({size:e,subdivisions:s,normals:!0,coords:!0});break;case 4:this._mesh=GL.Mesh.sphere({size:e,long:s,lat:s,normals:!0,coords:!0});break;case 5:this._mesh=GL.Mesh.circle({size:e,slices:s,normals:!0,coords:!0});break;case 6:this._mesh=GL.Mesh.sphere({size:e,long:s,lat:s,normals:!0,coords:!0,hemi:!0});break;case 7:this._mesh=GL.Mesh.icosahedron({size:e,subdivisions:s});break;case 8:this._mesh=GL.Mesh.cone({radius:e,height:e,subdivisions:s});break;case 9:this._mesh=GL.Mesh.plane({size:e,xz:!1,detail:s,normals:!0,coords:!0})}this.last_info.type=t,this.last_info.size=e,this.last_info.subdivisions=s,this._mesh.version=this.version++},e.registerNodeType("geometry/mesh_primitive",_),b.title="renderPoints",b.desc="render points with a texture",b.widgets_info={color:{widget:"color"}},b.prototype.updateMesh=function(t){this.buffer,this.buffer&&this.buffer.data&&this.buffer.data.length==t.vertices.length?(this.buffer.data.set(t.vertices),this.buffer.upload(GL.DYNAMIC_DRAW)):this.buffer=new GL.Buffer(GL.ARRAY_BUFFER,t.vertices,3,GL.DYNAMIC_DRAW),this.mesh||(this.mesh=new GL.Mesh),this.mesh.addBuffer("vertices",this.buffer),this.geometry_id=this.mesh.id=t._id,this.version=this.mesh.version=t._version},b.prototype.onExecute=function(){if(this.properties.enabled){var t=this.getInputData(0);if(t){if((this.version!=t._version||this.geometry_id!=t._id)&&this.updateMesh(t),!e.LGraphRender.onRequestCameraMatrices){console.warn("cannot render geometry, LiteGraph.onRequestCameraMatrices is null, remember to fill this with a callback(view_matrix, projection_matrix,viewprojection_matrix) to use 3D rendering from the graph");return}e.LGraphRender.onRequestCameraMatrices(s,o,n);var u,h=null;this.getInputData(2)?(h=gl.shaders.textured_points)||(h=gl.shaders.textured_points=new GL.Shader(b.vertex_shader_code,b.fragment_shader_code,{USE_TEXTURED_POINTS:""})):(h=gl.shaders.points)||(h=gl.shaders.points=new GL.Shader(b.vertex_shader_code,b.fragment_shader_code,{USE_POINTS:""})),this.color.set(this.properties.color),this.color[3]=this.properties.opacity;var l=this.getInputData(1);l?r.set(l):mat4.identity(r),this.uniforms.u_point_size=this.properties.point_size,this.uniforms.u_point_perspective=this.properties.fixed_size?0:1,this.uniforms.u_perspective=gl.viewport_data[3]*o[5],h.uniforms(a),h.uniforms(this.uniforms),this.properties.opacity>=1?gl.disable(gl.BLEND):gl.enable(gl.BLEND),gl.enable(gl.DEPTH_TEST),this.properties.additive?(gl.blendFunc(gl.SRC_ALPHA,gl.ONE),gl.depthMask(!1)):gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),h.draw(this.mesh,GL.POINTS),gl.disable(gl.BLEND),gl.depthMask(!0)}}},e.registerNodeType("geometry/render_points",b),b.vertex_shader_code="		precision mediump float;\n		attribute vec3 a_vertex;\n		varying vec3 v_vertex;\n		attribute vec3 a_normal;\n		varying vec3 v_normal;\n		#ifdef USE_COLOR\n			attribute vec4 a_color;\n			varying vec4 v_color;\n		#endif\n		attribute vec2 a_coord;\n		varying vec2 v_coord;\n		#ifdef USE_SIZE\n			attribute float a_extra;\n		#endif\n		#ifdef USE_INSTANCING\n			attribute mat4 u_model;\n		#else\n			uniform mat4 u_model;\n		#endif\n		uniform mat4 u_viewprojection;\n		uniform float u_point_size;\n		uniform float u_perspective;\n		uniform float u_point_perspective;\n		float computePointSize(float radius, float w)\n		{\n			if(radius < 0.0)\n				return -radius;\n			return u_perspective * radius / w;\n		}\n		void main() {\n			v_coord = a_coord;\n			#ifdef USE_COLOR\n				v_color = a_color;\n			#endif\n			v_vertex = ( u_model * vec4( a_vertex, 1.0 )).xyz;\n			v_normal = ( u_model * vec4( a_normal, 0.0 )).xyz;\n			gl_Position = u_viewprojection * vec4(v_vertex,1.0);\n			gl_PointSize = u_point_size;\n			#ifdef USE_SIZE\n				gl_PointSize = a_extra;\n			#endif\n			if(u_point_perspective != 0.0)\n				gl_PointSize = computePointSize( gl_PointSize, gl_Position.w );\n		}	",b.fragment_shader_code="		precision mediump float;\n		uniform vec4 u_color;\n		#ifdef USE_COLOR\n			varying vec4 v_color;\n		#endif\n		varying vec2 v_coord;\n		uniform sampler2D u_texture;\n		void main() {\n			vec4 color = u_color;\n			#ifdef USE_TEXTURED_POINTS\n				color *= texture2D(u_texture, gl_PointCoord.xy);\n			#else\n				#ifdef USE_TEXTURE\n				  color *= texture2D(u_texture, v_coord);\n				  if(color.a < 0.1)\n					discard;\n				#endif\n				#ifdef USE_POINTS\n					float dist = length( gl_PointCoord.xy - vec2(0.5) );\n					if( dist > 0.45 )\n						discard;\n				#endif\n			#endif\n			#ifdef USE_COLOR\n				color *= v_color;\n			#endif\n			gl_FragColor = color;\n		}	")}(this),function(t){var e=t.LiteGraph,s=t.LGraphTexture;if("undefined"!=typeof GL){function o(){this.addInput("Texture","Texture"),this.addInput("Aberration","number"),this.addInput("Distortion","number"),this.addInput("Blur","number"),this.addOutput("Texture","Texture"),this.properties={aberration:1,distortion:1,blur:1,precision:s.DEFAULT},o._shader||(o._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,o.pixel_shader),o._texture=new GL.Texture(3,1,{format:gl.RGB,wrap:gl.CLAMP_TO_EDGE,magFilter:gl.LINEAR,minFilter:gl.LINEAR,pixel_data:[255,0,0,0,255,0,0,0,255]}))}function n(){this.addInput("Texture","Texture"),this.addInput("Blurred","Texture"),this.addInput("Mask","Texture"),this.addInput("Threshold","number"),this.addOutput("Texture","Texture"),this.properties={shape:"",size:10,alpha:1,threshold:1,high_precision:!1}}function r(){this.addInput("Texture","Texture"),this.addInput("value1","number"),this.addInput("value2","number"),this.addOutput("Texture","Texture"),this.properties={fx:"halftone",value1:1,value2:1,precision:s.DEFAULT}}function a(){this.addInput("Tex.","Texture"),this.addInput("intensity","number"),this.addOutput("Texture","Texture"),this.properties={intensity:1,invert:!1,precision:s.DEFAULT},a._shader||(a._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,a.pixel_shader))}o.title="Lens",o.desc="Camera Lens distortion",o.widgets_info={precision:{widget:"combo",values:s.MODE_VALUES}},o.prototype.onExecute=function(){var t=this.getInputData(0);if(this.properties.precision===s.PASS_THROUGH){this.setOutputData(0,t);return}if(t){this._tex=s.getTargetTexture(t,this._tex,this.properties.precision);var e=this.properties.aberration;this.isInputConnected(1)&&(e=this.getInputData(1),this.properties.aberration=e);var n=this.properties.distortion;this.isInputConnected(2)&&(n=this.getInputData(2),this.properties.distortion=n);var r=this.properties.blur;this.isInputConnected(3)&&(r=this.getInputData(3),this.properties.blur=r),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var a=Mesh.getScreenQuad(),u=o._shader;this._tex.drawTo(function(){t.bind(0),u.uniforms({u_texture:0,u_aberration:e,u_distortion:n,u_blur:r}).draw(a)}),this.setOutputData(0,this._tex)}},o.pixel_shader="precision highp float;\n			precision highp float;\n			varying vec2 v_coord;\n			uniform sampler2D u_texture;\n			uniform vec2 u_camera_planes;\n			uniform float u_aberration;\n			uniform float u_distortion;\n			uniform float u_blur;\n			\n			void main() {\n				vec2 coord = v_coord;\n				float dist = distance(vec2(0.5), coord);\n				vec2 dist_coord = coord - vec2(0.5);\n				float percent = 1.0 + ((0.5 - dist) / 0.5) * u_distortion;\n				dist_coord *= percent;\n				coord = dist_coord + vec2(0.5);\n				vec4 color = texture2D(u_texture,coord, u_blur * dist);\n				color.r = texture2D(u_texture,vec2(0.5) + dist_coord * (1.0+0.01*u_aberration), u_blur * dist ).r;\n				color.b = texture2D(u_texture,vec2(0.5) + dist_coord * (1.0-0.01*u_aberration), u_blur * dist ).b;\n				gl_FragColor = color;\n			}\n			",e.registerNodeType("fx/lens",o),t.LGraphFXLens=o,n.title="Bokeh",n.desc="applies an Bokeh effect",n.widgets_info={shape:{widget:"texture"}},n.prototype.onExecute=function(){var t=this.getInputData(0),e=this.getInputData(1),o=this.getInputData(2);if(!t||!o||!this.properties.shape){this.setOutputData(0,t);return}e||(e=t);var r=s.getTexture(this.properties.shape);if(r){var a=this.properties.threshold;this.isInputConnected(3)&&(a=this.getInputData(3),this.properties.threshold=a);var u=gl.UNSIGNED_BYTE;this.properties.high_precision&&(u=gl.half_float_ext?gl.HALF_FLOAT_OES:gl.FLOAT),this._temp_texture&&this._temp_texture.type==u&&this._temp_texture.width==t.width&&this._temp_texture.height==t.height||(this._temp_texture=new GL.Texture(t.width,t.height,{type:u,format:gl.RGBA,filter:gl.LINEAR})),this.properties.size;var h=n._first_shader;h||(h=n._first_shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,n._first_pixel_shader));var l=n._second_shader;l||(l=n._second_shader=new GL.Shader(n._second_vertex_shader,n._second_pixel_shader));var d=this._points_mesh;d&&d._width==t.width&&d._height==t.height&&2==d._spacing||(d=this.createPointsMesh(t.width,t.height,2));var c=Mesh.getScreenQuad(),f=this.properties.size;this.properties.min_light;var g=this.properties.alpha;gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND),this._temp_texture.drawTo(function(){t.bind(0),e.bind(1),o.bind(2),h.uniforms({u_texture:0,u_texture_blur:1,u_mask:2,u_texsize:[t.width,t.height]}).draw(c)}),this._temp_texture.drawTo(function(){gl.enable(gl.BLEND),gl.blendFunc(gl.ONE,gl.ONE),t.bind(0),r.bind(3),l.uniforms({u_texture:0,u_mask:2,u_shape:3,u_alpha:g,u_threshold:a,u_pointSize:f,u_itexsize:[1/t.width,1/t.height]}).draw(d,gl.POINTS)}),this.setOutputData(0,this._temp_texture)}},n.prototype.createPointsMesh=function(t,e,s){for(var o=Math.round(t/s),n=Math.round(e/s),r=new Float32Array(o*n*2),a=-1,u=2/t*s,h=2/e*s,l=0;l<n;++l){for(var d=-1,c=0;c<o;++c){var f=l*o*2+2*c;r[f]=d,r[f+1]=a,d+=u}a+=h}return this._points_mesh=GL.Mesh.load({vertices2D:r}),this._points_mesh._width=t,this._points_mesh._height=e,this._points_mesh._spacing=s,this._points_mesh},n._first_pixel_shader="precision highp float;\n			precision highp float;\n			varying vec2 v_coord;\n			uniform sampler2D u_texture;\n			uniform sampler2D u_texture_blur;\n			uniform sampler2D u_mask;\n			\n			void main() {\n				vec4 color = texture2D(u_texture, v_coord);\n				vec4 blurred_color = texture2D(u_texture_blur, v_coord);\n				float mask = texture2D(u_mask, v_coord).x;\n			   gl_FragColor = mix(color, blurred_color, mask);\n			}\n			",n._second_vertex_shader="precision highp float;\n			attribute vec2 a_vertex2D;\n			varying vec4 v_color;\n			uniform sampler2D u_texture;\n			uniform sampler2D u_mask;\n			uniform vec2 u_itexsize;\n			uniform float u_pointSize;\n			uniform float u_threshold;\n			void main() {\n				vec2 coord = a_vertex2D * 0.5 + 0.5;\n				v_color = texture2D( u_texture, coord );\n				v_color += texture2D( u_texture, coord + vec2(u_itexsize.x, 0.0) );\n				v_color += texture2D( u_texture, coord + vec2(0.0, u_itexsize.y));\n				v_color += texture2D( u_texture, coord + u_itexsize);\n				v_color *= 0.25;\n				float mask = texture2D(u_mask, coord).x;\n				float luminance = length(v_color) * mask;\n				/*luminance /= (u_pointSize*u_pointSize)*0.01 */;\n				luminance -= u_threshold;\n				if(luminance < 0.0)\n				{\n					gl_Position.x = -100.0;\n					return;\n				}\n				gl_PointSize = u_pointSize;\n				gl_Position = vec4(a_vertex2D,0.0,1.0);\n			}\n			",n._second_pixel_shader="precision highp float;\n			varying vec4 v_color;\n			uniform sampler2D u_shape;\n			uniform float u_alpha;\n			\n			void main() {\n				vec4 color = texture2D( u_shape, gl_PointCoord );\n				color *= v_color * u_alpha;\n				gl_FragColor = color;\n			}\n",e.registerNodeType("fx/bokeh",n),t.LGraphFXBokeh=n,r.title="FX",r.desc="applies an FX from a list",r.widgets_info={fx:{widget:"combo",values:["halftone","pixelate","lowpalette","noise","gamma"]},precision:{widget:"combo",values:s.MODE_VALUES}},r.shaders={},r.prototype.onExecute=function(){if(this.isOutputConnected(0)){var e,o=this.getInputData(0);if(this.properties.precision===s.PASS_THROUGH){this.setOutputData(0,o);return}if(o){this._tex=s.getTargetTexture(o,this._tex,this.properties.precision);var n=this.properties.value1;this.isInputConnected(1)&&(n=this.getInputData(1),this.properties.value1=n);var a=this.properties.value2;this.isInputConnected(2)&&(a=this.getInputData(2),this.properties.value2=a);var u=this.properties.fx,h=r.shaders[u];if(!h){var l=r["pixel_shader_"+u];if(!l)return;h=r.shaders[u]=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,l)}gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var d,c=Mesh.getScreenQuad();e=(t.LS?LS.Renderer._current_camera:null)?[LS.Renderer._current_camera.near,LS.Renderer._current_camera.far]:[1,100];var f=null;"noise"==u&&(f=s.getNoiseTexture()),this._tex.drawTo(function(){o.bind(0),"noise"==u&&f.bind(1),h.uniforms({u_texture:0,u_noise:1,u_size:[o.width,o.height],u_rand:[Math.random(),Math.random()],u_value1:n,u_value2:a,u_camera_planes:e}).draw(c)}),this.setOutputData(0,this._tex)}}},r.pixel_shader_halftone="precision highp float;\n			varying vec2 v_coord;\n			uniform sampler2D u_texture;\n			uniform vec2 u_camera_planes;\n			uniform vec2 u_size;\n			uniform float u_value1;\n			uniform float u_value2;\n			\n			float pattern() {\n				float s = sin(u_value1 * 3.1415), c = cos(u_value1 * 3.1415);\n				vec2 tex = v_coord * u_size.xy;\n				vec2 point = vec2(\n				   c * tex.x - s * tex.y ,\n				   s * tex.x + c * tex.y \n				) * u_value2;\n				return (sin(point.x) * sin(point.y)) * 4.0;\n			}\n			void main() {\n				vec4 color = texture2D(u_texture, v_coord);\n				float average = (color.r + color.g + color.b) / 3.0;\n				gl_FragColor = vec4(vec3(average * 10.0 - 5.0 + pattern()), color.a);\n			}\n",r.pixel_shader_pixelate="precision highp float;\n			varying vec2 v_coord;\n			uniform sampler2D u_texture;\n			uniform vec2 u_camera_planes;\n			uniform vec2 u_size;\n			uniform float u_value1;\n			uniform float u_value2;\n			\n			void main() {\n				vec2 coord = vec2( floor(v_coord.x * u_value1) / u_value1, floor(v_coord.y * u_value2) / u_value2 );\n				vec4 color = texture2D(u_texture, coord);\n				gl_FragColor = color;\n			}\n",r.pixel_shader_lowpalette="precision highp float;\n			varying vec2 v_coord;\n			uniform sampler2D u_texture;\n			uniform vec2 u_camera_planes;\n			uniform vec2 u_size;\n			uniform float u_value1;\n			uniform float u_value2;\n			\n			void main() {\n				vec4 color = texture2D(u_texture, v_coord);\n				gl_FragColor = floor(color * u_value1) / u_value1;\n			}\n",r.pixel_shader_noise="precision highp float;\n			varying vec2 v_coord;\n			uniform sampler2D u_texture;\n			uniform sampler2D u_noise;\n			uniform vec2 u_size;\n			uniform float u_value1;\n			uniform float u_value2;\n			uniform vec2 u_rand;\n			\n			void main() {\n				vec4 color = texture2D(u_texture, v_coord);\n				vec3 noise = texture2D(u_noise, v_coord * vec2(u_size.x / 512.0, u_size.y / 512.0) + u_rand).xyz - vec3(0.5);\n				gl_FragColor = vec4( color.xyz + noise * u_value1, color.a );\n			}\n",r.pixel_shader_gamma="precision highp float;\n			varying vec2 v_coord;\n			uniform sampler2D u_texture;\n			uniform float u_value1;\n			\n			void main() {\n				vec4 color = texture2D(u_texture, v_coord);\n				float gamma = 1.0 / u_value1;\n				gl_FragColor = vec4( pow( color.xyz, vec3(gamma) ), color.a );\n			}\n",e.registerNodeType("fx/generic",r),t.LGraphFXGeneric=r,a.title="Vigneting",a.desc="Vigneting",a.widgets_info={precision:{widget:"combo",values:s.MODE_VALUES}},a.prototype.onExecute=function(){var t=this.getInputData(0);if(this.properties.precision===s.PASS_THROUGH){this.setOutputData(0,t);return}if(t){this._tex=s.getTargetTexture(t,this._tex,this.properties.precision);var e=this.properties.intensity;this.isInputConnected(1)&&(e=this.getInputData(1),this.properties.intensity=e),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var o=Mesh.getScreenQuad(),n=a._shader,r=this.properties.invert;this._tex.drawTo(function(){t.bind(0),n.uniforms({u_texture:0,u_intensity:e,u_isize:[1/t.width,1/t.height],u_invert:r?1:0}).draw(o)}),this.setOutputData(0,this._tex)}},a.pixel_shader="precision highp float;\n			precision highp float;\n			varying vec2 v_coord;\n			uniform sampler2D u_texture;\n			uniform float u_intensity;\n			uniform int u_invert;\n			\n			void main() {\n				float luminance = 1.0 - length( v_coord - vec2(0.5) ) * 1.414;\n				vec4 color = texture2D(u_texture, v_coord);\n				if(u_invert == 1)\n					luminance = 1.0 - luminance;\n				luminance = mix(1.0, luminance, u_intensity);\n			   gl_FragColor = vec4( luminance * color.xyz, color.a);\n			}\n			",e.registerNodeType("fx/vigneting",a),t.LGraphFXVigneting=a}}(this),function(t){var e=t.LiteGraph,s="#243";function o(t){this.channel=0,this.cmd=0,this.data=new Uint32Array(3),t&&this.setup(t)}for(var n in e.MIDIEvent=o,o.prototype.fromJSON=function(t){this.setup(t.data)},o.prototype.setup=function(t){var e=t;t.constructor===Object&&(e=t.data),this.data.set(e);var s=e[0];this.status=s;var n=240&s;s>=240?this.cmd=s:this.cmd=n,this.cmd==o.NOTEON&&0==this.velocity&&(this.cmd=o.NOTEOFF),this.cmd_str=o.commands[this.cmd]||"",(n>=o.NOTEON||n<=o.NOTEOFF)&&(this.channel=15&s)},Object.defineProperty(o.prototype,"velocity",{get:function(){return this.cmd==o.NOTEON?this.data[2]:-1},set:function(t){this.data[2]=t},enumerable:!0}),o.notes=["A","A#","B","C","C#","D","D#","E","F","F#","G","G#"],o.note_to_index={A:0,"A#":1,B:2,C:3,"C#":4,D:5,"D#":6,E:7,F:8,"F#":9,G:10,"G#":11},Object.defineProperty(o.prototype,"note",{get:function(){return this.cmd!=o.NOTEON?-1:o.toNoteString(this.data[1],!0)},set:function(t){throw"notes cannot be assigned this way, must modify the data[1]"},enumerable:!0}),Object.defineProperty(o.prototype,"octave",{get:function(){return this.cmd!=o.NOTEON?-1:Math.floor((this.data[1]-24)/12+1)},set:function(t){throw"octave cannot be assigned this way, must modify the data[1]"},enumerable:!0}),o.prototype.getPitch=function(){return 440*Math.pow(2,(this.data[1]-69)/12)},o.computePitch=function(t){return 440*Math.pow(2,(t-69)/12)},o.prototype.getCC=function(){return this.data[1]},o.prototype.getCCValue=function(){return this.data[2]},o.prototype.getPitchBend=function(){return this.data[1]+(this.data[2]<<7)-8192},o.computePitchBend=function(t,e){return t+(e<<7)-8192},o.prototype.setCommandFromString=function(t){this.cmd=o.computeCommandFromString(t)},o.computeCommandFromString=function(t){if(!t)return 0;if(t&&t.constructor===Number)return t;switch(t=t.toUpperCase()){case"NOTE ON":case"NOTEON":case"NOTE OFF":case"NOTEOFF":return o.NOTEON;case"KEY PRESSURE":case"KEYPRESSURE":return o.KEYPRESSURE;case"CONTROLLER CHANGE":case"CONTROLLERCHANGE":case"CC":return o.CONTROLLERCHANGE;case"PROGRAM CHANGE":case"PROGRAMCHANGE":case"PC":return o.PROGRAMCHANGE;case"CHANNEL PRESSURE":case"CHANNELPRESSURE":return o.CHANNELPRESSURE;case"PITCH BEND":case"PITCHBEND":return o.PITCHBEND;case"TIME TICK":case"TIMETICK":return o.TIMETICK;default:return Number(t)}},o.toNoteString=function(t,e){var s=(t=Math.round(t))-21,n=Math.floor((t-24)/12+1);return(s%=12)<0&&(s=12+s),o.notes[s]+(e?"":n)},o.NoteStringToPitch=function(t){var e=(t=t.toUpperCase())[0],s=4;"#"==t[1]?(e+="#",t.length>2&&(s=Number(t[2]))):t.length>1&&(s=Number(t[1]));var n=o.note_to_index[e];return null==n?null:(s-1)*12+n+21},o.prototype.toString=function(){var t=""+this.channel+". ";switch(this.cmd){case o.NOTEON:t+="NOTEON "+o.toNoteString(this.data[1]);break;case o.NOTEOFF:t+="NOTEOFF "+o.toNoteString(this.data[1]);break;case o.CONTROLLERCHANGE:t+="CC "+this.data[1]+" "+this.data[2];break;case o.PROGRAMCHANGE:t+="PC "+this.data[1];break;case o.PITCHBEND:t+="PITCHBEND "+this.getPitchBend();break;case o.KEYPRESSURE:t+="KEYPRESS "+this.data[1]}return t},o.prototype.toHexString=function(){for(var t="",e=0;e<this.data.length;e++)t+=this.data[e].toString(16)+" "},o.prototype.toJSON=function(){return{data:[this.data[0],this.data[1],this.data[2]],object_class:"MIDIEvent"}},o.NOTEOFF=128,o.NOTEON=144,o.KEYPRESSURE=160,o.CONTROLLERCHANGE=176,o.PROGRAMCHANGE=192,o.CHANNELPRESSURE=208,o.PITCHBEND=224,o.TIMETICK=248,o.commands={128:"note off",144:"note on",160:"key pressure",176:"controller change",192:"program change",208:"channel pressure",224:"pitch bend",240:"system",242:"Song pos",243:"Song select",246:"Tune request",248:"time tick",250:"Start Song",251:"Continue Song",252:"Stop Song",254:"Sensing",255:"Reset"},o.commands_short={128:"NOTEOFF",144:"NOTEOFF",160:"KEYP",176:"CC",192:"PC",208:"CP",224:"PB",240:"SYS",242:"POS",243:"SELECT",246:"TUNEREQ",248:"TT",250:"START",251:"CONTINUE",252:"STOP",254:"SENS",255:"RESET"},o.commands_reversed={},o.commands)o.commands_reversed[o.commands[n]]=n;function r(t,e){if(!navigator.requestMIDIAccess){this.error="not suppoorted",e?e("Not supported"):console.error("MIDI NOT SUPPORTED, enable by chrome://flags");return}this.on_ready=t,this.state={note:[],cc:[]},this.input_ports=null,this.input_ports_info=[],this.output_ports=null,this.output_ports_info=[],navigator.requestMIDIAccess().then(this.onMIDISuccess.bind(this),this.onMIDIFailure.bind(this))}function a(){this.addOutput("on_midi",e.EVENT),this.addOutput("out","midi"),this.properties={port:0},this._last_midi_event=null,this._current_midi_event=null,this.boxcolor="#AAA",this._last_time=0;var t=this;new r(function(e){t._midi=e,t._waiting&&t.onStart(),t._waiting=!1})}function u(){this.addInput("send",e.EVENT),this.properties={port:0};var t=this;new r(function(e){t._midi=e,t.widget.options.values=t.getMIDIOutputs()}),this.widget=this.addWidget("combo","Device",this.properties.port,{property:"port",values:this.getMIDIOutputs.bind(this)}),this.size=[340,60]}function h(){this.addInput("on_midi",e.EVENT),this._str="",this.size=[200,40]}function l(){this.properties={channel:-1,cmd:-1,min_value:-1,max_value:-1};var t=this;this._learning=!1,this.addWidget("button","Learn","",function(){t._learning=!0,t.boxcolor="#FA3"}),this.addInput("in",e.EVENT),this.addOutput("on_midi",e.EVENT),this.boxcolor="#AAA"}function d(){this.properties={channel:0,cmd:144,value1:1,value2:1},this.addInput("send",e.EVENT),this.addInput("assign",e.EVENT),this.addOutput("on_midi",e.EVENT),this.midi_event=new o,this.gate=!1}function c(){this.properties={cc:1,value:0},this.addOutput("value","number")}function f(){this.addInput("generate",e.ACTION),this.addInput("scale","string"),this.addInput("octave","number"),this.addOutput("note",e.EVENT),this.properties={notes:"A,A#,B,C,C#,D,D#,E,F,F#,G,G#",octave:2,duration:.5,mode:"sequence"},this.notes_pitches=f.processScale(this.properties.notes),this.sequence_index=0}function g(){this.properties={amount:0},this.addInput("in",e.ACTION),this.addInput("amount","number"),this.addOutput("out",e.EVENT),this.midi_event=new o}function v(){this.properties={scale:"A,A#,B,C,C#,D,D#,E,F,F#,G,G#"},this.addInput("note",e.ACTION),this.addInput("scale","string"),this.addOutput("out",e.EVENT),this.valid_notes=Array(12),this.offset_notes=Array(12),this.processScale(this.properties.scale)}function $(){this.properties={url:"",autoplay:!0},this.addInput("play",e.ACTION),this.addInput("pause",e.ACTION),this.addOutput("note",e.EVENT),this._midi=null,this._current_time=0,this._playing=!1,"undefined"==typeof MidiParser&&(console.error("midi-parser.js not included, LGMidiPlay requires that library: https://raw.githubusercontent.com/colxi/midi-parser-js/master/src/main.js"),this.boxcolor="red")}function m(){if(this.properties={volume:.5,duration:1},this.addInput("note",e.ACTION),this.addInput("volume","number"),this.addInput("duration","number"),this.addOutput("note",e.EVENT),"undefined"==typeof AudioSynth)console.error("Audiosynth.js not included, LGMidiPlay requires that library"),this.boxcolor="red";else{var t=this.synth=new AudioSynth;this.instrument=t.createInstrument("piano")}}function y(){this.properties={num_octaves:2,start_octave:2},this.addInput("note",e.ACTION),this.addInput("reset",e.ACTION),this.addOutput("note",e.EVENT),this.size=[400,100],this.keys=[],this._last_key=-1}function x(){return window.performance.now()}r.input=null,r.MIDIEvent=o,r.prototype.onMIDISuccess=function(t){console.log("MIDI ready!"),console.log(t),this.midi=t,this.updatePorts(),this.on_ready&&this.on_ready(this)},r.prototype.updatePorts=function(){var t=this.midi;this.input_ports=t.inputs,this.input_ports_info=[],this.output_ports=t.outputs,this.output_ports_info=[];for(var e=0,s=this.input_ports.values(),o=s.next();o&&!1===o.done;){var n=o.value;this.input_ports_info.push(n),console.log("Input port [type:'"+n.type+"'] id:'"+n.id+"' manufacturer:'"+n.manufacturer+"' name:'"+n.name+"' version:'"+n.version+"'"),e++,o=s.next()}this.num_input_ports=e,e=0;for(var s=this.output_ports.values(),o=s.next();o&&!1===o.done;){var n=o.value;this.output_ports_info.push(n),console.log("Output port [type:'"+n.type+"'] id:'"+n.id+"' manufacturer:'"+n.manufacturer+"' name:'"+n.name+"' version:'"+n.version+"'"),e++,o=s.next()}this.num_output_ports=e},r.prototype.onMIDIFailure=function(t){console.error("Failed to get MIDI access - "+t)},r.prototype.openInputPort=function(t,e){var s=this.input_ports.get("input-"+t);if(!s)return!1;r.input=this;var n=this;return s.onmidimessage=function(t){var s=new o(t.data);n.updateState(s),e&&e(t.data,s),r.on_message&&r.on_message(t.data,s)},console.log("port open: ",s),!0},r.parseMsg=function(t){},r.prototype.updateState=function(t){switch(t.cmd){case o.NOTEON:this.state.note[0|t.value1]=t.value2;break;case o.NOTEOFF:this.state.note[0|t.value1]=0;break;case o.CONTROLLERCHANGE:this.state.cc[t.getCC()]=t.getCCValue()}},r.prototype.sendMIDI=function(t,e){if(e){var s=this.output_ports_info[t];s&&(r.output=this,e.constructor===o?s.send(e.data):s.send(e))}},a.MIDIInterface=r,a.title="MIDI Input",a.desc="Reads MIDI from a input port",a.color=s,a.prototype.getPropertyInfo=function(t){if(this._midi&&"port"==t){for(var e={},s=0;s<this._midi.input_ports_info.length;++s){var o=this._midi.input_ports_info[s];e[s]=s+".- "+o.name+" version:"+o.version}return{type:"enum",values:e}}},a.prototype.onStart=function(){this._midi?this._midi.openInputPort(this.properties.port,this.onMIDIEvent.bind(this)):this._waiting=!0},a.prototype.onMIDIEvent=function(t,s){this._last_midi_event=s,this.boxcolor="#AFA",this._last_time=e.getTime(),this.trigger("on_midi",s),s.cmd==o.NOTEON?this.trigger("on_noteon",s):s.cmd==o.NOTEOFF?this.trigger("on_noteoff",s):s.cmd==o.CONTROLLERCHANGE?this.trigger("on_cc",s):s.cmd==o.PROGRAMCHANGE?this.trigger("on_pc",s):s.cmd==o.PITCHBEND&&this.trigger("on_pitchbend",s)},a.prototype.onDrawBackground=function(t){if(this.boxcolor="#AAA",!this.flags.collapsed&&this._last_midi_event){t.fillStyle="white";var s=1-Math.max(0,(e.getTime()-this._last_time)*.001);if(s>0){var o=t.globalAlpha;t.globalAlpha*=s,t.font="12px Tahoma",t.fillText(this._last_midi_event.toString(),2,.5*this.size[1]+3),t.globalAlpha=o}}},a.prototype.onExecute=function(){if(this.outputs)for(var t=this._last_midi_event,e=0;e<this.outputs.length;++e){var s=this.outputs[e],o=null;switch(s.name){case"midi":o=this._midi;break;case"last_midi":o=t;break;default:continue}this.setOutputData(e,o)}},a.prototype.onGetOutputs=function(){return[["last_midi","midi"],["on_midi",e.EVENT],["on_noteon",e.EVENT],["on_noteoff",e.EVENT],["on_cc",e.EVENT],["on_pc",e.EVENT],["on_pitchbend",e.EVENT]]},e.registerNodeType("midi/input",a),u.MIDIInterface=r,u.title="MIDI Output",u.desc="Sends MIDI to output channel",u.color=s,u.prototype.onGetPropertyInfo=function(t){if(this._midi&&"port"==t)return{type:"enum",values:this.getMIDIOutputs()}},u.default_ports={0:"unknown"},u.prototype.getMIDIOutputs=function(){var t={};if(!this._midi)return u.default_ports;if(this._midi.output_ports_info)for(var e=0;e<this._midi.output_ports_info.length;++e){var s=this._midi.output_ports_info[e];if(s){var o=e+".- "+s.name+" version:"+s.version;t[e]=o}}return t},u.prototype.onAction=function(t,e){this._midi&&("send"==t&&this._midi.sendMIDI(this.properties.port,e),this.trigger("midi",e))},u.prototype.onGetInputs=function(){return[["send",e.ACTION]]},u.prototype.onGetOutputs=function(){return[["on_midi",e.EVENT]]},e.registerNodeType("midi/output",u),h.title="MIDI Show",h.desc="Shows MIDI in the graph",h.color=s,h.prototype.getTitle=function(){return this.flags.collapsed?this._str:this.title},h.prototype.onAction=function(t,e){e&&(e.constructor===o?this._str=e.toString():this._str="???")},h.prototype.onDrawForeground=function(t){this._str&&!this.flags.collapsed&&(t.font="30px Arial",t.fillText(this._str,10,.8*this.size[1]))},h.prototype.onGetInputs=function(){return[["in",e.ACTION]]},h.prototype.onGetOutputs=function(){return[["on_midi",e.EVENT]]},e.registerNodeType("midi/show",h),l.title="MIDI Filter",l.desc="Filters MIDI messages",l.color=s,l["@cmd"]={type:"enum",title:"Command",values:o.commands_reversed},l.prototype.getTitle=function(){var t=null;return t=-1==this.properties.cmd?"Nothing":o.commands_short[this.properties.cmd]||"Unknown",-1!=this.properties.min_value&&-1!=this.properties.max_value&&(t+=" "+(this.properties.min_value==this.properties.max_value?this.properties.max_value:this.properties.min_value+".."+this.properties.max_value)),"Filter: "+t},l.prototype.onPropertyChanged=function(t,e){if("cmd"==t){var s=Number(e);isNaN(s)&&(s=o.commands[e]||0),this.properties.cmd=s}},l.prototype.onAction=function(t,e){if(e&&e.constructor===o){if(this._learning)this._learning=!1,this.boxcolor="#AAA",this.properties.channel=e.channel,this.properties.cmd=e.cmd,this.properties.min_value=this.properties.max_value=e.data[1];else if(-1!=this.properties.channel&&e.channel!=this.properties.channel||-1!=this.properties.cmd&&e.cmd!=this.properties.cmd||-1!=this.properties.min_value&&e.data[1]<this.properties.min_value||-1!=this.properties.max_value&&e.data[1]>this.properties.max_value)return;this.trigger("on_midi",e)}},e.registerNodeType("midi/filter",l),d.title="MIDIEvent",d.desc="Create a MIDI Event",d.color=s,d.prototype.onAction=function(t,e){if("assign"==t){this.properties.channel=e.channel,this.properties.cmd=e.cmd,this.properties.value1=e.data[1],this.properties.value2=e.data[2],e.cmd==o.NOTEON?this.gate=!0:e.cmd==o.NOTEOFF&&(this.gate=!1);return}var e=this.midi_event;e.channel=this.properties.channel,this.properties.cmd&&this.properties.cmd.constructor===String?e.setCommandFromString(this.properties.cmd):e.cmd=this.properties.cmd,e.data[0]=e.cmd|e.channel,e.data[1]=Number(this.properties.value1),e.data[2]=Number(this.properties.value2),this.trigger("on_midi",e)},d.prototype.onExecute=function(){var t=this.properties;if(this.inputs)for(var e=0;e<this.inputs.length;++e){var s=this.inputs[e];if(-1!=s.link)switch(s.name){case"note":var n=this.getInputData(e);null!=n&&(n.constructor===String&&(n=o.NoteStringToPitch(n)),this.properties.value1=(0|n)%255);break;case"cmd":var n=this.getInputData(e);null!=n&&(this.properties.cmd=n);break;case"value1":var n=this.getInputData(e);null!=n&&(this.properties.value1=clamp(0|n,0,127));break;case"value2":var n=this.getInputData(e);null!=n&&(this.properties.value2=clamp(0|n,0,127))}}if(this.outputs)for(var e=0;e<this.outputs.length;++e){var r=this.outputs[e],n=null;switch(r.name){case"midi":(n=new o).setup([t.cmd,t.value1,t.value2]),n.channel=t.channel;break;case"command":n=t.cmd;break;case"cc":n=t.value1;break;case"cc_value":n=t.value2;break;case"note":n=t.cmd==o.NOTEON||t.cmd==o.NOTEOFF?t.value1:null;break;case"velocity":n=t.cmd==o.NOTEON?t.value2:null;break;case"pitch":n=t.cmd==o.NOTEON?o.computePitch(t.value1):null;break;case"pitchbend":n=t.cmd==o.PITCHBEND?o.computePitchBend(t.value1,t.value2):null;break;case"gate":n=this.gate;break;default:continue}null!==n&&this.setOutputData(e,n)}},d.prototype.onPropertyChanged=function(t,e){"cmd"==t&&(this.properties.cmd=o.computeCommandFromString(e))},d.prototype.onGetInputs=function(){return[["cmd","number"],["note","number"],["value1","number"],["value2","number"]]},d.prototype.onGetOutputs=function(){return[["midi","midi"],["on_midi",e.EVENT],["command","number"],["note","number"],["velocity","number"],["cc","number"],["cc_value","number"],["pitch","number"],["gate","bool"],["pitchbend","number"]]},e.registerNodeType("midi/event",d),c.title="MIDICC",c.desc="gets a Controller Change",c.color=s,c.prototype.onExecute=function(){this.properties,r.input&&(this.properties.value=r.input.state.cc[this.properties.cc]),this.setOutputData(0,this.properties.value)},e.registerNodeType("midi/cc",c),f.title="MIDI Generator",f.desc="Generates a random MIDI note",f.color=s,f.processScale=function(t){for(var s=t.split(","),n=0;n<s.length;++n){var r=s[n];2==r.length&&"#"!=r[1]||r.length>2?s[n]=-e.MIDIEvent.NoteStringToPitch(r):s[n]=o.note_to_index[r]||0}return s},f.prototype.onPropertyChanged=function(t,e){"notes"==t&&(this.notes_pitches=f.processScale(e))},f.prototype.onExecute=function(){var t=this.getInputData(2);null!=t&&(this.properties.octave=t);var e=this.getInputData(1);e&&(this.notes_pitches=f.processScale(e))},f.prototype.onAction=function(t,e){var s=0,n=this.notes_pitches.length,r=0;"sequence"==this.properties.mode?r=this.sequence_index=(this.sequence_index+1)%n:"random"==this.properties.mode&&(r=Math.floor(Math.random()*n));var a=this.notes_pitches[r];s=a>=0?a+(this.properties.octave-1)*12+33:-a;var e=new o;e.setup([o.NOTEON,s,10]);var u=this.properties.duration||1;this.trigger("note",e),setTimeout((function(){var t=new o;t.setup([o.NOTEOFF,s,0]),this.trigger("note",t)}).bind(this),1e3*u)},e.registerNodeType("midi/generator",f),g.title="MIDI Transpose",g.desc="Transpose a MIDI note",g.color=s,g.prototype.onAction=function(t,e){e&&e.constructor===o&&(e.data[0]==o.NOTEON||e.data[0]==o.NOTEOFF?(this.midi_event=new o,this.midi_event.setup(e.data),this.midi_event.data[1]=Math.round(this.midi_event.data[1]+this.properties.amount),this.trigger("out",this.midi_event)):this.trigger("out",e))},g.prototype.onExecute=function(){var t=this.getInputData(1);null!=t&&(this.properties.amount=t)},e.registerNodeType("midi/transpose",g),v.title="MIDI Quantize Pitch",v.desc="Transpose a MIDI note tp fit an scale",v.color=s,v.prototype.onPropertyChanged=function(t,e){"scale"==t&&this.processScale(e)},v.prototype.processScale=function(t){this._current_scale=t,this.notes_pitches=f.processScale(t);for(var e=0;e<12;++e)this.valid_notes[e]=-1!=this.notes_pitches.indexOf(e);for(var e=0;e<12;++e){if(this.valid_notes[e]){this.offset_notes[e]=0;continue}for(var s=1;s<12;++s){if(this.valid_notes[(e-s)%12]){this.offset_notes[e]=-s;break}if(this.valid_notes[(e+s)%12]){this.offset_notes[e]=s;break}}}},v.prototype.onAction=function(t,e){if(e&&e.constructor===o){if(e.data[0]==o.NOTEON||e.data[0]==o.NOTEOFF){this.midi_event=new o,this.midi_event.setup(e.data);var s=e.note,n=o.note_to_index[s],r=this.offset_notes[n];this.midi_event.data[1]+=r,this.trigger("out",this.midi_event)}else this.trigger("out",e)}},v.prototype.onExecute=function(){var t=this.getInputData(1);null!=t&&t!=this._current_scale&&this.processScale(t)},e.registerNodeType("midi/quantize",v),$.title="MIDI fromFile",$.desc="Plays a MIDI file",$.color=s,$.prototype.onAction=function(t){"play"==t?this.play():"pause"==t&&(this._playing=!this._playing)},$.prototype.onPropertyChanged=function(t,e){"url"==t&&this.loadMIDIFile(e)},$.prototype.onExecute=function(){if(this._midi&&this._playing){this._current_time+=this.graph.elapsed_time;for(var t=100*this._current_time,e=0;e<this._midi.tracks;++e){var s=this._midi.track[e];s._last_pos||(s._last_pos=0,s._time=0);var n=s.event[s._last_pos];if(n&&s._time+n.deltaTime<=t&&(s._last_pos++,s._time+=n.deltaTime,n.data)){var r=n.type<<4+n.channel,a=new o;a.setup([r,n.data[0],n.data[1]]),this.trigger("note",a)}}}},$.prototype.play=function(){if(this._playing=!0,this._current_time=0,this._midi)for(var t=0;t<this._midi.tracks;++t){var e=this._midi.track[t];e._last_pos=0,e._time=0}},$.prototype.loadMIDIFile=function(t){var s=this;e.fetchFile(t,"arraybuffer",function(t){s.boxcolor="#AFA",s._midi=MidiParser.parse(new Uint8Array(t)),s.properties.autoplay&&s.play()},function(t){s.boxcolor="#FAA",s._midi=null})},$.prototype.onDropFile=function(t){this.properties.url="",this.loadMIDIFile(t)},e.registerNodeType("midi/fromFile",$),m.title="MIDI Play",m.desc="Plays a MIDI note",m.color=s,m.prototype.onAction=function(t,e){if(e&&e.constructor===o){if(this.instrument&&e.data[0]==o.NOTEON){var s=e.note;if(!s||"undefined"==s||s.constructor!==String)return;this.instrument.play(s,e.octave,this.properties.duration,this.properties.volume)}this.trigger("note",e)}},m.prototype.onExecute=function(){var t=this.getInputData(1);null!=t&&(this.properties.volume=t);var e=this.getInputData(2);null!=e&&(this.properties.duration=e)},e.registerNodeType("midi/play",m),y.title="MIDI Keys",y.desc="Keyboard to play notes",y.color=s,y.keys=[{x:0,w:1,h:1,t:0},{x:.75,w:.5,h:.6,t:1},{x:1,w:1,h:1,t:0},{x:1.75,w:.5,h:.6,t:1},{x:2,w:1,h:1,t:0},{x:2.75,w:.5,h:.6,t:1},{x:3,w:1,h:1,t:0},{x:4,w:1,h:1,t:0},{x:4.75,w:.5,h:.6,t:1},{x:5,w:1,h:1,t:0},{x:5.75,w:.5,h:.6,t:1},{x:6,w:1,h:1,t:0}],y.prototype.onDrawForeground=function(t){if(!this.flags.collapsed){var e=12*this.properties.num_octaves;this.keys.length=e;var s=this.size[0]/(7*this.properties.num_octaves),o=this.size[1];t.globalAlpha=1;for(var n=0;n<2;n++)for(var r=0;r<e;++r){var a=y.keys[r%12];if(a.t==n){var u,h=7*Math.floor(r/12)*s+a.x*s;0==n?t.fillStyle=this.keys[r]?"#CCC":"white":t.fillStyle=this.keys[r]?"#333":"black",t.fillRect(h+1,0,s*a.w-2,o*a.h)}}}},y.prototype.getKeyIndex=function(t){this.properties.num_octaves;for(var e=this.size[0]/(7*this.properties.num_octaves),s=this.size[1],o=1;o>=0;o--)for(var n=0;n<this.keys.length;++n){var r=y.keys[n%12];if(r.t==o){var a=7*Math.floor(n/12)*e+r.x*e,u=e*r.w,h=s*r.h;if(!(t[0]<a)&&!(t[0]>a+u)&&!(t[1]>h))return n}}return -1},y.prototype.onAction=function(t,e){if("reset"==t){for(var s=0;s<this.keys.length;++s)this.keys[s]=!1;return}if(e&&e.constructor===o){var n=e,r=(this.properties.start_octave-1)*12+29,a=n.data[1]-r;a>=0&&a<this.keys.length&&(n.data[0]==o.NOTEON?this.keys[a]=!0:n.data[0]==o.NOTEOFF&&(this.keys[a]=!1)),this.trigger("note",n)}},y.prototype.onMouseDown=function(t,e){if(!(e[1]<0)){var s=this.getKeyIndex(e);this.keys[s]=!0,this._last_key=s;var n=(this.properties.start_octave-1)*12+29+s,r=new o;return r.setup([o.NOTEON,n,100]),this.trigger("note",r),!0}},y.prototype.onMouseMove=function(t,e){if(!(e[1]<0)&&-1!=this._last_key){this.setDirtyCanvas(!0);var s=this.getKeyIndex(e);if(this._last_key==s)return!0;this.keys[this._last_key]=!1;var n=(this.properties.start_octave-1)*12+29+this._last_key,r=new o;r.setup([o.NOTEOFF,n,100]),this.trigger("note",r),this.keys[s]=!0;var n=(this.properties.start_octave-1)*12+29+s,r=new o;return r.setup([o.NOTEON,n,100]),this.trigger("note",r),this._last_key=s,!0}},y.prototype.onMouseUp=function(t,e){if(!(e[1]<0)){var s=this.getKeyIndex(e);this.keys[s]=!1,this._last_key=-1;var n=(this.properties.start_octave-1)*12+29+s,r=new o;return r.setup([o.NOTEOFF,n,100]),this.trigger("note",r),!0}},e.registerNodeType("midi/keys",y)}(this),function(t){var e=t.LiteGraph,s={};function o(){this.properties={src:"",gain:.5,loop:!0,autoplay:!0,playbackRate:1},this._loading_audio=!1,this._audiobuffer=null,this._audionodes=[],this._last_sourcenode=null,this.addOutput("out","audio"),this.addInput("gain","number");var t=s.getAudioContext();this.audionode=t.createGain(),this.audionode.graphnode=this,this.audionode.gain.value=this.properties.gain,this.properties.src&&this.loadSound(this.properties.src)}function n(){this.properties={gain:.5},this._audionodes=[],this._media_stream=null,this.addOutput("out","audio"),this.addInput("gain","number");var t=s.getAudioContext();this.audionode=t.createGain(),this.audionode.graphnode=this,this.audionode.gain.value=this.properties.gain}function r(){this.properties={fftSize:2048,minDecibels:-100,maxDecibels:-10,smoothingTimeConstant:.5};var t=s.getAudioContext();this.audionode=t.createAnalyser(),this.audionode.graphnode=this,this.audionode.fftSize=this.properties.fftSize,this.audionode.minDecibels=this.properties.minDecibels,this.audionode.maxDecibels=this.properties.maxDecibels,this.audionode.smoothingTimeConstant=this.properties.smoothingTimeConstant,this.addInput("in","audio"),this.addOutput("freqs","array"),this.addOutput("samples","array"),this._freq_bin=null,this._time_bin=null}function a(){this.properties={gain:1},this.audionode=s.getAudioContext().createGain(),this.addInput("in","audio"),this.addInput("gain","number"),this.addOutput("out","audio")}function u(){this.properties={impulse_src:"",normalize:!0},this.audionode=s.getAudioContext().createConvolver(),this.addInput("in","audio"),this.addOutput("out","audio")}function h(){this.properties={threshold:-50,knee:40,ratio:12,reduction:-20,attack:0,release:.25},this.audionode=s.getAudioContext().createDynamicsCompressor(),this.addInput("in","audio"),this.addOutput("out","audio")}function l(){this.properties={},this.audionode=s.getAudioContext().createWaveShaper(),this.addInput("in","audio"),this.addInput("shape","waveshape"),this.addOutput("out","audio")}function d(){this.properties={gain1:.5,gain2:.5},this.audionode=s.getAudioContext().createGain(),this.audionode1=s.getAudioContext().createGain(),this.audionode1.gain.value=this.properties.gain1,this.audionode2=s.getAudioContext().createGain(),this.audionode2.gain.value=this.properties.gain2,this.audionode1.connect(this.audionode),this.audionode2.connect(this.audionode),this.addInput("in1","audio"),this.addInput("in1 gain","number"),this.addInput("in2","audio"),this.addInput("in2 gain","number"),this.addOutput("out","audio")}function c(){this.properties={A:.1,D:.1,S:.1,R:.1},this.audionode=s.getAudioContext().createGain(),this.audionode.gain.value=0,this.addInput("in","audio"),this.addInput("gate","boolean"),this.addOutput("out","audio"),this.gate=!1}function f(){this.properties={delayTime:.5},this.audionode=s.getAudioContext().createDelay(10),this.audionode.delayTime.value=this.properties.delayTime,this.addInput("in","audio"),this.addInput("time","number"),this.addOutput("out","audio")}function g(){this.properties={frequency:350,detune:0,Q:1},this.addProperty("type","lowpass","enum",{values:["lowpass","highpass","bandpass","lowshelf","highshelf","peaking","notch","allpass"]}),this.audionode=s.getAudioContext().createBiquadFilter(),this.addInput("in","audio"),this.addOutput("out","audio")}function v(){this.properties={frequency:440,detune:0,type:"sine"},this.addProperty("type","sine","enum",{values:["sine","square","sawtooth","triangle","custom"]}),this.audionode=s.getAudioContext().createOscillator(),this.addOutput("out","audio")}function $(){this.properties={continuous:!0,mark:-1},this.addInput("data","array"),this.addInput("mark","number"),this.size=[300,200],this._last_buffer=null}function m(){this.properties={band:440,amplitude:1},this.addInput("freqs","array"),this.addOutput("signal","number")}function y(){if(!y.default_code){var t=y.default_function.toString(),e=t.indexOf("{")+1,o=t.lastIndexOf("}");y.default_code=t.substr(e,o-e)}this.properties={code:y.default_code};var n=s.getAudioContext();n.createScriptProcessor?this.audionode=n.createScriptProcessor(4096,1,1):(console.warn("ScriptProcessorNode deprecated"),this.audionode=n.createGain()),this.processCode(),y._bypass_function||(y._bypass_function=this.audionode.onaudioprocess),this.addInput("in","audio"),this.addOutput("out","audio")}function x(){this.audionode=s.getAudioContext().destination,this.addInput("in","audio")}t.LGAudio=s,s.getAudioContext=function(){if(!this._audio_context){if(window.AudioContext=window.AudioContext||window.webkitAudioContext,!window.AudioContext)return console.error("AudioContext not supported by browser"),null;this._audio_context=new AudioContext,this._audio_context.onmessage=function(t){console.log("msg",t)},this._audio_context.onended=function(t){console.log("ended",t)},this._audio_context.oncomplete=function(t){console.log("complete",t)}}return this._audio_context},s.connect=function(t,e){try{t.connect(e)}catch(s){console.warn("LGraphAudio:",s)}},s.disconnect=function(t,e){try{t.disconnect(e)}catch(s){console.warn("LGraphAudio:",s)}},s.changeAllAudiosConnections=function(t,e){if(t.inputs)for(var o=0;o<t.inputs.length;++o){var n=t.inputs[o],r=t.graph.links[n.link];if(r){var a=t.graph.getNodeById(r.origin_id),u=null;u=a.getAudioNodeInOutputSlot?a.getAudioNodeInOutputSlot(r.origin_slot):a.audionode;var h=null;h=t.getAudioNodeInInputSlot?t.getAudioNodeInInputSlot(o):t.audionode,e?s.connect(u,h):s.disconnect(u,h)}}if(t.outputs)for(var o=0;o<t.outputs.length;++o)for(var l=t.outputs[o],d=0;d<l.links.length;++d){var r=t.graph.links[l.links[d]];if(r){var u=null;u=t.getAudioNodeInOutputSlot?t.getAudioNodeInOutputSlot(o):t.audionode;var c=t.graph.getNodeById(r.target_id),h=null;h=c.getAudioNodeInInputSlot?c.getAudioNodeInInputSlot(r.target_slot):c.audionode,e?s.connect(u,h):s.disconnect(u,h)}}},s.onConnectionsChange=function(t,o,n,r){if(t==e.OUTPUT){var a=null;if(r&&(a=this.graph.getNodeById(r.target_id)),a){var u=null;u=this.getAudioNodeInOutputSlot?this.getAudioNodeInOutputSlot(o):this.audionode;var h=null;h=a.getAudioNodeInInputSlot?a.getAudioNodeInInputSlot(r.target_slot):a.audionode,n?s.connect(u,h):s.disconnect(u,h)}}},s.createAudioNodeWrapper=function(t){var e=t.prototype.onPropertyChanged;t.prototype.onPropertyChanged=function(t,s){e&&e.call(this,t,s),this.audionode&&void 0!==this.audionode[t]&&(void 0!==this.audionode[t].value?this.audionode[t].value=s:this.audionode[t]=s)},t.prototype.onConnectionsChange=s.onConnectionsChange},s.cached_audios={},s.loadSound=function(t,e,o){if(s.cached_audios[t]&&-1==t.indexOf("blob:")){e&&e(s.cached_audios[t]);return}s.onProcessAudioURL&&(t=s.onProcessAudioURL(t));var n=new XMLHttpRequest;n.open("GET",t,!0),n.responseType="arraybuffer";var r=s.getAudioContext();function a(t){console.log("Audio loading sample error:",t),o&&o(t)}return n.onload=function(){console.log("AudioSource loaded"),r.decodeAudioData(n.response,function(o){console.log("AudioSource decoded"),s.cached_audios[t]=o,e&&e(o)},a)},n.send(),n},o.desc="Plays an audio file",o["@src"]={widget:"resource"},o.supported_extensions=["wav","ogg","mp3"],o.prototype.onAdded=function(t){t.status===LGraph.STATUS_RUNNING&&this.onStart()},o.prototype.onStart=function(){this._audiobuffer&&this.properties.autoplay&&this.playBuffer(this._audiobuffer)},o.prototype.onStop=function(){this.stopAllSounds()},o.prototype.onPause=function(){this.pauseAllSounds()},o.prototype.onUnpause=function(){this.unpauseAllSounds()},o.prototype.onRemoved=function(){this.stopAllSounds(),this._dropped_url&&URL.revokeObjectURL(this._url)},o.prototype.stopAllSounds=function(){for(var t=0;t<this._audionodes.length;++t)this._audionodes[t].started&&(this._audionodes[t].started=!1,this._audionodes[t].stop());this._audionodes.length=0},o.prototype.pauseAllSounds=function(){s.getAudioContext().suspend()},o.prototype.unpauseAllSounds=function(){s.getAudioContext().resume()},o.prototype.onExecute=function(){if(this.inputs)for(var t=0;t<this.inputs.length;++t){var e=this.inputs[t];if(null!=e.link){var s=this.getInputData(t);if(void 0!==s){if("gain"==e.name)this.audionode.gain.value=s;else if("src"==e.name)this.setProperty("src",s);else if("playbackRate"==e.name){this.properties.playbackRate=s;for(var o=0;o<this._audionodes.length;++o)this._audionodes[o].playbackRate.value=s}}}}if(this.outputs)for(var t=0;t<this.outputs.length;++t)"buffer"==this.outputs[t].name&&this._audiobuffer&&this.setOutputData(t,this._audiobuffer)},o.prototype.onAction=function(t){this._audiobuffer&&("Play"==t?this.playBuffer(this._audiobuffer):"Stop"==t&&this.stopAllSounds())},o.prototype.onPropertyChanged=function(t,e){if("src"==t)this.loadSound(e);else if("gain"==t)this.audionode.gain.value=e;else if("playbackRate"==t)for(var s=0;s<this._audionodes.length;++s)this._audionodes[s].playbackRate.value=e},o.prototype.playBuffer=function(t){var e=this,o=s.getAudioContext().createBufferSource();return this._last_sourcenode=o,o.graphnode=this,o.buffer=t,o.loop=this.properties.loop,o.playbackRate.value=this.properties.playbackRate,this._audionodes.push(o),o.connect(this.audionode),this._audionodes.push(o),this.trigger("start"),o.onended=function(){e.trigger("ended");var t=e._audionodes.indexOf(o);-1!=t&&e._audionodes.splice(t,1)},o.started||(o.started=!0,o.start()),o},o.prototype.loadSound=function(t){var o=this;function n(t){this.boxcolor=e.NODE_DEFAULT_BOXCOLOR,o._audiobuffer=t,o._loading_audio=!1,o.graph&&o.graph.status===LGraph.STATUS_RUNNING&&o.onStart()}this._request&&(this._request.abort(),this._request=null),this._audiobuffer=null,this._loading_audio=!1,t&&(this._request=s.loadSound(t,n),this._loading_audio=!0,this.boxcolor="#AA4")},o.prototype.onConnectionsChange=s.onConnectionsChange,o.prototype.onGetInputs=function(){return[["playbackRate","number"],["src","string"],["Play",e.ACTION],["Stop",e.ACTION]]},o.prototype.onGetOutputs=function(){return[["buffer","audiobuffer"],["start",e.EVENT],["ended",e.EVENT]]},o.prototype.onDropFile=function(t){this._dropped_url&&URL.revokeObjectURL(this._dropped_url);var e=URL.createObjectURL(t);this.properties.src=e,this.loadSound(e),this._dropped_url=e},o.title="Source",o.desc="Plays audio",e.registerNodeType("audio/source",o),n.prototype.onAdded=function(t){t.status===LGraph.STATUS_RUNNING&&this.onStart()},n.prototype.onStart=function(){null!=this._media_stream||this._waiting_confirmation||this.openStream()},n.prototype.onStop=function(){this.audionode.gain.value=0},n.prototype.onPause=function(){this.audionode.gain.value=0},n.prototype.onUnpause=function(){this.audionode.gain.value=this.properties.gain},n.prototype.onRemoved=function(){if(this.audionode.gain.value=0,this.audiosource_node&&(this.audiosource_node.disconnect(this.audionode),this.audiosource_node=null),this._media_stream){var t=this._media_stream.getTracks();t.length&&t[0].stop()}},n.prototype.openStream=function(){if(!navigator.mediaDevices){console.log("getUserMedia() is not supported in your browser, use chrome and enable WebRTC from about://flags");return}this._waiting_confirmation=!0,navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(this.streamReady.bind(this)).catch(e);var t=this;function e(e){console.log("Media rejected",e),t._media_stream=!1,t.boxcolor="red"}},n.prototype.streamReady=function(t){this._media_stream=t,this.audiosource_node&&this.audiosource_node.disconnect(this.audionode);var e=s.getAudioContext();this.audiosource_node=e.createMediaStreamSource(t),this.audiosource_node.graphnode=this,this.audiosource_node.connect(this.audionode),this.boxcolor="white"},n.prototype.onExecute=function(){if(null!=this._media_stream||this._waiting_confirmation||this.openStream(),this.inputs)for(var t=0;t<this.inputs.length;++t){var e=this.inputs[t];if(null!=e.link){var s=this.getInputData(t);void 0!==s&&"gain"==e.name&&(this.audionode.gain.value=this.properties.gain=s)}}},n.prototype.onAction=function(t){"Play"==t?this.audionode.gain.value=this.properties.gain:"Stop"==t&&(this.audionode.gain.value=0)},n.prototype.onPropertyChanged=function(t,e){"gain"==t&&(this.audionode.gain.value=e)},n.prototype.onConnectionsChange=s.onConnectionsChange,n.prototype.onGetInputs=function(){return[["playbackRate","number"],["Play",e.ACTION],["Stop",e.ACTION]]},n.title="MediaSource",n.desc="Plays microphone",e.registerNodeType("audio/media_source",n),r.prototype.onPropertyChanged=function(t,e){this.audionode[t]=e},r.prototype.onExecute=function(){if(this.isOutputConnected(0)){var t=this.audionode.frequencyBinCount;this._freq_bin&&this._freq_bin.length==t||(this._freq_bin=new Uint8Array(t)),this.audionode.getByteFrequencyData(this._freq_bin),this.setOutputData(0,this._freq_bin)}if(this.isOutputConnected(1)){var t=this.audionode.frequencyBinCount;this._time_bin&&this._time_bin.length==t||(this._time_bin=new Uint8Array(t)),this.audionode.getByteTimeDomainData(this._time_bin),this.setOutputData(1,this._time_bin)}for(var e=1;e<this.inputs.length;++e){var s=this.inputs[e];if(null!=s.link){var o=this.getInputData(e);void 0!==o&&(this.audionode[s.name].value=o)}}},r.prototype.onGetInputs=function(){return[["minDecibels","number"],["maxDecibels","number"],["smoothingTimeConstant","number"]]},r.prototype.onGetOutputs=function(){return[["freqs","array"],["samples","array"]]},r.title="Analyser",r.desc="Audio Analyser",e.registerNodeType("audio/analyser",r),a.prototype.onExecute=function(){if(this.inputs&&this.inputs.length)for(var t=1;t<this.inputs.length;++t){var e=this.inputs[t],s=this.getInputData(t);void 0!==s&&(this.audionode[e.name].value=s)}},s.createAudioNodeWrapper(a),a.title="Gain",a.desc="Audio gain",e.registerNodeType("audio/gain",a),s.createAudioNodeWrapper(u),u.prototype.onRemove=function(){this._dropped_url&&URL.revokeObjectURL(this._dropped_url)},u.prototype.onPropertyChanged=function(t,e){"impulse_src"==t?this.loadImpulse(e):"normalize"==t&&(this.audionode.normalize=e)},u.prototype.onDropFile=function(t){this._dropped_url&&URL.revokeObjectURL(this._dropped_url),this._dropped_url=URL.createObjectURL(t),this.properties.impulse_src=this._dropped_url,this.loadImpulse(this._dropped_url)},u.prototype.loadImpulse=function(t){var e=this;function o(t){e._impulse_buffer=t,e.audionode.buffer=t,console.log("Impulse signal set"),e._loading_impulse=!1}this._request&&(this._request.abort(),this._request=null),this._impulse_buffer=null,this._loading_impulse=!1,t&&(this._request=s.loadSound(t,o),this._loading_impulse=!0)},u.title="Convolver",u.desc="Convolves the signal (used for reverb)",e.registerNodeType("audio/convolver",u),s.createAudioNodeWrapper(h),h.prototype.onExecute=function(){if(this.inputs&&this.inputs.length)for(var t=1;t<this.inputs.length;++t){var e=this.inputs[t];if(null!=e.link){var s=this.getInputData(t);void 0!==s&&(this.audionode[e.name].value=s)}}},h.prototype.onGetInputs=function(){return[["threshold","number"],["knee","number"],["ratio","number"],["reduction","number"],["attack","number"],["release","number"]]},h.title="DynamicsCompressor",h.desc="Dynamics Compressor",e.registerNodeType("audio/dynamicsCompressor",h),l.prototype.onExecute=function(){if(this.inputs&&this.inputs.length){var t=this.getInputData(1);void 0!==t&&(this.audionode.curve=t)}},l.prototype.setWaveShape=function(t){this.audionode.curve=t},s.createAudioNodeWrapper(l),d.prototype.getAudioNodeInInputSlot=function(t){return 0==t?this.audionode1:2==t?this.audionode2:void 0},d.prototype.onPropertyChanged=function(t,e){"gain1"==t?this.audionode1.gain.value=e:"gain2"==t&&(this.audionode2.gain.value=e)},d.prototype.onExecute=function(){if(this.inputs&&this.inputs.length)for(var t=1;t<this.inputs.length;++t){var e=this.inputs[t];if(null!=e.link&&"audio"!=e.type){var s=this.getInputData(t);void 0!==s&&(1==t?this.audionode1.gain.value=s:3==t&&(this.audionode2.gain.value=s))}}},s.createAudioNodeWrapper(d),d.title="Mixer",d.desc="Audio mixer",e.registerNodeType("audio/mixer",d),c.prototype.onExecute=function(){var t=s.getAudioContext().currentTime,e=this.audionode.gain,o=this.getInputData(1),n=this.getInputOrProperty("A"),r=this.getInputOrProperty("D"),a=this.getInputOrProperty("S"),u=this.getInputOrProperty("R");!this.gate&&o?(e.cancelScheduledValues(0),e.setValueAtTime(0,t),e.linearRampToValueAtTime(1,t+n),e.linearRampToValueAtTime(a,t+n+r)):this.gate&&!o&&(e.cancelScheduledValues(0),e.setValueAtTime(e.value,t),e.linearRampToValueAtTime(0,t+u)),this.gate=o},c.prototype.onGetInputs=function(){return[["A","number"],["D","number"],["S","number"],["R","number"]]},s.createAudioNodeWrapper(c),c.title="ADSR",c.desc="Audio envelope",e.registerNodeType("audio/adsr",c),s.createAudioNodeWrapper(f),f.prototype.onExecute=function(){var t=this.getInputData(1);void 0!==t&&(this.audionode.delayTime.value=t)},f.title="Delay",f.desc="Audio delay",e.registerNodeType("audio/delay",f),g.prototype.onExecute=function(){if(this.inputs&&this.inputs.length)for(var t=1;t<this.inputs.length;++t){var e=this.inputs[t];if(null!=e.link){var s=this.getInputData(t);void 0!==s&&(this.audionode[e.name].value=s)}}},g.prototype.onGetInputs=function(){return[["frequency","number"],["detune","number"],["Q","number"]]},s.createAudioNodeWrapper(g),g.title="BiquadFilter",g.desc="Audio filter",e.registerNodeType("audio/biquadfilter",g),v.prototype.onStart=function(){if(!this.audionode.started){this.audionode.started=!0;try{this.audionode.start()}catch(t){}}},v.prototype.onStop=function(){this.audionode.started&&(this.audionode.started=!1,this.audionode.stop())},v.prototype.onPause=function(){this.onStop()},v.prototype.onUnpause=function(){this.onStart()},v.prototype.onExecute=function(){if(this.inputs&&this.inputs.length)for(var t=0;t<this.inputs.length;++t){var e=this.inputs[t];if(null!=e.link){var s=this.getInputData(t);void 0!==s&&(this.audionode[e.name].value=s)}}},v.prototype.onGetInputs=function(){return[["frequency","number"],["detune","number"],["type","string"]]},s.createAudioNodeWrapper(v),v.title="Oscillator",v.desc="Oscillator",e.registerNodeType("audio/oscillator",v),$.prototype.onExecute=function(){this._last_buffer=this.getInputData(0);var t=this.getInputData(1);void 0!==t&&(this.properties.mark=t),this.setDirtyCanvas(!0,!1)},$.prototype.onDrawForeground=function(t){if(this._last_buffer){var e=this._last_buffer,o=e.length/this.size[0],n=this.size[1];t.fillStyle="black",t.fillRect(0,0,this.size[0],this.size[1]),t.strokeStyle="white",t.beginPath();var r=0;if(this.properties.continuous){t.moveTo(r,n);for(var a=0;a<e.length;a+=o)t.lineTo(r,n-e[0|a]/255*n),r++}else for(var a=0;a<e.length;a+=o)t.moveTo(r+.5,n),t.lineTo(r+.5,n-e[0|a]/255*n),r++;if(t.stroke(),this.properties.mark>=0){var u=s.getAudioContext().sampleRate/e.length,r=2*(this.properties.mark/u)/o;r>=this.size[0]&&(r=this.size[0]-1),t.strokeStyle="red",t.beginPath(),t.moveTo(r,n),t.lineTo(r,0),t.stroke()}}},$.title="Visualization",$.desc="Audio Visualization",e.registerNodeType("audio/visualization",$),m.prototype.onExecute=function(){if(this._freqs=this.getInputData(0),this._freqs){var t,e,o=this.properties.band,n=this.getInputData(1);void 0!==n&&(o=n);var r=2*(o/(s.getAudioContext().sampleRate/this._freqs.length)),n=0;if(r<0&&(n=this._freqs[0]),r>=this._freqs.length)n=this._freqs[this._freqs.length-1];else{var a=0|r,u=this._freqs[a],h=this._freqs[a+1],l=r-a;n=u*(1-l)+h*l}this.setOutputData(0,n/255*this.properties.amplitude)}},m.prototype.onGetInputs=function(){return[["band","number"]]},m.title="Signal",m.desc="extract the signal of some frequency",e.registerNodeType("audio/signal",m),y.prototype.onAdded=function(t){t.status==LGraph.STATUS_RUNNING&&(this.audionode.onaudioprocess=this._callback)},y["@code"]={widget:"code",type:"code"},y.prototype.onStart=function(){this.audionode.onaudioprocess=this._callback},y.prototype.onStop=function(){this.audionode.onaudioprocess=y._bypass_function},y.prototype.onPause=function(){this.audionode.onaudioprocess=y._bypass_function},y.prototype.onUnpause=function(){this.audionode.onaudioprocess=this._callback},y.prototype.onExecute=function(){},y.prototype.onRemoved=function(){this.audionode.onaudioprocess=y._bypass_function},y.prototype.processCode=function(){try{var t=Function("properties",this.properties.code);this._script=new t(this.properties),this._old_code=this.properties.code,this._callback=this._script.onaudioprocess}catch(e){console.error("Error in onaudioprocess code",e),this._callback=y._bypass_function,this.audionode.onaudioprocess=this._callback}},y.prototype.onPropertyChanged=function(t,e){"code"==t&&(this.properties.code=e,this.processCode(),this.graph&&this.graph.status==LGraph.STATUS_RUNNING&&(this.audionode.onaudioprocess=this._callback))},y.default_function=function(){this.onaudioprocess=function(t){for(var e=t.inputBuffer,s=t.outputBuffer,o=0;o<s.numberOfChannels;o++)for(var n=e.getChannelData(o),r=s.getChannelData(o),a=0;a<e.length;a++)r[a]=n[a]}},s.createAudioNodeWrapper(y),y.title="Script",y.desc="apply script to signal",e.registerNodeType("audio/script",y),x.title="Destination",x.desc="Audio output",e.registerNodeType("audio/destination",x)}(this),function(t){var e=t.LiteGraph;function s(){this.size=[60,20],this.addInput("send",e.ACTION),this.addOutput("received",e.EVENT),this.addInput("in",0),this.addOutput("out",0),this.properties={url:"",room:"lgraph",only_send_changes:!0},this._ws=null,this._last_sent_data=[],this._last_received_data=[]}function o(){this.room_widget=this.addWidget("text","Room","lgraph",this.setRoom.bind(this)),this.addWidget("button","Reconnect",null,this.connectSocket.bind(this)),this.addInput("send",e.ACTION),this.addOutput("received",e.EVENT),this.addInput("in",0),this.addOutput("out",0),this.properties={url:"tamats.com:55000",room:"lgraph",only_send_changes:!0},this._server=null,this.connectSocket(),this._last_sent_data=[],this._last_received_data=[],"undefined"==typeof SillyClient&&console.warn("remember to add SillyClient.js to your project: https://tamats.com/projects/sillyserver/src/sillyclient.js")}function n(){this.addInput("request",e.ACTION),this.addInput("url","string"),this.addProperty("url",""),this.addOutput("ready",e.EVENT),this.addOutput("data","string"),this.addWidget("button","Fetch",null,this.fetch.bind(this)),this._data=null,this._fetching=null}s.title="WebSocket",s.desc="Send data through a websocket",s.prototype.onPropertyChanged=function(t,e){"url"==t&&this.connectSocket()},s.prototype.onExecute=function(){if(!this._ws&&this.properties.url&&this.connectSocket(),this._ws&&this._ws.readyState==WebSocket.OPEN){for(var t=this.properties.room,e=this.properties.only_send_changes,s=1;s<this.inputs.length;++s){var o,n=this.getInputData(s);if(null!=n){try{o=JSON.stringify({type:0,room:t,channel:s,data:n})}catch(r){continue}(!e||this._last_sent_data[s]!=o)&&(this._last_sent_data[s]=o,this._ws.send(o))}}for(var s=1;s<this.outputs.length;++s)this.setOutputData(s,this._last_received_data[s]);"#AFA"==this.boxcolor&&(this.boxcolor="#6C6")}},s.prototype.connectSocket=function(){var t=this,s=this.properties.url;"ws"!=s.substr(0,2)&&(s="ws://"+s),this._ws=new WebSocket(s),this._ws.onopen=function(){console.log("ready"),t.boxcolor="#6C6"},this._ws.onmessage=function(s){t.boxcolor="#AFA";var o=JSON.parse(s.data);if(!o.room||o.room==t.properties.room){if(1==o.type){if(o.data.object_class&&e[o.data.object_class]){var n=null;try{n=new e[o.data.object_class](o.data),t.triggerSlot(0,n)}catch(r){return}}else t.triggerSlot(0,o.data)}else t._last_received_data[o.channel||0]=o.data}},this._ws.onerror=function(e){console.log("couldnt connect to websocket"),t.boxcolor="#E88"},this._ws.onclose=function(e){console.log("connection closed"),t.boxcolor="#000"}},s.prototype.send=function(t){this._ws&&this._ws.readyState==WebSocket.OPEN&&this._ws.send(JSON.stringify({type:1,msg:t}))},s.prototype.onAction=function(t,e){this._ws&&this._ws.readyState==WebSocket.OPEN&&this._ws.send({type:1,room:this.properties.room,action:t,data:e})},s.prototype.onGetInputs=function(){return[["in",0]]},s.prototype.onGetOutputs=function(){return[["out",0]]},e.registerNodeType("network/websocket",s),o.title="SillyClient",o.desc="Connects to SillyServer to broadcast messages",o.prototype.onPropertyChanged=function(t,e){"room"==t&&(this.room_widget.value=e),this.connectSocket()},o.prototype.setRoom=function(t){this.properties.room=t,this.room_widget.value=t,this.connectSocket()},o.prototype.onDrawForeground=function(){for(var t=1;t<this.inputs.length;++t){var e=this.inputs[t];e.label="in_"+t}for(var t=1;t<this.outputs.length;++t){var e=this.outputs[t];e.label="out_"+t}},o.prototype.onExecute=function(){if(this._server&&this._server.is_connected){for(var t=this.properties.only_send_changes,e=1;e<this.inputs.length;++e){var s=this.getInputData(e),o=this._last_sent_data[e];if(null!=s){if(t){var n=!0;if(s&&s.length&&o&&o.length==s.length&&s.constructor!==String){for(var r=0;r<s.length;++r)if(o[r]!=s[r]){n=!1;break}}else this._last_sent_data[e]!=s&&(n=!1);if(n)continue}if(this._server.sendMessage({type:0,channel:e,data:s}),s.length&&s.constructor!==String){if(this._last_sent_data[e]){this._last_sent_data[e].length=s.length;for(var r=0;r<s.length;++r)this._last_sent_data[e][r]=s[r]}else s.constructor===Array?this._last_sent_data[e]=s.concat():this._last_sent_data[e]=new s.constructor(s)}else this._last_sent_data[e]=s}}for(var e=1;e<this.outputs.length;++e)this.setOutputData(e,this._last_received_data[e]);"#AFA"==this.boxcolor&&(this.boxcolor="#6C6")}},o.prototype.connectSocket=function(){var t=this;if("undefined"==typeof SillyClient){this._error||console.error("SillyClient node cannot be used, you must include SillyServer.js"),this._error=!0;return}if(this._server=new SillyClient,this._server.on_ready=function(){console.log("ready"),t.boxcolor="#6C6"},this._server.on_message=function(s,o){var n=null;try{n=JSON.parse(o)}catch(r){return}if(1==n.type){if(n.data.object_class&&e[n.data.object_class]){var a=null;try{a=new e[n.data.object_class](n.data),t.triggerSlot(0,a)}catch(u){return}}else t.triggerSlot(0,n.data)}else t._last_received_data[n.channel||0]=n.data;t.boxcolor="#AFA"},this._server.on_error=function(e){console.log("couldnt connect to websocket"),t.boxcolor="#E88"},this._server.on_close=function(e){console.log("connection closed"),t.boxcolor="#000"},this.properties.url&&this.properties.room){try{this._server.connect(this.properties.url,this.properties.room)}catch(s){console.error("SillyServer error: "+s),this._server=null;return}this._final_url=this.properties.url+"/"+this.properties.room}},o.prototype.send=function(t){this._server&&this._server.is_connected&&this._server.sendMessage({type:1,data:t})},o.prototype.onAction=function(t,e){this._server&&this._server.is_connected&&this._server.sendMessage({type:1,action:t,data:e})},o.prototype.onGetInputs=function(){return[["in",0]]},o.prototype.onGetOutputs=function(){return[["out",0]]},e.registerNodeType("network/sillyclient",o),n.title="HTTP Request",n.desc="Fetch data through HTTP",n.prototype.fetch=function(){var t=this.properties.url;if(t){this.boxcolor="#FF0";var e=this;this._fetching=fetch(t).then(t=>{if(t.ok)return this.boxcolor="#0F0",t.text();this.boxcolor="#F00",e.trigger("error")}).then(t=>{e._data=t,e._fetching=null,e.trigger("ready")})}},n.prototype.onAction=function(t){"request"==t&&this.fetch()},n.prototype.onExecute=function(){this.setOutputData(1,this._data)},n.prototype.onGetOutputs=function(){return[["error",e.EVENT]]},e.registerNodeType("network/httprequest",n)}(this);